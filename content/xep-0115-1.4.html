<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>XEP-0115: Entity Capabilities</title><link rel="stylesheet" type="text/css" href="/xmpp.css" /><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" /><meta name="DC.Title" content="Entity Capabilities" /><meta name="DC.Creator" content="Joe Hildebrand" /><meta name="DC.Creator" content="Peter Saint-Andre" /><meta name="DC.Creator" content="Remko Tron&#xE7;on" /><meta name="DC.Description" content="This document defines an XMPP protocol extension for broadcasting and dynamically discovering client, device, or generic entity capabilities in a way that minimizes network impact." /><meta name="DC.Publisher" content="XMPP Standards Foundation" /><meta name="DC.Contributor" content="XMPP Extensions Editor" /><meta name="DC.Date" content="2007-08-13" /><meta name="DC.Type" content="XMPP Extension Protocol" /><meta name="DC.Format" content="XHTML" /><meta name="DC.Identifier" content="XEP-0115" /><meta name="DC.Language" content="en" /><meta name="DC.Rights" content="This XMPP Extension Protocol is copyright 1999 - 2007 by the XMPP Standards Foundation (XSF) and is in full conformance with the XSF's Intellectual Property Rights Policy &lt;http://www.xmpp.org/extensions/ipr-policy.shtml&gt;. This material may be distributed only subject to the terms and conditions set forth in the Creative Commons Attribution License (&lt;http://creativecommons.org/licenses/by/2.5/&gt;)." /></head><body><h1>XEP-0115: Entity Capabilities</h1><p>This document defines an XMPP protocol extension for broadcasting and dynamically discovering client, device, or generic entity capabilities in a way that minimizes network impact.</p><hr /><p style="color:green">NOTICE: The protocol defined herein is a Draft Standard of the XMPP Standards Foundation. Implementations are encouraged and the protocol is appropriate for deployment in production systems, but some changes to the protocol are possible before it becomes a Final Standard.</p><hr /><h2>Document Information</h2><p class="indent">
            Series: <a href="http://www.xmpp.org/extensions/">XEP</a><br />
            Number: 0115<br />
            Publisher: <a href="/xsf/">XMPP Standards Foundation</a><br />
            Status: 
            <a href="http://www.xmpp.org/extensions/xep-0001.html#states-Draft">Draft</a><br />
            Type:
            <a href="http://www.xmpp.org/extensions/xep-0001.html#types-Standards Track">Standards Track</a><br />
            Version: 1.4<br />
            Last Updated: 2007-08-13<br />
                Approving Body: <a href="http://www.xmpp.org/council/">XMPP Council</a><br />Dependencies: XMPP Core, XMPP IM, XEP-0030<br />
                Supersedes: None<br />
                Superseded By: None<br />
            Short Name: caps<br />
        Schema: &lt;<a href="http://www.xmpp.org/schemas/caps.xsd">http://www.xmpp.org/schemas/caps.xsd</a>&gt;<br />
              Wiki Page: &lt;<a href="http://wiki.jabber.org/index.php/Entity Capabilities (XEP-0115)">http://wiki.jabber.org/index.php/Entity Capabilities (XEP-0115)</a>&gt;
            </p><h2>Author Information</h2><div class="indent"><h3>Joe Hildebrand</h3><p class="indent">
        Email:
        <a href="mailto:jhildebrand@jabber.com">jhildebrand@jabber.com</a><br />
        JabberID: 
        <a href="xmpp:hildjj@jabber.org">hildjj@jabber.org</a></p><h3>Peter Saint-Andre</h3><p class="indent">
        Email:
        <a href="mailto:stpeter@jabber.org">stpeter@jabber.org</a><br />
        JabberID: 
        <a href="xmpp:stpeter@jabber.org">stpeter@jabber.org</a></p><h3>Remko Tronçon</h3><p class="indent">
        Email:
        <a href="mailto:public@el-tramo.be">public@el-tramo.be</a><br />
        JabberID: 
        <a href="xmpp:public@el-tramo.be">public@el-tramo.be</a></p></div><h2>Legal Notice</h2><p class="indent">This XMPP Extension Protocol is copyright 1999 - 2007 by the <a href="http://www.xmpp.org/xsf/">XMPP Standards Foundation</a> (XSF) and is in full conformance with the XSF's Intellectual Property Rights Policy &lt;<a href="http://www.xmpp.org/extensions/ipr-policy.shtml">http://www.xmpp.org/extensions/ipr-policy.shtml</a>&gt;. This material may be distributed only subject to the terms and conditions set forth in the Creative Commons Attribution License (&lt;<a href="http://creativecommons.org/licenses/by/2.5/">http://creativecommons.org/licenses/by/2.5/</a>&gt;).</p><h2>Discussion Venue</h2><p class="indent">The preferred venue for discussion of this document is the Standards discussion list: &lt;<a href="http://mail.jabber.org/mailman/listinfo/standards">http://mail.jabber.org/mailman/listinfo/standards</a>&gt;.</p><h2>Relation to XMPP</h2><p class="indent">The Extensible Messaging and Presence Protocol (XMPP) is defined in the XMPP Core (RFC 3920) and XMPP IM (RFC 3921) specifications contributed by the XMPP Standards Foundation to the Internet Standards Process, which is managed by the Internet Engineering Task Force in accordance with RFC 2026. Any protocol defined in this document has been developed outside the Internet Standards Process and is to be understood as an extension to XMPP rather than as an evolution, development, or modification of XMPP itself.</p><h2>Conformance Terms</h2><p class="indent">The following keywords as used in this document are to be interpreted as described in <a href="http://www.ietf.org/rfc/rfc2119.txt">RFC 2119</a>: "MUST", "SHALL", "REQUIRED"; "MUST NOT", "SHALL NOT"; "SHOULD", "RECOMMENDED"; "SHOULD NOT", "NOT RECOMMENDED"; "MAY", "OPTIONAL".</p><hr /><h2>Table of Contents</h2><div class="indent"><p><br />1.  <a href="#intro">Introduction</a><br />   
      1.1.  <a href="#motivation">Motivation</a><br />   
      1.2.  <a href="#howitworks">How It Works</a><br />2.  <a href="#assumptions">Assumptions</a><br />3.  <a href="#reqs">Requirements</a><br />4.  <a href="#protocol">Protocol</a><br />5.  <a href="#ver">Generation of ver Attribute</a><br />6.  <a href="#usecases">Use Cases</a><br />   
      6.1.  <a href="#advertise">Advertising Capabilities</a><br />   
      6.2.  <a href="#discover">Discovering Capabilities</a><br />   
      6.3.  <a href="#stream">Stream Feature</a><br />7.  <a href="#optimizations">Server Optimizations</a><br />8.  <a href="#directed">Directed Presence</a><br />9.  <a href="#caching">Caching</a><br />10.  <a href="#security">Security Considerations</a><br />11.  <a href="#iana">IANA Considerations</a><br />12.  <a href="#registrar">XMPP Registrar Considerations</a><br />   
      12.1.  <a href="#ns">Protocol Namespaces</a><br />13.  <a href="#schema">XML Schema</a><br />14.  <a href="#legacy">Legacy Format</a><br />15.  <a href="#ack">Acknowledgements</a><br /><a href="#notes">Notes</a><br /><a href="#revs">Revision History</a></p></div><hr /><h2>1.
       <a name="intro" id="intro">Introduction</a></h2>
    <div class="indent"><h3>1.1 <a name="motivation" id="motivation">Motivation</a></h3>
      <p class="" style="">It is often desirable for an XMPP application (commonly but not necessarily a client) to take different actions depending on the capabilities of another application from which it receives presence information. Examples include:</p>
      <ul class="" style="">
        <li class="" style="">Showing a different set of icons depending on the capabilities of other entities.</li>
        <li class="" style="">Not sending <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0071.html">XHTML-IM</a></span>  [<a href="#nt-id2251076">1</a>] or other rich content to plaintext clients such as cell phones.</li> 
        <li class="" style="">Allowing the initiation of a Voice over IP (VoIP) session only to clients that support <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0166.html">Jingle</a></span>  [<a href="#nt-id2251108">2</a>] and <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0167.html">Jingle Audio via RTP</a></span>  [<a href="#nt-id2251133">3</a>].</li>
        <li class="" style="">Not showing a "Send a File" button if another user's client does not support <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0096.html">File Transfer</a></span>  [<a href="#nt-id2251160">4</a>].</li>
        <li class="" style="">Filtering <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0060.html">Publish-Subscribe</a></span>  [<a href="#nt-id2251193">5</a>] notifications based on advertised subscriber interests.</li>
      </ul>
      <p class="" style="">In the past, some Jabber clients sent one <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0030.html">Service Discovery</a></span>  [<a href="#nt-id2251226">6</a>] and one <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0092.html">Software Version</a></span>  [<a href="#nt-id2251252">7</a>] request to each entity from which they received presence after login. That "disco+version flood" resulted in an excessive use of bandwidth and was impractical on a larger scale, particularly for users or applications with large rosters. Therefore this document defines a more robust and scalable solution: namely, a presence-based mechanism  [<a href="#nt-id2251176">8</a>] for exchanging information about entity capabilities. Clients should not engage in the older "disco+version flood" behavior and instead should use Entity Capabilities as specified herein.</p>
    </div>
    <div class="indent"><h3>1.2 <a name="howitworks" id="howitworks">How It Works</a></h3>
      <p class="" style="">This section provides a friendly introduction to entity capabilities.</p>
      <p class="" style="">Imagine that you are a Shakespearean character named Juliet and one of your contacts, a handsome fellow named Romeo, becomes available. His client wants to publish its capabilities, and does this by adding a &lt;c/&gt; element with special attributes to its presence packets. As a result, your client receives the following presence packet:</p>
      <p class="caption"></p><div class="indent"><pre>
&lt;presence from='romeo@montague.lit/orchard'&gt;
  &lt;c xmlns='http://jabber.org/protocol/caps' 
     node='http://exodus.jabberstudio.org/#0.9.1'
     ver='8RovUdtOmiAjzj+xI7SK5BCw3A8='/&gt;
&lt;/presence&gt;
      </pre></div>
      <p class="" style="">The 'node' attribute represents the client Romeo is using (the client identifier is an "FYI" and is not used further in Entity Capabilities). The 'ver' attribute is a specially-constructed string that represents the identity (see &lt;<a href="http://www.xmpp.org/registrar/disco-categories.html">http://www.xmpp.org/registrar/disco-categories.html</a>&gt;) and supported features (see &lt;<a href="http://www.xmpp.org/registrar/disco-features.html">http://www.xmpp.org/registrar/disco-features.html</a>&gt;) of the entity.</p>
      <p class="" style="">At this point, your client has no idea what the capabilities are of someone with a version string '8RovUdtOmiAjzj+xI7SK5BCw3A8='. Your client therefore sends a service discovery query to Romeo, asking what his client can do.</p>
      <p class="caption"></p><div class="indent"><pre>
&lt;iq from='juliet@capulet.lit/chamber' 
    id='disco1'
    to='romeo@montague.lit/orchard' 
    type='get'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#info'/&gt;
&lt;/iq&gt;
      </pre></div>
      <p class="" style="">The response is:</p>
      <p class="caption"></p><div class="indent"><pre>
&lt;iq from='romeo@montague.lit/orchard' 
    id='disco1'
    to='juliet@capulet.lit/chamber' 
    type='result'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#info'&gt;
    &lt;identity category='client' type='pc'/&gt;
    &lt;feature var='http://jabber.org/protocol/disco#info'/&gt;
    &lt;feature var='http://jabber.org/protocol/disco#items'/&gt;
    &lt;feature var='http://jabber.org/protocol/muc'/&gt;
  &lt;/query&gt;
&lt;/iq&gt;
      </pre></div>
      <p class="" style="">At this point, your client knows that anyone advertising a version string of '8RovUdtOmiAjzj+xI7SK5BCw3A8=' has a client that can do <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0045.html">Multi-User Chat</a></span>  [<a href="#nt-id2251408">9</a>] and the other features returned by Romeo's client (the string can be relied upon because of how it is generated and checked as explained later in this document). Your client remembers this information, so that it does not need to explicitly query the capabilities of a contact with the same version string. For example, Benvolio may send you the following presence:</p>
      <p class="caption"></p><div class="indent"><pre>
&lt;presence from='benvolio@capulet.lit/230193'&gt;
  &lt;c xmlns='http://jabber.org/protocol/caps' 
     node='http://psi-im.org/#0.11'
     ver='8RovUdtOmiAjzj+xI7SK5BCw3A8='/&gt;
&lt;/presence&gt;
      </pre></div>
      <p class="" style="">Now your client automatically knows that Benvolio can do MUC, without needing to ask him explicitly via service discovery.</p>
      <p class="" style="">On the other hand, for a person with the following presence ...</p>
      <p class="caption"></p><div class="indent"><pre>
&lt;presence from='nurse@capulet.lit/chamber'&gt;
  &lt;c xmlns='http://jabber.org/protocol/caps' 
     node='http://psi-im.org/#0.10'
     ver='uCoVCteRe3ty2wU2gHxkMaA7xhs='/&gt;
&lt;/presence&gt;
      </pre></div>
      <p class="" style="">... or the following presence ...</p>
      <p class="caption"></p><div class="indent"><pre>
&lt;presence from='bard@shakespeare.lit/globe'&gt;
  &lt;c xmlns='http://jabber.org/protocol/caps' 
     node='http://www.chatopus.com/#2.2'
     ver='zHyEOgxTrkpSdGcQKH8EFPLsriY='/&gt;
&lt;/presence&gt;
      </pre></div>
      <p class="" style="">... you have no information about what this contact's client is capable of unless you have cached previous entity capabilities information; therefore you need to query for capabilities explicitly again via service discovery.</p>
    </div>
  <h2>2.
       <a name="assumptions" id="assumptions">Assumptions</a></h2>
    <p class="" style="">This document makes several assumptions:</p>
    <ul class="" style="">
      <li class="" style="">The type of client I am using is of interest to the people in my roster.</li>
      <li class="" style="">Clients for the people on my roster might want to make user interface decisions based on my capabilities.</li>
      <li class="" style="">Different clients may support the same capabilities.</li>
      <li class="" style="">Members of a community tend to cluster around a small set of clients with a small set of capabilities. More specifically, multiple people in my roster use the same client, and they upgrade versions relatively slowly (commonly a few times a year, perhaps once a week at most, certainly not once a minute).</li>
      <li class="" style="">Some clients are running against servers without server-to-server connectivity enabled, and without access to the Internet via HTTP.</li>
      <li class="" style="">Conversations are possible between users who are not on each other's rosters.</li>
      <li class="" style="">Client capabilities may change over the course of a presence session, due to features being enabled and disabled.</li>
    </ul>
  <h2>3.
       <a name="reqs" id="reqs">Requirements</a></h2>
    <p class="" style="">The protocol defined herein addresses the following requirements:</p>
    <ol start="" class="" style="">
      <li class="" style="">Clients must be able to participate even if they support only <span class="ref" style=""><a href="http://tools.ietf.org/html/rfc3920">XMPP Core</a></span>  [<a href="#nt-id2260844">10</a>], <span class="ref" style=""><a href="http://tools.ietf.org/html/rfc3921">XMPP IM</a></span>  [<a href="#nt-id2260869">11</a>], and <span class="ref">XEP-0030</span>.</li>
      <li class="" style="">Clients must be able to participate even if they are on networks without connectivity to other XMPP servers, services offering specialized XMPP extensions, or HTTP servers. [<a href="#nt-id2260880">12</a>]</li>
      <li class="" style="">Clients must be able to retrieve information without querying each user.</li>
      <li class="" style="">Since presence is normally broadcasted to many users, the byte size of the proposed extension must be as small as possible.</li>
      <li class="" style="">It must be possible to write a XEP-0045 server implementation that passes the given information along.</li>
      <li class="" style="">It must be possible to publish a change in capabilities within a single presence session.</li>
      <li class="" style="">Server infrastructure above and beyond that defined in <span class="ref">XMPP Core</span> and <span class="ref">XMPP IM</span> must not be required for this approach to work, although additional server infrastructure may be used for optimization purposes.</li>
    </ol>
  <h2>4.
       <a name="protocol" id="protocol">Protocol</a></h2>
    <p class="" style="">Entity capabilities are encapsulated in a &lt;c/&gt; element qualified by the 'http://jabber.org/protocol/caps' namespace. The attributes of the &lt;c/&gt; element are as follows.</p>
    <p class="caption">Table 1: Attributes</p><table border="1" cellpadding="3" cellspacing="0">
      <tr class="body">
        <th colspan="" rowspan="">Name</th>
        <th colspan="" rowspan="">Definition</th>
        <th colspan="" rowspan="">Inclusion</th>
      </tr>
      <tr class="body">
        <td colspan="" rowspan="">ext</td>
        <td colspan="" rowspan="">A set of nametokens specifying additional feature bundles; this attribute is deprecated.</td>
        <td colspan="" rowspan="">OPTIONAL</td>
      </tr>
      <tr class="body">
        <td colspan="" rowspan="">hash</td>
        <td colspan="" rowspan="">The hashing algorithm used in generated the 'ver' attribute (see <span class="ref" style=""><a href="http://www.iana.org/assignments/hash-function-text-names">IANA Hash Function Textual Names Registry </a></span>  [<a href="#nt-id2261078">14</a>]); the value defaults to "sha-1".</td>
        <td colspan="" rowspan="">OPTIONAL</td>
      </tr>
      <tr class="body">
        <td colspan="" rowspan="">node</td>
        <td colspan="" rowspan="">A unique identifier for the software underlying the entity, typically a URL at the website of the project or company that produces the software. although this information is an "FYI" in the current version of entity capabilities, it is required for backward-compatibility with older versions. It is RECOMMENDED for the value to identify both the software product and the released version in the form "ProductURL#Version", such as "http://psi-im.org/#0.11".</td>
        <td colspan="" rowspan="">REQUIRED</td>
      </tr>
      <tr class="body">
        <td colspan="" rowspan="">ver</td>
        <td colspan="" rowspan="">A string that specifies the identity and supported features of the entity.  [<a href="#nt-id2261136">15</a>]</td>
        <td colspan="" rowspan="">REQUIRED</td>
      </tr>
    </table>
  <h2>5.
       <a name="ver" id="ver">Generation of ver Attribute</a></h2>
    <p class="" style="">In order to help prevent poisoning of entity capabilities information, the value of the 'ver' attribute MUST be generated according to the following method.</p>
    <p class="" style="">Note: All sorting operations MUST be performed using "i;octet" collation as specified in Section 9.3 of <span class="ref" style=""><a href="http://tools.ietf.org/html/rfc4790">RFC 4790</a></span>  [<a href="#nt-id2261192">16</a>].</p>
    <ol start="" class="" style="">
      <li class="" style="">Initialize an empty string S.</li>
      <li class="" style="">Sort the service discovery identities by category and then by type (if it exists), formatted as 'category' '/' 'type'.</li>
      <li class="" style="">For each identity, append the 'category/type' to S, followed by the '&lt;' character.</li>
      <li class="" style="">Sort the supported features.</li>
      <li class="" style="">For each feature, append the feature to S, followed by the '&lt;' character.</li>
      <li class="" style="">Compute ver by hashing S using the SHA-1 algorithm as specified in <span class="ref" style=""><a href="http://tools.ietf.org/html/rfc3174">RFC 3174</a></span>  [<a href="#nt-id2261291">17</a>] (with binary output) and encoding the hash using Base64 as specified in Section 4 of <span class="ref" style=""><a href="http://tools.ietf.org/html/rfc4648">RFC 4648</a></span>  [<a href="#nt-id2261317">18</a>] (note: the Base64 output MUST NOT include whitespace and MUST set padding bits to zero).  [<a href="#nt-id2261277">19</a>]</li>
    </ol>
    <p class="" style="">For example, consider an entity whose service discovery category is "client", whose service discovery type is "pc", and whose supported features are "http://jabber.org/protocol/disco#info", "http://jabber.org/protocol/disco#items", and "http://jabber.org/protocol/muc". The value of the 'ver' attribute would be generated as follows:</p>
    <ol start="" class="" style="">
      <li class="" style="">S = ''</li>
      <li class="" style="">Only one identity: "client/pc"</li>
      <li class="" style="">S = 'client/pc&lt;'</li>
      <li class="" style="">Sort the features: "http://jabber.org/protocol/disco#info", "http://jabber.org/protocol/disco#items", "http://jabber.org/protocol/muc".</li>
      <li class="" style="">S = 'client/pc&lt;http://jabber.org/protocol/disco#info&lt;http://jabber.org/protocol/disco#items&lt;http://jabber.org/protocol/muc&lt;'</li>
      <li class="" style="">ver = 8RovUdtOmiAjzj+xI7SK5BCw3A8=</li>
    </ol>
  <h2>6.
       <a name="usecases" id="usecases">Use Cases</a></h2>
    <div class="indent"><h3>6.1 <a name="advertise" id="advertise">Advertising Capabilities</a></h3>
      <p class="" style="">Each time a conformant entity sends presence, it annotates that presence with an entity identifier ('node' attribute) and identity and feature identifier ('ver' attribute). In order that servers can remember the last presence for use in responding to probes, the client SHOULD include entity capabilities with every presence change.</p>
       <p class="" style="">If the supported features change during a client's presence session (e.g., a user installs an updated version of a client plugin), the application MUST recompute the 'ver' attribute and SHOULD send a new presence broadcast.</p>

      <p class="caption"><a name="example-1" id="example-1"></a>Example 1. Annotated presence sent</p><div class="indent"><pre>
&lt;presence&gt;
  &lt;c xmlns='http://jabber.org/protocol/caps'
     node='http://exodus.jabberstudio.org/#0.9.1'
     ver='8RovUdtOmiAjzj+xI7SK5BCw3A8='/&gt;
&lt;/presence&gt;
      </pre></div>
    </div>

    <div class="indent"><h3>6.2 <a name="discover" id="discover">Discovering Capabilities</a></h3>
      <p class="" style="">An application can learn what features another entity supports by sending a disco#info request (see <span class="ref">XEP-0030</span>) to any entity that sent a particular value of the <span class="strong">ver</span> attribute.</p>

      <p class="caption"><a name="example-2" id="example-2"></a>Example 2. Disco#info request</p><div class="indent"><pre>
&lt;iq from='juliet@capulet.lit/balcony' 
    id='disco1'
    to='romeo@montague.lit/orchard' 
    type='get'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#info'/&gt;
&lt;/iq&gt;
      </pre></div>

      <p class="" style="">The entity then returns all of the capabilities it supports.</p>

      <p class="caption"><a name="example-3" id="example-3"></a>Example 3. Disco#info response</p><div class="indent"><pre>
&lt;iq from='romeo@montague.lit/orchard' 
    id='disco1'
    to='juliet@capulet.lit/balcony' 
    type='result'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#info'/&gt;
    &lt;identity category='client' type='pc'/&gt;
    &lt;feature var='http://jabber.org/protocol/disco#info'/&gt;
    &lt;feature var='http://jabber.org/protocol/disco#items'/&gt;
    &lt;feature var='http://jabber.org/protocol/muc'/&gt;
  &lt;/query&gt;
&lt;/iq&gt;
      </pre></div>

      <p class="" style="">The client MUST check the identities and supported features against the 'ver' value by calculating the hash as described under <a href="#ver">Generating the ver Attribute</a> and making sure that the values match. If the values do not match, the client MUST NOT accept or cache the 'ver' value as reliable and SHOULD check the value of another user who advertises that value (if any). This helps to prevent poisoning of entity capabilities information.</p>

    </div>

    <div class="indent"><h3>6.3 <a name="stream" id="stream">Stream Feature</a></h3>
      <p class="" style="">A server MAY include its own entity capabilities in a stream feature element so that connecting clients and peer servers do not need to send service discovery requests each time they connect:</p>
      <p class="caption"><a name="example-4" id="example-4"></a>Example 4. Stream feature element including capabilities</p><div class="indent"><pre>
&lt;stream:features&gt;
  &lt;c xmlns='http://jabber.org/protocol/caps'
     node='http://jabberd.org/entity'
     ver='ItBTI0XLDFvVxZ72NQElAzKS9sU='&gt;
&lt;/stream:features&gt;
      </pre></div>
    </div>
  <h2>7.
       <a name="optimizations" id="optimizations">Server Optimizations</a></h2>
    <p class="" style="">A server that is managing an entity's presence session MAY choose to optimize traffic through the server. In this case, the server MAY strip off redundant capabilities annotations. Because of this, receivers of annotations MUST NOT expect an annotation on every presence packet they receive. If the server wants to perform this traffic optimization, it MUST ensure that the first presence each subscriber receives contains the annotation. The server MUST also ensure that any changes in the annotation (e.g., an updated 'ver' attribute)(e.g., an updated 'ver' attribute)  are sent to all subscribers.</p>

      <p class="" style="">A client MAY query the server using <span class="strong">disco#info</span> to determine if the server supports the <span class="strong">'http://jabber.org/protocol/caps'</span> feature. If so, the server MUST perform the optimization delineated above, and the client MAY choose to send the capabilities annotation only on the first presence packet, as well as whenever its capabilities change.</p>

      <p class="caption"><a name="example-5" id="example-5"></a>Example 5. Disco#info request for server optimization</p><div class="indent"><pre>
&lt;iq from='juliet@capulet.lit/balcony'
    to='capulet.lit'
    type='get'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#info'/&gt;
&lt;/iq&gt;

&lt;iq from='capulet.lit'
    to='juliet@capulet.lit/balcony'
    type='result'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#info'&gt;
    ...
    &lt;feature var='http://jabber.org/protocol/caps'/&gt;
    ...
  &lt;/query&gt;
&lt;/iq&gt;
    </pre></div>
  <h2>8.
       <a name="directed" id="directed">Directed Presence</a></h2>
    <p class="" style="">If two entities exchange messages but they do not normally exchange presence (i.e., via presence subscription), the entities MAY choose to send directed presence to each other, where the presence information SHOULD be annotated with the same capabilities information as each entity sends in broadcasted presence. If capabilities information has not been received from another entity, an application MUST assume that the other entity does not support capabilities.</p>
  <h2>9.
       <a name="caching" id="caching">Caching</a></h2>
    <p class="" style="">An application that accepts entity capabilities information SHOULD cache associations between the 'ver' attribute and discovered features within the scope of one presence session and MAY cache such associations across sessions. This obviates the need for extensive service discovery requests within a session or at the beginning of a session.</p>
  <h2>10.
       <a name="security" id="security">Security Considerations</a></h2>
    <p class="" style="">Use of the protocol specified in this document might make some client-specific forms of attack slightly easier, since the attacker could more easily determine the type of client being used. However, since most clients respond to Service Discoery and Software Version requests without performing access control checks, there is no new vulnerability. Entities that wish to restrict access to capabilities information SHOULD use <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0016.html">Server-Based Privacy Rules</a></span>  [<a href="#nt-id2261699">20</a>] to define appropriate communications blocking (e.g., an entity MAY choose to allow IQ requests only from "trusted" entities, such as those with whom it has a subscription of "both").</p>
    <p class="" style="">Adherence to the algorithm defined in the <a href="#ver">Generation of ver Attribute</a> section of this document for both generation and checking of the 'ver' attribute helps to guard against poisoning of entity capabilities information by malicious or improperly implemented entities.</p>
  <h2>11.
       <a name="iana" id="iana">IANA Considerations</a></h2>
    <p class="" style="">This document requires no interaction with the <span class="ref" style=""><a href="http://www.iana.org/">Internet Assigned Numbers Authority (IANA)</a></span>  [<a href="#nt-id2261763">21</a>]. </p>
  <h2>12.
       <a name="registrar" id="registrar">XMPP Registrar Considerations</a></h2>
    <div class="indent"><h3>12.1 <a name="ns" id="ns">Protocol Namespaces</a></h3>
    <p class="" style="">The <span class="ref" style=""><a href="http://www.xmpp.org/registrar/">XMPP Registrar</a></span>  [<a href="#nt-id2261857">22</a>] includes 'http://jabber.org/protocol/caps' in its registry of protocol namespaces  (see &lt;<a href="http://www.xmpp.org/registrar/namespaces.html">http://www.xmpp.org/registrar/namespaces.html</a>&gt;).</p>
    </div>
  <h2>13.
       <a name="schema" id="schema">XML Schema</a></h2>
    <p class="caption"></p><div class="indent"><pre>
&lt;?xml version='1.0' encoding='UTF-8'?&gt;

&lt;xs:schema
    xmlns:xs='http://www.w3.org/2001/XMLSchema'
    targetNamespace='http://jabber.org/protocol/caps'
    xmlns='http://jabber.org/protocol/caps'
    elementFormDefault='qualified'&gt;

  &lt;xs:annotation&gt;
    &lt;xs:documentation&gt;
      The protocol documented by this schema is defined in
      XEP-0115: http://www.xmpp.org/extensions/xep-0115.html
    &lt;/xs:documentation&gt;
  &lt;/xs:annotation&gt;

  &lt;xs:element name='c'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:simpleContent&gt;
        &lt;xs:extension base='empty'&gt;
          &lt;xs:attribute name='ext' type='xs:NMTOKENS' use='optional'/&gt;
          &lt;xs:attribute name='hash' type='xs:NMTOKEN' use='optional' default='sha-1'/&gt;
          &lt;xs:attribute name='node' type='xs:string' use='required'/&gt;
          &lt;xs:attribute name='ver' type='xs:string' use='required'/&gt;
        &lt;/xs:extension&gt;
      &lt;/xs:simpleContent&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:simpleType name='empty'&gt;
    &lt;xs:restriction base='xs:string'&gt;
      &lt;xs:enumeration value=''/&gt;
    &lt;/xs:restriction&gt;
  &lt;/xs:simpleType&gt;

&lt;/xs:schema&gt;
    </pre></div>
  <h2>14.
       <a name="legacy" id="legacy">Legacy Format</a></h2>
    <p class="" style="">Before Version 1.4 of this specification, the 'ver' attribute was generated differently and the 'ext' attribute was used more extensively. For historical purposes, Version 1.3 of this specification is archived at &lt;<a href="http://www.xmpp.org/extensions/attic/xep-0115-1.3.html">http://www.xmpp.org/extensions/attic/xep-0115-1.3.html</a>&gt;. For backward-compatibility with the legacy format, the 'node' attribute is REQUIRED and the 'ext' attribute MAY be included.</p>
  <h2>15.
       <a name="ack" id="ack">Acknowledgements</a></h2>
    <p class="" style="">Thanks to Rachel Blackman, Dave Cridland, Richard Dobson, Sergei Golovan, Justin Karneges, Jacek Konieczny, Ian Paterson, Kevin Smith, Tomasz Sterna, and Michal Vaner for comments and suggestions.</p>
  <hr /><h2><a name="notes" id="notes"></a>Notes</h2><div class="indent"><p><a name="nt-id2251076" id="nt-id2251076">1</a>. XEP-0071: XHTML-IM &lt;<a href="http://www.xmpp.org/extensions/xep-0071.html">http://www.xmpp.org/extensions/xep-0071.html</a>&gt;.</p><p><a name="nt-id2251108" id="nt-id2251108">2</a>. XEP-0166: Jingle &lt;<a href="http://www.xmpp.org/extensions/xep-0166.html">http://www.xmpp.org/extensions/xep-0166.html</a>&gt;.</p><p><a name="nt-id2251133" id="nt-id2251133">3</a>. XEP-0167: Jingle Audio via RTP &lt;<a href="http://www.xmpp.org/extensions/xep-0167.html">http://www.xmpp.org/extensions/xep-0167.html</a>&gt;.</p><p><a name="nt-id2251160" id="nt-id2251160">4</a>. XEP-0096: File Transfer &lt;<a href="http://www.xmpp.org/extensions/xep-0096.html">http://www.xmpp.org/extensions/xep-0096.html</a>&gt;.</p><p><a name="nt-id2251193" id="nt-id2251193">5</a>. XEP-0060: Publish-Subscribe &lt;<a href="http://www.xmpp.org/extensions/xep-0060.html">http://www.xmpp.org/extensions/xep-0060.html</a>&gt;.</p><p><a name="nt-id2251226" id="nt-id2251226">6</a>. XEP-0030: Service Discovery &lt;<a href="http://www.xmpp.org/extensions/xep-0030.html">http://www.xmpp.org/extensions/xep-0030.html</a>&gt;.</p><p><a name="nt-id2251252" id="nt-id2251252">7</a>. XEP-0092: Software Version &lt;<a href="http://www.xmpp.org/extensions/xep-0092.html">http://www.xmpp.org/extensions/xep-0092.html</a>&gt;.</p><p><a name="nt-id2251176" id="nt-id2251176">8</a>. This proposal is not limited to clients, and can be used by any entity that exchanges presence with another entity, e.g., a gateway. However, this document uses the example of clients throughout.</p><p><a name="nt-id2251408" id="nt-id2251408">9</a>. XEP-0045: Multi-User Chat &lt;<a href="http://www.xmpp.org/extensions/xep-0045.html">http://www.xmpp.org/extensions/xep-0045.html</a>&gt;.</p><p><a name="nt-id2260844" id="nt-id2260844">10</a>. RFC 3920: Extensible Messaging and Presence Protocol (XMPP): Core &lt;<a href="http://tools.ietf.org/html/rfc3920">http://tools.ietf.org/html/rfc3920</a>&gt;.</p><p><a name="nt-id2260869" id="nt-id2260869">11</a>. RFC 3921: Extensible Messaging and Presence Protocol (XMPP): Instant Messaging and Presence &lt;<a href="http://tools.ietf.org/html/rfc3921">http://tools.ietf.org/html/rfc3921</a>&gt;.</p><p><a name="nt-id2260880" id="nt-id2260880">12</a>. These first two requirements effectively eliminated <span class="ref" style=""><a href="http://www.xmpp.org/extensions/xep-0060.html">Publish-Subscribe</a></span>  [<a href="#nt-id2260894">13</a>] as a possible implementation of entity capabilities.</p><p><a name="nt-id2260894" id="nt-id2260894">13</a>. XEP-0060: Publish-Subscribe &lt;<a href="http://www.xmpp.org/extensions/xep-0060.html">http://www.xmpp.org/extensions/xep-0060.html</a>&gt;.</p><p><a name="nt-id2261078" id="nt-id2261078">14</a>. IANA registry of Hash Function Textual Names &lt;<a href="http://www.iana.org/assignments/hash-function-text-names">http://www.iana.org/assignments/hash-function-text-names</a>&gt;.</p><p><a name="nt-id2261136" id="nt-id2261136">15</a>. Before version 1.4 of this specification, the 'ver' attribute was used to specify the released version of the software; however, the values of the 'ver' attribute that result from use of the algorithm specified since version 1.4 are backward-compatible with the legacy approach.</p><p><a name="nt-id2261192" id="nt-id2261192">16</a>. RFC 4790: Internet Application Protocol Collation Registry &lt;<a href="http://tools.ietf.org/html/rfc4790">http://tools.ietf.org/html/rfc4790</a>&gt;.</p><p><a name="nt-id2261291" id="nt-id2261291">17</a>. RFC 3174: US Secure Hash Algorithm 1 (SHA1) &lt;<a href="http://tools.ietf.org/html/rfc3174">http://tools.ietf.org/html/rfc3174</a>&gt;.</p><p><a name="nt-id2261317" id="nt-id2261317">18</a>. RFC 4648: The Base16, Base32, and Base64 Data Encodings &lt;<a href="http://tools.ietf.org/html/rfc4648">http://tools.ietf.org/html/rfc4648</a>&gt;.</p><p><a name="nt-id2261277" id="nt-id2261277">19</a>. The OpenSSL command for producing such output is "echo -n 'S' | openssl dgst -binary -sha1 | openssl enc -nopad -base64".</p><p><a name="nt-id2261699" id="nt-id2261699">20</a>. XEP-0016: Server-Based Privacy Rules &lt;<a href="http://www.xmpp.org/extensions/xep-0016.html">http://www.xmpp.org/extensions/xep-0016.html</a>&gt;.</p><p><a name="nt-id2261763" id="nt-id2261763">21</a>. The Internet Assigned Numbers Authority (IANA) is the central coordinator for the assignment of unique parameter values for Internet protocols, such as port numbers and URI schemes. For further information, see &lt;<a href="http://www.iana.org/">http://www.iana.org/</a>&gt;.</p><p><a name="nt-id2261857" id="nt-id2261857">22</a>. The XMPP Registrar maintains a list of reserved protocol namespaces as well as registries of parameters used in the context of XMPP extension protocols approved by the XMPP Standards Foundation. For further information, see &lt;<a href="http://www.xmpp.org/registrar/">http://www.xmpp.org/registrar/</a>&gt;.</p></div><hr /><h2><a name="revs" id="revs"></a>Revision History</h2><div class="indent"><h4>Version 1.4 (2007-08-13)</h4><div class="indent"><p class="" style="">In response to persistent security concerns over caps poisoning, redefined ver attribute to be a hash of the service discovery identity and features in a way that is backward-compatible with the legacy format.</p> (psa/jjh)
    </div><h4>Version 1.3 (2007-04-10)</h4><div class="indent"><p class="" style="">Added developer-friendly introduction; specified that ext names must be stable across application versions; further clarified examples; added stream feature use case; removed message example (send directed presence instead).</p> (psa/rt/jjh)
    </div><h4>Version 1.2 (2007-02-15)</h4><div class="indent"><p class="" style="">Clarified motivation and handling of service discovery requests.</p> (psa)
    </div><h4>Version 1.1 (2004-10-29)</h4><div class="indent"><p class="" style="">Clarified meaning of service discovery results for client#ver and client#ext.</p> (psa)
    </div><h4>Version 1.0 (2004-08-01)</h4><div class="indent"><p class="" style="">Per a vote of the Jabber Council, advanced status to Draft.</p> (psa)
    </div><h4>Version 0.7 (2004-06-29)</h4><div class="indent"><p class="" style="">Added several items to the Security Considerations; clarified naming requirements regarding 'node', 'ver', and 'ext' attributes.</p> (jjh/psa)
    </div><h4>Version 0.6 (2004-04-25)</h4><div class="indent"><p class="" style="">Made a number of editorial adjustments.</p> (psa)
    </div><h4>Version 0.5 (2004-01-05)</h4><div class="indent"><p class="" style="">Specified that the protocol can be used whenever presence is used (e.g., by gateways); improved the XML schema; made several editorial adjustments.</p> (psa)
    </div><h4>Version 0.4 (2003-09-04)</h4><div class="indent"><p class="" style="">IQ eets must be to a resource, since they are intended to go to a particular session.</p> (jjh)
    </div><h4>Version 0.3 (2003-09-02)</h4><div class="indent"><p class="" style="">Servers MUST strip extras changed to MAY, due to implementer feedback.</p> (jjh)
    </div><h4>Version 0.2 (2003-08-28)</h4><div class="indent"><p class="" style="">Add more clarifying assumptions and requirements, make
        it clear that clients don't have to send capabilities every
        time if the server is optimizing.</p> (jjh)
    </div><h4>Version 0.1 (2003-08-27)</h4><div class="indent"><p class="" style="">Initial version.</p> (jjh)
    </div></div><hr /><p>END</p></body></html>
