<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>JEP-0151: Virtual Presence</title>
<link rel="stylesheet" type="text/css" href="jep.css">
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
<meta name="DC.Title" content="Virtual Presence">
<meta name="DC.Creator" content="Klaus H. Wolf">
<meta name="DC.Description" content="This JEP proposes extensions to the Jabber groupchat protocol for virtual presence on Web pages.">
<meta name="DC.Publisher" content="Jabber Software Foundation">
<meta name="DC.Contributor" content="JEP Editor">
<meta name="DC.Date" content="2005-06-02">
<meta name="DC.Type" content="Jabber Enhancement Proposal">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="JEP-0151">
<meta name="DC.Language" content="en">
<meta name="DC.Rights" content="This Jabber Enhancement Proposal is copyright 1999 - 2006 by the Jabber Software Foundation (JSF) and is in full conformance with the JSF's Intellectual Property Rights Policy &lt;http://www.jabber.org/jsf/ipr-policy.shtml&gt;. This material may be distributed only subject to the terms and conditions set forth in the Creative Commons Attribution License (&lt;http://creativecommons.org/licenses/by/2.5/&gt;).">
</head>
<body>
<h1>JEP-0151: Virtual Presence</h1>
<p>This JEP proposes extensions to the Jabber groupchat protocol for virtual presence on Web pages.</p>
<p><hr></p>
<p style="color:red">WARNING: Consideration of this JEP has been Deferred by the Jabber Software Foundation. Implementation of the protocol described herein is not recommended.</p>
<p><hr></p>
<h2>JEP Information</h2>
<p class="indent">
            Status: Deferred<br>
            Type: Standards Track<br>
            Number: 0151<br>
            Version: 0.1<br>
            Last Updated: 2005-06-02<br>
            JIG: Standards JIG<br>
                Approving Body: Jabber Council<br>Dependencies: XMPP Core, JEP-0045<br>
                Supersedes: None<br>
                Superseded By: None<br>
            Short Name: Not yet assigned<br>
              Wiki Page: &lt;<a href="http://wiki.jabber.org/index.php/Virtual%20Presence%20(JEP-0151)">http://wiki.jabber.org/index.php/Virtual Presence (JEP-0151)</a>&gt;
            </p>
<h2>Author Information</h2>
<div class="indent">
<h3>Klaus H. Wolf</h3>
<p class="indent">
        Email:
        <a href="mailto:wolf@bluehands.de">wolf@bluehands.de</a><br>
        JID: 
        <a href="xmpp:wolfspelz@jabber.bluehands.de">wolfspelz@jabber.bluehands.de</a></p>
</div>
<h2>Legal Notice</h2>
<p class="indent">This Jabber Enhancement Proposal is copyright 1999 - 2006 by the <a href="http://www.jabber.org/jsf/">Jabber Software Foundation</a> (JSF) and is in full conformance with the JSF's Intellectual Property Rights Policy &lt;<a href="http://www.jabber.org/jsf/ipr-policy.shtml">http://www.jabber.org/jsf/ipr-policy.shtml</a>&gt;. This material may be distributed only subject to the terms and conditions set forth in the Creative Commons Attribution License (&lt;<a href="http://creativecommons.org/licenses/by/2.5/">http://creativecommons.org/licenses/by/2.5/</a>&gt;).</p>
<h2>Discussion Venue</h2>
<p class="indent">The preferred venue for discussion of this document is the Standards-JIG discussion list: &lt;<a href="http://mail.jabber.org/mailman/listinfo/standards-jig">http://mail.jabber.org/mailman/listinfo/standards-jig</a>&gt;.</p>
<h2>Relation to XMPP</h2>
<p class="indent">The Extensible Messaging and Presence Protocol (XMPP) is defined in the XMPP Core (RFC 3920) and XMPP IM (RFC 3921) specifications contributed by the Jabber Software Foundation to the Internet Standards Process, which is managed by the Internet Engineering Task Force in accordance with RFC 2026. Any protocol defined in this JEP has been developed outside the Internet Standards Process and is to be understood as an extension to XMPP rather than as an evolution, development, or modification of XMPP itself.</p>
<h2>Conformance Terms</h2>
<p class="indent">The keywords "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "NOT RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in RFC 2119.</p>
<p><hr></p>
<h2>Table of Contents</h2>
<div class="indent"><dl>
<dt>1.  <a href="#sect-id2250743">Introduction</a>
</dt>
<dt>2.  <a href="#sect-id2250761">Requirements</a>
</dt>
<dl>
<dt>2.1.  <a href="#sect-id2250944">Interaction on Virtual Locations</a>
</dt>
<dt>2.2.  <a href="#sect-id2250816">Discovering Virtual Locations</a>
</dt>
</dl>
<dt>3.  <a href="#sect-id2257226">Example of a Virtual Meeting</a>
</dt>
<dl>
<dt>3.1.  <a href="#sect-id2257257">Meeting on Virtual Locations</a>
</dt>
<dt>3.2.  <a href="#sect-id2257413">Getting more information</a>
</dt>
<dt>3.3.  <a href="#sect-id2257534">Avatars</a>
</dt>
<dt>3.4.  <a href="#sect-id2257992">Other Ways to get the Avatar</a>
</dt>
<dt>3.5.  <a href="#sect-id2258109">Avatar Movement</a>
</dt>
<dt>3.6.  <a href="#sect-id2258290">Bubble Chat</a>
</dt>
<dt>3.7.  <a href="#sect-id2258403">Video Icon</a>
</dt>
</dl>
<dt>4.  <a href="#sect-id2258509">Finding Virtual Locations</a>
</dt>
<dl>
<dt>4.1.  <a href="#sect-id2258543">Mapping Rules</a>
</dt>
<dt>4.2.  <a href="#sect-id2258947">Web Server based Configuration</a>
</dt>
<dt>4.3.  <a href="#sect-id2259180">The Mapping Process</a>
</dt>
<dl>
<dt>4.3.1.  <a href="#sect-id2259230">Retrieve the Configuration File</a>
</dt>
<dt>4.3.2.  <a href="#sect-id2259408">Find a Mapping Rule</a>
</dt>
<dt>4.3.3.  <a href="#sect-id2259474">Apply the Rule</a>
</dt>
</dl>
</dl>
<dt>5.  <a href="#sect-id2259555">Error Codes</a>
</dt>
<dt>6.  <a href="#sect-id2259570">Security Considerations</a>
</dt>
<dt>7.  <a href="#sect-id2259600">Jabber Registrar Considerations</a>
</dt>
<dt>8.  <a href="#sect-id2259663">Formal Definition</a>
</dt>
<dl><dt>8.1.  <a href="#sect-id2259670">Schema</a>
</dt></dl>
<dt>9.  <a href="#sect-id2259688">Conclusion</a>
</dt>
<dt><a href="#notes">Notes</a></dt>
<dt><a href="#revs">Revision History</a></dt>
</dl></div>
<p><hr></p>
<h2>1.
       <a name="sect-id2250743">Introduction</a>
</h2>
  <p class="" style="">Virtual presence on Web pages (also sometimes known as co-browsing, while co-browsing can also mean something different) makes people aware of each other, who are at the same Web location at the same time. The basic purpose of a virtual presence system is to show names, icons, and/or avatars of people who are on a page or a set of pages and to let them communicate. This document proposes extensions to the Jabber protocol, which enable neat virtual presence on Web pages. The extensions are implemented as namespaces for the protocol elements &lt;iq/&gt;, &lt;presence/&gt;, &lt;message/&gt;, and for server storage. </p>
  
  <p class="" style="">This document also covers the mapping of URLs to Jabber chat rooms. It describes step by step how clients derive virtual locations from URLs of web pages. The process includes queries to the web server, queries to default configuration sources, delegation between configuration sets, ways for administrators of websites to opt out, and methods to shape the virtual space actively by clustering together or splitting off URL groups.</p>  
  
  <p class="" style="">This document describes an implementation that proved to be useful over one year. We propose the extensions, but we are open to comments and other proposals, if readers think that different approaches would better fit into the Jabber architecture. This also applies to namespaces, especially since the extensions where designed while the Jabber community was moving to URL-style namespaces. So did this implementation.</p>
<h2>2.
       <a name="sect-id2250761">Requirements</a>
</h2>

  <div class="indent">
<h3>2.1 <a name="sect-id2250944">Interaction on Virtual Locations</a>
</h3>

  <p class="" style="">Meeting on virtual locations is very similar to meeting peers in a public chat room. But web pages can be regarded as 2 dimensional. They very often cover the entire screen. They use graphics elements for their content. Plainly speaking: representing users as figures or other images fits well to web pages. Once they are shown as individual figures, a line based chat and a chat window are not required any more (though a chat window can still be used). The figures can move around and talk in chat bubble style. Chat bubbles in turn enable incremental chat.</p>

  <p class="" style="">This document describes protocol elements for 
    <ul>
      <li>the visualization of users on web pages (animated avatars) and</li>
      <li>communication beyond line based group chat (incremental or instant bubble chat)</li>
    </ul>
  </p>

  <p class="" style="">While users are browsing the web, they enter and leave many rooms. They meet many people and some of them multiple times. Minimum overall traffic and minimum traffic on the user connection are primary design goals. The user connection is limited by typical karma settings of jabber servers. Logging in to virtual locations (rooms) must be quick in terms of round trips and cheap in terms of traffic. Once logged in to a room, the traffic on the user connection should be independent of the number of peers already present. </p>

  <p class="" style="">The extensions have been designed to be:
    <ul>
      <li>compatible to the existing Jabber infrastructure and protocols,</li>
      <li>lightweight with respect to the number of new elements,</li>
      <li>lightweight with respect to the traffic generated.</li>
    </ul>
  </p>

  <p class="" style="">The traffic goals can be met by using only the initial &lt;presence/&gt; stanza, which carries all required information, so that no peer-to-peer messages are required on entering. VP clients which gather additional information about peers (e.g. avatar images) should cache the data so that it can be re-used. This is especially important since users browsing virtually connected locations (i.e. linked pages) may meet very often in a short time.</p>

  <p class="" style="">The virtual presence extensions make use of Jabber group chat. Virtual locations are implemented as public Jabber chat channels. The proposed protocol works with <span class="ref" style="">Multi-User Chat</span>  [<a href="#nt-id2250805">1</a>] rooms and GroupChat 1.0 compatible services. It core functionality described here uses only groupchat features.</p> 

  <p class="" style="">The virtual presence extensions are supposed to be implemented by Jabber IM clients in addition to the IM functions or by pure virtual presence (Jabber VP) clients.</p>

  </div>

  <div class="indent">
<h3>2.2 <a name="sect-id2250816">Discovering Virtual Locations</a>
</h3>

  <p class="" style="">The virtual presence network is a distributed network of Jabber conference components. Each component is hosting a part of the Web. Conference components may be specifically set up for virtual locations, or they may run chat rooms for virtual locations in addition to other rooms. A website may choose to run a conference component to host the presence on its web pages or it may use a publicly available service. Websites, which do not care, are covered by default servers, while others may opt out entirely in order to avoid virtual presence on their pages. </p>

  <p class="" style="">Usually VP clients gather URLs from active web browsers. They convert these URLs to Jabber chat rooms IDs (JIDs) using web server specific and general rules for the mapping process. Then they enter the room as described in the section 'Example of a Virtual Meeting'. There are many different types of URLs. Many are based on file system paths, others are query style, or a mix of path and query. Sometimes users regard individual pages as locations, sometimes a 'location' consists of multiple pages. Large websites may even consist of multiple DNS names, so that users expect to be at the same location regardless of the actual server name.</p>

  <p class="" style="">Usually website operators will not care about virtual presence on their pages. But once there is a significant amount of chat on their pages, they want to control what happens there. In other words: they need to be able to enforce domestic authority on their pages and even expel visitors from 'their' chat. They will install moderators (persons or software). Moderators authorized by the website might operate on public chat servers, but control is only guaranteed, if a website controls the assignment of moderators by running the chat server. Hence, website operators must be able to control the mapping process so that they can assign chat server addresses (and chat room names) to URLs. Many websites are hierarchical, with sub-folders being managed by different independent owners. The mapping process should allow for detailed mapping rules for sub-folders and general rules closer to the root of websites, so that the 'inner' config prevails. </p>

  <p class="" style="">The mapping process is controlled by configuration files. The files will be downloaded from websites and/or from a default location. Most websites do not know about virtual presence and if they know, then they do not care. Therefore, the mapping process should be designed to allow for virtual presence without cooperation of the website. A default configuration with a simple standard mapping will be used if a website does not provide mapping rules. </p>

  <p class="" style="">Configuration files for the mapping process will often be downloaded over the network. Since the data for multiple virtual locations might add up to large files, the configuration can be split up into individual documents. The splitting is managed by delegation to other config files for subsets of URLs. This is especially important for the default configuration, which may cover special rules for prominent websites.</p>

  <p class="" style="">Global fallback servers are not able to carry all the enter/leave and chat traffic. The virtual presence of many users on many websites demands commercial services for virtual presence hosting. Much like web hosters provide disk space, traffic and processing power, there are commercial (or free) presence hosting services, which provide traffic and processing power. Website operators will either run their own presence servers or rely on commercial services. Commercial operators are limiting the ad-hoc creation of chat rooms for virtual presence or they allow static rooms only. Website operators encode the 'rented' room JID into their mapping configuration. They might even delegate the handling of configuration files entirely to the presence server operator by means of config file delegation.</p>

  <p class="" style="">The mapping process should try to protect the privacy of the user. After all, virtual presence is a violation of privacy in general, because people know where other people are (virtually). This is critical, if compared to the totally un-observed Web without virtual presence. In the real world people are used to being seen in physical locations, but only by others who are physically present in the same location. The mapping process should emulate this restriction. The general idea is to include a one way function (message digest) during the mapping process to prohibit the discovery of 'interesting' chat room names. In other words: observers must do the forward mapping and enter a room to see who is there or discover random room names without being able to re-create the source URL. So, they may be able to find people in random rooms, but do not know the virtual location.</p>

  <p class="" style="">This mapping process is designed to 
    <ul>
      <li>make the virtual presence service a distributed network of jabber servers, i.e. conference components,</li>
      <li>allow for flexible mapping from URLs to JIDs, taking into account that
        <ul>
          <li>most URLs are path based,</li>
          <li>URLs contain queries,</li>
          <li>sometimes only the query part defines the virtual location,</li>
          <li>groups of URLs map to a single JID,</li>
          <li>a single virtual location may comprise multiple web servers,</li>
          <li>groups of URLs may only cover a sub-folder of path based URLs,</li>
          <li>not all URLs are known at config time,</li>
        </ul>
      </li>
      <li>allow operators of websites to control the mapping for the URL-space they control,</li>
      <li>let websites opt out of virtual presence,</li>
      <li>allow for hierarchical configuration for file system path based URLs,</li>
      <li>support delegation,</li>
      <li>allow for virtual presence without the cooperation of the website,</li>
      <li>allow for distribution of the load of the default configuration server,</li>
      <li>support commercial virtual presence servers and rented rooms,</li>
      <li>be extensible to other protocols as virtual presence transport,</li>
      <li>be easily implemented by website operators,</li>
      <li>at least limit the privacy issues associated with virtual presence.</li>
    </ul>
  </p>

  </div>

<h2>3.
       <a name="sect-id2257226">Example of a Virtual Meeting</a>
</h2>

  <p class="" style="">Since it has been suggested that the use of Shakespeare characters might please the reader we will try to employ them without really knowing the works of Shakespeare. Two characters called Romeo and Juliet will appear. Both will be equipped with a Web browser and a virtual presence Jabber client which implements the protocol extensions described in this document (called VP client in the following). The communication is shown as seen by the conference component including 'from' attributes.</p> 

  <div class="indent">
<h3>3.1 <a name="sect-id2257257">Meeting on Virtual Locations</a>
</h3>
    <p class="" style="">This shows how the first meeting of Romeo and Juliet would have happened if they had known Cyberspace, i.e. the Web. Romeo browses the Web with his favorite web client. He reads the page http://www.shakespeare.com/market/ModernLibrary/page1.html. He is also running a VP client. There is no mention of a buddy list jabber client at this point. The VP client is properly logged in to the Jabber server using the JID romeo@montague.net. Through some magic, the VP client acquires the URL of the current web page. The VP client converts the URL into the JID of a public chat room (see section 'Virtual Locations'). The JID will usually be a SHA1 digest of the URL prefixed to a conference component (like f4eb29410ec339144633773dda1dc4a643513933@shakespeare.com). For the sake of readability we will refer to the chat room as room1@shakespeare.com. The VP client then enters the room using 'YoungHero' as the nickname.</p>
    <p class="caption">Example 1. Entering a virtual location</p>
<div class="indent"><pre>
&lt;presence from='romeo@montague.net/garden' to='room1@shakespeare.com/YoungHero' /&gt;
    </pre></div>

    <p class="" style="">The room responds:</p>
    <p class="caption">Example 2. Acknowledgement of the entry</p>
<div class="indent"><pre>
&lt;presence from='room1@shakespeare.com/YoungHero' to='romeo@montague.net/garden' /&gt;
    </pre></div>

  <p class="" style="">Upon reception the VP client visualizes the presence of Romeo at the location to Romeo, e.g. by displaying Romeo's icon and/or nickname on, at, or close to the web page. In other words: the VP client shows an avatar of Romeo on the page.</p> 

  <p class="" style="">Dramatic increases when Juliet browses to the same web page. Her VP client also gathers the URL, performs the same mapping and enters the room. It sends a &lt;presence/&gt; stanza to the room using nickname 'WebGirl'. The room as expected returns the acknowledgement. In addition the room forwards both &lt;presence/&gt; stanzas to the VP clients in order to announce the mutual presence. </p> 

    <p class="" style="">Romeo gets:</p>
    <p class="caption">Example 3. Announcement of peer presence</p>
<div class="indent"><pre>
&lt;presence from='room1@shakespeare.com/WebGirl' to='romeo@montague.net/garden' /&gt;
    </pre></div>

  <p class="" style="">Juliet gets the equivalent. Romeo's VP client shows Juliet's presence by adding a second avatar to the page. They now engage in a vivid conversation. In deviation to the original text Juliet would not ask "Who art thou, Romeo?", because she only knows the nickname and on the other hand she actually knows where Romeo is: he is on the same web page. There is nothing new until now. Everything happened according to GroupChat 1.0 (JEP-0045) without MUC features. Of course, users can join the same room with any client that supports GroupChat, if they know the room's JID.</p> 

  <p class="" style="">Extensions come into the play in order to make the virtual presence more attractive and more vivid.</p>
  </div>

  <div class="indent">
<h3>3.2 <a name="sect-id2257413">Getting more information</a>
</h3>
  
    <p class="" style="">For more information about 'YoungHero' beyond the nickname Juliet needs a JID (see below for anonymous variants of the avatar image). Non-anonymous rooms will supply the JIDs automatically. But we suggest that rooms, which make up the virtual presence network are configured to be anonymous so that users can choose if they want to disclose the JID. We propose an extension to the &lt;presence/&gt; stanza for users to supply their JID automatically to peers in anonymous rooms with minimum traffic even for many participants. </p>
    
    <p class="" style="">Note: even though Romeo sends a JID, the systems is still anonymous. Romeo could send any JID. He may send a (fake) JID that is just the base address of his storage, but not his communication address. In anonymous rooms Juliet will use any JID Romeo provides. If the room is not anonymous, then Romeo's client may use Juliet's actual JID. </p>
    
    <p class="" style="">Entering the room Juliet would add a JID-element to the initial &lt;presence/&gt; stanza.</p>

    <p class="caption">Example 4. Disclosing the JID</p>
<div class="indent"><pre>
&lt;presence from='juliet@capulet.com/balcony' to='room1@shakespeare.com/WebGirl' 
  &lt;x xmlns='firebat:user:jid'&gt;juliet@capulet.com/balcony&lt;/x&gt;
&lt;/presence&gt;
    </pre></div>

    <p class="" style="">(Note: 'firebat' was the developer name of the VP client. Jabber.org URIs could be used here)</p>

    <p class="" style="">This tells the conference component to send the JID to all participants automatically. Romeo will receive the &lt;presence/&gt; stanza including the JID element. Romeo may now fetch Juliet's avatar or add Juliet to a buddy list. </p>

    <p class="" style="">Note: disclosing the JID is usually not advisable in public rooms. We decided to offer the functionality as an option, for 2 reasons:
      <ol start="" type="">
        <li>to provide access to extended information from peers without cluttering the &lt;presence/&gt; stanza more than necessary,</li>
        <li>to allow for caching of extended information.</li>
      </ol>
    Caching requires a persistent and unique id per user. While a message digest of the JID would be sufficient for caching extended information, it is not sufficient for retrieving extended information. 
    </p>

  </div>

  <div class="indent">
<h3>3.3 <a name="sect-id2257534">Avatars</a>
</h3>

    <p class="" style="">Romeo will be much more interested in Juliet if Juliet is depicted by a nice image rather than only a name. Users may choose avatars, publish those avatars, and change them on the fly. Changes to the avatar are tracked by comparing a stored digest of the avatar data to the received digest. The avatar digest will be received as part of the &lt;presence/&gt; stanza. Juliet also includes an avatar-digest element with a hex-coded SHA1-digest of the avatar data (i.e. the digest of the image file): </p>

    <p class="caption">Example 5. Avatar Digest</p>
<div class="indent"><pre>
&lt;presence from='juliet@capulet.com/balcony' to='room1@shakespeare.com/WebGirl' 
  &lt;x xmlns='firebat:user:jid'&gt;juliet@capulet.com/balcony&lt;/x&gt;
  &lt;x xmlns='firebat:avatar:digest'&gt;9b3635eb1440a1ee1c9f67767651194f34ecf130&lt;/x&gt;
&lt;/presence&gt;
    </pre></div>

    <p class="" style="">Romeo receives the digest with the initial &lt;presence/&gt; stanza from Juliet. Since this is their first meeting Romeo does not have Juliet's avatar yet. He will fetch the avatar from Juliet's public XML server storage (for a public XML storage free variant see below):</p>

    <p class="caption">Example 6. Avatar Request</p>
<div class="indent"><pre>
&lt;iq type='get' to='juliet@capulet.com'&gt;
  &lt;query xmlns='storage:client:avatar' /&gt;
&lt;/iq&gt;
    </pre></div>

    <p class="" style="">The server returns Juliet's avatar.  </p>

    <p class="caption">Example 7. Avatar Response with Avatar URL</p>
<div class="indent"><pre>
&lt;iq type='result' to='romeo@montague.net/garden'&gt;
  &lt;query xmlns='storage:client:avatar'&gt;
    &lt;data src='http://www.capulet.com/juliet.png'/&gt;
  &lt;/query&gt;
&lt;/iq&gt;
    </pre></div>

    <p class="" style="">The 'src' attribute points to the real data, which is to be fetched out of band via HTTP. Juliet supplied a reference to the data because she is a smart WebGirl concerned about bandwidth on the Jabber connection. But if the Capulets would not own a domain she could also choose to store the avatar data directly on the server using base-64 encoding. The avatar response would then be like:</p>

    <p class="caption">Example 8. Avatar Response with Immediate Data</p>
<div class="indent"><pre>
&lt;iq type='result' to='romeo@montague.net/garden'&gt;
  &lt;query xmlns='storage:client:avatar'&gt;
    &lt;data mimetype='image/png' encoding='base64'
      &gt;E00fcB79F822u192e7A2067E5229ec136892A296... &lt;/data&gt;
  &lt;/query&gt;
&lt;/iq&gt;
    </pre></div>

  <p class="" style="">Juliet can omit the 'mimetype' attribute if she supplies the avatar URL, because the HTTP server will return the MIME type. The 'mimetype' attribute must be included for immediate data. Avatars may be of any type and size. The maximum visible dimensions of avatars should be 64x96 pixels. Larger images will be scaled down to fit into this rectangle. They will not be scaled up. Images align at the bottom so that they can 'stand' on a page on the same base line. </p>

  <p class="" style="">Implementation note: The client should check the image size (byte count) and advice the user if the size exceeds 20 kb. It should also check the image dimensions and warn the user if the image will be scaled down. Checking the size is especially important for immediate data, which will be uploaded over a Jabber connection which is subject to flow control. Typical karma settings only allow for few kb without stalling the connection.</p>

  <p class="" style="">Implementation note: Avatars and associated digests should be stored permanently. They will always be up to date as soon as people meet and exchange digests. There is no cache timeout. The implementation should keep an eye on the avatar storage and delete old and rarely used ones.</p>

  <p class="" style="">Avatars images can also be created of other data types. The following shows an avatar description in XML format, which is to be processed by an advanced avatar engine. The avatar engine will be chosen by the MIME type. For simple image based avatars, the MIME type selects the type of image decoder. Other MIME types may select from a dynamic list of installable avatar rendering plug-ins.</p>

    <p class="caption">Example 9. Avatar Response for an Advanced Avatar</p>
<div class="indent"><pre>
&lt;iq type='result' to='romeo@montague.net/garden'&gt;
  &lt;query xmlns='storage:client:avatar'&gt;
    &lt;data mimetype='avatar/comic' encoding='plain'&gt;
      &lt;config xmlns='http://schema.bluehands.de/character-config' version='1.0'&gt;
        &lt;character name='lluna' version='1.0'
         src='http://avatar.vp.bluehands.de/comic/lluna.xml'/&gt;
        &lt;color rgb='#00FF00' name='head'/&gt;
        &lt;color rgb='#999900' name='shadow'/&gt;
        &lt;color rgb='#000000' name='border'/&gt;
        &lt;color rgb='#FFFFFF' name='tooth'/&gt;
        &lt;color rgb='#FFFFFF' name='eye'/&gt;
        &lt;color rgb='#000000' name='pupil'/&gt;
        &lt;color rgb='#000000' name='mouth'/&gt;
        &lt;color rgb='#FF0000' name='tail1'/&gt;
        &lt;color rgb='#FF0000' name='tail2'/&gt;
        &lt;color rgb='#FF0000' name='tail3'/&gt;
        &lt;scale ratio='0.8'/&gt;
      &lt;/config&gt;
    &lt;/data&gt;
  &lt;/query&gt;
&lt;/iq&gt;
    </pre></div>

  <p class="" style="">The example avatar data above will be interpreted by the avatar engine, which registered for the MIME type 'avatar/comic'. This is a sample implementation of an animated avatar. The data states that an animation file shall be loaded from <a href="http://avatar.vp.bluehands.de/comic/lluna.xml">http://avatar.vp.bluehands.de/comic/lluna.xml</a> and then the character config shall be applied modifying the colors of the character definition.</p>

  <p class="" style="">The design is particular targeted at existing online games as avatar providers. It would be very easy to adapt the avatar rendering of an online role playing game (MMORPG) or any other community so that it provides avatar images for the VP client. In this case the avatar data would probably only consist of the online accout ID. This is up to the implementation. We imagine such avatar data to be like:</p>

    <p class="caption">Example 10. Potential Role Play-Plugin Avatar Data</p>
<div class="indent"><pre>
&lt;iq type='result' to='romeo@montague.net/garden'&gt;
  &lt;query xmlns='storage:client:avatar'&gt;
    &lt;data mimetype='rpg/my-favorite-mmorpg' encoding='plain'&gt;ACCOUNTID=6575438998&lt;/data&gt;
  &lt;/query&gt;
&lt;/iq&gt;
    </pre></div>

  <p class="" style="">... and the plug-in (which is part or the game distribution) connects to the game server, fetches the configuration, and renders Juliet as an nightelve mage level 30 with all insignia on the web page of Romeo. Romeo is very impressed, falls in love instantly and they both die in the course of a tragic story. Provided that Romeo happens to have the same gaming engine installed. Having not might save him in this time.</p>

  <p class="" style="">Note: As a matter of fact, we propose a call level plug-in interface described at  [<a href="#nt-id2257963">2</a>] for advanced avatars.</p>

  <p class="" style="">Note: To make things simple for the implementation users may have 2 avatars. The first avatar ('storage:client:avatar') is restricted to GIF and PNG images. The second avatar is fully featured, but optional. It is accessed through the namespace 'storage:client:avatar2' and tracked through digest 'firebat:avatar2:digest'. VP clients must implement 'storage:client:avatar' and 'firebat:avatar:digest' with at least PNG support. They may implement 'storage:client:avatar2' and 'firebat:avatar2:digest'. The scheme can be extended with higher numbers. </p>

  </div>

  <div class="indent">
<h3>3.4 <a name="sect-id2257992">Other Ways to get the Avatar</a>
</h3>

  <p class="" style="">If Juliet wants to protect her real JID, then she can not use public XML server storage. She can still provide an avatar by including the avatar data into the &lt;presence/&gt; stanza. </p>
    <p class="caption">Example 11. Explicit Avatar Presence Data</p>
<div class="indent"><pre>
&lt;x xmlns='firebat:avatar:data'&gt;&lt;data src='http://www.capulet.com/juliet.png'/&gt;&lt;/x&gt;

as part of:
&lt;presence from='juliet@capulet.com/balcony' to='room1@shakespeare.com/WebGirl' 
  &lt;x xmlns='firebat:avatar:digest'&gt;9b3635eb1440a1ee1c9f67767651194f34ecf130&lt;/x&gt;
  &lt;x xmlns='firebat:avatar:data'&gt;&lt;data src='http://www.capulet.com/juliet.png'/&gt;&lt;/x&gt;
&lt;/presence&gt;
    </pre></div>

  <p class="" style="">Juliet must not send bulky immediate data, but a reference to the image. Immediate data is only allowed, if it is smaller than a simple &lt;presence/&gt; stanza (see above). </p>
    <p class="caption">Example 12. Explicit and Immediate Avatar Presence Data</p>
<div class="indent"><pre>
&lt;x xmlns='firebat:avatar:data'&gt;
  &lt;data mimetype='rpg/my-favorite-mmorpg' encoding='plain'&gt;ACCOUNTID=6575438998&lt;/data&gt;
&lt;/x&gt;
    </pre></div>

  <p class="" style="">Note: There are other features which won't work without the real JID. Therefore it is recommended that clients include the JID in the &lt;presence/&gt; stanza. If Juliet wants to use all JID-based features then she would rather use a public Jabber server with an anonymous account, like she is used to do in case of email. This feature is supported because there are still Juliets who refrain from disclosing the JID and because the avatar is very important.</p>

  <p class="" style="">If Juliet provides the JID, but public XML server storage is not supported on Juliet's server, then Romeo may try to discover the avatar using disco features. He will query Juliet's server avatar disco node</p>
    <p class="caption">Example 13. Avatar Discovery Request</p>
<div class="indent"><pre>
&lt;iq to='juliet@capulet.com' type='get'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#info' node='http://jabber.org/protocol/avatar'/&gt;
&lt;/iq&gt;
    </pre></div>

  <p class="" style="">The result contains an item with the JID of the pubsub component where Juliet's avatar information is published and the specific node for that information:</p>
    <p class="caption">Example 14. Avatar Discovery Response</p>
<div class="indent"><pre>
&lt;iq type='result' from='juliet@capulet.com' to='romeo@montague.net/orchard' &gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#items'
    node='http://jabber.org/protocol/avatar'&gt;
    &lt;item jid='pubsub.shakespeare.lit' node='avatar/info/juliet@capulet.com'/&gt;
  &lt;/query&gt;
&lt;/iq&gt;
    </pre></div>

  </div>

  <div class="indent">
<h3>3.5 <a name="sect-id2258109">Avatar Movement</a>
</h3>
    <p class="" style="">A web page can be regarded as a two dimensional space. Avatars can move around on the page. Users are not just at a page, they are at a certain coordinate of the page. Entering the room Juliet tells Romeo (and all other participants) her initial position by including a position element into the initial &lt;presence/&gt; stanza:</p>

    <p class="caption">Example 15. Avatar Position</p>
<div class="indent"><pre>
&lt;presence from='juliet@capulet.com/balcony' to='room1@shakespeare.com/WebGirl' 
  &lt;x xmlns='firebat:user:jid'&gt;juliet@capulet.com/balcony&lt;/x&gt;
  &lt;x xmlns='firebat:avatar:digest'&gt;9b3635eb1440a1ee1c9f67767651194f34ecf130&lt;/x&gt;
  &lt;x xmlns='firebat:avatar:position'&gt;&lt;position x='180' w='853'/&gt;&lt;/x&gt;
&lt;/presence&gt;
    </pre></div>

    <p class="" style="">The coordinates are in pixels from the bottom left corner of the browser window. In this case she only tells the horizontal position. She could add a 'y' attribute. She also voluntarily discloses the width of her browser window. The width ('w') and height ('h') attributes are optional. They enable relative positioning at the other end.</p>

    <p class="" style="">As soon as Juliet enters and her avatar appears, Romeo moves his avatar up to Juliet's. Romeo's VP client sends a new &lt;presence/&gt; stanza with an altered position. The message is automatically broadcast by the room to all participants and stored for new participants. Romeo approaches Juliet:</p>

    <p class="caption">Example 16. Move Avatar</p>
<div class="indent"><pre>
&lt;presence from='romeo@montague.net/garden' to='room1@shakespeare.com/YoungHero' 
  &lt;x xmlns='firebat:user:jid'&gt;romeo@montague.net&lt;/x&gt;
  &lt;x xmlns='firebat:avatar:digest'&gt;e5229ec136892e00fcb79f822c192e7a2067a296&lt;/x&gt;
  &lt;x xmlns='firebat:avatar:position'&gt;&lt;position x='150'/&gt;&lt;/x&gt;
&lt;/presence&gt;
    </pre></div>

    <p class="" style="">Note that this &lt;presence/&gt; stanza, which is sent in order to move the avatar is not different from the initial &lt;presence/&gt; stanza to the room. This is just a repetition with a different coordinate.</p>

    <p class="" style="">Juliet's VP client forwards the movement to the avatar rendering engine. In case of an image based avatar the image is just moved to take up the new position. In case on an animated avatar, the avatar engine will generate a sequence of images which lets the figure 'walk' to the new position or whatever movement method is appropriate for the avatar.</p>

    <p class="" style="">Now Romeo occupies exactly the part of the web page that Juliet is reading so she moves Romeo (locally) out of the way. This happens only on Juliet's screen. Once Juliet finished reading, she wants to restore Romeo's position. She sends a control message to Romeo to request the current position:</p>

    <p class="caption">Example 17. Request Avatar Position</p>
<div class="indent"><pre>
&lt;iq from='room1@shakespeare.com/WebGirl' to='room1@shakespeare.com/YoungHero' type='get'&gt;
  &lt;query xmlns='http://schema.bluehands.de/avatar#position'/&gt;
&lt;/iq&gt;
    </pre></div>

    <p class="" style="">Romeo responds with a control message which indicates the avatar position:</p>

    <p class="caption">Example 18. Send Avatar Position</p>
<div class="indent"><pre>
&lt;iq from='room1@shakespeare.com/YoungHero' to='room1@shakespeare.com/WebGirl' type='result'&gt;
  &lt;query xmlns='http://schema.bluehands.de/avatar#position'&gt;
    &lt;position x='123' w='800'/&gt;
  &lt;/query&gt;
&lt;/iq&gt;
    </pre></div>

    <p class="" style="">Juliet' VP client restores Romeo's avatar position:</p>

  </div>

  <div class="indent">
<h3>3.6 <a name="sect-id2258290">Bubble Chat</a>
</h3>
    
    <p class="" style="">We remember: after seeing Juliet's avatar, Romeo has already falling in love. But Juliet is a more realistic type. She insists on talking before falling in love. The avatar-on-web-pages paradigm frees us from chat line based chat. Each avatar may show a separate chat bubble with the latest text or even a chat history. </p>

    <p class="" style="">While Juliet is writing an opening, her VP client may send the current contents of the chat line to the room giving other participants snapshots of the text. We propose instant chat updates as an extension to groupchat. For backward compatibility these snapshots are transmitted as control messages without body text, so that other clients ignore them. Once Juliet hits the send button (or the enter-key) the VP client sends the chat message as body text of a &lt;message/&gt;. With a timely distance of fractions of seconds to few seconds Juliet sends the following messages:</p>

    <p class="caption">Example 19. Instant Chat</p>
<div class="indent"><pre>
&lt;message from='room1@shakespeare.com/WebGirl' to='room1@shakespeare.com'&gt;
  &lt;x xmlns='firebat:chat:state'&gt;Who&lt;/x&gt;
&lt;/message&gt;

&lt;message from='room1@shakespeare.com/WebGirl' to='room1@shakespeare.com'&gt;
  &lt;x xmlns='firebat:chat:state'&gt;Who art thou,&lt;/x&gt;
&lt;/message&gt;

&lt;message from='room1@shakespeare.com/WebGirl' to='room1@shakespeare.com'&gt;
  &lt;x xmlns='firebat:chat:state'&gt;Who art thou, YoungHer&lt;/x&gt;
&lt;/message&gt;

&lt;message from='room1@shakespeare.com/WebGirl' to='room1@shakespeare.com'&gt;
  &lt;body&gt;Who art thou, YoungHero?&lt;/body&gt;
&lt;/message&gt;
    </pre></div>

    <p class="" style="">Note: we propose to send the full text with every message. Differential updates seem to be the proper way. But the addressing information sent with each message produces more traffic than the enclosed text. This is especially true for randomly chosen (read: long) room names. On the other hand differential text requires synchronization points for new participants, who lack the history. Such synchronization points would carry the full text every other second rendering differential updates almost useless.</p>

    <p class="" style="">Implementation note: The traffic must stay below the karma-limitations of typical jabber servers. The minimum delay between instant chat messages should be 1 sec. The delay should be increased with the size of the text. We get a good balance between interactivity and traffic with the following algorithm (in msec): delay = max(5000, min(NumberOfChars x 25, 1000)). In words: from 1 second at 40 characters up to 5 seconds at 200 characters.</p>

    <p class="" style="">Implementation note: There is no limitation on the size of the instant chat specified. But some users, especially the ones not used to chat channels write without ever pressing the enter-key. Implementations should limit the size to reasonable length (200-1000 characters) by telling the user, refusing to send more, or just stripping the beginning of a long text.</p>

  </div>

  <div class="indent">
<h3>3.7 <a name="sect-id2258403">Video Icon</a>
</h3>    
    <p class="" style="">After some chatting, Juliet is still not convinced. She demands to see Romeo live (although not in person). Romeo switches on his webcam and sends the webcam URL as part of the &lt;presence/&gt; stanza.</p>

    <p class="caption">Example 20. Iconic Video</p>
<div class="indent"><pre>
&lt;presence from='romeo@montague.net/garden' to='room1@shakespeare.com/YoungHero' 
  &lt;x xmlns='firebat:user:jid'&gt;romeo@montague.net&lt;/x&gt;
  &lt;x xmlns='firebat:avatar:digest'&gt;e5229ec136892e00fcb79f822c192e7a2067a296&lt;/x&gt;
  &lt;x xmlns='firebat:avatar:position'&gt;&lt;position x='150'/&gt;&lt;/x&gt;
  &lt;x xmlns='firebat:icon:video'&gt;http://romeo.montague.net/video/icon&lt;/x&gt;
&lt;/presence&gt;
    </pre></div>

    <p class="" style="">Juliet's VP client HTTP-requests the video stream. The video is shown close to Romeo's avatar. Juliet falls in love.</p>

    <p class="" style="">The video format is the common, widely used webcam format introduced by Netscape (JPEG server-pushed).</p>

    <p class="" style="">In the real world there are many Romeos and Juliets even on the same page at the same time. Some of them with a webcam. Depending on the default settings of VP clients all users (say 8) will automatically request the videos of the subset of users equipped with a webcam (say 3). This automatically creates many video streams, 3 streams on the dialup line of all users and 7 streams on the line of webcam users. We therefore suggest the following optimizations and limitations:
      <ul>
        <li>video dimensions should be limited to 64x64 pixels, thus fitting into the 64x96 avatar rectangle,</li>
        <li>the frame rate should not exceed 3 frames per second for simple web browsing (special applications, especially assymmetric ones, like virtual class rooms, presentations may differ),</li>
        <li>for small sizes, quantization tables and Huffman tables make much more data than the encoded image. Therefore the DQT and DHT markers should be stripped from JPEG frames except for the first frame of a stream. Only the JPEG baseline algorithm is supported with static Huffman tables,</li>
        <li>VP clients which support such a optimized JPEG server-push format should add a 'Accept: image/djpeg' header to the HTTP request. (djpeg for differential JPEG)</li>
      </ul>

    The purpose of these limitations is to allow for webcams which send optimized streams of small images (reducing the data volume by a factor of 3) while supporting usual webcams.
    </p>

  </div>

<h2>4.
       <a name="sect-id2258509">Finding Virtual Locations</a>
</h2>

  <p class="" style="">Finding a virtual location for a websites means mapping a URL to a JID. The VP client gets the URL from the browser by some platform dependent way of interprocess communication. The URL may have been entered by the user, or it may be the result of a URI resolver. Then the VP client searches for an applicable mapping rule. This may include fetching multiple configuration files over the network. Finally the rule is applied and the VP client can enter the room.</p>

  <p class="" style="">Note: It is not possible to map general URIs to JIDs. Finding a mapping rule is only defined for HTTP and FTP schemes. Hence the mapping process is only defined for http: and ftp: URLs.</p>

  <div class="indent">
<h3>4.1 <a name="sect-id2258543">Mapping Rules</a>
</h3>

  <p class="" style="">The basic mechanism is very simple: a URL is mapped by means of a regular expression with replacement term. A hash function may follow after the regular expression and an optional prefix has been added for convenience. This is called a mapping rule. </p>

  <p class="" style="">Romeo is on http://www.shakespeare.com/market/ModernLibrary/index.html. A single mapping rule might cover the entire URL space of http://www.shakespeare.com/. It might look like:</p>

  <p class="caption">Example 21. Basic Mapping Rule</p>
<div class="indent"><pre>
&lt;rule&gt;
  &lt;search&gt;^http://www\.shakespeare\.com/([^/]+)/.*$&lt;/search&gt; 
  &lt;replace&gt;\1-room&lt;/replace&gt;
  &lt;digest&gt;
    &lt;prefix&gt;vp-generated-&lt;/prefix&gt;
  &lt;/digest&gt;
&lt;/rule&gt;
  </pre></div>

  <p class="" style="">This rule extracts the first level folder of the path section from the URL. It creates a room for each first level folder. The result ('market-room') is hashed by a message digest, if the &lt;digest/&gt; tag is present. A SHA1 digest is used by default. VP clients must support SHA1. The hashed result will be prefixed by 'vp-generated-'. This is for convenience, so that rooms generated for virtual presence can be sorted easily in room lists of conference components. Both &lt;digest/&gt; and &lt;prefix/&gt; are optional.</p>

  <p class="" style="">Flexibility requires that there be a set of rules applied to a URL. At least one of the rules (actually the &lt;search/&gt;-expression of the rule) should match the URL. The first matching rule will be used for the mapping. Rules are applied in the order of appearance. The set is enclosed by a &lt;location/&gt;-tag. The &lt;location/&gt; has a match-attribute that selects the URL space, which is handled by the &lt;location/&gt;. In other words: the URL is compared to the match-attribute of all &lt;location/&gt;s in a config file. If a match-attribute is omitted, then the &lt;location/&gt; generates JIDs for all URLs <span style="font-style: italic">in the same folder as the original URL</span>. The first &lt;location/&gt; that matches will produce the JID. All &lt;rule/&gt;s will be &lt;search&gt;ed and the first matching &lt;rule/&gt; will be used for the mapping by doing the &lt;replace&gt;ment, &lt;digest/&gt; and &lt;prefix/&gt;.</p>
  
  <p class="" style="">The rule set produces a room-name. The address of the conference component will then be appended to the room-name. The result is a Jabber room JID. This is the Jabber view.</p>
  
  <p class="" style="">More generally speaking: The rules generate a virtual location ID. The location ID is then sent to the virtual presence service denoted in the &lt;service/&gt;-tag of the &lt;location/&gt;. The &lt;service/&gt;-tag contains a service URL, which consists of a scheme and address. In this case the 'jabber'-scheme means that the Jabber protocol will be used and that the VP client joins a Jabber chat room with a JID created according to the Jabber ID building rules, i.e. room-name@address. This mechanism is extensible to other protocols as virtual presence transport, e.g. IRC.</p>

  <p class="" style="">A location configuration looks like: </p>

  <p class="caption">Example 22. Location Config</p>
<div class="indent"><pre>
&lt;location match="^http://www\.shakespeare\.com($|/.*$)"&gt;
  &lt;mapping&gt;
    &lt;rule&gt;
      &lt;search&gt;^http://www\.shakespeare\.com($|/$|/index\..+$)&lt;/search&gt; 
      &lt;replace&gt;toplevel-room&lt;/replace&gt;
      &lt;digest&gt;
        &lt;prefix&gt;vp-generated-&lt;/prefix&gt;
      &lt;/digest&gt;
    &lt;/rule&gt;
    &lt;rule&gt;
      &lt;search&gt;^http://www\.shakespeare\.com/([^/]+)/.*$&lt;/search&gt; 
      &lt;replace&gt;\1-room&lt;/replace&gt;
      &lt;digest&gt;
        &lt;prefix&gt;vp-generated-&lt;/prefix&gt;
      &lt;/digest&gt;
    &lt;/rule&gt;
    &lt;rule&gt;
      &lt;search&gt;.*&lt;/search&gt; 
      &lt;replace&gt;fallback-room&lt;/replace&gt;
      &lt;digest&gt;
        &lt;prefix&gt;vp-generated-&lt;/prefix&gt;
      &lt;/digest&gt;
    &lt;/rule&gt;
  &lt;/mapping&gt;
  &lt;service&gt;jabber:conference.shakespeare.com&lt;/service&gt;
&lt;/location&gt;
  </pre></div>

  <p class="" style="">Most web sites will use the same conference server for all rooms. Therefore the location has a default &lt;service/&gt; directive. In the above example the service-URL is <span style="font-style: italic">jabber:conference.shakespeare.com</span> (please note the scheme). But there might be configurations where a single &lt;location/&gt; section connects to different conference servers. For this reason the default &lt;service/&gt; directive can be overridden by a rule specific &lt;service/&gt; directive. The service-URL of the rule is computed by means of the same search expression, using the rule specific &lt;service/&gt; directive as replacement string.</p>

  <p class="caption">Example 23. Service URL by rule</p>
<div class="indent"><pre>
&lt;location match="^http://www\.shakespeare\.com($|/.*$)"&gt;
  &lt;mapping&gt;
    &lt;rule&gt;
      &lt;search&gt;^http://www\.shakespeare\.com/([^/]+)/(.*)$&lt;/search&gt; 
      &lt;replace&gt;\2&lt;/replace&gt;
      &lt;service&gt;jabber:\1.conference.shakespeare.com&lt;/service&gt;
    &lt;/rule&gt;
  &lt;/mapping&gt;
&lt;/location&gt;
  </pre></div>

  <p class="" style="">In this example each sub-folder of the URL will connect to a different conference server. The \1 means that the name of the first sub-folder is used as part of the conference server name. The URL part behind the first sub-folder determines the room name (\2).</p>


  <p class="" style="">Independent services may publish lists of virtual locations. An example is a 'topsites'-service, which publishes a list of most active locations as a list of URLs. These services usually require the cooperation of VP clients. VP clients publish their locations (and URLs), if configured to do so. In some cases website operators allow for virtual presence on their pages, but they do not want that the real URLs are published, or they do not want the URLs published at all. Therefore the location configuration offers optional tags to control how URLs are disclosed by VP clients. A &lt;hidden/&gt;-tag prohibits the publication of the URL. A &lt;destination/&gt;-tag modifies the URL. A &lt;hidden/&gt; location may look like:</p>

  <p class="caption">Example 24. Hidden Location</p>
<div class="indent"><pre>
&lt;location match="^http://www\.shakespeare\.com($|/.*$)"&gt;
  &lt;mapping&gt;
    &lt;rule&gt;
      &lt;search&gt;.*&lt;/search&gt; 
      &lt;replace&gt;www.shakespeare.com&lt;/replace&gt;
      &lt;hidden/&gt;
    &lt;/rule&gt;
  &lt;/mapping&gt;
&lt;/location&gt;
  </pre></div>

  <p class="" style="">In this example all URLs of the website will be mapped to a single room. Users will be present there, but the room will not appear in public lists (if clients and publication services comply).</p>

  <p class="" style="">A simplification of the above is the &lt;mapped/&gt;-tag, which does not employ regular expressions. All URLs of the website can be mapped to a single location (omitting the &lt;hidden/&gt; feature again):</p>

  <p class="caption">Example 25. Direct Mapping</p>
<div class="indent"><pre>
&lt;location match="^http://www\.shakespeare\.com($|/.*$)"&gt;
  &lt;mapping&gt;
    &lt;mapped&gt;www.shakespeare.com&lt;/mapped&gt;
  &lt;/mapping&gt;
&lt;/location&gt;
  </pre></div>

  <p class="" style="">The &lt;destination/&gt;-tag modifies the URL so that website operators control which URLs are published. They might delete a web-session ID from URLs or alter the URL so that users who discover the location on a publication service are directed to a different URL. The biggest concern is that the exposed URL may contain security relevant session data. The &lt;destination/&gt;- (per &lt;rule/&gt;) allows to remove this data from URLs while preserving browseable URLs. The following example deletes the query part from URLs.</p>

  <p class="caption">Example 26. Destination: Modifying Published URLs</p>
<div class="indent"><pre>
&lt;location match="^http://www\.shakespeare\.com($|/.*$)"&gt;
  &lt;mapping&gt;
    &lt;rule&gt;
      &lt;search&gt;.*&lt;/search&gt; 
      &lt;replace&gt;www.shakespeare.com&lt;/replace&gt;
      &lt;destination&gt;
        &lt;search&gt;(^http://www\.shakespeare\.com[^?]*)($|[?].*$)&lt;/search&gt;
        &lt;replace&gt;\1&lt;/replace&gt;
      &lt;/destination&gt;
    &lt;/rule&gt;
  &lt;/mapping&gt;
&lt;/location&gt;
  </pre></div>

  <p class="" style="">Note: VP clients should not rely on a &lt;destination/&gt; only, when publishing URLs. A client should consult the user if, how, and where URLs are to be published. It is recommended to strip the query part by default until configured otherwise. </p>

  <p class="" style="">The &lt;ignore/&gt;-tag prevents virtual presence clients from dealing with matching URLs. There will be no virtual presence associated with the URL.</p>

  <p class="caption">Example 27. Ignore: Opt out</p>
<div class="indent"><pre>
&lt;location match="^http://www\.shakespeare\.com($|/.*$)"&gt;
  &lt;ignore/&gt;
&lt;/location&gt;
  </pre></div>

  <p class="" style="">Finally, all &lt;location/&gt;s are wrapped by the document element &lt;vpi/&gt; with an appropriate XML namespace. A VPI file looks like: 
      <p class="caption">Example 28. VPI file format</p><div class="indent"><pre>
&lt;?xml version='1.0' ?&gt;
&lt;vpi xmlns='http://schema.bluehands.de/virtual-presence-info'&gt;
  &lt;location match='...'&gt;...&lt;/location&gt;
  &lt;location match='...'&gt;...&lt;/location&gt;
  ...                        &lt;!--   more locations  --&gt;
  &lt;location&gt;...&lt;/location&gt;   &lt;!--  default location --&gt;
&lt;/vpi&gt;</pre></div>
  
  Examples are available at  [<a href="#nt-id2258931">3</a>]
  </p>
  
  </div>

  <div class="indent">
<h3>4.2 <a name="sect-id2258947">Web Server based Configuration</a>
</h3>

  <p class="" style="">Location configuration data, such as the above is stored in configuration files called Virtual Presence Information (VPI) files. The files are fetched via HTTP or FTP, according to the scheme of the URL which is to be mapped. Websites can offer VPI files at each level in the path hierarchy. If they do not offer VPI files then the VP client reverts to default VPI. The VP client tries to find a VPI file in the same folder as the file of the URL. It strips the file and query parts of the URL and appends the file name _vpi.xml:</p>

  <p class="caption">Example 29. Nearest VPI File</p>
<div class="indent"><pre>
http://www.shakespeare.com/market/ModernLibrary/_vpi.xml
  </pre></div>

  <p class="" style="">HTTP-servers have many different ways to respond if the file is not available, which is the most common case. They should respond with a 404 status code and an optional HTML message. But some web servers are configured to return a default document, some return a status code 200 and a 'Content-type: text/html' message with an error text, some even return  status code 200 and 'Content-type: text/xml' with an HTML message. It is therefore recommended that VP clients check the HTTP status code, the Content-type and the validity of the XML document. If there is no such file or if it is not a valid XML file or, in case of HTTP, if the Content-type is not text/xml, then the request fails. If the request fails then the client ascends the path until it hits the top level of the website trying to fetch:</p>

  <p class="caption">Example 30. Web Site Toplevel VPI File</p>
<div class="indent"><pre>
http://www.shakespeare.com/_vpi.xml
  </pre></div>

  <p class="" style="">If the request fails, then the client reverts to a default VPI file if there is any. Our implementation uses http://vpi.vp.bluehands.de/lluna-2.3.10/root-vpi.xml. It will finally use http://vpi.vp.bluehands.de/root-vpi.xml or another global configuration file. http://vpi.jabber.org/root.xml would be an option.</p>

  <p class="" style="">If there is no default VPI file then the VP client uses the following configuration data:</p>

  <p class="caption">Default VPI</p>
<div class="indent"><pre>
&lt;location&gt;
  &lt;service&gt;jabber:conference.jabber.bluehands.de&lt;/service&gt; 
  &lt;mapping&gt;
    &lt;rule&gt;
      &lt;search&gt;^http://([^/]+)($|/.*$)&lt;/search&gt; 
      &lt;replace&gt;\1&lt;/replace&gt; 
      &lt;digest/&gt;
    &lt;/rule&gt;
  &lt;/mapping&gt;
&lt;/location&gt;
  </pre></div>

  <p class="" style="">This configuration creates a virtual location for each web server address. The server name is obfuscated by a hash function (SHA1). The location configuration applies to all URLs, since the match attribute of the &lt;location/&gt; defaults to '.*'.</p>

  <p class="" style="">VP clients must cache the result of VPI downloads including failed requests and invalid responses. They must keep a local copy for at least a few minutes to avoid traffic from multiple (ascending) VPI file downloads. </p>

  <p class="" style="">Note: There are many websites, which consist of multiple web server addresses. This is especially true for large sites, which use DNS round-robin for load balancing. These websites need a special mapping to meet the expectation of the user, because users usually do not care if they are on www01.website.com or on www02.website.com. If users expect to see each other, then the virtual presence service should meet the expectations. There might also be website operators, who do not like virtual presence on their pages. These operators may even take legal action against the provider of the VP client software. So, these websites may require special configuration as well. And there may be other reasons for individual configuration of selected websites. Therefore it is recommended, that VP clients update their default configuration, i.e. by using an automatic update feature or by downloading the default VPI.</p>

  <p class="" style="">A VPI file may delegate the handling of URL spaces to another VPI file. The &lt;delegate/&gt;-node replaces the &lt;mapping/&gt; and &lt;service/&gt; nodes of the &lt;location/&gt;. If the VP client discovers a &lt;delegate/&gt; tag inside a &lt;location/&gt;, which matches the URL to be mapped, then it stops processing the file and loads the VPI file denoted by the &lt;delegate/&gt;-tag. A request to http://www.shakespeare.com/market/ModernLibrary/_vpi.xml could return VPI like:</p>

  <p class="caption">Example 31. Delegation</p>
<div class="indent"><pre>
&lt;location&gt;
  &lt;delegate&gt;http://www.shakespeare.com/_vpi.xml&lt;/delegate&gt; 
&lt;/location&gt;
  </pre></div>

  <p class="" style="">This means that the VP client skips http://www.shakespeare.com/market/_vpi.xml and continues with http://www.shakespeare.com/_vpi.xml. Delegation can be used to direct the VP client to the VPI file of a commercial virtual presence service. The commercial service would then be responsible to create rooms for customers and to provide the appropriate VPI. Delegation is also useful to split up the default VPI file. The default VPI file contains special configuration for some large websites. It has been split into individual files for different (DNS) top level domains. The global VPI file currently in use (http://vpi.vp.bluehands.de/lluna-2.3.10/root-vpi.xml) contains the following statement for the .com space:</p>

  <p class="caption">Example 32. Delegation for Subspaces</p>
<div class="indent"><pre>
...
&lt;location match="^http://.*\.com($|/.*)"&gt;
  &lt;delegate&gt;http://vpi.vp.bluehands.de/lluna-2.3.10/dotcom-vpi.xml&lt;/delegate&gt; 
&lt;/location&gt;
...
  </pre></div>

  </div>

  <div class="indent">
<h3>4.3 <a name="sect-id2259180">The Mapping Process</a>
</h3>

  <p class="" style="">This section is intended as a guideline for the implementation of the mapping process.</p>

  <p class="" style="">The mapping has 3 phases: 
    <ol start="" type="">
    <li>retrieving the config file, </li>
    <li>finding the appropriate mapping rule, and</li>
    <li>applying the rule</li>
    </ol>
  </p>

  <div class="indent">
<h3>4.3.1 <a name="sect-id2259230">Retrieve the Configuration File</a>
</h3>

  <p class="" style="">
      We get a URL from the web browser, say
        <p class="caption"></p><div class="indent"><pre>http://www.shakespeare.com/market/ModernLibrary/index.html</pre></div>
      We try to fetch the configuration file from 
        <p class="caption"></p><div class="indent"><pre>http://www.shakespeare.com/market/ModernLibrary/_vpi.xml</pre></div>
      The request fails (the failure is noted in the cache), and we try
        <p class="caption"></p><div class="indent"><pre>http://www.shakespeare.com/market/_vpi.xml</pre></div>
      The request fails again (the failure is noted in the cache). We try
        <p class="caption"></p><div class="indent"><pre>http://www.shakespeare.com/_vpi.xml</pre></div>
      We do not find it (the failure is noted in the cache), and we revert to the 
      global file (this depends on the client configuration)
        <p class="caption"></p><div class="indent"><pre>http://vpi.vp.bluehands.de/lluna-2.3.10/root-vpi.xml</pre></div>
      The request returns (and the data is stored in the cache): 
      <p class="caption"></p><div class="indent"><pre>
&lt;?xml version='1.0' ?&gt;
&lt;vpi xmlns='http://schema.bluehands.de/virtual-presence-info'&gt;

  &lt;!-- handle .com(s) by another file --&gt; 
  &lt;location match='^http://.*\.com/.*'&gt;
    &lt;delegate&gt;http://vpi.vp.bluehands.de/lluna-2.3.10/dotcom-vpi.xml&lt;/delegate&gt;
  &lt;/location&gt;

  &lt;!-- handle .de(s) by another file --&gt; 
  &lt;location match='^http://.*\.de/.*'&gt;
    &lt;delegate&gt;http://vpi.vp.bluehands.de/lluna-2.3.10/dotde-vpi.xml&lt;/delegate&gt;
  &lt;/location&gt;

  &lt;!-- all others go here --&gt;
  &lt;location&gt;
    &lt;service&gt;jabber:conference.jabber.bluehands.de&lt;/service&gt;
    &lt;mapping&gt;
      &lt;!-- one location per website  --&gt;
      &lt;rule&gt;
        &lt;search&gt;^http://([^/]+)($|/.*$)&lt;/search&gt;
        &lt;replace&gt;\1&lt;/replace&gt;
        &lt;digest/&gt;
      &lt;/rule&gt;
    &lt;/mapping&gt;
  &lt;/location&gt;
&lt;/vpi&gt;</pre></div>

      We try to find a &lt;location/&gt; that matches our URL. We find:
      <p class="caption"></p><div class="indent"><pre>
&lt;location match='^http://.*\.com/.*'&gt;
  &lt;delegate&gt;http://vpi.vp.bluehands.de/lluna-2.3.10/dotcom-vpi.xml&lt;/delegate&gt;
&lt;/location&gt;</pre></div>

      This means that all .com domains are forwarded to a separate VPI file. 
      We fetch:
      <p class="caption"></p><div class="indent"><pre>http://vpi.vp.bluehands.de/lluna-2.3.10/dotcom-vpi.xml</pre></div>

      We store the result in the cache and search for a matching &lt;location/&gt;
      again. We find the default section (rest of the file omitted):
      <p class="caption"></p><div class="indent"><pre>
...
&lt;location&gt;
  &lt;service&gt;jabber:conference.jabber.bluehands.de&lt;/service&gt;
  &lt;mapping&gt;
    &lt;rule&gt;
      &lt;search&gt;^http://([^/]+)($|/.*$)&lt;/search&gt;
      &lt;replace&gt;\1&lt;/replace&gt;
      &lt;digest/&gt;
    &lt;/rule&gt;
  &lt;/mapping&gt;
&lt;/location&gt;
...</pre></div>

      The default &lt;location/&gt; matches, so we get a virtual presence 
      service address and a set of rules. 
      The virtual presence service is 
        <p class="caption"></p><div class="indent"><pre>conference.jabber.bluehands.de</pre></div>

      The protocol to use is 
        <p class="caption"></p><div class="indent"><pre>jabber</pre></div>

      There is one mapping rule:
      <p class="caption"></p><div class="indent"><pre>
&lt;rule&gt;
  &lt;search&gt;^http://([^/]+)($|/.*$)&lt;/search&gt; 
  &lt;replace&gt;\1&lt;/replace&gt;
  &lt;digest/&gt;
&lt;/rule&gt;</pre></div>

      The result of the first phase is a set of mapping rules (with 1 rule), which will be 
      applied to all URLs <span style="font-style: italic">in the same folder</span> as the original URL. In regex-speech:
      <p class="caption"></p><div class="indent"><pre>http://www.shakespeare.com/market/ModernLibrary/.*</pre></div>

      To apply the mask only to URLs in the same URL-path folder is a security 
      requirement, so that 'inner' VPI files 
      from websites can not configure the mapping of 'outer' folders or 'sibling' folders. 
      VPI files from web sites can only configure the path from which they are 
      loaded. So, there are actually 2 URL-masks which must be combined to get the real 
      mask of a rule set. 
  </p>
  <p class="" style="">
      The VPI file has been found at:
      <p class="caption"></p><div class="indent"><pre>http://www.shakespeare.com/market/ModernLibrary/_vpi.xml</pre></div>

      So, the security mask is:
      <p class="caption"></p><div class="indent"><pre>^http://www\.shakespeare\.com/market/ModernLibrary/.*</pre></div>

      The &lt;location/&gt; has a match attribute. This is the user supplied mask 
      of the rule set:
      <p class="caption"></p><div class="indent"><pre>^http://www\.shakespeare\.com($|/.*$)</pre></div>

      The simplest way to guarantee that both masks are matched is to check against 
      both, rather than creating a combined mask. So, the rule above will be 
      stored to the rule repository with 2 masks:
      <p class="caption"></p><div class="indent"><pre>
^http://www\.shakespeare\.com/market/ModernLibrary/.* (security-mask)
^http://www\.shakespeare\.com($|/.*$)                 (user-mask)</pre></div>

  </p>

  </div>

  <div class="indent">
<h3>4.3.2 <a name="sect-id2259408">Find a Mapping Rule</a>
</h3>

  <p class="" style="">
      We have a URL and a set of mapping rules. There are mapping rules left
      over from earlier browser navigations and the new one just retrieved.

      In deviation from the above (which featured delegation and the default VPI) now
      imagine that there is a special configuration for the www.shakespeare.com
      website. Imagine the VPI is
      <p class="caption"></p><div class="indent"><pre>
...
&lt;location match="^http://www\.shakespeare\.com($|/.*$)"&gt;
  &lt;service&gt;jabber:conference.jabber.bluehands.de&lt;/service&gt;
  &lt;mapping&gt;
    &lt;rule&gt;
      &lt;search&gt;^http://www\.shakespeare\.com/([^/]+)/.*$&lt;/search&gt; 
      &lt;replace&gt;\1-room&lt;/replace&gt;
      &lt;digest&gt;
        &lt;prefix&gt;vp-generated-&lt;/prefix&gt;
      &lt;/digest&gt;
    &lt;/rule&gt;
  &lt;/mapping&gt;
&lt;/location&gt;
...</pre></div>

      In this case we had the masks:
      <p class="caption"></p><div class="indent"><pre>
^http://www.shakespeare.com/market/ModernLibrary/.*
^http://www\.shakespeare\.com($|/.*$)</pre></div>

      With a single rule:
      <p class="caption"></p><div class="indent"><pre>
&lt;rule&gt;
  &lt;search&gt;^http://www\.shakespeare\.com/([^/]+)/.*$&lt;/search&gt; 
  &lt;replace&gt;\1-room&lt;/replace&gt;
  &lt;digest&gt;
    &lt;prefix&gt;vp-generated-&lt;/prefix&gt;
  &lt;/digest&gt;
&lt;/rule&gt;</pre></div>

      We now scan all rule sets (including the new one) to find the rule set 
      whose URL-mask(s) match our URL
      <p class="caption"></p><div class="indent"><pre>http://www.shakespeare.com/market/ModernLibrary/index.html</pre></div>

      Surprise! We find the rule set, which has just been downloaded and 
      added to the repository. We would do the same for any following URL 
      and even for a slightly different URL like  
      <p class="caption"></p><div class="indent"><pre>http://www.shakespeare.com/market/ModernLibrary/page1.html</pre></div>

      we would find the same mask. So we do not have to fetch a config file 
      as long as we are in the same folder. If we leave the folder then we 
      fetch a new config file. This will probably end up in the same 
      global config file, which will already be available in the VPI cache.

      But for now we have to map a URL and we already found the rule set. So...
  </p>

  </div>

  <div class="indent">
<h3>4.3.3 <a name="sect-id2259474">Apply the Rule</a>
</h3>

  <p class="" style="">
      In the rule set applicable to there is one rule that matches the URL. 
      <p class="caption"></p><div class="indent"><pre>
&lt;rule&gt;
  &lt;search&gt;^http://www\.shakespeare\.com/([^/]+)/.*$&lt;/search&gt; 
  &lt;replace&gt;\1-room&lt;/replace&gt;
  &lt;digest&gt;
    &lt;prefix&gt;vp-generated-&lt;/prefix&gt;
  &lt;/digest&gt;
&lt;/rule&gt;</pre></div>

      The rule is a regex expression with replacement. The expression
      <p class="caption"></p><div class="indent"><pre>^http://www\.shakespeare\.com/([^/]+)/.*$</pre></div>

      will be replaced by (see regex syntax)
      <p class="caption"></p><div class="indent"><pre>\1-room</pre></div>

      which means that it will extract the first level folder from the URL. The URL
      <p class="caption"></p><div class="indent"><pre>http://www.shakespeare.com/market/ModernLibrary/index.html</pre></div>

      is replaced by
      <p class="caption"></p><div class="indent"><pre>market-room</pre></div>

      The &lt;digest/&gt;-tag tells us to hash the regex replacement result with 
      the default message digest SHA1. So we get:
      <p class="caption"></p><div class="indent"><pre>87d0c3e8d08f344375f22014c7cafe6527acbae3</pre></div>

      The &lt;prefix/&gt;-tag tells us to prefix with 
      <p class="caption"></p><div class="indent"><pre>vp-generated-</pre></div>
      
      and finally the ID of the virtual location (the room name) is:
      <p class="caption"></p><div class="indent"><pre>vp-generated-87d0c3e8d08f344375f22014c7cafe6527acbae3</pre></div>

      From the &lt;service/&gt;
      <p class="caption"></p><div class="indent"><pre>jabber:conference.jabber.bluehands.de</pre></div>

      the client knows the transport protocol and the address. The Jabber protocol will 
      be used as transport protocol and the Jabber conference room JID is
      <p class="caption"></p><div class="indent"><pre>vp-generated-87d0c3e8d08f344375f22014c7cafe6527acbae3@conference.jabber.bluehands.de</pre></div>

  </p>

  </div>
  
  </div>

<h2>5.
       <a name="sect-id2259555">Error Codes</a>
</h2>
  <p class="" style="">This document does not introduce new error codes.</p>
<h2>6.
       <a name="sect-id2259570">Security Considerations</a>
</h2>
  <p class="" style="">The system has been designed to protect the privacy of the user as good as possible. If users decide to run the VP client, then other users may see their movement, but only if they enter the same locations. There is no way to track users, especially since the JIDs of virtual locations (Jabber chat rooms) are supposed to be SHA1 digests of URLs which are not predicable. So people trying to track Romeo have to guess the URL and enter the respective chat room to find Romeo. They cannot browse the room list of a conference component and deduce the URL from the room name.</p>
  <p class="" style="">The fact that clients may disclose their JID in order to provide access to their avatar server storage and in order to enable caching is a weak point. A different but equally unique ID could be for caching purposes, provided that it is part of the &lt;presence/&gt; stanza. But traffic restrictions on the client connection prevent that additional data is exchanged between peers in a room. The data could be broadcast to the room, but this could end up in many people always broadcasting avatars while entering a room (web page). The chosen solution is to let peers download from public server storage. A better solution might be to let the conference component fetch from the server storage. In this case clients would need only the room-JID of the user, not the real JID.</p>
<h2>7.
       <a name="sect-id2259600">Jabber Registrar Considerations</a>
</h2>
  <p class="" style="">These namespaces need to be reviewed and/or registered with the Jabber Registrar as a result of this JEP. 
      <ul>
        <li>firebat:user:jid</li>
        <li>firebat:avatar:position</li>
        <li>firebat:avatar:getpos</li>
        <li>firebat:chat:state</li>
        <li>firebat:icon:video</li>
        <li>firebat:avatar:digest</li>
        <li>firebat:avatar2:digest</li>
        <li>storage:client:avatar</li>
        <li>storage:client:avatar2</li>
      </ul>
  </p>
<h2>8.
       <a name="sect-id2259663">Formal Definition</a>
</h2>
  <div class="indent">
<h3>8.1 <a name="sect-id2259670">Schema</a>
</h3>
    <p class="" style="">No schema definitions yet. They will be added in the next version of this document, if it is considered for publication. </p>
  </div>
<h2>9.
       <a name="sect-id2259688">Conclusion</a>
</h2>
  <p class="" style="">The virtual presence on Jabber has been designed to fit easily into the existing Jabber infrastructure including existing software components, clients, and protocols. It turns out that Jabber offers everything necessary for basic virtual presence. </p>

  <p class="" style="">This document proposes a mapping process in order to create a space for virtual presence on top of the URL based Web infrastructure. It also proposes namespace extensions for the protocol, which make virtual presence on web pages more convenient. The core features are: 
    <ul>
      <li>URL mapping and service discovery,</li>
      <li>avatars standing and walking on a web page,</li>
      <li>bubble chat,</li>
      <li>iconic video.</li>
    </ul>
    There are definitely more features possible. Suggestions are welcome</p>
<p><hr></p>
<a name="notes"></a><h2>Notes</h2>
<div class="indent">
<p><a name="nt-id2250805">1</a>. JEP-0045: Multi-User Chat &lt;<a href="http://www.jabber.org/jeps/jep-0045.html">http://www.jabber.org/jeps/jep-0045.html</a>&gt;.</p>
<p><a name="nt-id2257963">2</a>. <a href="http://www.lluna.de/docs/animated-avatars.html">http://www.lluna.de/docs/animated-avatars.html</a></p>
<p><a name="nt-id2258931">3</a>. <a href="http://www.lluna.de/docs/vpi-file-syntax.html">http://www.lluna.de/docs/vpi-file-syntax.html</a></p>
</div>
<p><hr></p>
<a name="revs"></a><h2>Revision History</h2>
<div class="indent">
<h4>Version 0.1 (2005-06-02)</h4>
<div class="indent">Initial JEP version. (psa)
    </div>
<h4>Version 0.0.8 (2005-05-20)</h4>
<div class="indent">Added ignore-tag. (hw)
    </div>
<h4>Version 0.0.7 (2005-02-08)</h4>
<div class="indent">Added comments on anonymity of presence element JID. 
            Added additional avatar retrieval methods: 1. presence stanza avatar data element 2. via disco (hw)
    </div>
<h4>Version 0.0.6 (2005-01-26)</h4>
<div class="indent">Replaced firebat:chat:key by firebat:chat:state (hw)
    </div>
<h4>Version 0.0.5 (2004-07-29)</h4>
<div class="indent">Notes about future changes in the JID/storage related sections. (hw)
    </div>
<h4>Version 0.0.4 (2004-07-27)</h4>
<div class="indent">Changed avatar position request frem message-x to iq-get, because MUC may block unknown message namespaces. (hw)
    </div>
<h4>Version 0.0.3 (2004-03-17)</h4>
<div class="indent">Textual changes. Added service tag to rule to overwrite default service of the location. (hw)
    </div>
<h4>Version 0.0.2 (2003-11-19)</h4>
<div class="indent">Refined introduction and requirements. Added location mapping. (hw)
    </div>
<h4>Version 0.0.1 (2003-11-11)</h4>
<div class="indent">Initial version. (hw)
    </div>
</div>
<p><hr></p>
<p>END</p>
</body>
</html>
