<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>JEP-0187: Offline Encrypted Sessions</title>
<link rel="stylesheet" type="text/css" href="jep.css">
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
<meta name="DC.Title" content="Offline Encrypted Sessions">
<meta name="DC.Creator" content="Ian Paterson">
<meta name="DC.Description" content="This document specifies an end-to-end encryption protocol for offline XMPP communication sessions.">
<meta name="DC.Publisher" content="Jabber Software Foundation">
<meta name="DC.Contributor" content="JEP Editor">
<meta name="DC.Date" content="2006-07-18">
<meta name="DC.Type" content="Jabber Enhancement Proposal">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="JEP-0187">
<meta name="DC.Language" content="en">
<meta name="DC.Rights" content="This Jabber Enhancement Proposal is copyright 1999 - 2006 by the Jabber Software Foundation (JSF) and is in full conformance with the JSF's Intellectual Property Rights Policy &lt;http://www.jabber.org/jsf/ipr-policy.shtml&gt;. This material may be distributed only subject to the terms and conditions set forth in the Creative Commons Attribution License (&lt;http://creativecommons.org/licenses/by/2.5/&gt;).">
</head>
<body>
<h1>JEP-0187: Offline Encrypted Sessions</h1>
<p>This document specifies an end-to-end encryption protocol for offline XMPP communication sessions.</p>
<p><hr></p>
<p style="color:red">WARNING: This Standards-Track JEP is Experimental. Publication as a Jabber Enhancement Proposal does not imply approval of this proposal by the Jabber Software Foundation. Implementation of the protocol described herein is encouraged in exploratory implementations, but production systems should not deploy implementations of this protocol until it advances to a status of Draft.</p>
<p><hr></p>
<h2>JEP Information</h2>
<p class="indent">
            Status: 
            <a href="http://www.jabber.org/jeps/jep-0001.html#states-Experimental">Experimental</a><br>
            Type:
            <a href="http://www.jabber.org/jeps/jep-0001.html#types-Standards%20Track">Standards Track</a><br>
            Number: 0187<br>
            Version: 0.1<br>
            Last Updated: 2006-07-18<br>
            JIG: Standards JIG<br>
                Approving Body: <a href="http://www.jabber.org/council/">Jabber Council</a><br>Dependencies: XMPP Core, RFC 2104, RFC 2409, RFC 3526, RFC 3548, xml-c14n, JEP-0004, JEP-0020, JEP-0068, JEP-0079, JEP-0116, JEP-0155, JEP-0163<br>
                Supersedes: None<br>
                Superseded By: None<br>
            Short Name: offlineesession<br>
              Wiki Page: &lt;<a href="http://wiki.jabber.org/index.php/Offline%20Encrypted%20Sessions%20(JEP-0187)">http://wiki.jabber.org/index.php/Offline Encrypted Sessions (JEP-0187)</a>&gt;
            </p>
<h2>Author Information</h2>
<div class="indent">
<h3>Ian Paterson</h3>
<p class="indent">
        Email:
        <a href="mailto:ian.paterson@clientside.co.uk">ian.paterson@clientside.co.uk</a><br>
        JID: 
        <a href="xmpp:ian@zoofy.com">ian@zoofy.com</a></p>
</div>
<h2>Legal Notice</h2>
<p class="indent">This Jabber Enhancement Proposal is copyright 1999 - 2006 by the <a href="http://www.jabber.org/jsf/">Jabber Software Foundation</a> (JSF) and is in full conformance with the JSF's Intellectual Property Rights Policy &lt;<a href="http://www.jabber.org/jsf/ipr-policy.shtml">http://www.jabber.org/jsf/ipr-policy.shtml</a>&gt;. This material may be distributed only subject to the terms and conditions set forth in the Creative Commons Attribution License (&lt;<a href="http://creativecommons.org/licenses/by/2.5/">http://creativecommons.org/licenses/by/2.5/</a>&gt;).</p>
<h2>Discussion Venue</h2>
<p class="indent">The preferred venue for discussion of this document is the Standards-JIG discussion list: &lt;<a href="http://mail.jabber.org/mailman/listinfo/standards-jig">http://mail.jabber.org/mailman/listinfo/standards-jig</a>&gt;.</p>
<p class="indent">Given that this JEP normatively references IETF technologies, discussion on the JSF-IETF list may also be appropriate (see &lt;<a href="http://mail.jabber.org/mailman/listinfo/jsf-ietf">http://mail.jabber.org/mailman/listinfo/jsf-ietf</a>&gt; for details).</p>
<h2>Relation to XMPP</h2>
<p class="indent">The Extensible Messaging and Presence Protocol (XMPP) is defined in the XMPP Core (RFC 3920) and XMPP IM (RFC 3921) specifications contributed by the Jabber Software Foundation to the Internet Standards Process, which is managed by the Internet Engineering Task Force in accordance with RFC 2026. Any protocol defined in this JEP has been developed outside the Internet Standards Process and is to be understood as an extension to XMPP rather than as an evolution, development, or modification of XMPP itself.</p>
<h2>Conformance Terms</h2>
<p class="indent">The following keywords as used in this document are to be interpreted as described in RFC 2119: "MUST", "SHALL", "REQUIRED"; "MUST NOT", "SHALL NOT"; "SHOULD", "RECOMMENDED"; "SHOULD NOT", "NOT RECOMMENDED"; "MAY", "OPTIONAL".</p>
<p><hr></p>
<h2>Table of Contents</h2>
<div class="indent"><dl>
<dt>1.  <a href="#intro">Introduction</a>
</dt>
<dt>2.  <a href="#personae">Dramatis Personae</a>
</dt>
<dt>3.  <a href="#init">Offline ESession Negotiation</a>
</dt>
<dl>
<dt>3.1.  <a href="#init-offline-publish">Publishing Offline ESession Options</a>
</dt>
<dt>3.2.  <a href="#init-offline-request">Requesting Offline ESession Options</a>
</dt>
<dt>3.3.  <a href="#init-offline-start">Starting an Offline ESession</a>
</dt>
<dt>3.4.  <a href="#init-offline-accept">Accepting Offline ESessions</a>
</dt>
</dl>
<dt>4.  <a href="#exchange">Exchanging Stanzas</a>
</dt>
<dt>5.  <a href="#terminate">ESession Termination</a>
</dt>
<dt>6.  <a href="#sec">Security Considerations</a>
</dt>
<dl>
<dt>6.1.  <a href="#sec-replay">Replay Attacks</a>
</dt>
<dt>6.2.  <a href="#sec-expire">Options Expiry Time</a>
</dt>
<dt>6.3.  <a href="#sec-identity">Identity Exposure</a>
</dt>
<dt>6.4.  <a href="#sec-conclusion">Conclusion</a>
</dt>
</dl>
<dt>7.  <a href="#iana">IANA Considerations</a>
</dt>
<dt>8.  <a href="#registrar">Jabber Registrar Considerations</a>
</dt>
<dt><a href="#notes">Notes</a></dt>
<dt><a href="#revs">Revision History</a></dt>
</dl></div>
<p><hr></p>
<h2>1.
       <a name="intro">Introduction</a>
</h2>
  <p class="" style="">The convenience of sending stanzas to other entities that are offline ("offline messages") is an important and popular feature of most XMPP implementations (see <span class="ref" style="">Best Practices for Handling Offline Messages</span>  [<a href="#nt-id2251046">1</a>]). Without offline messages delivery would have to wait until both entities managed to be online at the same time. So many urgent messages could not be delivered in time. For example, the sender might want to send an urgent message before jumping on a flight.</p>
  <p class="" style="">End-to-end encryption is another desirable feature for any communication technology. Unfortunately it is not possible to make offline encryption quite so secure as online encryption. However, offline encryption has a long history and is certainly preferable to having no encryption at all.  [<a href="#nt-id2251062">2</a>] Unfortunately, for reasons described in <span class="ref" style="">Cryptographic Design of Encrypted Sessions</span>  [<a href="#nt-id2251092">3</a>], the existing proposals (including <span class="ref" style="">Current Jabber OpenPGP Usage</span>  [<a href="#nt-id2251115">4</a>] and <span class="ref" style="">RFC 3923</span>  [<a href="#nt-id2251138">5</a>]) have not been widely implemented and deployed. This document describes a different approach to offline end-to-end encryption for use by entities that communicate using XMPP. It builds on the existing online <span class="ref" style="">Encrypted Sessions</span>  [<a href="#nt-id2259725">6</a>] protocol. As a result it offers important advantages over the existing "Object Encryption" proposals:</p>
  <ul>
    <li>Perfect Forward Secrecy  [<a href="#nt-id2251072">7</a>]</li>
    <li>Other security features described in <span style="font-weight: bold">Cryptographic Design of Encrypted Sessions</span>
</li>
    <li>Most of the code can be borrowed from implementations of <span style="font-weight: bold">Encrypted Sessions</span>
</li>
  </ul>
  <p class="" style="">The requirements and the consequent cryptographic design that underpin this protocol are described in <span style="font-weight: bold">Cryptographic Design of Encrypted Sessions</span>. The basic concept is that of an encrypted session which acts as a secure tunnel between the online endpoint and the offline endpoint. The offline endpoint completes its part of the tunnel "negotiation" by publishing its preferences before it goes offline (see <a href="#sec">Security Considerations</a>). Once the tunnel is established by the online endpoint, the content of each one-to-one XML stanza sent by the online endpoint is encrypted and then transmitted within a "wrapper" stanza.</p>
<h2>2.
       <a name="personae">Dramatis Personae</a>
</h2>
  <p class="" style="">This JEP introduces two characters to help the reader follow the necessary exchanges:</p>
  <ol start="1" type="">
    <li>"Bob" is the name of the online participant in the offline ESession. Within the scope of this JEP, his fully-qualified JID is: &lt;bob@example.com/laptop&gt;.</li>
    <li>"Alice" is the name of the offline participant in the offline ESession started by Bob. Within the scope of this JEP, we stipulate that her fully-qualified JID is: &lt;alice@example.org/pda&gt;.</li>
  </ol>
  <p class="" style="">While Bob and Alice are introduced as "end users", they are simply meant to be examples of Jabber entities. Any directly addressable Jabber entity may participate in an offline ESession.</p>
<h2>3.
       <a name="init">Offline ESession Negotiation</a>
</h2>
  <p class="" style="">The approach to establishing a secure session with an entity that is offline is in essence a special case of 3-message negotiation employed for online ESessions (see <span style="font-weight: bold">Encrypted Sessions</span>).</p>
  <p class="" style="">Alice MAY publish a set of offline ESession options just before she goes offline. If Bob subscribes to Alice's presence and wishes to establish an online ESession with her, but he finds that she is offline, then if she published her offline ESession options before going offline, he may use the protocol described below to perform the initial Diffie-Hellman key exchange, establish an offline ESession and send encrypted stanzas to her while she is offline. Note: Bob MUST NOT initiate a new ESession with Alice if he already has an ESession established with her.</p>
  <p class="" style="">Note: Alice MAY also publish <span style="font-style: italic">another</span> similar set of relatively long-lived  [<a href="#nt-id2259874">8</a>] offline ESession options that any entity MAY use for the same purpose.</p>

    <div class="indent">
<h3>3.1 <a name="init-offline-publish">Publishing Offline ESession Options</a>
</h3>
      <p class="" style="">In order to publish either set of her offline ESession options Alice MUST create an options data form in exactly the same way as she would create an online ESession request data form (see the ESession Request section in <span style="font-weight: bold">Encrypted Sessions</span>) except she MUST omit The 'accept' and 'pk_hash' fields. Note: The list of stanza types she is willing to decrypt MUST NOT include the value 'iq'.</p>
      <p class="" style="">Alice MUST append to the content of the form an 'expires' field containing the UTC time (see <span class="ref" style="">Jabber Date and Time Profiles</span>  [<a href="#nt-id2259939">9</a>]) that she decides her offline ESession options will expire (see <a href="#sec-expire">Options Expiry Time</a> Security Considerations).</p>
      <p class="" style="">Alice MUST store her value of N<span class="sub" style="">A</span> (her ESession ID), all her values of x (one for each MODP group) and the time she decides her offline ESession options will expire in a secure way, so that she can retrieve them when she comes back online (idealy even if that is using a different client and/or a different machine).</p>
      <p class="" style="">If Alice would not be able to decrypt stanzas if she came back online using a different client and/or a different machine then she SHOULD also encapsulate the resource of her client in a 'match_resource' field and append it to her options data form. In this case, the list of stanza types she is willing to decrypt MUST include only 'message'.</p>
      <p class="" style="">Alice MUST also append to the content of the form the list of the fingerprints (PKIDs) of all her public signature-verification keys that she can sign for in a 'pkids' field, and the corresponding list of signatures (see <a href="#sign">Signature Generation</a>) of the <span style="font-style: italic">content</span> of the data form (excluding the 'signs' field).</p>
      <p class="" style="">Alice MUST publish the ESession options data form through her own server using <span class="ref" style="">Personal Eventing via Pubsub</span>  [<a href="#nt-id2260036">10</a>].</p>
      <p class="" style="">If the pubkey PEP node does not exist already then Alice MUST create it first. In this case, Alice SHOULD specify the "Presence" access model for the set of options for presence subscribers (or the "Open" model for the set for other entities), unless she wants greater control over trivial access to her identity (see <a href="#sec-identity">Identity Exposure</a> Security Considerations). Alice SHOULD specify that the options will never be pushed to subscribers (even when she publishes new options) - especially if she specifies the "Whitelist" access model.</p>
  <p class="caption">Example 1. Alice Creates PEP Node for ESession Options for Presence Subscribers</p>
<div class="indent"><pre>
&lt;iq from='alice@example.org/pda' type='set' id='create1'&gt;
  &lt;pubsub xmlns='http://jabber.org/protocol/pubsub'&gt;
    &lt;create node='http://jabber.org/protocol/esession#subscription'/&gt;
    &lt;configure&gt;
      &lt;x xmlns='jabber:x:data' type='form'&gt;
        &lt;field var='FORM_TYPE' type='hidden'&gt;
          &lt;value&gt;http://jabber.org/protocol/pubsub#node_config&lt;/value&gt;
        &lt;/field&gt;
        &lt;field var='pubsub#deliver_notifications'&gt;
          &lt;option&gt;&lt;value&gt;0&lt;/value&gt;&lt;/option&gt;
        &lt;/field&gt;
        &lt;field var='pubsub#send_last_published_item'&gt;
          &lt;option&gt;&lt;value&gt;never&lt;/value&gt;&lt;/option&gt;
        &lt;/field&gt;
        &lt;field var='pubsub#access_model'&gt;
          &lt;option&gt;&lt;value&gt;presence&lt;/value&gt;&lt;/option&gt;
        &lt;/field&gt;
      &lt;/x&gt;
    &lt;/configure&gt;
  &lt;/pubsub&gt;
&lt;/iq&gt;
  </pre></div>
  <p class="caption">Example 2. Alice Creates PEP Node for ESession Options for All Entities</p>
<div class="indent"><pre>
&lt;iq from='alice@example.org/pda' type='set' id='create2'&gt;
  &lt;pubsub xmlns='http://jabber.org/protocol/pubsub'&gt;
    &lt;create node='http://jabber.org/protocol/esession'/&gt;
    &lt;configure&gt;
      &lt;x xmlns='jabber:x:data' type='form'&gt;
        &lt;field var='FORM_TYPE' type='hidden'&gt;
          &lt;value&gt;http://jabber.org/protocol/pubsub#node_config&lt;/value&gt;
        &lt;/field&gt;
        &lt;field var='pubsub#deliver_notifications'&gt;
          &lt;option&gt;&lt;value&gt;0&lt;/value&gt;&lt;/option&gt;
        &lt;/field&gt;
        &lt;field var='pubsub#send_last_published_item'&gt;
          &lt;option&gt;&lt;value&gt;never&lt;/value&gt;&lt;/option&gt;
        &lt;/field&gt;
        &lt;field var='pubsub#access_model'&gt;
          &lt;option&gt;&lt;value&gt;open&lt;/value&gt;&lt;/option&gt;
        &lt;/field&gt;
      &lt;/x&gt;
    &lt;/configure&gt;
  &lt;/pubsub&gt;
&lt;/iq&gt;
  </pre></div>
  <p class="" style="">Once the publishing node has been created, Alice can update her options for subscribers to her presence whenever she goes offline:</p>
  <p class="caption">Example 3. Alice Publishes Her ESession Options for Her Presence Subscribers</p>
<div class="indent"><pre>
&lt;iq from='alice@example.org/pda' type='set' id='pub1'&gt;
  &lt;pubsub xmlns='http://jabber.org/protocol/pubsub'&gt;
    &lt;publish node='http://jabber.org/protocol/esession#subscription'&gt;
      &lt;item&gt;
        &lt;x type='form' xmlns='jabber:x:data'&gt;
          &lt;field type="hidden" var="FORM_TYPE"&gt;
            &lt;value&gt;http://jabber.org/protocol/chatneg&lt;/value&gt;
          &lt;/field&gt;
          &lt;field type="boolean" var="logging"&gt;
            &lt;value&gt;1&lt;/value&gt;
          &lt;/field&gt;
          &lt;field type="boolean" var="secure"&gt;
            &lt;value&gt;0&lt;/value&gt;
          &lt;/field&gt;
          &lt;field type="list-single" var="modp"&gt;
            &lt;option&gt;&lt;value&gt;5&lt;/value&gt;&lt;/option&gt;
            &lt;option&gt;&lt;value&gt;14&lt;/value&gt;&lt;/option&gt;
            &lt;option&gt;&lt;value&gt;2&lt;/value&gt;&lt;/option&gt;
          &lt;/field&gt;
          &lt;field type="list-single" var="crypt_algs"&gt;
            &lt;option&gt;&lt;value&gt;aes256-ctr&lt;/value&gt;&lt;/option&gt;
            &lt;option&gt;&lt;value&gt;twofish256-ctr&lt;/value&gt;&lt;/option&gt;
            &lt;option&gt;&lt;value&gt;aes128-ctr&lt;/value&gt;&lt;/option&gt;
          &lt;/field&gt;
          &lt;field type="list-single" var="hash_algs"&gt;
            &lt;option&gt;&lt;value&gt;whirlpool&lt;/value&gt;&lt;/option&gt;
            &lt;option&gt;&lt;value&gt;sha256&lt;/value&gt;&lt;/option&gt;
          &lt;/field&gt;
          &lt;field type="list-single" var="sign_algs"&gt;
            &lt;option&gt;&lt;value&gt;rsa&lt;/value&gt;&lt;/option&gt;
            &lt;option&gt;&lt;value&gt;dsa&lt;/value&gt;&lt;/option&gt;
          &lt;/field&gt;
          &lt;field type="list-single" var="compress"&gt;
            &lt;option&gt;&lt;value&gt;none&lt;/value&gt;&lt;/option&gt;
          &lt;/field&gt;
          &lt;field type="list-multi" var="stanzas"&gt;
            &lt;option&gt;&lt;value&gt;message&lt;/value&gt;&lt;/option&gt;
          &lt;/field&gt;
          &lt;field type="list-single" var="ver"&gt;
            &lt;option&gt;&lt;value&gt;1.3&lt;/value&gt;&lt;/option&gt;
            &lt;option&gt;&lt;value&gt;1.2&lt;/value&gt;&lt;/option&gt;
          &lt;/field&gt;
          &lt;field type="text-single" var="rekey_freq"&gt;
            &lt;value&gt;1&lt;/value&gt;
          &lt;/field&gt;
          &lt;field var="expires"&gt;
            &lt;value&gt;2006-06-09T02:56:15Z&lt;/value&gt;
          &lt;/field&gt;
          &lt;field var="my_nonce"&gt;
            &lt;value&gt; ** Base64 encoded ESession ID ** &lt;/value&gt;
          &lt;/field&gt;
          &lt;field var="keys"&gt;
            &lt;value&gt; ** Base64 encoded value of e5 ** &lt;/value&gt;
            &lt;value&gt; ** Base64 encoded value of e14 ** &lt;/value&gt;
            &lt;value&gt; ** Base64 encoded value of e2 ** &lt;/value&gt;
          &lt;/field&gt;
          &lt;field var="match_resource"&gt;
            &lt;value&gt;pda&lt;/value&gt;
          &lt;/field&gt;
          &lt;field var="pkids"&gt;
            &lt;value&gt; ** PKID ** &lt;/value&gt;
            &lt;value&gt; ** PKID ** &lt;/value&gt;
          &lt;/field&gt;
          &lt;field var="signs"&gt;
            &lt;value&gt; ** signature of form ** &lt;/value&gt;
            &lt;value&gt; ** signature of form ** &lt;/value&gt;
          &lt;/field&gt;
        &lt;/x&gt;
      &lt;/item&gt;
    &lt;/publish&gt;
  &lt;/pubsub&gt;
&lt;/iq&gt;
  </pre></div>
  <p class="" style="">At the risk of divulging her presence, Alice MAY also update her options for all entities:</p>
  <p class="caption">Example 4. Alice Publishes Her ESession Options for All Entities</p>
<div class="indent"><pre>
&lt;iq type='set' from='alice@example.org/pda' id='pub2'&gt;
  &lt;pubsub xmlns='http://jabber.org/protocol/pubsub'&gt;
    &lt;publish node='http://jabber.org/protocol/esession'&gt;
      ...
    &lt;/publish&gt;
  &lt;/pubsub&gt;
&lt;/iq&gt;
  </pre></div>
    </div>
    <div class="indent">
<h3>3.2 <a name="init-offline-request">Requesting Offline ESession Options</a>
</h3>
      <p class="" style="">If Bob believes Alice is offline he SHOULD request her ESession options and, if he does not have a local copy of any of her public keys specified therein, her long-term public signature-verification keys (see <span class="ref" style="">Public Key Publishing</span>  [<a href="#nt-id2250542">11</a>]) from her server using <span style="font-weight: bold">Personal Eventing via Pubsub</span>.  [<a href="#nt-id2250532">12</a>]</p>
      <p class="" style="">If Bob is subscribing to Alice's presence he MUST request her ESession Options exclusively for subscribers.</p>
      <p class="caption">Example 5. Bob asks Alice's Server for her ESession Options (Subscribers)</p>
<div class="indent"><pre>
&lt;iq type='get'
    from='bob@example.com/laptop'
    to='alice@example.org'
    id='es4'&gt;
  &lt;pubsub xmlns='http://jabber.org/protocol/pubsub'&gt;
    &lt;items node='http://jabber.org/protocol/esession#subscription'/&gt;
  &lt;/pubsub&gt;
&lt;/iq&gt;
  </pre></div>
      <p class="" style="">If Bob is not subscribing to Alice's presence (or if Alice has no ESession options exclusively for subscribers) he MUST use the following request instead.</p>
      <p class="caption">Example 6. Bob asks Alice's Server for her ESession Options (All Entities)</p>
<div class="indent"><pre>
&lt;iq type='get'
    from='bob@example.com/laptop'
    to='alice@example.org'
    id='es4'&gt;
  &lt;pubsub xmlns='http://jabber.org/protocol/pubsub'&gt;
    &lt;items node='http://jabber.org/protocol/esession'/&gt;
  &lt;/pubsub&gt;
&lt;/iq&gt;
  </pre></div>
      <p class="" style="">If, after receiving Alice's public keys and ESession options, Bob is unable to verify any of Alice's signatures of her offline options data form (see <a href="#sign">Signature Verification</a>) then he MUST proceed no further, since he cannot be sure who will be able to decrypt his stanzas.</p>
      <p class="" style="">If Bob cannot acquire Alice's ESession options, or he does not support one or more of the options in each Alice's ESession fields, or if the 'expires' field indicates that Alice's options have expired, then he MUST NOT send encrypted stanzas to her while she is offline.</p>
    </div>

    <div class="indent">
<h3>3.3 <a name="init-offline-start">Starting an Offline ESession</a>
</h3>
      <p class="" style="">Bob MUST now continue as if Alice had requested an online ESession, performing the steps described in three of the sections of <span style="font-weight: bold">Encrypted Sessions</span>:</p>
      <ol start="1" type="">
        <li><p class="" style=""><span style="font-weight: bold">Diffie-Hellman Preparation (Bob)</span> Note: If the value of e he selected is not valid, Bob SHOULD terminate the ESession <span style="font-style: italic">without</span> sending an error.</p></li>
        <li><p class="" style=""><span style="font-weight: bold">Generating Session Keys</span></p></li>
        <li><p class="" style=""><span style="font-weight: bold">Hiding Identity</span> Note: Since Bob did not receive a 'pk_hash' field, he MUST assume its value is false. Bob SHOULD NOT include a 'pk_hash' field in form<span class="sub" style="">B</span> since Alice has already proved her identity.</p></li>
      </ol>
      <p class="" style="">As with 3-message ESession negotiation, Bob should encapsulate the Base64 encoded values of ID<span class="sub" style="">B</span> and M<span class="sub" style="">B</span> in data form fields ('identity' and 'mac'), and append the new fields to form<span class="sub" style="">B</span>.</p>
      <p class="" style="">Bob MAY also send encrypted content (see the Exchanging Stanzas section of <span style="font-weight: bold">Encrypted Sessions</span>) in the same stanza. Note: If he also includes a &lt;terminate/&gt; element (see the ESession Termination section of <span style="font-weight: bold">Encrypted Sessions</span>) within the &lt;encrypted/&gt; element then the ESession is terminated immediately. This special case, where a single stanza is encrypted and sent in isolation, is equivalent to object encryption (or object signing if no encryption is specified) and offers several significant advantages over non-session approaches - including perfect forward secrecy.</p>
      <p class="" style="">If Alice included a 'match_resource' field in her ESession options, then Bob MUST address all the stanzas he sends within the offline ESession to the specified resource and use the <span style="font-weight: bold">Advanced Message Processing</span> protocol to ensure that they are not delivered to any other resource.</p>
      <p class="" style="">After sending form<span class="sub" style="">B</span> to Alice, Bob can assume that the ESession negotiation is complete.</p>
      <p class="caption">Example 7. Bob Establishes an ESession Without Negotiation</p>
<div class="indent"><pre>
&lt;message from='bob@example.com/laptop' to='alice@example.org/pda' type='chat'&gt;
  &lt;init xmlns='http://jabber.org/protocol/esession#init'&gt;
    &lt;x type='submit' xmlns='jabber:x:data'&gt;
      &lt;field var="FORM_TYPE"&gt;
        &lt;value&gt;http://jabber.org/protocol/chatneg&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var="logging"&gt;&lt;value&gt;0&lt;/value&gt;&lt;/field&gt;
      &lt;field var="secure"&gt;&lt;value&gt;0&lt;/value&gt;&lt;/field&gt;
      &lt;field var="modp"&gt;&lt;value&gt;5&lt;/value&gt;&lt;/field&gt;
      &lt;field var="crypt_algs"&gt;&lt;value&gt;aes256-ctr&lt;/value&gt;&lt;/field&gt;
      &lt;field var="hash_algs"&gt;&lt;value&gt;sha256&lt;/value&gt;&lt;/field&gt;
      &lt;field var="sign_algs"&gt;&lt;value&gt;rsa&lt;/value&gt;&lt;/field&gt;
      &lt;field var="compress"&gt;&lt;value&gt;none&lt;/value&gt;&lt;/field&gt;
      &lt;field var="stanzas"&gt;&lt;value&gt;message&lt;/value&gt;&lt;/field&gt;
      &lt;field var="ver"&gt;&lt;value&gt;1.3&lt;/value&gt;&lt;/field&gt;
      &lt;field var="rekey_freq"&gt;&lt;value&gt;50&lt;/value&gt;&lt;/field&gt;
      &lt;field var="my_nonce"&gt;
        &lt;value&gt; ** Base64 encoded ESession ID ** &lt;/value&gt;
      &lt;/field&gt;
      &lt;field var="keys"&gt;
        &lt;value&gt; ** Base64 encoded value of d ** &lt;/value&gt;
      &lt;/field&gt;
      &lt;field var="nonce"&gt;
        &lt;value&gt; ** Base64 encoded ESession ID ** &lt;/value&gt;
      &lt;/field&gt;
      &lt;field var="counter"&gt;
        &lt;value&gt; ** Base64 encoded block counter ** &lt;/value&gt;
      &lt;/field&gt;
      &lt;field var="identity"&gt;
        &lt;value&gt; ** Encrypted identity ** &lt;/value&gt;
      &lt;/field&gt;
      &lt;field var="mac"&gt;
        &lt;value&gt; ** Integrity of identity ** &lt;/value&gt;
      &lt;/field&gt;
    &lt;/x&gt;
  &lt;/init&gt;
  &lt;encrypted xmlns='http://jabber.org/protocol/esession'&gt;
    &lt;data&gt; ** Base64 encoded m_final ** &lt;/data&gt;
    &lt;mac&gt; ** Base64 encoded a_mac ** &lt;/mac&gt;
  &lt;/encrypted&gt;
  &lt;amp xmlns='http://jabber.org/protocol/amp'&gt;
    &lt;rule action='??????' condition='match-resource' value='exact'/&gt;
  &lt;/amp&gt;
&lt;/message&gt;
    </pre></div>
    </div>
    <div class="indent">
<h3>3.4 <a name="init-offline-accept">Accepting Offline ESessions</a>
</h3>
      <p class="" style="">When Alice comes online she MUST perform the following steps:</p>
      <ol start="" type="">
        <li>
<p class="" style="">Ensure she is no longer publishing offline ESession options exclusively for entities that are subscribing to her presence.</p>
            <p class="caption">Example 8. Alice Stops Publishing Her ESession Options</p>
<div class="indent"><pre>
&lt;iq type='set' from='alice@example.org/pda' id='es5'&gt;
  &lt;pubsub xmlns='http://jabber.org/protocol/pubsub'&gt;
    &lt;publish node='http://jabber.org/protocol/esession#subscription'&gt;
      &lt;item/&gt;
    &lt;/publish&gt;
  &lt;/pubsub&gt;
&lt;/iq&gt;
  </pre></div>
        </li>
        <li><p class="" style="">Retrieve any values of N<span class="sub" style="">A</span>, x (one for each MODP group for each N<span class="sub" style="">A</span>) and her offline ESession options expiry time that she stored before going offline, and destroy in a secure way any persistently stored copies that correspond to ESession options exclusively for subscribers.</p></li>
      </ol>
      <p class="" style="">If the current time is after her offline ESession options expiry time then she MUST discard all stanzas from offline ESessions without decrypting them. Otherwise, when Alice receives an offline ESession request stanza from Bob then she MUST perform the following steps:</p>
      <ol start="" type="">
        <li><p class="" style="">Select her value of x that corresponds to the 'nonce' and 'modp' fields she received from Bob.  [<a href="#nt-id2260781">14</a>]</p></li>
        <li><p class="" style="">Confirm that she has not already received a key exchange stanza from Bob with the same value of d or N<span class="sub" style="">B</span> ('my_nonce' field) since she published her ESession options (see the Replay Attacks subsection of the Security Considerations section of <span style="font-weight: bold">Encrypted Sessions</span>). If the options were for subscribers, that means since she came online.</p></li>
        <li>
<p class="" style="">Alice MUST now continue as if Bob had responded to her online ESession request, performing the steps described in two of the sections of <span style="font-weight: bold">Encrypted Sessions</span>:</p>
        <ul>
          <li><p class="" style=""><span style="font-weight: bold">Diffie-Hellman Preparation (Alice)</span> Note: If she is not prepared to support any of the ESession options specified by Bob, or if the value of d she selected is not valid, then Alice SHOULD terminate the ESession <span style="font-style: italic">without</span> sending an error.</p></li>
          <li><p class="" style=""><span style="font-weight: bold">Verifying Bob's Identity</span> Note: Since Alice did not send a 'pk_hash' field to Bob, she MUST assume its value is false. If the value of M<span class="sub" style="">B</span> she calculated does not match the one she received, or if she cannot confirm that pubKey<span class="sub" style="">B</span> really is Bob's public key, or if she cannot confirm that sign<span class="sub" style="">B</span> is the signature of the HMAC result, then Alice SHOULD terminate the ESession <span style="font-style: italic">without</span> sending an error.</p></li>
        </ul>
</li>
      </ol>
    </div>
<h2>4.
       <a name="exchange">Exchanging Stanzas</a>
</h2>
  <p class="" style="">Alice MUST NOT send encrypted content within an offline ESession started by Bob. If Bob is conducting an offline ESession with Alice when she is online (e.g., if he is not subscribing to her presence), then if Alice wants to send a stanza to Bob, she MUST terminate the offline ESession and start a new online ESession first.</p>
  <p class="" style="">For Offline ESessions, Bob SHOULD include a 'Created' SHIM header in the encrypted content. Assuming she trusts Bob, Alice SHOULD trust this header and ignore the unencrypted <span class="ref" style="">Delayed Delivery</span>  [<a href="#nt-id2260958">15</a>] element inserted by her server.</p>
  <p class="caption">Example 9. Unencrypted Stanza</p>
<div class="indent"><pre>
&lt;message from='bob@example.com/laptop'
         to='alice@example.org/pda'
         type='chat'&gt;
  &lt;body&gt;Hello, Alice!&lt;/body&gt;
  &lt;amp xmlns='http://jabber.org/protocol/amp'&gt;
    &lt;rule action='error' condition='match-resource' value='exact'/&gt;
  &lt;/amp&gt;
  &lt;headers xmlns='http://jabber.org/protocol/shim'&gt;
    &lt;header name='Created'&gt;2005-02-10T03:01:52Z&lt;/header&gt;
  &lt;/headers&gt;
  &lt;active xmlns='http://jabber.org/protocol/chatstates'/&gt;
&lt;/message&gt;
</pre></div>
  <p class="caption">Example 10. XML Content to be Encrypted</p>
<div class="indent"><pre>
&lt;body&gt;Hello, Alice!&lt;/body&gt;
&lt;headers xmlns='http://jabber.org/protocol/shim'&gt;
  &lt;header name='Created'&gt;2005-02-10T03:01:52Z&lt;/header&gt;
&lt;/headers&gt;
&lt;active xmlns='http://jabber.org/protocol/chatstates'/&gt;
  </pre></div>
<h2>5.
       <a name="terminate">ESession Termination</a>
</h2>
  <p class="" style="">If Bob notices that Alice comes online during his offline ESession with her then he MUST terminate the ESession immediately. If required he may then negotiate a new (more secure) online ESession.</p>
  <p class="" style="">When Alice receives the offline ESession termination stanza from Bob, she SHOULD NOT send a termination stanza back to him.</p>
<h2>6.
       <a name="sec">Security Considerations</a>
</h2>
  <p class="" style="">For more security considerations refer to the Security Considerations section of <span style="font-weight: bold">Encrypted Sessions</span></p>
  <div class="indent">
<h3>6.1 <a name="sec-replay">Replay Attacks</a>
</h3>
    <p class="" style="">Since Alice supplies the same set of values of e for all offline ESessions, to prevent complete offline ESessions being replayed to her, she MUST take care to securely store <span style="font-style: italic">new</span> values (or destroy existing values) of N<span class="sub" style="">A</span> and x for subscribers whenever she goes offline (see <a href="#init-publish">Publishing ESession Options</a>). Also, when Alice comes online again, she MUST remember all the values of d he receives in offline ESession negotiation stanzas, and reject any offline ESessions that specify a value of d she has already received (see <a href="#init-accept">Accepting an Offline ESession</a>).</p>
    <p class="" style="">Note: If Alice publishes ESession options for non-subscribers, and if she does not update them whenever she comes online then, until she updates the options, she MUST save all the values of d she receives to secure persistent storage (along with the values of N<span class="sub" style="">A</span> and x).</p>
  </div>
  <div class="indent">
<h3>6.2 <a name="sec-expire">Options Expiry Time</a>
</h3>
    <p class="" style="">If Alice's offline private Diffie-Hellman keys are compromised, and the attacker also controls communications between Bob and Alice's server, then the attacker could prevent Bob discovering if she comes online, and resend her compromised ESession options to Bob whenever he asks for them. This would allow the attacker to decrypt all messages sent to Alice before her offline ESession options expire. Alice would probably never receive the messages sent to her after she comes back online. If an attack is discovered before the compromised ESession options expire then Alice SHOULD change her long-term signing key. Alice SHOULD mitigate this attack by choosing an expiry time for her ESession options that is not too long after she expects to be online again.</p>
  </div>
  <div class="indent">
<h3>6.3 <a name="sec-identity">Identity Exposure</a>
</h3>
    <p class="" style="">Offline ESession options include public keys. By publishing her public keys Alice associates her identity with her JID. Although the public keys are public information, it may be critically important for Alice to keep her identity secret from all but a few specified people. Implementors MUST take great care to ensure the identity of Alice is never divulged to anyone except her (PEP) server and the entities who have been permitted by Alice to access her offline ESession options. However, even then, Alice will not be able to protect her identity being exposed by passive attacks!</p>
  </div>
  <div class="indent">
<h3>6.4 <a name="sec-conclusion">Conclusion</a>
</h3>
    <p class="" style="">Alice MAY decide not to support offline ESessions since they are less secure than online ESessions. In addition to the issues above, the Perfect Forward Secrecy window of vulnerability is longer. More seriously, Alice MUST store her private Diffie-Hellman keys, x<span class="sub" style="">1</span>...x<span class="sub" style="">Z</span>, to local disk or to a server (perhaps symmetrically encrypted with a password). It is <span style="font-style: italic">really</span> hard to securely erase something from a disk. However, if Alice does not support Offline ESessions then, while she is offline, Bob, or Aunt Tillie, will probably send her completely unprotected messages!</p>
  </div>
<h2>7.
       <a name="iana">IANA Considerations</a>
</h2>
  <p class="" style="">This JEP requires no interaction with the <span class="ref" style="">Internet Assigned Numbers Authority (IANA)</span>  [<a href="#nt-id2261239">16</a>]. </p>
<h2>8.
       <a name="registrar">Jabber Registrar Considerations</a>
</h2>
  <p class="" style="">The <span class="ref" style="">Jabber Registrar</span>  [<a href="#nt-id2261279">17</a>] shall add 'http://jabber.org/protocol/esession#subscription' to its registry of protocol namespaces.</p>
<p><hr></p>
<a name="notes"></a><h2>Notes</h2>
<div class="indent">
<p><a name="nt-id2251046">1</a>. JEP-0160: Best Practices for Handling Offline Messages &lt;<a href="http://www.jabber.org/jeps/jep-0160.html">http://www.jabber.org/jeps/jep-0160.html</a>&gt;.</p>
<p><a name="nt-id2251062">2</a>. This protocol does not stop paranoid users avoiding sending offline messages.</p>
<p><a name="nt-id2251092">3</a>. JEP-0188: Cryptographic Design of Encrypted Sessions &lt;<a href="http://www.jabber.org/jeps/jep-0188.html">http://www.jabber.org/jeps/jep-0188.html</a>&gt;.</p>
<p><a name="nt-id2251115">4</a>. JEP-0027: Current Jabber OpenPGP Usage &lt;<a href="http://www.jabber.org/jeps/jep-0027.html">http://www.jabber.org/jeps/jep-0027.html</a>&gt;.</p>
<p><a name="nt-id2251138">5</a>. RFC 3923: End-to-End Signing and Object Encryption for the Extensible Messaging and Presence Protocol (XMPP) &lt;<a href="http://www.ietf.org/rfc/rfc3923.txt">http://www.ietf.org/rfc/rfc3923.txt</a>&gt;.</p>
<p><a name="nt-id2259725">6</a>. JEP-0116: Encrypted Sessions &lt;<a href="http://www.jabber.org/jeps/jep-0116.html">http://www.jabber.org/jeps/jep-0116.html</a>&gt;.</p>
<p><a name="nt-id2251072">7</a>. Long-lived keys are typically used for a few years, whereas Offline ESession decryption keys typically exist for just a few hours. So the Perfect Forward Secrecy feature significantly enhances the security of Offline ESessions.</p>
<p><a name="nt-id2259874">8</a>. The more often Alice changes her published ESession options, the shorter the Perfect Forward Secrecy window of vulnerability. However, whenever she changes them she divulges her presence to all the entities that are monitoring them.</p>
<p><a name="nt-id2259939">9</a>. JEP-0082: Jabber Date and Time Profiles &lt;<a href="http://www.jabber.org/jeps/jep-0082.html">http://www.jabber.org/jeps/jep-0082.html</a>&gt;.</p>
<p><a name="nt-id2260036">10</a>. JEP-0163: Personal Eventing via Pubsub &lt;<a href="http://www.jabber.org/jeps/jep-0163.html">http://www.jabber.org/jeps/jep-0163.html</a>&gt;.</p>
<p><a name="nt-id2250542">11</a>. JEP-0189: Public Key Publishing &lt;<a href="http://www.jabber.org/jeps/jep-0189.html">http://www.jabber.org/jeps/jep-0189.html</a>&gt;.</p>
<p><a name="nt-id2250532">12</a>. There is no need for Bob to discover Alice's support for the Offline ESessions protocol via <span class="ref" style="">Service Discovery</span>  [<a href="#nt-id2260388">13</a>].</p>
<p><a name="nt-id2260388">13</a>. JEP-0030: Service Discovery &lt;<a href="http://www.jabber.org/jeps/jep-0030.html">http://www.jabber.org/jeps/jep-0030.html</a>&gt;.</p>
<p><a name="nt-id2260781">14</a>. Alice may not be able to find the specified value of x if, for example, she went offline using a different client and/or a different machine without publishing a 'match_resource' field. In this case Alice cannot decrypt the offline ESession!</p>
<p><a name="nt-id2260958">15</a>. JEP-0091: Delayed Delivery &lt;<a href="http://www.jabber.org/jeps/jep-0091.html">http://www.jabber.org/jeps/jep-0091.html</a>&gt;.</p>
<p><a name="nt-id2261239">16</a>. The Internet Assigned Numbers Authority (IANA) is the central coordinator for the assignment of unique parameter values for Internet protocols, such as port numbers and URI schemes. For further information, see &lt;<a href="http://www.iana.org/">http://www.iana.org/</a>&gt;.</p>
<p><a name="nt-id2261279">17</a>. The Jabber Registrar maintains a list of reserved Jabber protocol namespaces as well as registries of parameters used in the context of protocols approved by the Jabber Software Foundation. For further information, see &lt;<a href="http://www.jabber.org/registrar/">http://www.jabber.org/registrar/</a>&gt;.</p>
</div>
<p><hr></p>
<a name="revs"></a><h2>Revision History</h2>
<div class="indent">
<h4>Version 0.1 (2006-07-18)</h4>
<div class="indent">Initial version (extracted from JEP-0116 version 0.9). (ip)
    </div>
</div>
<p><hr></p>
<p>END</p>
</body>
</html>
