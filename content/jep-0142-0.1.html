<html>
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<title>JEP-0142: Workgroups</title>
<link rel="stylesheet" type="text/css" href="jep.css">
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
<meta name="DC.Title" content="Workgroups">
<meta name="DC.Creator" content="Iain Shigeoka">
<meta name="DC.Creator" content="Matt Tucker">
<meta name="DC.Description" content="This JEP defines an XMPP protocol extension that enables a user to communicate with a representative of an organization, department, or workgroup (e.g., the support group).">
<meta name="DC.Publisher" content="Jabber Software Foundation">
<meta name="DC.Contributor" content="JEP Editor">
<meta name="DC.Date" content="2004-09-03">
<meta name="DC.Type" content="Jabber Enhancement Proposal">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="JEP-0142">
<meta name="DC.Language" content="en">
<meta name="DC.Rights" content="This Jabber Enhancement Proposal is copyright 1999 - 2004 by the Jabber Software Foundation (JSF) and is in full conformance with the JSF's Intellectual Property Rights Policy &lt;http://www.jabber.org/jsf/ipr-policy.php&gt;. This material may be distributed only subject to the terms and conditions set forth in the Open Publication License, v1.0 or later (the latest version is presently available at &lt;http://www.opencontent.org/openpub/&gt;).">
</head>
<body bgcolor="#FFFFFF">
<h1>JEP-0142: Workgroups</h1>
<p>This JEP defines an XMPP protocol extension that enables a user to communicate with a representative of an organization, department, or workgroup (e.g., the support group).</p>
<p><hr></p>
<p style="color:red">WARNING: This Standards-Track JEP is Experimental. Publication as a Jabber Enhancement Proposal does not imply approval of this proposal by the Jabber Software Foundation. Implementation of the protocol described herein is encouraged in exploratory implementations, but production systems should not deploy implementations of this protocol until it advances to a status of Draft.</p>
<p><hr></p>
<h2>JEP Information</h2>
<p class="indent">
            Status: Experimental<br>
            Type: Standards Track<br>
            Number: 0142<br>
            Version: 0.1<br>
            Last Updated: 2004-09-03<br>
            JIG: Standards JIG<br>
                Approving Body: Jabber Council<br>Dependencies: XMPP Core<br>
                Supersedes: None<br>
                Superseded By: None<br>
            Short Name: workgroup<br>
</p>
<h2>Author Information</h2>
<h3>Iain Shigeoka</h3>
<p class="indent">
        Email: iain@jivesoftware.com<br>
        JID: smirk@jabber.org</p>
<h3>Matt Tucker</h3>
<p class="indent">
        Email: matt@jivesoftware.com<br>
        JID: jivematt@jabber.org</p>
<h2>Legal Notice</h2>
<p class="indent">This Jabber Enhancement Proposal is copyright 1999 - 2004 by the Jabber Software Foundation (JSF) and is in full conformance with the JSF's Intellectual Property Rights Policy &lt;<a href="http://www.jabber.org/jsf/ipr-policy.php">http://www.jabber.org/jsf/ipr-policy.php</a>&gt;. This material may be distributed only subject to the terms and conditions set forth in the Open Publication License, v1.0 or later (the latest version is presently available at &lt;<a href="http://www.opencontent.org/openpub/">http://www.opencontent.org/openpub/</a>&gt;).</p>
<h2>Discussion Venue</h2>
<p class="indent">The preferred venue for discussion of this document is the Standards-JIG discussion list: &lt;<a href="http://mail.jabber.org/mailman/listinfo/standards-jig">http://mail.jabber.org/mailman/listinfo/standards-jig</a>&gt;.</p>
<h2>Relation to XMPP</h2>
<p class="indent">The Extensible Messaging and Presence Protocol (XMPP) is defined in the XMPP Core and XMPP IM specifications contributed by the Jabber Software Foundation to the Internet Standards Process, which is managed by the Internet Engineering Task Force in accordance with RFC 2026. Any protocols defined in this JEP have been developed outside the Internet Standards Process and are to be understood as extensions to XMPP rather than as an evolution, development, or modification of XMPP itself.</p>
<h2>Conformance Terms</h2>
<p class="indent">The keywords &quot;MUST&quot;, &quot;MUST NOT&quot;, &quot;REQUIRED&quot;, &quot;SHALL&quot;, &quot;SHALL NOT&quot;, &quot;SHOULD&quot;, &quot;SHOULD NOT&quot;, &quot;RECOMMENDED&quot;, &quot;NOT RECOMMENDED&quot;, &quot;MAY&quot;, and &quot;OPTIONAL&quot; in this document are to be interpreted as described in RFC 2119.</p>
<p><hr></p>
<h2>Table of Contents</h2>
<dl>
<dt>1.  <a href="#intro">Introduction</a>
</dt>
<dl>
<dt>1.1.  <a href="#intro-over">Overview</a>
</dt>
<dt>1.2.  <a href="#intro-motive">Motivation</a>
</dt>
<dt>1.3.  <a href="#intro-concepts">Concepts</a>
</dt>
<dt>1.4.  <a href="#intro-prereq">Prerequisites</a>
</dt>
</dl>
<dt>2.  <a href="#terms">Terminology</a>
</dt>
<dt>3.  <a href="#roleresp">Roles and Responsibilities</a>
</dt>
<dl>
<dt>3.1.  <a href="#roles">Roles</a>
</dt>
<dt>3.2.  <a href="#responsibilities">Responsibilities</a>
</dt>
</dl>
<dt>4.  <a href="#proto">Protocol</a>
</dt>
<dl>
<dt>4.1.  <a href="#proto-pres">Workgroup Presence</a>
</dt>
<dt>4.2.  <a href="#proto-states">User States</a>
</dt>
<dt>4.3.  <a href="#proto-user">User Packet Exchanges</a>
</dt>
<dl>
<dt>4.3.1.  <a href="#proto-user-join">User Join Protocol</a>
</dt>
<dl>
<dt>4.3.1.1.  <a href="#proto-user-join-errors">Error Conditions</a>
</dt>
<dt>4.3.1.2.  <a href="#proto-user-join-example">Example</a>
</dt>
</dl>
<dt>4.3.2.  <a href="#proto-user-depart">User Depart Protocol</a>
</dt>
<dl>
<dt>4.3.2.1.  <a href="#proto-user-depart-errors">Error Conditions</a>
</dt>
<dt>4.3.2.2.  <a href="#proto-user-depart-example">Example</a>
</dt>
</dl>
<dt>4.3.3.  <a href="#proto-user-status">User Status Update Protocol</a>
</dt>
<dl>
<dt>4.3.3.1.  <a href="#proto-user-status-updates">User Status Updates</a>
</dt>
<dt>4.3.3.2.  <a href="#proto-user-status-errors">Error Conditions</a>
</dt>
<dt>4.3.3.3.  <a href="#proto-user-status-example">Example</a>
</dt>
</dl>
<dt>4.3.4.  <a href="#proto-user-invite">User Invite Protocol</a>
</dt>
<dl>
<dt>4.3.4.1.  <a href="#proto-user-invite-errors">Error Conditions</a>
</dt>
<dt>4.3.4.2.  <a href="#proto-user-invite-example">Example</a>
</dt>
</dl>
</dl>
<dt>4.4.  <a href="#proto-agent-states">Agent States</a>
</dt>
<dt>4.5.  <a href="#proto-agent">Agent Packet Exchanges</a>
</dt>
<dl>
<dt>4.5.1.  <a href="#proto-agent-presence">Agent Presence Protocol</a>
</dt>
<dl>
<dt>4.5.1.1.  <a href="#proto-agent-presence-errors">Error Conditions</a>
</dt>
<dt>4.5.1.2.  <a href="#proto-agent-presence-example">Example</a>
</dt>
</dl>
<dt>4.5.2.  <a href="#proto-agent-status">Agent Status Update Protocol</a>
</dt>
<dl>
<dt>4.5.2.1.  <a href="#proto-agent-status-errors">Error Conditions</a>
</dt>
<dt>4.5.2.2.  <a href="#proto-agent-status-example">Example</a>
</dt>
</dl>
<dt>4.5.3.  <a href="#proto-agent-offer">Agent Offer Protocol</a>
</dt>
<dl>
<dt>4.5.3.1.  <a href="#proto-agent-offer-errors">Error Conditions</a>
</dt>
<dt>4.5.3.2.  <a href="#proto-agent-offer-example">Example</a>
</dt>
</dl>
<dt>4.5.4.  <a href="#proto-agent-acceptreject">Agent Offer Accept/Reject Protocol</a>
</dt>
<dl>
<dt>4.5.4.1.  <a href="#proto-agent-acceptreject-errors">Error Conditions</a>
</dt>
<dt>4.5.4.2.  <a href="#proto-agent-acceptreject-example">Example</a>
</dt>
</dl>
<dt>4.5.5.  <a href="#proto-agent-revoke">Agent Offer Revoke Protocol</a>
</dt>
<dl>
<dt>4.5.5.1.  <a href="#proto-agent-revoke-errors">Error Conditions</a>
</dt>
<dt>4.5.5.2.  <a href="#proto-agent-revoke-example">Example</a>
</dt>
</dl>
<dt>4.5.6.  <a href="#proto-agent-invite">Agent Invite Protocol</a>
</dt>
<dl>
<dt>4.5.6.1.  <a href="#proto-agent-invite-errors">Error Conditions</a>
</dt>
<dt>4.5.6.2.  <a href="#proto-agent-invite-example">Example</a>
</dt>
</dl>
</dl>
</dl>
<dt>5.  <a href="#example">Complete Protocol Example</a>
</dt>
<dt>6.  <a href="#impl">Implementation Notes</a>
</dt>
<dt>7.  <a href="#security">Security Considerations</a>
</dt>
<dt>8.  <a href="#iana">IANA Considerations</a>
</dt>
<dt>9.  <a href="#registrar">Jabber Registrar Considerations</a>
</dt>
<dt>9.1.  <a href="#registrar-ns">Protocol Namespaces</a>
</dt>
<dt>10.  <a href="#schema">XML Schema</a>
</dt>
<dt><a href="#notes">Notes</a></dt>
<dt><a href="#revs">Revision History</a></dt>
</dl>
<p><hr></p>
<h2>1.
       <a name="intro">Introduction</a>
</h2>
  <div class="indent">
<h3>1.1 <a name="intro-over">Overview</a>
</h3>
    <p class="" style="">This JEP documents a protocol that provides a generic service allowing users to contact a representative of an organization or workgroup without knowing the address of a particular member of that organization or workgroup. This functionality is similar to an 'email alias' with the addition of queuing pending communication requests and quality of service negotiation to accommodate the real-time nature of IM/chat. Although this protocol is generic enough to handle many use cases, specific features have been added that make it particularly suitable for customer support environments.</p>
  </div>
  <div class="indent">
<h3>1.2 <a name="intro-motive">Motivation</a>
</h3>
    <p class="" style="">This protocol addresses the need of starting a private XMPP conversation with a qualified member of a workgroup. In a standard XMPP exchange of messages, users either connect directly to another user for a one on one conversation, or connect to a chat room for a conversation between many people. The current protocols do not allow users to initiate a private conversation with any person playing a particular role in an organization or workgroup.</p>
    <p class="" style="">For example, a customer has a question and needs to talk to a support representative. The conversation is private and therefore cannot be conducted in a well-known chat room. Using the workgroup protocol, the user requests a chat with support@company.com. The chat request is put into a queue and the server routes the chat request to individual support representatives in the support@company.com workgroup. The support representative can accept or reject the chat request. Once the request is accepted, the conversation takes place through standard XMPP messaging protocols.</p>
  </div>
  <div class="indent">
<h3>1.3 <a name="intro-concepts">Concepts</a>
</h3>
    <p class="" style="">The namespace governing this protocol is &quot;http://jabber.org/protocol/workgroup&quot;. This namespace relies on the &lt;iq/&gt; element for execution, and uses the &lt;presence/&gt; element for announcing status updates.</p>
    <p class="" style="">This protocol depends on Service Discovery for reporting and announcing available workgroup services. However, support for service discovery is entirely optional and workgroup services may be made known through other means (e.g. web pages, word of mouth, etc).</p>
    <p class="" style="">The end result of a workgroup interaction is to negotiate and route a user and workgroup member (a.k.a. agent) to an appropriate chatroom for a chat conversation. Therefore, this JEP also relies on the groupchat and groupchat invitation protocols. However, groupchat essentially 'takes over' when the workgroup protocol successfully completes so there is no overlap between the two protocols. It is highly recommended that groupchat implementations support basic groupchat (a.k.a. Groupchat 1.0) for maximum client compatibility.</p>
  </div>
  <div class="indent">
<h3>1.4 <a name="intro-prereq">Prerequisites</a>
</h3>
    <p class="" style="">There are no requirements for supporting the workgroup protocol beyond <span class="ref">XMPP Core</span>  [<a href="#nt-id2596124">1</a>] and <span class="ref">Multi-User Chat</span>  [<a href="#nt-id2596230">2</a>]. Support for <span class="ref">Data Forms</span>  [<a href="#nt-id2596242">3</a>] is optional if users need to submit additional data before joining (see User Join section of this document).</p>
  </div>
<h2>2.
       <a name="terms">Terminology</a>
</h2>
  <p class="" style="">The keywords &quot;MUST&quot;, &quot;MUST NOT&quot;, &quot;REQUIRED&quot;, &quot;SHALL&quot;, &quot;SHALL NOT&quot;, &quot;SHOULD&quot;, &quot;RECOMMENDED&quot;, &quot;MAY&quot;, and &quot;OPTIONAL&quot; in this document are to be interpreted as described in <span class="ref">RFC 2119</span>  [<a href="#nt-id2596293">4</a>].</p>
<h2>3.
       <a name="roleresp">Roles and Responsibilities</a>
</h2>
  <p class="" style="">This protocol has clearly defined roles and responsibilities for its participants.</p>
  <div class="indent">
<h3>3.1 <a name="roles">Roles</a>
</h3>
    <p class="" style="">The workgroup protocol involves three distinct participants that fill the following roles:</p>
    <ul>
      <li><p class="" style="">
<span style="font-weight: bold">User</span> - The user participant requests a private conversation and drives the workgroup protocol. For examples throughout the rest of this JEP the user will be represented by the address user@server.com/home.</p></li>
      <li><p class="" style="">
<span style="font-weight: bold">Service</span> - The workgroup service receives and sends messages under the workgroup address. The workgroup address represents a general workgroup contact address where users can talk to members of a workgroup without the need to know any particular workgroup member's address. The workgroup service manages the interactions between users and agents. For examples throughout the rest of this JEP the service will be represented by the address support@company.com, representing a common scenario of a workgroup offering customer support for an organization.</p></li>
      <li><p class="" style="">
<span style="font-weight: bold">Agent</span> - The agent is a member of the workgroup and can carry out conversations with users on behalf of their workgroup organization or company. For examples throughout the rest of this JEP two agent addresses will be used: alice@company.com/work and bob@company.com/work.</p></li>
    </ul>
    <p class="" style="">Note: A service MAY contain several queues to help organize, route and handle incoming user chat requests. Implementations supporting multiple queues in a workgroup will respond differently to requests, and send different status information for each queue. Workgroup queues are identified by a unique resource name: e.g. support@company.com/platinum- plan or support@company.com/xmpp-products. Implementation should gracefully handle services with only one queue (using support@company.com) or multiple queues. Users should only be aware of one workgroup (users should never see workgroup queue resource names).</p>
  </div>
  <div class="indent">
<h3>3.2 <a name="responsibilities">Responsibilities</a>
</h3>
    <p class="" style="">Each participant is responsible for certain behaviors in the workgroup protocol.</p>
    <p class="" style="">Users should:</p>
    <ul>
      <li>Know the status of the workgroup queue before requesting a conversation.</li>
      <li>This information allows users to see if the workgroup is available, and how</li>
      <li>long a wait they may have before a chat is initiated.</li>
      <li>Know the status of their request while in the request queue.</li>
      <li>Are able to cancel a chat request at any time.</li>
    </ul>
    <p class="" style="">Workgroup agents should:</p>
    <ul>
      <li>Know the status of the workgroup queue(s).</li>
      <li>Be able to accept or reject requests for conversation.</li>
      <li>Indicate their availability for handling workgroup conversations.</li>
    </ul>
    <p class="" style="">The workgroup service:</p>
    <ul>
      <li>Controls the chat request queue(s).</li>
      <li>Manages the updating of queue status information.</li>
      <li>Determines how users are queued and how queue requests are routed to workgroup members. The queue routing algorithm is beyond the scope of this JEP and left to implementers (simple round-robin, priority based, rules based, etc).</li>
      <li>Maintains its presence, indicating the availability of the workgroup service.</li>
    </ul>
  </div>
<h2>4.
       <a name="proto">Protocol</a>
</h2>
  <p class="" style="">The workgroup protocol consists of several XMPP packet exchanges that occur during the lifetime of the protocol. These packet exchanges change the state of the relationship between user, agent and service.</p>
  <div class="indent">
<h3>4.1 <a name="proto-pres">Workgroup Presence</a>
</h3>
    <p class="" style="">The workgroup is a normal XMPP messaging node and MUST maintain its own presence. We also recommend that the workgroup service be able to respond to arbitrary chat messages sent to it (preferably by responding with instructions on how to join the queue). Other users may subscribe to the workgroup services' presence using standard XMPP presence-subscribe and presence-unsubscribe protocols. The workgroup service's presence can be used to determine the workgroup's status without joining the workgroup as a user or agent. Workgroup presence updates SHOULD contain the queue summary and agent summary meta-data defined in the Agent Status Update Protocol detailed later in this JEP. For example, a website server-side component can subscribe to the workgroup presence and indicate on web pages whether a workgroup is available to offer live chat to website visitors.</p>
  </div>
  <div class="indent">
<h3>4.2 <a name="proto-states">User States</a>
</h3>
    <p class="" style="">Users join the workgroup queue to wait for a conversation with an agent.  Once they have joined the queue, they may receive zero or more status updates from the workgroup service informing them of their status in the queue. Users have the option to cancel their chat request at any time.</p>
    <p class="" style="">When an agent is ready to chat with the user, the user will be sent a standard XMPP groupchat invitation to a chat room. Receipt of the invitation indicates that the user is no longer in the queue and that they should join the chat room using the standard XMPP groupchat protocol in order to converse with an agent. Groupchat is used because it offers several advantages in workgroup conversations including:</p>
    <ul>
      <li>Allowing more than one agent to join the conversation (useful for bringing in experts to join the conversation).</li>
      <li>Allowing managers to monitor conversations for quality of service.</li>
      <li>Creates a simple way of determining what is in a 'conversation' for logging and gathering other statistical information about the conversation.</li>
      <li>Allows a convenient mechanism for bringing 'chatbot' services into the conversation (e.g. answering FAQ, etc).</li>
    </ul>
    <p class="" style="">The user's states and packet exchanges that cause state transitions are shown below:</p>
    <p class="caption"></p>
<div class="indent"><pre>
              +-------+
              | Start |&lt;------+
              +-------+       |
                  |           |
                  | Join      |
                  v           |
             +---------+      |
      +-----&gt;| Queued  |      |
      |      +---------+      |
      | Status |  |  | Depart |
      +--------+  |  +--------+
                  |
                  | Invite
                  v
            +-----------+
            | Chat room |
            +-----------+
    </pre></div>
  </div>
  <div class="indent">
<h3>4.3 <a name="proto-user">User Packet Exchanges</a>
</h3>
    <p class="" style="">Packets are exchanged between the user and service to trigger state changes in the user. These packet exchanges are described next.</p>
    <div class="indent">
<h3>4.3.1 <a name="proto-user-join">User Join Protocol</a>
</h3>
      <p class="" style="">This section describes the packet exchange allowing users to join a workgroup service queue. This protocol MUST be supported by compliant implementations.</p>
      <p class="caption">Example 1. Transactions</p>
<div class="indent"><pre>
User                          Service
  |        Join Request          |
  |-----------------------------&gt;|
  |                              |
  |        Join Response         |
  |&lt;-----------------------------|
  |                              |
      </pre></div>
      <p class="" style="">The user sends a join request to the workgroup service in order to join the workgroup queue. The workgroup service may either accept or reject the request. A user session (e.g. user@server.com/home) may only join the workgroup service queue once. Subsequent, simultaneous joins will result in an error (see error section).</p>
      <p class="" style="">Some workgroups require that the user submit certain information before the user is allowed to join. In these cases, the workgroup will reject the initial join request with a &lt;not-acceptable/&gt; error. The user should then use the Data Forms (JEP-0004) [4] protocol within iq-join-queue to obtain a form, and submit it. Once the server accepts the submitted data, the user join should be retried.</p>
      <p class="caption">Example 2. Request Element</p>
<div class="indent"><pre>
U: &lt;iq to='service-jid' from='user-jid' id='id' type='set'&gt;
U:   &lt;join-queue xmlns='http://jabber.org/protocol/workgroup'&gt;
U:     &lt;queue-notifications/&gt;
U:   &lt;/join-queue&gt;
U: &lt;/iq&gt;
      </pre></div>
      <p class="" style="">The request may contain meta-data to help the service determine queuing of the user or Data Forms data when submitting form information. There is one optional standard workgroup sub-element of &lt;join-queue&gt;:</p>
      <ul>
        <li>&lt;queue-notifications/&gt; - if present, indicates the user would like to receive user status updates about its state in the queue.</li>
      </ul>
      <p class="" style="">A successful join results in a success response:</p>
      <p class="caption">Example 3. Response Element</p>
<div class="indent"><pre>
S: &lt;iq to='user-jid' from='service-jid' id='id' type='result'&gt;
S:    &lt;join-queue xmlns='http://jabber.org/protocol/workgroup'&gt;
S:      &lt;queue-notifications/&gt;
S:    &lt;/join-queue&gt;
S: &lt;/iq&gt;
      </pre></div>
      <p class="" style="">If the user indicated interest in their queue status information, the supported status updates that will be sent by the server is included in the response. Compliant implementations do not have to support any status update types. Status updates requested by the user and supported by the server will be pushed to the user by the service until the user departs or is invited to a chat room.</p>
      <div class="indent">
<h3>4.3.1.1 <a name="proto-user-join-errors">Error Conditions</a>
</h3>
        <p class="caption">Table 1: </p>
<table border="1" cellpadding="3" cellspacing="0">
          <tr class="body">
<th colspan="" rowspan="">Condition</th>
<th colspan="" rowspan="">Description</th>
</tr>
          <tr class="body">
<td align="" colspan="" rowspan="">&lt;not-authorized/&gt;</td>
<td align="" colspan="" rowspan="">The user is not authorized to join the queue. A determination of who has permission to join a queue is left to implementations.</td>
</tr>
          <tr class="body">
<td align="" colspan="" rowspan="">&lt;item-not-found/&gt;</td>
<td align="" colspan="" rowspan="">The address the user requests a chat with does not exist or is not a workgroup. Compliant workgroup service implementations MUST NOT return this error if the requested address is a valid workgroup.</td>
</tr>
          <tr class="body">
<td align="" colspan="" rowspan="">&lt;not-acceptable/&gt;</td>
<td align="" colspan="" rowspan="">The user must submit valid form data (using the Data Forms protocol [4]) before joining the queue. Note that this error is sent when user tries to join, or if the user submits form data that is not filled out correctly.</td>
</tr>
          <tr class="body">
<td align="" colspan="" rowspan="">&lt;conflict/&gt;</td>
<td align="" colspan="" rowspan="">The user has already joined the queue.</td>
</tr>
          <tr class="body">
<td align="" colspan="" rowspan="">&lt;service-unavailable/&gt;</td>
<td align="" colspan="" rowspan="">The workgroup is valid but closed (not accepting new join-queue requests). </td>
</tr>
        </table>
      </div>
      <div class="indent">
<h3>4.3.1.2 <a name="proto-user-join-example">Example</a>
</h3>
        <p class="" style="">The following protocol flows show an example of a user successfully joining a workgroup queue for support@company.com.</p>
        <p class="caption">Example 4. Successful Join</p>
<div class="indent"><pre>
U: &lt;iq type='set'
U:     from='user@server.com/home'
U:       to='support@company.com'
U:       id='id1'&gt;
U:   &lt;join-queue xmlns='http://jabber.org/protocol/workgroup'&gt;
U:     &lt;queue-notifications/&gt;
U:   &lt;/join-queue&gt;
U: &lt;/iq&gt;
S: &lt;iq type='result'
S:     from='support@company.com'
S:       to='user@server.com/home'
S:       id='id1'&gt;
S:   &lt;join-queue xmlns='http://jabber.org/protocol/workgroup'&gt;
S:     &lt;queue-notifications/&gt;
S:   &lt;/join-queue&gt;
S: &lt;/iq&gt;
        </pre></div>
        <p class="" style="">The following XML is another example where meta-data is sent by the user to assist the workgroup server in queuing and routing (naturally, the custom namespace that qualified the &lt;crm/&gt; element in this example would be defined outside the context of this specification). The service does not support the requested &lt;queue-notifications&gt; status updates and indicates this by not including it in the response.</p>
        <p class="caption">Example 5. Join With Meta-Data</p>
<div class="indent"><pre>
U: &lt;iq type='set'
U:     from='user@server.com/home'
U:       to='support@company.com'
U:       id='id2'&gt;
U:   &lt;join-queue xmlns='http://jabber.org/protocol/workgroup'&gt;
U:     &lt;crm xmlns=&quot;http://www.company.com/xmpp/workgroup&quot;&gt;
U:       &lt;customer-id&gt;the24th498onth&lt;/customer-id&gt;
U:       &lt;referrer&gt;
U:         http://www.company.com/portal/
U:       &lt;/referrer&gt;
U:       &lt;product&gt;Widget 1.0&lt;/product&gt;
U:     &lt;/crm&gt;
U:     &lt; queue-notifications/&gt;
U:   &lt;/join-queue&gt;
U: &lt;/iq&gt;
S: &lt;iq type='result'
S:     from='support@company.com'
S:       to='user@server.com/home'
S:       id='id2'/&gt;
        </pre></div>
        <p class="" style="">Finally an example of a required form submission before a user is allowed to the workgroup queue for support@company.com. The data form in this example is trivial; please see the Data Forms specification [4] for a complete data form example. The example begins as normal, but the workgroup returns a &lt;not-acceptable/&gt; error.</p>
        <p class="caption">Example 6. Join With Form</p>
<div class="indent"><pre>
U: &lt;iq type='set'
U:     from='user@server.com/home'
U:       to='support@company.com'
U:       id='id1'&gt;
U:   &lt;join-queue xmlns='http://jabber.org/protocol/workgroup'&gt;
U:     &lt;queue-notifications/&gt;
U:   &lt;/join-queue&gt;
U: &lt;/iq&gt;
S: &lt;iq type='error'
S:     from='support@company.com'
S:       to='user@server.com/home'
S:       id='id1'&gt;
S:   &lt;error code='406' type='modify'&gt;
S:     &lt;not-acceptable xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/&gt;
S:   &lt;/error&gt;
S: &lt;/iq&gt;
        </pre></div>
        <p class="" style="">The &lt;not-acceptable/&gt; error indicates that a data form is required. The user requests the required data form from the workgroup.</p>
        <p class="caption">Example 7. Join With Form (2)</p>
<div class="indent"><pre>
U: &lt;iq type='get'
U:     from='user@server.com/home'
U:       to='support@company.com'
U:       id='id2'&gt;
U:   &lt;join-queue xmlns='http://jabber.org/protocol/workgroup'/&gt;
U: &lt;/iq&gt;
S: &lt;iq type='result'
S:     from='support@company.com'
S:       to='user@server.com/home'
S:       id='id2'&gt;
S:   &lt;join-queue xmlns='http://jabber.org/protocol/workgroup'&gt;
S:     &lt;x xmlns='jabber:iq:data' type='form'&gt;
S:       &lt;title&gt;Support.com Chat Customer Information&lt;/title&gt;
S:       &lt;instructions&gt;Welcome to support.com! Please provide us with
S:         some information about yourself so we can serve you better.
S:       &lt;/instructions&gt;
S:       &lt;field type='text-single' label='First Name' var='first' /&gt;
S:       &lt;field type='text-single' label='Last Name' var='last' /&gt;
S:       &lt;field type='list-single' label='Contract Type'
var='contract_type'&gt;
S:         &lt;value&gt;0&lt;/value&gt;
S:         &lt;option label='None'&gt;&lt;value&gt;0&lt;/value&gt;&lt;/option&gt;
S:         &lt;option label='Bronze'&gt;&lt;value&gt;1&lt;/value&gt;&lt;/option&gt;
S:         &lt;option label='Silver'&gt;&lt;value&gt;2&lt;/value&gt;&lt;/option&gt;
S:         &lt;option label='Gold'&gt;&lt;value&gt;3&lt;/value&gt;&lt;/option&gt;
S:       &lt;/field&gt;
S:     &lt;/x&gt;
S:   &lt;/join-queue&gt;
S: &lt;/iq&gt;
        </pre></div>
        <p class="" style="">After presenting the form to the user and gathering the form data, the user submits the form data to the workgroup and the workgroup accepts it.</p>
        <p class="caption">Example 8. Join With Form (3)</p>
<div class="indent"><pre>
U: &lt;iq type='set'
U:     from='user@server.com/home'
U:       to='support@company.com'
U:       id='id3'&gt;
U:   &lt;join-queue xmlns='http://jabber.org/protocol/workgroup'&gt;
U:     &lt;x xmlns='jabber:iq:data' type='submit'&gt;
U:       &lt;field var='first'&gt;&lt;value&gt;John&lt;/value&gt;&lt;/field&gt;
U:       &lt;field var='last'&gt;&lt;value&gt;Doe&lt;/value&gt;&lt;/field&gt;
U:       &lt;field var='contract_type'&gt;&lt;value&gt;2&lt;/value&gt;&lt;/field&gt;
U:     &lt;/x&gt;
U:   &lt;/join-queue&gt;
U: &lt;/iq&gt;
S: &lt;iq type='result'
S:     from='support@company.com'
S:       to='user@server.com/home'
S:       id='id3' /&gt;
        </pre></div>
        <p class="" style="">A standard user join is attempted again. The workgroup now has the required form data so it allows the user to join.</p>
        <p class="caption">Example 9. Join With Form (4)</p>
<div class="indent"><pre>
U: &lt;iq type='set'
U:     from='user@server.com/home'
U:       to='support@company.com'
U:       id='id4'&gt;
U:   &lt;join-queue xmlns='http://jabber.org/protocol/workgroup'&gt;
U:     &lt;queue-notifications/&gt;
U:   &lt;/join-queue&gt;
U: &lt;/iq&gt;
S: &lt;iq type='result'
S:     from='support@company.com'
S:       to='user@server.com/home'
S:       id='id4'&gt;
S:   &lt;join-queue xmlns='http://jabber.org/protocol/workgroup'&gt;
S:     &lt;queue-notifications/&gt;
S:   &lt;/join-queue&gt;
S: &lt;/iq&gt;
        </pre></div>
      </div>
    </div>
    <div class="indent">
<h3>4.3.2 <a name="proto-user-depart">User Depart Protocol</a>
</h3>
      <p class="" style="">Describes the packet exchange allowing users to depart a workgroup service queue, or for a workgroup service to remove a user from the workgroup queue. This protocol MUST be supported by compliant implementations.</p>
      <p class="" style="">The user no longer wishes to be in the queue and issues a depart queue command.</p>
      <p class="caption">Example 10. Transactions</p>
<div class="indent"><pre>
Requester                     Service
  |        Depart Request        |
  |-----------------------------&gt;|
  |        Depart Response       |
  |&lt;-----------------------------|
  |                              |
      </pre></div>
      <p class="" style="">The service notifies the user that they have been removed from the workgroup queue.</p>
      <p class="caption">Example 11. Transactions (2)</p>
<div class="indent"><pre>
User                          Service
  |        Depart Message        |
  |&lt;-----------------------------|
  |                              |
      </pre></div>
      <p class="caption">Example 12. Depart Request</p>
<div class="indent"><pre>
U: &lt;iq from='user-jid' to='service-jid' id='id' type='set'&gt;
U:   &lt;depart-queue xmlns='http://jabber.org/protocol/workgroup'/&gt;
U: &lt;/iq&gt;
      </pre></div>
      <p class="" style="">In the typical case, the sender is the user departing the queue. However, it is possible for other users (system administrators for example) to request that another user be removed from the queue. In this case, the jid of the user who is departing is included in the depart request:</p>
      <p class="caption">Example 13. Depart Request With JID</p>
<div class="indent"><pre>
U: &lt;iq from='admin-jid' to='service-jid' id='id' type='set'&gt;
U:   &lt;depart-queue xmlns='http://jabber.org/protocol/workgroup'&gt;
U:     &lt;jid&gt;user-jid&lt;/jid&gt;
U:   &lt;/depart-queue&gt;
U: &lt;/iq&gt;
      </pre></div>
      <p class="" style="">It is expected that implementations will determine who is allowed to remove other users from the queue based on an implementation specific permissions model. These administrator depart requests may result in &lt;not-authorized/&gt; errors (see error section). A user removing their own queue entry MUST NOT receive unauthorized errors (the workgroup service may not refuse to allow a user to depart the queue).</p>
      <p class="" style="">The sender of the depart request receives a successful result packet:</p>
      <p class="caption">Example 14. Depart Request</p>
<div class="indent"><pre>
S: &lt;iq from='service-jid' to=user-jid' id='id' type='result'/&gt;
      </pre></div>
      <p class="" style="">And the user who is departing receives a depart message (the user may not have been the sender of the request):</p>
      <p class="caption">Example 15. Depart Message</p>
<div class="indent"><pre>
S: &lt;message from='service-jid' to='user-jid'&gt;
S:    &lt;depart-queue xmlns='http://jabber.org/protocol/workgroup'/&gt;
S: &lt;/message&gt;
      </pre></div>
      <p class="" style="">The user will not be in the queue after a response is received unless the error response code is &lt;not-authorized/&gt;.</p>
      <div class="indent">
<h3>4.3.2.1 <a name="proto-user-depart-errors">Error Conditions</a>
</h3>
        <p class="caption">Table 2: </p>
<table border="1" cellpadding="3" cellspacing="0">
          <tr class="body">
<th colspan="" rowspan="">Condition</th>
<th colspan="" rowspan="">Description</th>
</tr>
          <tr class="body">
<td align="" colspan="" rowspan="">&lt;not-authorized/&gt;</td>
<td align="" colspan="" rowspan="">The sender did not have permission to remove the user from the queue. This error code MUST NOT be used when a user is removing their queue entry.</td>
</tr>
          <tr class="body">
<td align="" colspan="" rowspan="">&lt;item-not-found/&gt;</td>
<td align="" colspan="" rowspan="">The user was not in the queue.</td>
</tr>
        </table>
      </div>
      <div class="indent">
<h3>4.3.2.2 <a name="proto-user-depart-example">Example</a>
</h3>
        <p class="" style="">A user leaves the workgroup queue support@company.com.</p>
        <p class="caption">Example 16. User Departs</p>
<div class="indent"><pre>
U: &lt;iq from='user@server.com/home'
U:       to='support@company.com'
U:       id='id1'
U:     type='set'&gt;
U:   &lt;depart-queue xmlns='http://jabber.org/protocol/workgroup'/&gt;
U: &lt;/iq&gt;
S: &lt;iq from='support@company.com'
S:     to='user@server.com/home'
S:     id='id1'
S:     type='result'/&gt;
S: &lt;message from='support@company.com' to='user@server.com/home'&gt;
S:    &lt;depart-queue xmlns='http://jabber.org/protocol/workgroup'/&gt;
S: &lt;/message&gt;
        </pre></div>
        <p class="" style="">An administrator removes a user from the workgroup queue support@company.com. Notice that the depart-queue message is sent to the user that has left the queue.</p>
        <p class="caption">Example 17. Administrator Removes User</p>
<div class="indent"><pre>
U: &lt;iq from='admin@company.com/work'
U:       to='support@company.com'
U:       id='id1'
U:     type='set'&gt;
U:   &lt;depart-queue xmlns='http://jabber.org/protocol/workgroup'&gt;
U:     &lt;jid&gt;user@server.com/home&lt;/jid&gt;
U:   &lt;/depart-queue&gt;
U: &lt;/iq&gt;
S: &lt;iq from='support@company.com'
S:     to='admin@company.com/work'
S:     id='id1'
S:     type='result'/&gt;
S: &lt;message from='support@company.com' to='user@server.com/home'&gt;
S:    &lt;depart-queue xmlns='http://jabber.org/protocol/workgroup'/&gt;
S: &lt;/message&gt;
        </pre></div>
      </div>
    </div>
    <div class="indent">
<h3>4.3.3 <a name="proto-user-status">User Status Update Protocol</a>
</h3>
      <p class="" style="">Describes the packet exchange for updating users on their queue status.  This protocol MAY be supported by compliant implementations.</p>
      <p class="caption">Example 18. Transactions</p>
<div class="indent"><pre>
User                          Service
  |      User Status Push        |
  |&lt;-----------------------------|
  |      User Status Ack         |
  |-----------------------------&gt;|
  |                              |
  |     User Status Request      |
  |-----------------------------&gt;|
  |     User Status Response     |
  |&lt;-----------------------------|
  |                              |
      </pre></div>
      <p class="" style="">The workgroup service pushes updates to the user as their queue status changes and the user may request their queue status at any time.</p>
      <div class="indent">
<h3>4.3.3.1 <a name="proto-user-status-updates">User Status Updates</a>
</h3>
        <p class="" style="">User status updates are contained in a &lt;queue-status/&gt; element that updates the user on their queue position and estimated time. The position contained in a &lt;position&gt; sub-element is a non-negative integer indicating the number of queue entries that must be routed to an agent before the user is routed to an agent. A position of 0 (zero) indicates the user is currently being routed. Clients may use this information to display the current queue position to the user.</p>
        <p class="" style="">The queue time status is contained in a &lt;time/&gt; sub-element that updates the user with the estimated time until they will be routed to an agent. The time is a non-negative integer indicating the estimated number of seconds remaining before being routed. Services should send this update at regular intervals. We recommend every 15 seconds, but the best solution will depend on application dependent factors and the service may decide to send updates at any interval or never (relying on the client to request the information). User clients should assume the estimated time counts down at a rate of one second per second between status updates. Clients may use this information to display the running estimated time to the user.</p>
        <p class="" style="">A server 'push' occurs asynchronously to client, and the client acknowledges the update:</p>
        <p class="caption">Example 19. User Status Push</p>
<div class="indent"><pre>
S: &lt;iq to='user-jid' from='service-jid' id='id' type='set'&gt;
S:   &lt;queue-status xmlns='http://jabber.org/protocol/workgroup'&gt;
S:     &lt;position&gt;4&lt;/position&gt;
S:     &lt;time&gt;60&lt;/time&gt;
S:   &lt;/queue-status&gt;
S: &lt;/iq&gt;
U: &lt;iq to='service-jid' from='user-jid' id='id' type='result'/&gt;
        </pre></div>
        <p class="" style="">Alternately the client may poll their position:</p>
        <p class="caption">Example 20. User Status Poll</p>
<div class="indent"><pre>
U: &lt;iq to='service-jid' from='user-jid' id='id' type='get'&gt;
U:   &lt;queue-status xmlns='http://jabber.org/protocol/workgroup'/&gt;
U: &lt;/iq&gt;
S: &lt;iq to='user-jid' from='service-jid' id='id' type='result'&gt;
S:   &lt;queue-status xmlns='http://jabber.org/protocol/workgroup'&gt;
S:     &lt;position&gt;4&lt;/position&gt;
S:     &lt;time&gt;60&lt;/time&gt;
S:   &lt;/queue-status&gt;
S: &lt;/iq&gt;
        </pre></div>
      </div>
      <div class="indent">
<h3>4.3.3.2 <a name="proto-user-status-errors">Error Conditions</a>
</h3>
        <p class="caption">Table 3: </p>
<table border="1" cellpadding="3" cellspacing="0">
          <tr class="body">
<th colspan="" rowspan="">Condition</th>
<th colspan="" rowspan="">Description</th>
</tr>
          <tr class="body">
<td align="" colspan="" rowspan="">&lt;not-authorized/&gt;</td>
<td align="" colspan="" rowspan="">Sent by the server to the user in response to a status query only if the user is not a member of the queue.</td>
</tr>
          <tr class="body">
<td align="" colspan="" rowspan="">&lt;feature-not-implemented/&gt;</td>
<td align="" colspan="" rowspan="">Sent only if status updates are not implemented in either the client or server.</td>
</tr>
        </table>
      </div>
      <div class="indent">
<h3>4.3.3.3 <a name="proto-user-status-example">Example</a>
</h3>
        <p class="" style="">A user receives a position update from the workgroup queue support@company.com.</p>
        <p class="caption">Example 21. Position Update</p>
<div class="indent"><pre>
S: &lt;iq from='support@company.com'
S:       to='user@server.com/home'
S:       id='id1'
S:     type='set'&gt;
S:   &lt;queue-status xmlns='http://jabber.org/protocol/workgroup'&gt;
S:     &lt;position&gt;4&lt;/position&gt;
S:     &lt;time&gt;60&lt;/time&gt;
S:   &lt;/queue-status&gt;
S: &lt;/iq&gt;
U: &lt;iq from='user@server.com/home'
U:       to='support@company.com'
U:       id='id1'
U:     type='result'/&gt;
        </pre></div>
      </div>
    </div>
    <div class="indent">
<h3>4.3.4 <a name="proto-user-invite">User Invite Protocol</a>
</h3>
      <p class="" style="">This section describes the packet exchange for inviting a queued user to a chat room for conversation with an agent. This protocol MUST be supported by compliant implementations.</p>
      <p class="caption">Example 22. Transactions</p>
<div class="indent"><pre>
User                          Service
  |          User Invite         |
  |&lt;-----------------------------|
  |                              |
      </pre></div>
      <p class="" style="">The server sends a standard JEP-0045 groupchat invitation to the user to begin their conversation with an agent.</p>
      <p class="" style="">User invitations use JEP-0045 standard multi-user chat invitations. The invitation indicates that the user is no longer in the workgroup queue. The user MUST NOT receive any more user queue status updates once they receive an invitation.</p>
      <p class="" style="">In order to match invitations to offers, all invitations should carry meta data in the workgroup namespace in the 'workgroup' element with a 'user' and 'agent' attribute set to the address of each party in the invite. The typical meta-data fragment would appear as:</p>
      <p class="caption">Example 23. Invitation Meta-Data</p>
<div class="indent"><pre>
&lt;workgroup user='user-jid' agent='agent-jid'/&gt;
      </pre></div>
      <div class="indent">
<h3>4.3.4.1 <a name="proto-user-invite-errors">Error Conditions</a>
</h3>
        <p class="" style="">There are no valid error conditions for user invitations.</p>
      </div>
      <div class="indent">
<h3>4.3.4.2 <a name="proto-user-invite-example">Example</a>
</h3>
        <p class="" style="">An invitation from the support@server.com workgroup:</p>
        <p class="caption">Example 24. An Invitation</p>
<div class="indent"><pre>
&lt;message from='support@company.com' to='user@server.com/home&gt;
  &lt;body&gt;You have been invited to chat with a support@company.com
agent.&lt;/body&gt;
  &lt;x jid='roomname@chatserver.company.com' xmlns='jabber:x:conference'/&gt;
  &lt;workgroup xmlns='http://jabber.org/protocol/workgroup'
             user='user@server.com/home'
             agent='agent-alice@company.com/work'/&gt;
&lt;/message&gt;
        </pre></div>
      </div>
    </div>
  </div>
  <div class="indent">
<h3>4.4 <a name="proto-agent-states">Agent States</a>
</h3>
    <p class="" style="">Agents join a workgroup to indicate they are capable of handling conversations with users. Agent membership in the workgroup is expected to be a long term, persistent relationship similar to roster membership. For example, a customer support agent may join the support@company.com workgroup when they begin working at company.com and will only depart when they leave that position.  The wide variety of relationships, processes and permissions associated with joining and leaving workgroups lies outside the scope of this JEP.</p>
    <p class="" style="">Once an agent has joined a workgroup they will receive workgroup status updates to inform them of the status of other members of the workgroup.  Agents are responsible for updating the workgroup service with their presence so the service can intelligently route chat requests to the 'best' agent. Workgroup agent presence uses standard XMPP presence packets with optional meta-data to help routing of chat requests to agents. Some meta- data will be standard and defined later in this JEP. It is expected that other deployment specific meta-data will also be needed to make routing decisions.</p>
    <p class="" style="">The general agent workgroup state diagram is shown below:</p>
    <p class="caption"></p>
<div class="indent"><pre>
            +-----------+
      +----&gt;| Workgroup |&lt;-----+
      |     +-----------+      |
      |        |     |Agent    |
      | Status |     |Presence |
      +--------+     +---------+
    </pre></div>
    <p class="" style="">Once an agent has joined a workgroup and is available, the agent will receive offers to chat with users by the workgroup service. Chat offers will be made to the agent and the agent has the opportunity to accept or reject each offer. The workgroup service may also revoke an offer. For example, a service may revoke chat offers if the offer is not responded to within a certain period of time to ensure fast responses to user chat requests.</p>
    <p class="" style="">Once an offer has been accepted, the agent must wait for a standard groupchat invitation from the workgroup service. The workgroup service may revoke the offer at this stage of the protocol as well. This enables workgroup services to send offers to several agents in parallel, and choose the 'best' agent that accepts. A diagram showing the agent workgroup sub- states and transitions is shown below:</p>
    <p class="caption"></p>
<div class="indent"><pre>
              +-------+
              | Start |&lt;---------+
              +-------+          |
                  |              |
                  | Offer        |
                  v              |
            +---------------+    |
            | Offer Pending |    |
            +---------------+    |
                 |  |  | Revoke  |
                 |  |  +--------&gt;|
                 |  | Reject     |
          Accept |  +-----------&gt;|
                 v               |
            +--------------+     |
            | Chat Pending |     |
            +--------------+     |
                 |   | Revoke    |
          Invite |   +-----------+
                 V
              +-----------+
              | Chat room |
              +-----------+
    </pre></div>
  </div>
  <div class="indent">
<h3>4.5 <a name="proto-agent">Agent Packet Exchanges</a>
</h3>
    <p class="" style="">Packets are exchanged between the agent and service to trigger state changes in the agent client. These packet exchanges are described next.</p>
    <div class="indent">
<h3>4.5.1 <a name="proto-agent-presence">Agent Presence Protocol</a>
</h3>
      <p class="" style="">Describes the packet exchange allowing agents to update a workgroup with their current presence. This protocol MUST be supported by compliant implementations.</p>
      <p class="caption">Example 25. Transactions</p>
<div class="indent"><pre>
Agent                         Service
  |       Presence Update        |
  |-----------------------------&gt;|
  |                              |
      </pre></div>
      <p class="" style="">The agent must inform the workgroup of its presence by sending it a presence update packet. Agent presence updates use standard XMPP presence with optional meta-data. However, there must always be an agent-status workgroup sub-element in the presence packet to indicate that the presence update relates to agent workgroup presence. Agent workgroup presence is designed to allow a separation between the agent's normal XMPP presence (server-managed via rosters) and their presence with the workgroup.</p>
      <p class="caption">Example 26. Presence Update</p>
<div class="indent"><pre>
U: &lt;presence from='agent-jid' to='service-jid' id='id'&gt;
U:   &lt;agent-status xmlns='http://jabber.org/protocol/workgroup'&gt;
U:     &lt;max-chats&gt;count&lt;/max-chats&gt;
U:     &lt;current-chats&gt;count&lt;/current-chats&gt;
U:   &lt;/agent-status&gt;
U: &lt;/presence&gt;
      </pre></div>
      <p class="" style="">Agent presence updates use standard XMPP presence packets and should contain the normal sub elements as needed (e.g. &lt;show/&gt;, &lt;status/&gt;, etc) and can be of type='unavailable' to indicate the agent is not available for workgroup routing or for receiving workgroup agent updates. The standard XMPP show states have specific meaning within the context of the workgroup protocol:</p>
      <ul>
        <li>chat - Indicates the agent is available to chat (is idle and ready to handle more conversations).</li>
        <li>away - The agent is busy (possibly with other chats). The agent may still be able to handle other chats but an offer rejection is likely.</li>
        <li>xa - The agent is physically away from their terminal and should not have a chat routed to them.</li>
        <li>dnd - The agent is busy and should not be disturbed. However, special case, or extreme urgency chats may still be offered to the agent although offer rejection or offer timeouts are highly likely.</li>
      </ul>
      <p class="" style="">Agents may also wish to embed meta-data to help the workgroup service route chat requests. The two optional standard presence updates in the workgroup namespace are:</p>
      <ul>
        <li><p class="" style="">&lt;max-chats&gt; - The maximum number of chats the agent can handle. If a presence is sent to the workgroup that does not contain the max-chats value, the &quot;default setting&quot; will be assumed. The value of the default setting for an agent is up to an implementation.   [<a href="#nt-id2603775">5</a>]</p></li>
        <li><p class="" style="">&lt;current-chats&gt; - The number of chats the agent is currently handling. The number of chats the agent is handling may include chats outside of the workgroup (e.g. the agent is working in more than one workgroup), normal IM/chat conversations, and includes possible 'team' chats where multiple agents are chatting with a single user. Since it is impossible for the server to track all these interactions reliably, the agent must properly report the number of current chats the agent is engaged in. If a presence is sent to the workgroup that does not contain the current-chats value, the current chat value is assumed to be zero.  [<a href="#nt-id2603824">6</a>]</p></li>
      </ul>
      <div class="indent">
<h3>4.5.1.1 <a name="proto-agent-presence-errors">Error Conditions</a>
</h3>
        <p class="" style="">There are no valid error conditions for presence updates.</p>
      </div>
      <div class="indent">
<h3>4.5.1.2 <a name="proto-agent-presence-example">Example</a>
</h3>
        <p class="" style="">An agent becomes available to the workgroup support@company.com.</p>
        <p class="caption">Example 27. Agent Becomes Available</p>
<div class="indent"><pre>
U: &lt;presence from='agent-alice@company.com/work'
U:             to='support@company.com'
U:             id='id1'&gt;
U:   &lt;show&gt;chat&lt;/show&gt;
U:   &lt;agent-status xmlns='http://jabber.org/protocol/workgroup'&gt;
U:     &lt;max-chats&gt;3&lt;/max-chats&gt;
U:     &lt;current-chats&gt;0&lt;/current-chats&gt;
U:   &lt;/agent-status&gt;
U: &lt;/presence&gt;
        </pre></div>
      </div>
    </div>
    <div class="indent">
<h3>4.5.2 <a name="proto-agent-status">Agent Status Update Protocol</a>
</h3>
      <p class="" style="">This section describes the packet exchange used to update agents on the status of the workgroup. This protocol MAY be supported by compliant implementations.</p>
      <p class="caption">Example 28. Transactions</p>
<div class="indent"><pre>
Agent                         Service
  |         Agent Status         |
  |&lt;-----------------------------|
  |                              |
      </pre></div>
      <p class="" style="">The workgroup service pushes updates to the agent as the workgroup and queue status changes.</p>
      <p class="" style="">There are four standard status types currently defined. The first is , which updates the agent on the detailed status of other agents in the workgroup. All fields except for the embedded &lt;presence&gt; are optional:</p>
      <p class="caption">Example 29. Agent Status Type</p>
<div class="indent"><pre>
S: &lt;presence to='agent-jid' from='service-jid' id='id'&gt;
S:   &lt;agent-status xmlns='http://jabber.org/protocol/workgroup'&gt;
S:     &lt;agent jid='agent-jid'&gt;
S:       &lt;presence&gt;standard XMPP presence attributes&lt;/presence&gt;
S:       &lt;current-chats&gt;count&lt;/current-chats&gt;
S:       &lt;max-chats&gt;max&lt;/max-chats&gt;
S:     &lt;/agent&gt;
S:   &lt;/agent-status&gt;
S: &lt;/presence&gt;
      </pre></div>
      <p class="" style="">An update may contain one or more agent entries detailing the current status of other agents in the workgroup. The defined sub-elements of &lt;agent&gt; are:</p>
      <ul>
        <li><p class="" style="">&lt;presence&gt; - Required. Standard XMPP presence packet indicating the current presence of the agent reported to the workgroup.</p></li>
        <li><p class="" style="">&lt;current-chats&gt; - The number of conversations currently being handled by the agent.</p></li>
        <li><p class="" style="">&lt;max-chats&gt; - The maximum number of simultaneous conversations the agent can handle.</p></li>
      </ul>
      <p class="" style="">The second defined agent status type is , which updates the agent with a summary of the status of agents in the workgroup. All fields are optional:</p>
      <p class="caption">Example 30. Notify-Agent Status Type</p>
<div class="indent"><pre>
S: &lt;presence to='agent-jid' from='service-jid' id='id'&gt;
S:   &lt;notify-agents xmlns='http://jabber.org/protocol/workgroup'&gt;
S:     &lt;available&gt;count&lt;/available&gt;
S:     &lt;current-chats&gt;count&lt;/current-chats&gt;
S:     &lt;max-chats&gt;max&lt;/max-chats&gt;
S:   &lt;/notify-agents&gt;
S: &lt;/presence&gt;
      </pre></div>
      <p class="" style="">The defined sub-elements of &lt;notify-agents&gt; are:</p>
      <ul>
        <li><p class="" style="">&lt;available&gt; - The total number of agents available in the workgroup.</p></li>
        <li><p class="" style="">&lt;current-chats&gt; - The current total number of chats being handled by agents in the workgroup.</p></li>
        <li><p class="" style="">&lt;max-chats&gt; - The maximum number of simultaneous conversations that can be handled by agents in the workgroup.</p></li>
      </ul>
      <p class="" style="">The third defined agent status type is , which updates the agent with details on the status of the workgroup queue. All fields are optional:</p>
      <p class="caption">Example 31. Notify-Queue-Details Status Type</p>
<div class="indent"><pre>
S: &lt;presence to='agent-jid' from='service-jid' id='id'&gt;
S:   &lt;notify-queue-details xmlns='http://jabber.org/protocol/workgroup'&gt;
S:     &lt;user jid='user-jid'&gt;
S:       &lt;position&gt;pos&lt;/position&gt;
S:       &lt;time&gt;estimated-time&lt;/time&gt;
S:       &lt;join-time&gt;YYYYMMDDTHH:mm:SS&lt;/join-time&gt;
S:     &lt;/user&gt;
S:   &lt;/notify-queue-details&gt;
S: &lt;/presence&gt;
      </pre></div>
      <p class="" style="">An update may contain one or more &lt;user&gt; entries (one per user in the queue whose status has changed). The defined sub-elements of &lt;user&gt; are:</p>
      <ul>
        <li><p class="" style="">&lt;position&gt; - The user's position in the queue.</p></li>
        <li><p class="" style="">&lt;time&gt; - Estimated time in seconds remaining before the user is routed to an agent.</p></li>
        <li><p class="" style="">&lt;join-time&gt; - The date and time the user joined the queue in UTC.</p></li>
      </ul>
      <p class="" style="">The fourth defined user status type is , which updates the agent with a summary of the status of the workgroup queue. All fields are optional:</p>
      <p class="caption">Example 32. Notify-Queue Status Type</p>
<div class="indent"><pre>
S: &lt;presence to='agent-jid' from='service-jid' id='id'&gt;
S:   &lt;notify-queue xmlns='http://jabber.org/protocol/workgroup'&gt;
S:     &lt;count&gt;count&lt;/count&gt;
S:     &lt;oldest&gt;YYYYMMDDTHH:mm:ss&lt;/oldest&gt;
S:     &lt;time&gt;average-time-to-chat&lt;/time&gt;
S:     &lt;status&gt;open&lt;/status&gt;
S:   &lt;/notify-queue&gt;
S: &lt;/presence&gt;
      </pre></div>
      <p class="" style="">The defined sub-elements of &lt;lnotify-queue&gt; are:</p>
      <ul>
        <li><p class="" style="">&lt;count&gt; - The total number of users in the workgroup queue.</p></li>
        <li><p class="" style="">&lt;oldest&gt; - The date and time in UTC the oldest member of the queue joined.</p></li>
        <li><p class="" style="">&lt;time&gt; - The average time in seconds that a user is in the queue before they are routed to an agent for handling.</p></li>
        <li>
          <p class="" style="">&lt;status&gt; - The status of the queue. Queues may be active (requests are being routed and handled by agents) but not accepting new requests for handling. Typical reasons for this state include the queue is shutting down but finishing processing users in the queue, or because the queue has too many requests and should not accept more request until the existing requests are handled. The status field MUST contain one of the following values:</p>
          <ul>
            <li>open - the queue is active and accepting new chat requests</li>
            <li>active - the queue is active but NOT accepting new chat requests</li>
            <li>closed - the queue is NOT active and NOT accepting new chat requests</li>
          </ul>
        </li>
      </ul>
      <div class="indent">
<h3>4.5.2.1 <a name="proto-agent-status-errors">Error Conditions</a>
</h3>
        <p class="" style="">There are no valid error conditions for agent status updates.</p>
      </div>
      <div class="indent">
<h3>4.5.2.2 <a name="proto-agent-status-example">Example</a>
</h3>
        <p class="" style="">An agent receives an update from workgroup support@company.com.</p>
        <p class="caption">Example 33. Agent Receives Update</p>
<div class="indent"><pre>
S: &lt;presence from='support@company.com'
S:             to='agent-alice@company.com/work'
S:             id='id1'&gt;
S:   &lt;agent-status xmlns='http://jabber.org/protocol/workgroup'&gt;
S:       &lt;available&gt;7&lt;/available&gt;
S:       &lt;current-chats&gt;12&lt;/current-chats&gt;
S:       &lt;max-chats&gt;21&lt;/max-chats&gt;
S:   &lt;/agent-status&gt;
S: &lt;/presence&gt;
        </pre></div>
      </div>
    </div>
    <div class="indent">
<h3>4.5.3 <a name="proto-agent-offer">Agent Offer Protocol</a>
</h3>
      <p class="" style="">This section describes the packet exchange involved in a service offering a chat to an agent. This protocol MUST be supported by compliant implementations.</p>
      <p class="caption">Example 34. Transactions</p>
<div class="indent"><pre>
Agent                         Service
  |         Offer Request        |
  |&lt;-----------------------------|
  |         Offer Response       |
  |-----------------------------&gt;|
  |                              |
      </pre></div>
      <p class="" style="">The agent is offered a chat with a user. A successful offer results in the agent owning the offer, but does not mean it has accepted the chat.  Accepting an offer is handled by the Agent Accept protocol. The separation between offer and acceptance is made so that agents may receive offers while engaged in other activities (busy with other chats) and accept them at a later time.</p>
      <p class="caption">Example 35. Offer Request</p>
<div class="indent"><pre>
S: &lt;iq from='service-jid' to='agent-jid' id='id' type='set'&gt;
S:   &lt;offer xmlns='http://jabber.org/protocol/workgroup' jid='user-jid'&gt;
S:       &lt;timeout&gt;seconds&lt;/timeout&gt;
S:   &lt;/offer&gt;
S: &lt;/iq&gt;
      </pre></div>
      <p class="" style="">Application specific meta-data will normally be added as a sub-element of &lt;offer&gt; to help agents decide whether to accept or not. An optional &lt;timeout&gt; sub-element may be included indicating the amount of time the offer stands before the service will revoke it.</p>
      <p class="caption">Example 36. Offer Response</p>
<div class="indent"><pre>
A: &lt;iq from='agent-jid' to='service-jid' id='id' type='result'/&gt;
      </pre></div>
      <p class="" style="">The agent may respond only with a successful result.</p>
      <div class="indent">
<h3>4.5.3.1 <a name="proto-agent-offer-errors">Error Conditions</a>
</h3>
        <p class="" style="">There are no valid error results for an offer response.</p>
      </div>
      <div class="indent">
<h3>4.5.3.2 <a name="proto-agent-offer-example">Example</a>
</h3>
        <p class="" style="">An agent is offered a chat with a user. The offer will be revoked in 30 seconds.</p>
        <p class="caption">Example 37. Agent is Offered a Chat</p>
<div class="indent"><pre>
S: &lt;iq to='agent-alice@company.com/work'
S:     from='support@company.com'
S:     id='id1'
S:     type='set'&gt;
S:     &lt;offer xmlns='http://jabber.org/protocol/workgroup' jid='user@server.com/home'&gt;
S:       &lt;timeout&gt;30&lt;/timeout&gt;
S:     &lt;/offer&gt;
S: &lt;/iq&gt;
A: &lt;iq to='support@company.com'
A:     from='agent-alice@company.com/work'
A:     id='id1'
A:     type='result'/&gt;
        </pre></div>
        <p class="" style="">The following is a more typical offer containing meta-data about the user.  The offer will be revoked in 30 seconds.</p>
        <p class="caption">Example 38. Offer Including Meta-Data</p>
<div class="indent"><pre>
S: &lt;iq to='agent-alice@company.com/work'
S:     from='support@company.com'
S:     id='id1'
S:     type='set'&gt;
S:     &lt;offer xmlns='http://jabber.org/protocol/workgroup' jid='user@server.com/home'&gt;
S:       &lt;timeout&gt;30&lt;/timeout&gt;
S:       &lt;crm xmlns=&quot;http://www.company.com/xmpp/workgroup'&gt;
S:         &lt;user-id&gt;423498ae84f&lt;/user-id&gt;
S:         &lt;product&gt;Widget 1.0&lt;/product&gt;
S:       &lt;/crm&gt;
S:     &lt;/offer&gt;
S: &lt;/iq&gt;
A: &lt;iq to='support@company.com'
A:     from='agent-alice@company.com/work'
A:     id='id1'
A:     type='result'/&gt;
        </pre></div>
      </div>
    </div>
    <div class="indent">
<h3>4.5.4 <a name="proto-agent-acceptreject">Agent Offer Accept/Reject Protocol</a>
</h3>
      <p class="" style="">This section describes the packet exchange involved in an agent rejecting an offering a chat to a user. This protocol MUST be supported by compliant implementations.</p>
      <p class="caption">Example 39. Transactions</p>
<div class="indent"><pre>
Agent                         Service
  |  Offer Accept/Reject Request |
  |-----------------------------&gt;|
  | Offer Accept/Reject Response |
  |&lt;-----------------------------|
  |                              |
      </pre></div>
      <p class="" style="">The agent accepts or rejects an offer to chat with a user.</p>
      <p class="caption">Example 40. Offer Accept Request</p>
<div class="indent"><pre>
A: &lt;iq to='service-jid' from='agent-jid' id='id' type='set'&gt;
A:   &lt;offer-accept jid='user-jid' xmlns='http://jabber.org/protocol/workgroup' /&gt;
A: &lt;/iq&gt;
      </pre></div>
      <p class="caption">Example 41. Offer Reject Request</p>
<div class="indent"><pre>
A: &lt;iq to='service-jid' from='agent-jid' id='id' type='set'&gt;
A:   &lt;offer-reject jid='user-jid' xmlns='http://jabber.org/protocol/workgroup'/&gt;
A: &lt;/iq&gt;
      </pre></div>
      <p class="caption">Example 42. Offer Response</p>
<div class="indent"><pre>
S: &lt;iq to='agent-jid' from='service-jid' id='id' type='result'/&gt;
      </pre></div>
      <p class="" style="">The service may respond only with a successful result.</p>
      <div class="indent">
<h3>4.5.4.1 <a name="proto-agent-acceptreject-errors">Error Conditions</a>
</h3>
        <p class="" style="">There are no valid error results for an accept/reject offer response.</p>
      </div>
      <div class="indent">
<h3>4.5.4.2 <a name="proto-agent-acceptreject-example">Example</a>
</h3>
        <p class="caption">Example 43. Agent Accepts Chat</p>
<div class="indent"><pre>
A: &lt;iq from='agent-alice@company.com/work'
A:       to='support@company.com'
A:       id='id1'
A:     type='set'&gt;
A:   &lt;offer-accept jid='user@server.com/home' xmlns='http://jabber.org/protocol/workgroup'/&gt;
A: &lt;/iq&gt;
S: &lt;iq from='support@company.com'
S:     to='agent-alice@company.com/work'
S:     id='id1'
S:     type='result'/&gt;
        </pre></div>
      </div>
    </div>
    <div class="indent">
<h3>4.5.5 <a name="proto-agent-revoke">Agent Offer Revoke Protocol</a>
</h3>
      <p class="" style="">This section describes the packet exchange involved in a service revoking an offer to an agent to chat to a user. This protocol MUST be supported by compliant implementations.</p>
      <p class="caption">Example 44. Transactions</p>
<div class="indent"><pre>
Agent                         Service
  |     Offer Revoke Request     |
  |&lt;-----------------------------|
  |    Offer Revoke Response     |
  |-----------------------------&gt;|
  |                              |
      </pre></div>
      <p class="" style="">The service revokes an earlier offer to chat to a user. Offer revocations typically occur when the original offer times out, or a better agent was found to handle the chat. Note that offer revocations may occur anytime after an offer has been made, and before an invitation is sent (see agent state diagram). In other words, even though an agent has accepted an offer to chat, the agent may still receive an offer revocation (e.g. a better agent was found to handle the chat).</p>
      <p class="caption">Example 45. Offer Revoke Request</p>
<div class="indent"><pre>
S: &lt;iq from='service-jid' to='agent-jid' id='id' type='set'&gt;
S:     &lt;offer-revoke jid='user-jid' xmlns='http://jabber.org/protocol/workgroup'&gt;
S:       &lt;reason&gt;
S:         [reason]
S:       &lt;/reason&gt;
S:     &lt;/offer-revoke&gt;
S: &lt;/iq&gt;
      </pre></div>
      <p class="" style="">The reason element may optionally contain free form text explaining the reason the offer was revoked.</p>
      <p class="caption">Example 46. Offer Response</p>
<div class="indent"><pre>
A: &lt;iq from='agent-jid' to='service-jid' id='id' type='result'/&gt;
      </pre></div>
      <p class="" style="">The agent may respond only with a successful result.</p>
      <div class="indent">
<h3>4.5.5.1 <a name="proto-agent-revoke-errors">Error Conditions</a>
</h3>
        <p class="" style="">There are no valid error results for an offer response.</p>
      </div>
      <div class="indent">
<h3>4.5.5.2 <a name="proto-agent-revoke-example">Example</a>
</h3>
        <p class="caption">Example 47. Offer Revoked Due to Timeout</p>
<div class="indent"><pre>
S: &lt;iq   to='agent-alice@company.com/work'
S:     from='support@company.com'
S:       id='id1'
S:     type='set'&gt;
S:     &lt;offer-revoke xmlns='http://jabber.org/protocol/workgroup' jid='user@server.com/home'&gt;
S:         &lt;reason&gt;
S:           Offer timed out
S:         &lt;/reason&gt;
S:     &lt;/offer-revoke&gt;
S: &lt;/iq&gt;
A: &lt;iq   to='support@company.com'
A:     from='agent-alice@company.com/work'
A:       id='id1'
A:     type='result'/&gt;
        </pre></div>
      </div>
    </div>
    <div class="indent">
<h3>4.5.6 <a name="proto-agent-invite">Agent Invite Protocol</a>
</h3>
      <p class="" style="">This section describes the packet exchange inviting an agent to a chat room for conversation with a user. This protocol MUST be supported by compliant implementations.</p>
      <p class="caption">Example 48. Transactions</p>
<div class="indent"><pre>
Agent                         Service
  |         Agent Invite         |
  |&lt;-----------------------------|
  |                              |
      </pre></div>
      <p class="" style="">The server sends a standard JEP-0045 groupchat invitation to the agent to begin their conversation with a user. The invitation follows the same format as shown in the User Invite Protocol.</p>
      <p class="" style="">Agent invitations use JEP-0045 standard multi-user chat invitations. The agent will continue to receive agent status updates from the workgroup.</p>
      <div class="indent">
<h3>4.5.6.1 <a name="proto-agent-invite-errors">Error Conditions</a>
</h3>
        <p class="" style="">There are no valid error conditions for agent invitations.</p>
      </div>
      <div class="indent">
<h3>4.5.6.2 <a name="proto-agent-invite-example">Example</a>
</h3>
        <p class="" style="">See <span style="font-weight: bold">JEP-0045: Multi-User Chat</span> for examples.</p>
      </div>
    </div>
  </div>
<h2>5.
       <a name="example">Complete Protocol Example</a>
</h2>
  <p class="" style="">The following is a complete example showing the typical process flow and protocol packet exchanges between user, service, and agent.</p>
  <p class="" style="">To follow.</p>
<h2>6.
       <a name="impl">Implementation Notes</a>
</h2>
  <p class="" style="">If workgroup goes offline, all queued users SHOULD be notified of workgroup cancellation.</p>
  <p class="" style="">An implementation MAY support for anonymous login by users, which makes it easier to deploy such a system on a website.</p>
  <p class="" style="">A user MAY pass in arbitrary meta-data during the initial chat request, which allows for more complex routing and queue processing decisions by the server. Such meta-data SHOULD be included as xxx.</p>
<h2>7.
       <a name="security">Security Considerations</a>
</h2>
  <p class="" style="">To follow.</p>
<h2>8.
       <a name="iana">IANA Considerations</a>
</h2>
  <p class="" style="">This JEP requires no interaction with the <span class="ref">Internet Assigned Numbers Authority (IANA)</span>  [<a href="#nt-id2605153">7</a>].</p>
<h2>9.
       <a name="registrar">Jabber Registrar Considerations</a>
</h2>
  <h2>1.
       <a name="registrar-ns">Protocol Namespaces</a>
</h2>
    <p class="" style="">Upon advancement of this JEP to a status of Draft, the <span class="ref">Jabber Registrar</span>  [<a href="#nt-id2605100">8</a>] shall add 'http://jabber.org/protocol/workgroup' to its registry of protocol namespaces.</p>
  
<h2>10.
       <a name="schema">XML Schema</a>
</h2>
  <p class="" style="">To follow.</p>
<p><hr></p>
<a name="notes"></a><h2>Notes</h2>
<p>
<a name="nt-id2596124">1</a>. RFC 3920: Extensible Messaging and Presence Protocol (XMPP): Core &lt;<a href="http://www.ietf.org/rfc/rfc3920.txt">http://www.ietf.org/rfc/rfc3920.txt</a>&gt;.</p>
<p>
<a name="nt-id2596230">2</a>. JEP-0045: Multi-User Chat &lt;<a href="http://www.jabber.org/jeps/jep-0045.html">http://www.jabber.org/jeps/jep-0045.html</a>&gt;.</p>
<p>
<a name="nt-id2596242">3</a>. JEP-0004: Data Forms &lt;<a href="http://www.jabber.org/jeps/jep-0004.html">http://www.jabber.org/jeps/jep-0004.html</a>&gt;.</p>
<p>
<a name="nt-id2596293">4</a>. RFC 2119: Key words for use in RFCs to Indicate Requirement Levels &lt;<a href="http://www.ietf.org/rfc/rfc2119.txt">http://www.ietf.org/rfc/rfc2119.txt</a>&gt;.</p>
<p>
<a name="nt-id2603775">5</a>. The max-chats value sent from agent to workgroup service is a 'hint' or recommended value. The workgroup service is not obliged to accept this value. The actual max-chats value for the agent will be sent to the agent via the next Agent Status Update. This allows administrators to constrain agent behavior in order to enforce company policy, quality assurance, etc.</p>
<p>
<a name="nt-id2603824">6</a>. Presence values are not &quot;sticky&quot;. For example, if a presence show value is 'dnd' and another presence is sent without a show value, the entity's presence show is the default show, and NOT 'dnd'. The same non- sticky behavior applies to workgroup presence values such as max-chats and current-chats.</p>
<p>
<a name="nt-id2605153">7</a>. The Internet Assigned Numbers Authority (IANA) is the central coordinator for the assignment of unique parameter values for Internet protocols, such as port numbers and URI schemes. For further information, see &lt;<a href="http://www.iana.org/">http://www.iana.org/</a>&gt;.</p>
<p>
<a name="nt-id2605100">8</a>. The Jabber Registrar maintains a list of reserved Jabber protocol namespaces as well as registries of parameters used in the context of protocols approved by the Jabber Software Foundation. For further information, see &lt;<a href="http://www.jabber.org/registrar/">http://www.jabber.org/registrar/</a>&gt;.</p>
<p><hr></p>
<a name="revs"></a><h2>Revision History</h2>
<div class="indent">
<h4>Version 0.1 (2004-09-03)</h4>
<div class="indent">Initial version. (is/mt)
    </div>
</div>
<p><hr></p>
<p>END</p>
</body>
</html>
