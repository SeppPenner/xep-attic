<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>XEP-0155: Chat Session Negotiation</title>
<link rel="stylesheet" type="text/css" href="/xmpp.css">
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
<meta name="DC.Title" content="Chat Session Negotiation">
<meta name="DC.Creator" content="Peter Saint-Andre">
<meta name="DC.Creator" content="Ian Paterson">
<meta name="DC.Description" content="This document specifies a feature negotiation profile for initiating a one-to-one XMPP chat session.">
<meta name="DC.Publisher" content="Jabber Software Foundation">
<meta name="DC.Contributor" content="XMPP Extensions Editor">
<meta name="DC.Date" content="2006-10-31">
<meta name="DC.Type" content="XMPP Extension Protocol">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="XEP-0155">
<meta name="DC.Language" content="en">
<meta name="DC.Rights" content="This XMPP Extension Protocol is copyright 1999 - 2006 by the Jabber Software Foundation (JSF) and is in full conformance with the JSF's Intellectual Property Rights Policy &lt;http://www.xmpp.org/extensions/ipr-policy.shtml&gt;. This material may be distributed only subject to the terms and conditions set forth in the Creative Commons Attribution License (&lt;http://creativecommons.org/licenses/by/2.5/&gt;).">
</head>
<body>
<h1>XEP-0155: Chat Session Negotiation</h1>
<p>This document specifies a feature negotiation profile for initiating a one-to-one XMPP chat session.</p>
<p><hr></p>
<p style="color:red">WARNING: This Standards-Track document is Experimental. Publication as an XMPP Extension Protocol does not imply approval of this proposal by the Jabber Software Foundation. Implementation of the protocol described herein is encouraged in exploratory implementations, but production systems should not deploy implementations of this protocol until it advances to a status of Draft.</p>
<p><hr></p>
<h2>XEP Information</h2>
<p class="indent">
            Status: 
            <a href="http://www.xmpp.org/extensions/xep-0001.html#states-Experimental">Experimental</a><br>
            Type:
            <a href="http://www.xmpp.org/extensions/xep-0001.html#types-Standards%20Track">Standards Track</a><br>
            Number: 0155<br>
            Version: 0.10<br>
            Last Updated: 2006-10-31<br>
            Publishing Organization: <a href="http://www.jabber.org/jsf/">Jabber Software Foundation</a><br>
                Approving Body: <a href="http://www.jabber.org/council/">XMPP Council</a><br>Dependencies: XMPP Core, XMPP IM, XEP-0020, XEP-0068<br>
                Supersedes: None<br>
                Superseded By: None<br>
            Short Name: chatneg<br>
              Wiki Page: &lt;<a href="http://wiki.jabber.org/index.php/Chat%20Session%20Negotiation%20(XEP-0155)">http://wiki.jabber.org/index.php/Chat Session Negotiation (XEP-0155)</a>&gt;
            </p>
<h2>Author Information</h2>
<div class="indent">
<h3>Peter Saint-Andre</h3>
<p class="indent">
        Email:
        <a href="mailto:stpeter@jabber.org">stpeter@jabber.org</a><br>
        JID: 
        <a href="xmpp:stpeter@jabber.org">stpeter@jabber.org</a></p>
<h3>Ian Paterson</h3>
<p class="indent">
        Email:
        <a href="mailto:ian.paterson@clientside.co.uk">ian.paterson@clientside.co.uk</a><br>
        JID: 
        <a href="xmpp:ian@zoofy.com">ian@zoofy.com</a></p>
</div>
<h2>Legal Notice</h2>
<p class="indent">This XMPP Extension Protocol is copyright 1999 - 2006 by the <a href="http://www.jabber.org/jsf/">Jabber Software Foundation</a> (JSF) and is in full conformance with the JSF's Intellectual Property Rights Policy &lt;<a href="http://www.xmpp.org/extensions/ipr-policy.shtml">http://www.xmpp.org/extensions/ipr-policy.shtml</a>&gt;. This material may be distributed only subject to the terms and conditions set forth in the Creative Commons Attribution License (&lt;<a href="http://creativecommons.org/licenses/by/2.5/">http://creativecommons.org/licenses/by/2.5/</a>&gt;).</p>
<h2>Discussion Venue</h2>
<p class="indent">The preferred venue for discussion of this document is the Standards-JIG discussion list: &lt;<a href="http://mail.jabber.org/mailman/listinfo/standards-jig">http://mail.jabber.org/mailman/listinfo/standards-jig</a>&gt;.</p>
<h2>Relation to XMPP</h2>
<p class="indent">The Extensible Messaging and Presence Protocol (XMPP) is defined in the XMPP Core (RFC 3920) and XMPP IM (RFC 3921) specifications contributed by the Jabber Software Foundation to the Internet Standards Process, which is managed by the Internet Engineering Task Force in accordance with RFC 2026. Any protocol defined in this document has been developed outside the Internet Standards Process and is to be understood as an extension to XMPP rather than as an evolution, development, or modification of XMPP itself.</p>
<h2>Conformance Terms</h2>
<p class="indent">The following keywords as used in this document are to be interpreted as described in RFC 2119: "MUST", "SHALL", "REQUIRED"; "MUST NOT", "SHALL NOT"; "SHOULD", "RECOMMENDED"; "SHOULD NOT", "NOT RECOMMENDED"; "MAY", "OPTIONAL".</p>
<p><hr></p>
<h2>Table of Contents</h2>
<div class="indent"><dl>
<dt>1.  <a href="#intro">Introduction</a>
</dt>
<dt>2.  <a href="#usecases">Use Cases</a>
</dt>
<dl>
<dt>2.1.  <a href="#initiate">Initiating a Chat</a>
</dt>
<dt>2.2.  <a href="#renegotiate">Renegotiating a Chat</a>
</dt>
<dt>2.3.  <a href="#switch">Switching Resources</a>
</dt>
<dt>2.4.  <a href="#terminate">Terminating a Chat</a>
</dt>
</dl>
<dt>3.  <a href="#sip">Mapping to SIP</a>
</dt>
<dt>4.  <a href="#impl">Implementation Notes</a>
</dt>
<dl>
<dt>4.1.  <a href="#impl-auto">Auto Accept or Reject</a>
</dt>
<dt>4.2.  <a href="#impl-unavail">Unavailable Presence</a>
</dt>
</dl>
<dt>5.  <a href="#security">Security Considerations</a>
</dt>
<dt>6.  <a href="#iana">IANA Considerations</a>
</dt>
<dt>7.  <a href="#registrar">XMPP Registrar Considerations</a>
</dt>
<dl>
<dt>7.1.  <a href="#registrar-features">Service Discovery Features</a>
</dt>
<dt>7.2.  <a href="#registrar-formtype">Field Standardization</a>
</dt>
</dl>
<dt>8.  <a href="#schema">XML Schema</a>
</dt>
<dt>9.  <a href="#ack">Acknowledgements</a>
</dt>
<dt><a href="#notes">Notes</a></dt>
<dt><a href="#revs">Revision History</a></dt>
</dl></div>
<p><hr></p>
<h2>1.
       <a name="intro">Introduction</a>
</h2>
  <p class="" style="">The traditional model for one-to-one chat "sessions" in Jabber/XMPP is for a user to simply send a message to a contact without any formal negotiation of chat session parameters (e.g., see <span class="ref" style="">XMPP IM</span>  [<a href="#nt-id2250923">1</a>]). This informal approach to initiation of a chat session is perfectly acceptable in many contexts, environments, and cultures. However, it may be desirable to formally request the chat and negotiate its parameters before beginning the chat session in some circumstances, such as:</p>
  <ul>
    <li>Whenever parameters specific to a chat session must be agreed. e.g., security and privacy parameters (see <span class="ref" style="">Encrypted Sessions</span>  [<a href="#nt-id2250963">2</a>] and <span class="ref" style="">Message Archiving</span>  [<a href="#nt-id2250985">3</a>]).</li>
    <li>The parties are unknown to each other, have not exchanged presence, or have not discovered their respective capabilities via <span class="ref" style="">Service Discovery</span>  [<a href="#nt-id2251006">4</a>] or <span class="ref" style="">Entity Capabilities</span>  [<a href="#nt-id2250996">5</a>].</li>
    <li>When an XMPP-based system interfaces with a SIP-based system built on top of <span class="ref" style="">RFC 3261</span>  [<a href="#nt-id2251051">6</a>].  [<a href="#nt-id2251038">7</a>]</li>
    <li>Within an organization or culture in which one would not simply begin chatting with another person (e.g., a superior) without first receiving permission to do so.</li>
  </ul>
  <p class="" style="">This proposal defines best practices for such a negotiation, re-using the protocol defined in <span class="ref" style="">Feature Negotiation</span>  [<a href="#nt-id2260204">8</a>].</p>
<h2>2.
       <a name="usecases">Use Cases</a>
</h2>
  <div class="indent">
<h3>2.1 <a name="initiate">Initiating a Chat</a>
</h3>
    <p class="" style="">In order to initiate a negotiated chat session, the initiating party ("user") sends a &lt;message/&gt;  [<a href="#nt-id2260236">9</a>] stanza to the receiving party ("contact") containing a &lt;feature/&gt; child qualified by the 'http://jabber.org/protocol/feature-neg' namespace. The &lt;message/&gt; stanza MUST NOT contain a &lt;body/&gt; child element (as specified in <span class="ref" style="">RFC 3921</span>  [<a href="#nt-id2260264">10</a>]). The &lt;message/&gt; stanza type SHOULD be "normal" (either explicitly or by non-inclusion of the 'type' attribute). The stanza MUST contain a &lt;thread/&gt; element for tracking purposes (where the newly-generated ThreadID is unique to the proposed session). The data form MUST contain a hidden FORM_TYPE field whose value is "http://jabber.org/protocol/chatneg" and MUST contain a boolean field named "accept".  [<a href="#nt-id2260283">11</a>] The inclusion of "otr" and "security" fields is also RECOMMENDED. Note: The options within any 'list-single' fields SHOULD appear in order of preference.</p>
    <p class="" style="">Note: Chat sessions may be conducted between entities who are never online at the same time. However, if the user is interested only in an <span style="font-style: italic">immediate</span> chat session then the user SHOULD instruct the contact's server not to store the message for later delivery using the <span class="ref" style="">Advanced Message Processing</span>  [<a href="#nt-id2260325">12</a>] protocol.</p>
    <p class="" style="">In the following example of a negotiation request, Romeo requests a chat with Juliet and also queries her regarding whether she wants to enable all message logging (see <span class="ref" style="">Message Archiving</span>  [<a href="#nt-id2260342">13</a>])  [<a href="#nt-id2260353">14</a>] and support the <span class="ref" style="">XHTML-IM</span>  [<a href="#nt-id2260382">15</a>] and <span class="ref" style="">Chat State Notifications</span>  [<a href="#nt-id2260406">16</a>] extensions during this chat session. He also requires that they are both connected securely to their servers, and asks which language she prefers amoungst those he can write. (Note: These fields are examples only; a full set of chat session negotiation parameters will be registered as described in the <a href="#registrar">XMPP Registrar Considerations</a> section of this document.)</p>
    <p class="caption">Example 1. User requests chat session</p>
<div class="indent"><pre>
&lt;message type='normal'
         from='romeo@montague.net/orchard'
         to='juliet@capulet.com'&gt;
  &lt;thread&gt;ffd7076498744578d10edabfe7f4a866&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='form'&gt;
      &lt;title&gt;Open chat with Romeo?&lt;/title&gt;
      &lt;field var='FORM_TYPE' type='hidden'&gt;
        &lt;value&gt;http://jabber.org/protocol/chatneg&lt;/value&gt;
      &lt;/field&gt;
      &lt;field label='Accept this chat?' type='boolean' var='accept'&gt;
        &lt;value&gt;true&lt;/value&gt;
        &lt;required/&gt;
      &lt;/field&gt;
      &lt;field label='Off-The-Record?' type='list-single' var='otr'&gt;
        &lt;value&gt;false&lt;/value&gt;
        &lt;option label='Allow message logging'&gt;
          &lt;value&gt;false&lt;/value&gt;
        &lt;/option&gt;
        &lt;option label='Disable all message logging'&gt;
          &lt;value&gt;true&lt;/value&gt;
        &lt;/option&gt;
      &lt;/field&gt;
      &lt;field label='XHTML Formatting?'
             type='list-single'
             var='http://jabber.org/protocol/xhtml-im'&gt;
        &lt;value&gt;true&lt;/value&gt;
        &lt;option label='Disable'&gt;&lt;value&gt;false&lt;/value&gt;&lt;/option&gt;
        &lt;option label='Enable'&gt;&lt;value&gt;true&lt;/value&gt;&lt;/option&gt;
      &lt;/field&gt;
      &lt;field label='Chat State Notifications?'
             type='list-single'
             var='http://jabber.org/protocol/chatstates'&gt;
        &lt;value&gt;true&lt;/value&gt;
        &lt;option label='Disable'&gt;&lt;value&gt;false&lt;/value&gt;&lt;/option&gt;
        &lt;option label='Enable'&gt;&lt;value&gt;true&lt;/value&gt;&lt;/option&gt;
      &lt;/field&gt;
      &lt;field label='Minimum security level'
             type='list-single'
             var='security'&gt;
        &lt;value&gt;c2s&lt;/value&gt;
        &lt;option label='Both parties must be securely connected to their servers'&gt;
          &lt;value&gt;c2s&lt;/value&gt;
        &lt;/option&gt;
      &lt;/field&gt;
      &lt;field label='Primary written language of the chat'
             type='list-single'
             var='language'&gt;
        &lt;value&gt;en&lt;/value&gt;
        &lt;option label='English'&gt;&lt;value&gt;en&lt;/value&gt;&lt;/option&gt;
        &lt;option label='Italiano'&gt;&lt;value&gt;it&lt;/value&gt;&lt;/option&gt;
      &lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
  &lt;amp xmlns='http://jabber.org/protocol/amp'&gt;
    &lt;rule action='drop' condition='deliver' value='stored'/&gt;
  &lt;/amp&gt;
&lt;/message&gt;
    </pre></div>
    <p class="" style="">The user MAY request a session with a specific resource of the contact. However, if the user specifies no resource (or if the specified resource is not available), then the contact's server delivers the request to the contact's most available resource (which in the examples below happens to be "balcony"). If no resource is available (and no <span style="font-weight: bold">Advanced Message Processing</span> rule included in the request specifies otherwise) then the server MAY store the request for later delivery. In this case, if the contact is interested only in an <span style="font-style: italic">immediate</span> chat session when it eventually receives the request, it SHOULD initiate a new chat session negotiation (including a newly-generated ThreadID) instead of responding to the user's request. Note: Sending any response to the user's original request would leak presence information since it would divulge the fact that the contact had been offline rather than just ignoring the user.</p>
    <p class="" style="">In any response to the user's request, the contact's client MUST mirror the &lt;thread/&gt; value so that the user's client can correctly track the response.</p>
    <p class="" style="">If the contact's client does not support one of the default values or if the contact has disabled its support (as for Chat State Notifications and XHTML formatting in the example below), and the client can still accept the request, then it MUST set that field to a value that it can support.</p>
    <p class="" style="">If the contact's client is configured to show the form to the client instead of responding automatically it SHOULD replace the content of the &lt;title/&gt; element and of all label attributes of the &lt;field/&gt; and &lt;option/&gt; elements with it's own localised versions before showing the form to the client - even if the form already appears to be in the correct language. Note: If a client fails to localise the form then an malicious contact might, for examples, either switch the labels on the 'security' and 'otr' fields, or use the &lt;title/&gt; to mislead the user regarding the identity of the contact.</p>
    <p class="" style="">In the example below we assume that Juliet accepts the chat and specifies that she prefers to speak Italian with Romeo:</p>
    <p class="caption">Example 2. Contact accepts chat and specifies parameters</p>
<div class="indent"><pre>
&lt;message type='normal'
         from='juliet@capulet.com/balcony'
         to='romeo@montague.net/orchard'&gt;
  &lt;thread&gt;ffd7076498744578d10edabfe7f4a866&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='submit'&gt;
      &lt;field var='FORM_TYPE'&gt;
        &lt;value&gt;http://jabber.org/protocol/chatneg&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='accept'&gt;&lt;value&gt;true&lt;/value&gt;&lt;/field&gt;
      &lt;field var='otr'&gt;&lt;value&gt;false&lt;/value&gt;&lt;/field&gt;
      &lt;field var='http://jabber.org/protocol/xhtml-im'&gt;
        &lt;value&gt;false&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='http://jabber.org/protocol/chatstates'&gt;
        &lt;value&gt;false&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='security'&gt;&lt;value&gt;c2s&lt;/value&gt;&lt;/field&gt;
      &lt;field var='language'&gt;&lt;value&gt;it&lt;/value&gt;&lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
&lt;/message&gt;
    </pre></div>
    <p class="" style="">Note: Both entities MUST assume the session has been established with the resource of the contact that sends the reply, even if the user sent its request to a different resource of the contact.</p>
    <p class="" style="">If the contact does not want to reveal presence to the user for whatever reason then the contact's client SHOULD return no response or error (see <a href="#security">Security Considerations</a>). Also, if the contact is using a legacy client then it MAY not support returning any response or error. In both these cases the user MAY, proceed to send stanzas to the contact outside the context of a negotiated chat session.</p>
    <p class="" style="">However, if the contact simply prefers not to chat then the client SHOULD decline the invitation:</p>
    <p class="caption">Example 3. Contact declines offer and specifies reason</p>
<div class="indent"><pre>
&lt;message type='normal'
         from='juliet@capulet.com/balcony'
         to='romeo@montague.net/orchard'&gt;
  &lt;thread&gt;ffd7076498744578d10edabfe7f4a866&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='submit'&gt;
      &lt;field var='FORM_TYPE'&gt;
        &lt;value&gt;http://jabber.org/protocol/chatneg&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='accept'&gt;&lt;value&gt;0&lt;/value&gt;&lt;/field&gt;
      &lt;field var='reason'&gt;
        &lt;value&gt;Sorry, can't chat now! How about tonight?&lt;/value&gt;
      &lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
&lt;/message&gt;
    </pre></div>
    <p class="" style="">If the contact's client does not support feature negotiation or does not support the "http://jabber.org/protocol/chatneg" FORM_TYPE, it SHOULD return a &lt;service-unavailable/&gt; error:</p>
    <p class="caption">Example 4. Contact returns service unavailable error</p>
<div class="indent"><pre>
&lt;message type='error'
         from='juliet@capulet.com/balcony'
         to='romeo@montague.net/orchard'&gt;
  &lt;thread&gt;ffd7076498744578d10edabfe7f4a866&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='form'&gt;
      &lt;field var='FORM_TYPE' type='hidden'&gt;
        &lt;value&gt;http://jabber.org/protocol/chatneg&lt;/value&gt;
      &lt;/field&gt;
      ...
    &lt;/x&gt;
  &lt;/feature&gt;
  &lt;error code='503' type='cancel'&gt;
    &lt;service-unavailable xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/&gt;
  &lt;/error&gt;
&lt;/message&gt;
    </pre></div>
    <p class="" style="">If the contact's client does not support one or more of the <span style="font-style: italic">required</span> features, it SHOULD return a &lt;feature-not-implemented/&gt; error, specifying the field(s) not implemented using the 'var' attribute of one or more &lt;field/&gt; child elements of a &lt;feature/&gt; child element of the &lt;error/&gt; scoped by the 'http://jabber.org/protocol/feature-neg' namespace:</p>
    <p class="caption">Example 5. Contact returns feature not implemented error</p>
<div class="indent"><pre>
&lt;message type='error'
         from='juliet@capulet.com/balcony'
         to='romeo@montague.net/orchard'&gt;
  &lt;thread&gt;ffd7076498744578d10edabfe7f4a866&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='form'&gt;
      &lt;field var='FORM_TYPE' type='hidden'&gt;
        &lt;value&gt;http://jabber.org/protocol/chatneg&lt;/value&gt;
      &lt;/field&gt;
      ...
    &lt;/x&gt;
  &lt;/feature&gt;
  &lt;error code='501' type='cancel'&gt;
    &lt;feature-not-implemented xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/&gt;
    &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
      &lt;field var='otr'/&gt;
    &lt;/feature&gt;
  &lt;/error&gt;
&lt;/message&gt;
    </pre></div>
    <p class="" style="">If the contact's client supports <span style="font-style: italic">none</span> of the options for one or more fields, it SHOULD return a &lt;not-acceptable/&gt; error, specifying the field(s) with unsupported options using the 'var' attribute of one or more &lt;field/&gt; child elements of a &lt;feature/&gt; child element of the &lt;error/&gt; scoped by the 'http://jabber.org/protocol/feature-neg' namespace:</p>
    <p class="caption">Example 6. Contact returns options not acceptable error</p>
<div class="indent"><pre>
&lt;message type='error'
         from='juliet@capulet.com/balcony'
         to='romeo@montague.net/orchard'&gt;
  &lt;thread&gt;ffd7076498744578d10edabfe7f4a866&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='form'&gt;
      &lt;field var='FORM_TYPE' type='hidden'&gt;
        &lt;value&gt;http://jabber.org/protocol/chatneg&lt;/value&gt;
      &lt;/field&gt;
      ...
    &lt;/x&gt;
  &lt;/feature&gt;
  &lt;error code='406' type='modify'&gt;
    &lt;not-acceptable xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/&gt;
    &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
      &lt;field var='security'/&gt;
    &lt;/feature&gt;
  &lt;/error&gt;
&lt;/message&gt;
    </pre></div>
    <p class="" style="">Finally, if the contact accepted the chat then the user SHOULD reply with a result form containing an 'accept' field set to 'true' (or '1') to confirm to the contact that the combination of values it submitted was acceptable, and that the chat session is open.  [<a href="#nt-id2260863">17</a>] The user MAY include other content (e.g., a &lt;body/&gt; element) in the confirmation stanza:</p>
    <p class="caption">Example 7. User confirms session is open</p>
<div class="indent"><pre>
&lt;message type='normal'
         from='romeo@montague.net/orchard'
         to='juliet@capulet.com/balcony'&gt;
  &lt;thread&gt;ffd7076498744578d10edabfe7f4a866&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='result'&gt;
      &lt;field var='FORM_TYPE'&gt;
        &lt;value&gt;http://jabber.org/protocol/chatneg&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='accept'&gt;&lt;value&gt;1&lt;/value&gt;&lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
  &lt;body&gt;I forgot what I wanted to say!&lt;/body&gt;
&lt;/message&gt;
    </pre></div>
  </div>
  <div class="indent">
<h3>2.2 <a name="renegotiate">Renegotiating a Chat</a>
</h3>
    <p class="" style="">At any time during an existing chat session, either party MAY attempt to renegotiate the parameters of the session. The requesting party does this by sending a new &lt;message/&gt; stanza containing a feature negotiation form and a &lt;thread/&gt; element with the same value as that of the existing chat session.</p>
    <p class="" style="">Note: The "accept" field SHOULD NOT be included in a renegotiation form. The set of other fields in the form MAY be different from the set included in the initial session negotitation.</p>
    <p class="caption">Example 8. One party requests renegotiation</p>
<div class="indent"><pre>
&lt;message type='normal'
         from='juliet@capulet.com/balcony'
         to='romeo@montague.net/orchard'&gt;
  &lt;thread&gt;ffd7076498744578d10edabfe7f4a866&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='form'&gt;
      &lt;field var='FORM_TYPE' type='hidden'&gt;
        &lt;value&gt;http://jabber.org/protocol/chatneg&lt;/value&gt;
      &lt;/field&gt;
      &lt;field label='Off-The-Record?' type='list-single' var='otr'&gt;
        &lt;value&gt;true&lt;/value&gt;
        &lt;option label='Disable all message logging'&gt;
          &lt;value&gt;true&lt;/value&gt;
        &lt;/option&gt;
      &lt;/field&gt;
      &lt;field label='Reason' type='text-single' var='reason'&gt;
        &lt;value&gt;Lets keep this private!&lt;/value&gt;
      &lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
&lt;/message&gt;
    </pre></div>
    <p class="caption">Example 9. Other party accepts offer and specifies parameters</p>
<div class="indent"><pre>
&lt;message type='normal'
         from='romeo@montague.net/orchard'
         to='juliet@capulet.com/balcony'&gt;
  &lt;thread&gt;ffd7076498744578d10edabfe7f4a866&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='submit'&gt;
      &lt;field var='FORM_TYPE'&gt;
        &lt;value&gt;http://jabber.org/protocol/chatneg&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='otr'&gt;&lt;value&gt;true&lt;/value&gt;&lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
&lt;/message&gt;
    </pre></div>
    <p class="" style="">If the other party's client does not support one or more of the <span style="font-style: italic">required</span> features, it SHOULD return a &lt;feature-not-implemented/&gt; error instead, while if it supports <span style="font-style: italic">none</span> of the options for one or more fields, it SHOULD return a &lt;not-acceptable/&gt; error instead (see <a href="#initiate">Initiating a Chat</a>). In either of these cases the existing negotiated chat session parameters are maintained. Either party MAY then terminate the chat session as specified in the section <a href="#terminate">Terminating a Chat</a>.</p>
  </div>
  <div class="indent">
<h3>2.3 <a name="switch">Switching Resources</a>
</h3>
    <p class="" style="">Either party MAY ask to continue the session using another of its resources. The requesting party does this by submitting a form with a "continue" field containing the value of the new resource:</p>
    <p class="caption">Example 10. One party asks to switch session to another of its resources</p>
<div class="indent"><pre>
&lt;message type='normal'
         from='juliet@capulet.com/balcony'
         to='romeo@montague.net/orchard'&gt;
  &lt;thread&gt;ffd7076498744578d10edabfe7f4a866&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='submit'&gt;
      &lt;field var='FORM_TYPE'&gt;
        &lt;value&gt;http://jabber.org/protocol/chatneg&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='continue'&gt;&lt;value&gt;PDA&lt;/value&gt;&lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
&lt;/message&gt;
    </pre></div>
    <p class="" style="">The requesting party SHOULD NOT send stanzas within the session from either resource until the other party has accepted or rejected (with a &lt;feature-not-implemented/&gt; error) the switch to the new resource.</p>
    <p class="" style="">The other party SHOULD accept the switch since the requesting party might otherwise be unable to continue the session:</p>
    <p class="caption">Example 11. Other party accepts switch</p>
<div class="indent"><pre>
&lt;message type='normal'
         from='romeo@montague.net/orchard'
         to='juliet@capulet.com/balcony'&gt;
  &lt;thread&gt;ffd7076498744578d10edabfe7f4a866&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='result'&gt;
      &lt;field var='FORM_TYPE'&gt;
        &lt;value&gt;http://jabber.org/protocol/chatneg&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='continue'&gt;&lt;value&gt;PDA&lt;/value&gt;&lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
&lt;/message&gt;
    </pre></div>
    <p class="" style="">Once the other party has accepted the switch then all stanzas sent within the chat session MUST be to or from the new resource. Note: Both parties MUST ensure that they comply with all the other chat session negotiation parameters that were previously agreed for this session.</p>
  </div>
  <div class="indent">
<h3>2.4 <a name="terminate">Terminating a Chat</a>
</h3>
    <p class="" style="">In order to explicitly terminate a negotiated chat, the party that wishes to end the chat MUST do so by sending a &lt;message/&gt; containing a data form of type "submit". The &lt;message/&gt; stanza MUST contain a &lt;thread/&gt; element with the same XML character data as the original initiation request. The data form containing a boolean field named "terminate" set to a value of "1" or "true" and MAY also contain a "reason" field.</p>
    <p class="caption">Example 12. One party terminates chat and specifies reason</p>
<div class="indent"><pre>
&lt;message type='normal'
         from='juliet@capulet.com/balcony'
         to='romeo@montague.net/orchard'&gt;
  &lt;thread&gt;ffd7076498744578d10edabfe7f4a866&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='submit'&gt;
      &lt;field var='FORM_TYPE'&gt;
        &lt;value&gt;http://jabber.org/protocol/chatneg&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='terminate'&gt;&lt;value&gt;1&lt;/value&gt;&lt;/field&gt;
      &lt;field var='reason'&gt;&lt;value&gt;Gotta go!&lt;/value&gt;&lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
&lt;/message&gt;
    </pre></div>
    <p class="" style="">Both parties MUST then consider the chat session to be ended.</p>
    <p class="" style="">The other party's client MAY explicitly acknowledge the termination of the chat by sending a &lt;message/&gt; containing a data form of type "result", with no "reason" field and the value of the "terminate" field set to "1" or "true". The client MUST mirror the &lt;thread/&gt; value it received.</p>
    <p class="caption">Example 13. Other party acknowledges chat termination</p>
<div class="indent"><pre>
&lt;message type='normal'
         from='romeo@montague.net/orchard'
         to='juliet@capulet.com/balcony'&gt;
  &lt;thread&gt;ffd7076498744578d10edabfe7f4a866&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='result'&gt;
      &lt;field var='FORM_TYPE'&gt;
        &lt;value&gt;http://jabber.org/protocol/chatneg&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='terminate'&gt;&lt;value&gt;1&lt;/value&gt;&lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
&lt;/message&gt;
    </pre></div>
  </div>
<h2>3.
       <a name="sip">Mapping to SIP</a>
</h2>
  <p class="" style="">When mapping instant messaging flows to SIP, implementations SHOULD adhere to <span class="ref" style="">draft-saintandre-xmpp-simple</span>  [<a href="#nt-id2261186">18</a>].</p>
  <p class="" style="">In addition, the following mappings apply to chat session negotiation:</p>
  <ul>
    <li>Initiation of a negotiated chat session maps to the semantics of the SIP INVITE method.</li>
    <li>Renegotiation of a negotiated chat session also maps to the semantics of the SIP INVITE method.</li>
    <li>Termination of a negotiated chat session maps to the semantics of the SIP BYE method.</li>
    <li>The XMPP &lt;thread/&gt; value maps to the semantics of the SIP Call-ID attribute.</li>
  </ul>
<h2>4.
       <a name="impl">Implementation Notes</a>
</h2>
  <div class="indent">
<h3>4.1 <a name="impl-auto">Auto Accept or Reject</a>
</h3>
    <p class="" style="">A client MAY require a human user to approve each chat session negotiation request or MAY auto-accept and auto-reject requests based on some user-configurable policy (see <a href="#security">Security Considerations</a>).</p>
  </div>
  <div class="indent">
<h3>4.2 <a name="impl-unavail">Unavailable Presence</a>
</h3>
    <p class="" style="">If a party receives an XMPP presence stanza of type "unavailable" from the full JID (&lt;node@domain.tld/resource&gt;) of the other party (i.e., the resource with which it has had an active session) during a chat session, the receiving party SHOULD assume that the other client will still be able to continue the session (perhaps it simply became "invisible", or it is persisting the state of the negotiated chat until it reconnects and receives "offline" messages).</p>
    <p class="" style="">However, the receiving party MAY assume that the other client will <span style="font-style: italic">not</span> be able to continue the session.  [<a href="#nt-id2261329">19</a>] In that case it MUST explicitly terminate the session (see <a href="#terminate">Terminating a Chat</a>) - since its assumption could be incorrect. If after terminating the session the receiving party later receives presence of type "available" from that same resource or another resource associated with the other party and the receiving party desires to restart the chat session, then it MUST initiate a new chat session (including a newly-generated ThreadID) with the other party. It MUST NOT renegotiate parameters for the terminated session. (Note: This is consistent with the handling of chat states as specified in <span style="font-weight: bold">XEP-0085</span>.)</p>
  </div>
<h2>5.
       <a name="security">Security Considerations</a>
</h2>
  <p class="" style="">If a contact accepts a user's chat session negotiation request or returns an error to the user, the user will effectively discover the presence of the contact's resource. Due care must therefore be exercised in determining whether to accept the request or return an error. For examples, the contact's client SHOULD NOT <span style="font-style: italic">automatically</span> (i.e. without first asking the contact) either accept the user's request or return an error to the user unless the user is subscribing to the contact's presence (and the contact's presence is not currently "invisible" to the user). Note: There should be no need for the contact's client to consult the contact's block list, since if the user is on the list then the contact would not receive any request messages from the user anyway.</p>
<h2>6.
       <a name="iana">IANA Considerations</a>
</h2>
  <p class="" style="">This document requires no interaction with the <span class="ref" style="">Internet Assigned Numbers Authority (IANA)</span>  [<a href="#nt-id2261398">20</a>].</p>
<h2>7.
       <a name="registrar">XMPP Registrar Considerations</a>
</h2>
  <div class="indent">
<h3>7.1 <a name="registrar-features">Service Discovery Features</a>
</h3>
    <p class="" style="">The <span class="ref" style="">XMPP Registrar</span>  [<a href="#nt-id2261449">21</a>] shall include 'http://jabber.org/protocol/chatneg' in its registry of Service Discovery features.</p>
    <p class="caption">Registry Submission</p>
<div class="indent"><pre>
&lt;var&gt;
  &lt;name&gt;http://jabber.org/protocol/chatneg&lt;/name&gt;
  &lt;desc&gt;Support for Chat Session Negotiation and its FORM_TYPE&lt;/desc&gt;
  &lt;doc&gt;XEP-0155&lt;/doc&gt;
&lt;/var&gt;
    </pre></div>
  </div>
  <div class="indent">
<h3>7.2 <a name="registrar-formtype">Field Standardization</a>
</h3>
    <p class="" style=""><span class="ref" style="">Field Standardization for Data Forms</span>  [<a href="#nt-id2261502">22</a>] defines a process for standardizing the fields used within Data Forms qualified by a particular namespace. The following fields shall be registered for use in Chat Session Negotiation:</p>
    <p class="caption">Registry Submission</p>
<div class="indent"><pre>
&lt;form_type&gt;
  &lt;name&gt;http://jabber.org/protocol/chatneg&lt;/name&gt;
  &lt;doc&gt;XEP-0155&lt;/doc&gt;
  &lt;desc&gt;
    Forms enabling negotation of a one-to-one
    chat session between two entities.
  &lt;/desc&gt;
  &lt;field
      var='accept'
      type='boolean'
      label='Whether to accept the invitation'/&gt;
  &lt;field
      var='continue'
      type='text-single'
      label='Another resource with which to continue the session'/&gt;
  &lt;field
      var='http://jabber.org/protocol/chatstates'
      type='list-single'
      label='Whether to enable Chat State Notifications per XEP-0085'&gt;
    &lt;option label='Disable'&gt;
      &lt;value&gt;false&lt;/value&gt;
    &lt;/option&gt;
    &lt;option label='Enable'&gt;
      &lt;value&gt;true&lt;/value&gt;
    &lt;/option&gt;
  &lt;/field&gt;
  &lt;field
      var='http://jabber.org/protocol/xhtml-im'
      type='list-single'
      label='Whether to enable XHTML-IM formatting per XEP-0071'/&gt;
    &lt;option label='Disable'&gt;
      &lt;value&gt;false&lt;/value&gt;
    &lt;/option&gt;
    &lt;option label='Enable'&gt;
      &lt;value&gt;true&lt;/value&gt;
    &lt;/option&gt;
  &lt;/field&gt;
  &lt;field
      var='language'
      type='list-single'
      label='Primary written language of the chat (each
            value appears in order of preference and 
            conforms to RFC 4646 and the IANA registry)'/&gt;
  &lt;field
      var='otr'
      type='list-single'
      label='Off-The-Record'&gt;
    &lt;option label='Allow message logging'&gt;
      &lt;value&gt;false&lt;/value&gt;
    &lt;/option&gt;
    &lt;option label='Disable absolutely all message logging 
                   including automatic archiving - see 
                   XEP-0136'&gt;
      &lt;value&gt;true&lt;/value&gt;
    &lt;/option&gt;
  &lt;/field&gt;
  &lt;field
      var='reason'
      type='text-single'
      label='A reason for chatting (or not)'/&gt;
  &lt;field
      var='security'
      type='list-single'
      label='Minimum security level'&gt;
    &lt;option label='Secure connections not required'&gt;
      &lt;value&gt;none&lt;/value&gt;
    &lt;/option&gt;
    &lt;option label='Both parties must be securely connected to their servers'&gt;
      &lt;value&gt;c2s&lt;/value&gt;
    &lt;/option&gt;
    &lt;option label='Both parties must be securely connected to each other'&gt;
      &lt;value&gt;e2e&lt;/value&gt;
    &lt;/option&gt;
  &lt;/field&gt;
  &lt;field
      var='terminate'
      type='boolean'
      label='Whether to terminate the session'/&gt;
&lt;/form_type&gt;
      </pre></div>
  </div>
<h2>8.
       <a name="schema">XML Schema</a>
</h2>
  <p class="" style="">This proposal re-uses the format defined in XEP-0020 and therefore does not require a separate schema.</p>
<h2>9.
       <a name="ack">Acknowledgements</a>
</h2>
  <p class="" style="">Thanks to Thomas Charron and Jean-Louis Seguineau for their feedback.</p>
<p><hr></p>
<a name="notes"></a><h2>Notes</h2>
<div class="indent">
<p><a name="nt-id2250923">1</a>. RFC 3921: Extensible Messaging and Presence Protocol (XMPP): Instant Messaging and Presence &lt;<a href="http://www.ietf.org/rfc/rfc3921.txt">http://www.ietf.org/rfc/rfc3921.txt</a>&gt;.</p>
<p><a name="nt-id2250963">2</a>. XEP-0116: Encrypted Sessions &lt;<a href="http://www.xmpp.org/extensions/xep-0116.html">http://www.xmpp.org/extensions/xep-0116.html</a>&gt;.</p>
<p><a name="nt-id2250985">3</a>. XEP-0136: Message Archiving &lt;<a href="http://www.xmpp.org/extensions/xep-0136.html">http://www.xmpp.org/extensions/xep-0136.html</a>&gt;.</p>
<p><a name="nt-id2251006">4</a>. XEP-0030: Service Discovery &lt;<a href="http://www.xmpp.org/extensions/xep-0030.html">http://www.xmpp.org/extensions/xep-0030.html</a>&gt;.</p>
<p><a name="nt-id2250996">5</a>. XEP-0115: Entity Capabilities &lt;<a href="http://www.xmpp.org/extensions/xep-0115.html">http://www.xmpp.org/extensions/xep-0115.html</a>&gt;.</p>
<p><a name="nt-id2251051">6</a>. RFC 3261: Session Initiation Protocol (SIP) &lt;<a href="http://www.ietf.org/rfc/rfc3261.txt">http://www.ietf.org/rfc/rfc3261.txt</a>&gt;.</p>
<p><a name="nt-id2251038">7</a>. In essence, a chat state negotiation request as specified herein is functionally equivalent to a SIP INVITE request, and acceptance of such a request is functionally equivalent to sending a SIP 200 OK response; see Section 17 of <span style="font-weight: bold">RFC 3261</span>.</p>
<p><a name="nt-id2260204">8</a>. XEP-0020: Feature Negotiation &lt;<a href="http://www.xmpp.org/extensions/xep-0020.html">http://www.xmpp.org/extensions/xep-0020.html</a>&gt;.</p>
<p><a name="nt-id2260236">9</a>. The &lt;message/&gt; stanza is used because the user does not necessarily know which of the contact's resources is most available (or indeed if the contact is online).</p>
<p><a name="nt-id2260264">10</a>. RFC 3921: Extensible Messaging and Presence Protocol (XMPP): Instant Messaging and Presence &lt;<a href="http://www.ietf.org/rfc/rfc3921.txt">http://www.ietf.org/rfc/rfc3921.txt</a>&gt;.</p>
<p><a name="nt-id2260283">11</a>. In accordance with Section 3.2.2.1 of <span style="font-weight: bold">XML Schema Part 2: Datatypes</span>, the allowable lexical representations for the xs:boolean datatype are the strings "0" and "false" for the concept 'false' and the strings "1" and "true" for the concept 'true'; implementations MUST support both styles of lexical representation.</p>
<p><a name="nt-id2260325">12</a>. XEP-0079: Advanced Message Processing &lt;<a href="http://www.xmpp.org/extensions/xep-0079.html">http://www.xmpp.org/extensions/xep-0079.html</a>&gt;.</p>
<p><a name="nt-id2260342">13</a>. XEP-0136: Message Archiving &lt;<a href="http://www.xmpp.org/extensions/xep-0136.html">http://www.xmpp.org/extensions/xep-0136.html</a>&gt;.</p>
<p><a name="nt-id2260353">14</a>. A client MUST NOT set the 'otr' field to 'true' unless it has confirmed that its server will allow it to switch off Automated Archiving (see <span style="font-weight: bold">Message Archiving</span>).</p>
<p><a name="nt-id2260382">15</a>. XEP-0071: XHTML-IM &lt;<a href="http://www.xmpp.org/extensions/xep-0071.html">http://www.xmpp.org/extensions/xep-0071.html</a>&gt;.</p>
<p><a name="nt-id2260406">16</a>. XEP-0085: Chat State Notifications &lt;<a href="http://www.xmpp.org/extensions/xep-0085.html">http://www.xmpp.org/extensions/xep-0085.html</a>&gt;.</p>
<p><a name="nt-id2260863">17</a>. See <span style="font-weight: bold">Encrypted Sessions</span> for examples where the user might find the values submitted by the contact unacceptable.</p>
<p><a name="nt-id2261186">18</a>. Basic Messaging and Presence Interoperability between the Extensible Messaging and Presence Protocol (XMPP) and Session Initiation Protocol (SIP) for Instant Messaging and Presence Leveraging Extensions (SIMPLE) &lt;<a href="http://www.ietf.org/internet-drafts/draft-saintandre-xmpp-simple-05.txt">http://www.ietf.org/internet-drafts/draft-saintandre-xmpp-simple-05.txt</a>&gt; (work in progress).</p>
<p><a name="nt-id2261329">19</a>. In general, if a party is not subscribing to the other party's presence then it will never assume the other party is is unable to continue a session.</p>
<p><a name="nt-id2261398">20</a>. The Internet Assigned Numbers Authority (IANA) is the central coordinator for the assignment of unique parameter values for Internet protocols, such as port numbers and URI schemes. For further information, see &lt;<a href="http://www.iana.org/">http://www.iana.org/</a>&gt;.</p>
<p><a name="nt-id2261449">21</a>. The XMPP Registrar maintains a list of reserved protocol namespaces as well as registries of parameters used in the context of XMPP extension protocols approved by the Jabber Software Foundation. For further information, see &lt;<a href="http://www.xmpp.org/registrar/">http://www.xmpp.org/registrar/</a>&gt;.</p>
<p><a name="nt-id2261502">22</a>. XEP-0068: Field Data Standardization for Data Forms &lt;<a href="http://www.xmpp.org/extensions/xep-0068.html">http://www.xmpp.org/extensions/xep-0068.html</a>&gt;.</p>
</div>
<p><hr></p>
<a name="revs"></a><h2>Revision History</h2>
<div class="indent">
<h4>Version 0.10 (2006-10-31)</h4>
<div class="indent">
<p class="" style="">Defined handling of offline requests; specified localization of the title element and all labels; changed syntax of list of unacceptable fields; removed reason field from some examples; added confirmation message to initial negotiation; clarified the initial participating resources; removed id attributes.</p> (ip)
    </div>
<h4>Version 0.9 (2006-10-08)</h4>
<div class="indent">
<p class="" style="">Added language field; replaced secure field with security field; changed type of otr, XHTML and Chat State fields from boolean to list-single; added not-acceptable error; several clarifications.</p> (ip)
    </div>
<h4>Version 0.8 (2006-10-02)</h4>
<div class="indent">
<p class="" style="">Added continue field and optional terminate acknowledgement; specified renegotiation failure proceedure; added context to Introduction; changed unavailable presence handling; renamed logging field to otr.</p> (ip)
    </div>
<h4>Version 0.7 (2006-07-14)</h4>
<div class="indent">
<p class="" style="">Added secure field from XEP-0116.</p> (psa)
    </div>
<h4>Version 0.6 (2006-07-13)</h4>
<div class="indent">
<p class="" style="">Specified that a client must re-initiate if it receives presence unavailable; changed document type to Standards Track.</p> (psa)
    </div>
<h4>Version 0.5 (2006-01-24)</h4>
<div class="indent">
<p class="" style="">Added renegotiate use case.</p> (psa)
    </div>
<h4>Version 0.4 (2006-01-03)</h4>
<div class="indent">
<p class="" style="">Added terminate use case; further specified mapping to SIP.</p> (psa)
    </div>
<h4>Version 0.3 (2005-12-30)</h4>
<div class="indent">
<p class="" style="">Further specified use of id attribute and thread element.</p> (psa)
    </div>
<h4>Version 0.2 (2005-07-15)</h4>
<div class="indent">
<p class="" style="">Further described contexts in which chat session negotiation could be useful; added more examples; added reference to SIP RFC and explained basic mapping to SIP INVITE method; added XMPP Registrar considerations.</p> (psa)
    </div>
<h4>Version 0.1 (2005-07-14)</h4>
<div class="indent">
<p class="" style="">Initial version.</p> (psa)
    </div>
<h4>Version 0.0.1 (2005-07-12)</h4>
<div class="indent">
<p class="" style="">First draft.</p> (psa)
    </div>
</div>
<p><hr></p>
<p>END</p>
</body>
</html>
