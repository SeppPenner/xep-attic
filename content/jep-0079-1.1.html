<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>JEP-0079: Advanced Message Processing</title>
<link rel="stylesheet" type="text/css" href="jep.css">
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
<meta name="DC.Title" content="Advanced Message Processing">
<meta name="DC.Creator" content="Matthew Miller">
<meta name="DC.Creator" content="Peter Saint-Andre">
<meta name="DC.Description" content="This JEP defines a protocol that enables entities to request, and servers to perform, advanced processing of XMPP &lt;message/&gt; stanzas, including reliable data transport, time-sensitive delivery, and transient messages.">
<meta name="DC.Publisher" content="Jabber Software Foundation">
<meta name="DC.Contributor" content="JEP Editor">
<meta name="DC.Date" content="2005-10-19">
<meta name="DC.Type" content="Jabber Enhancement Proposal">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="JEP-0079">
<meta name="DC.Language" content="en">
<meta name="DC.Rights" content="This Jabber Enhancement Proposal is copyright 1999 - 2005 by the Jabber Software Foundation (JSF) and is in full conformance with the JSF's Intellectual Property Rights Policy &lt;http://www.jabber.org/jsf/ipr-policy.shtml&gt;. This material may be distributed only subject to the terms and conditions set forth in the Creative Commons Attribution License (&lt;http://creativecommons.org/licenses/by/2.5/&gt;).">
</head>
<body>
<h1>JEP-0079: Advanced Message Processing</h1>
<p>This JEP defines a protocol that enables entities to request, and servers to perform, advanced processing of XMPP &lt;message/&gt; stanzas, including reliable data transport, time-sensitive delivery, and transient messages.</p>
<p><hr></p>
<p style="color:green">NOTICE: The protocol defined herein is a Draft Standard of the Jabber Software Foundation. Implementations are encouraged and the protocol is appropriate for deployment in production systems, but some changes to the protocol are possible before it becomes a Final Standard.</p>
<p><hr></p>
<h2>JEP Information</h2>
<p class="indent">
            Status: Draft<br>
            Type: Standards Track<br>
            Number: 0079<br>
            Version: 1.1<br>
            Last Updated: 2005-10-19<br>
            JIG: Standards JIG<br>
                Approving Body: Jabber Council<br>Dependencies: XMPP Core, JEP-0030, JEP-0082<br>Supersedes: JEP-0023<br>
                Superseded By: None<br>
            Short Name: amp<br>
        Schema for amp: &lt;<a href="http://jabber.org/protocol/amp/amp.xsd">http://jabber.org/protocol/amp/amp.xsd</a>&gt;<br>
        Schema for amp#errors: &lt;<a href="http://jabber.org/protocol/amp/errors.xsd">http://jabber.org/protocol/amp/errors.xsd</a>&gt;<br>
              Registry: 
              
              &lt;<a href="http://www.jabber.org/registrar/amp.html">http://www.jabber.org/registrar/amp.html</a>&gt;
              <br>
            Wiki Page: &lt;<a href="http://wiki.jabber.org/index.php/Advanced%20Message%20Processing%20(JEP-0079)">http://wiki.jabber.org/index.php/Advanced Message Processing (JEP-0079)</a>&gt;
          </p>
<h2>Author Information</h2>
<div class="indent">
<h3>Matthew Miller</h3>
<p class="indent">
        Email: linuxwolf@outer-planes.net<br>
        JID: linuxwolf@outer-planes.net</p>
<h3>Peter Saint-Andre</h3>
<p class="indent">
        Email: stpeter@jabber.org<br>
        JID: stpeter@jabber.org</p>
</div>
<h2>Legal Notice</h2>
<p class="indent">This Jabber Enhancement Proposal is copyright 1999 - 2005 by the <a href="http://www.jabber.org/jsf/">Jabber Software Foundation</a> (JSF) and is in full conformance with the JSF's Intellectual Property Rights Policy &lt;<a href="http://www.jabber.org/jsf/ipr-policy.shtml">http://www.jabber.org/jsf/ipr-policy.shtml</a>&gt;. This material may be distributed only subject to the terms and conditions set forth in the Creative Commons Attribution License (&lt;<a href="http://creativecommons.org/licenses/by/2.5/">http://creativecommons.org/licenses/by/2.5/</a>&gt;).</p>
<h2>Discussion Venue</h2>
<p class="indent">The preferred venue for discussion of this document is the Standards-JIG discussion list: &lt;<a href="http://mail.jabber.org/mailman/listinfo/standards-jig">http://mail.jabber.org/mailman/listinfo/standards-jig</a>&gt;.</p>
<h2>Relation to XMPP</h2>
<p class="indent">The Extensible Messaging and Presence Protocol (XMPP) is defined in the XMPP Core (RFC 3920) and XMPP IM (RFC 3921) specifications contributed by the Jabber Software Foundation to the Internet Standards Process, which is managed by the Internet Engineering Task Force in accordance with RFC 2026. Any protocol defined in this JEP has been developed outside the Internet Standards Process and is to be understood as an extension to XMPP rather than as an evolution, development, or modification of XMPP itself.</p>
<h2>Conformance Terms</h2>
<p class="indent">The keywords "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "NOT RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in RFC 2119.</p>
<p><hr></p>
<h2>Table of Contents</h2>
<div class="indent"><dl>
<dt>1.  <a href="#intro">Introduction</a>
</dt>
<dl>
<dt>1.1.  <a href="#intro-motivation">Motivation</a>
</dt>
<dt>1.2.  <a href="#intro-concepts">Concepts</a>
</dt>
<dt>1.3.  <a href="#intro-prereq">Prerequisites</a>
</dt>
</dl>
<dt>2.  <a href="#process">Process Flows</a>
</dt>
<dl>
<dt>2.1.  <a href="#process-s2s">Sender-to-Server</a>
</dt>
<dl>
<dt>2.1.1.  <a href="#process-s2s-disco">Discovery</a>
</dt>
<dt>2.1.2.  <a href="#process-s2s-semantics">Specifying Semantics</a>
</dt>
</dl>
<dt>2.2.  <a href="#process-server">Server Processing</a>
</dt>
<dl>
<dt>2.2.1.  <a href="#process-server-semantics">Validating Semantics</a>
</dt>
<dt>2.2.2.  <a href="#process-server-default">Determine Default Action</a>
</dt>
<dt>2.2.3.  <a href="#process-server-rules">Process Rules</a>
</dt>
<dt>2.2.4.  <a href="#process-server-execute">Execute Determined Action</a>
</dt>
</dl>
</dl>
<dt>3.  <a href="#conditionsactions">Conditions and Actions</a>
</dt>
<dl>
<dt>3.1.  <a href="#conditions-guide">Rule Condition Guidelines</a>
</dt>
<dt>3.2.  <a href="#actions-guide">Rule Action Guidelines</a>
</dt>
<dt>3.3.  <a href="#conditions-def">Defined Conditions</a>
</dt>
<dl>
<dt>3.3.1.  <a href="#conditions-def-deliver">deliver</a>
</dt>
<dt>3.3.2.  <a href="#conditions-def-expireat">expire-at</a>
</dt>
<dt>3.3.3.  <a href="#conditions-def-match">match-resource</a>
</dt>
</dl>
<dt>3.4.  <a href="#actions-def">Defined Actions</a>
</dt>
<dl>
<dt>3.4.1.  <a href="#actions-def-drop">drop</a>
</dt>
<dt>3.4.2.  <a href="#actions-def-error">error</a>
</dt>
<dt>3.4.3.  <a href="#actions-def-notify">notify</a>
</dt>
<dt>3.4.4.  <a href="#actions-def-alert">alert</a>
</dt>
</dl>
<dt>3.5.  <a href="#security-conditions">Security Considerations for the Defined Conditions/Actions</a>
</dt>
<dl><dt>3.5.1.  <a href="#security-deliver">"deliver" Condition</a>
</dt></dl>
</dl>
<dt>4.  <a href="#formal">Formal Description</a>
</dt>
<dl>
<dt>4.1.  <a href="#formal-root">&lt;amp/&gt; Root Element</a>
</dt>
<dt>4.2.  <a href="#formal-rule">&lt;rule/&gt; Element</a>
</dt>
</dl>
<dt>5.  <a href="#examples">Example Scenarios</a>
</dt>
<dl>
<dt>5.1.  <a href="#examples-reliabledata">Reliable Data Transport</a>
</dt>
<dt>5.2.  <a href="#examples-time">Time-Sensitive Messages</a>
</dt>
<dt>5.3.  <a href="#examples-transient">Transient Messages</a>
</dt>
</dl>
<dt>6.  <a href="#errors">Error Handling</a>
</dt>
<dl>
<dt>6.1.  <a href="#errors-conditions">Conditions</a>
</dt>
<dt>6.2.  <a href="#errors-examples">Examples</a>
</dt>
<dl>
<dt>6.2.1.  <a href="#errors-action">Unsupported Action</a>
</dt>
<dt>6.2.2.  <a href="#errors-condition">Unsupported Condition</a>
</dt>
<dt>6.2.3.  <a href="#errors-notacceptable">Not Acceptable</a>
</dt>
<dt>6.2.4.  <a href="#errors-unavail">Service Unavailable</a>
</dt>
<dt>6.2.5.  <a href="#errors-undefined">Undefined Condition</a>
</dt>
</dl>
</dl>
<dt>7.  <a href="#impl">Implementation Notes</a>
</dt>
<dt>8.  <a href="#security">Security Considerations</a>
</dt>
<dt>9.  <a href="#iana">IANA Considerations</a>
</dt>
<dt>10.  <a href="#registrar">Jabber Registrar Considerations</a>
</dt>
<dl>
<dt>10.1.  <a href="#registrar-ns">Protocol Namespaces</a>
</dt>
<dt>10.2.  <a href="#registrar-nodes">Well-Known Service Discovery Nodes</a>
</dt>
<dt>10.3.  <a href="#registrar-reg">Registries</a>
</dt>
<dl>
<dt>10.3.1.  <a href="#registrar-reg-conditions">Rule Conditions Registry</a>
</dt>
<dl>
<dt>10.3.1.1.  <a href="#registrar-reg-conditions-process">Process</a>
</dt>
<dt>10.3.1.2.  <a href="#registrar-reg-conditions-initial">Initial Submission</a>
</dt>
</dl>
<dt>10.3.2.  <a href="#registrar-reg-actions">Rule Actions Registry</a>
</dt>
<dl>
<dt>10.3.2.1.  <a href="#registrar-reg-actions-process">Process</a>
</dt>
<dt>10.3.2.2.  <a href="#registrar-reg-actions-initial">Initial Submission</a>
</dt>
</dl>
</dl>
</dl>
<dt>11.  <a href="#schemas">XML Schemas</a>
</dt>
<dl>
<dt>11.1.  <a href="#schemas-amp">AMP</a>
</dt>
<dt>11.2.  <a href="#schemas-err">Errors</a>
</dt>
</dl>
<dt>12.  <a href="#acks">Acknowledgements</a>
</dt>
<dt><a href="#notes">Notes</a></dt>
<dt><a href="#revs">Revision History</a></dt>
</dl></div>
<p><hr></p>
<h2>1.
       <a name="intro">Introduction</a>
</h2>
  <p class="" style="">This JEP defines a protocol that enables an end-point entity to specify additional delivery semantics for an XMPP &lt;message/&gt; stanza. This protocol is typically used by clients to inform the receiving server how to deliver a particular stanza, such as providing an expiration time or a resource-matching strategy.</p>
  <div class="indent">
<h3>1.1 <a name="intro-motivation">Motivation</a>
</h3>
    <p class="" style="">The built-in delivery semantics for &lt;message/&gt; stanzas (defined in <span class="ref" style="">XMPP Core</span>  [<a href="#nt-id2250770">1</a>] and, for instant messaging applications, also in <span class="ref" style="">XMPP IM</span>  [<a href="#nt-id2250713">2</a>]) are adequate for most current applications. However, there are various cases where more stringent delivery semantics are necessary. The most common cases discussed in this JEP are:</p>
    <ul>
      <li>Reliable data transport -- the sender requires notification (positive and/or negative) of message delivery.</li>
      <li>Time-sensitive messages -- the message is valid only until a certain date and time.</li>
      <li>Transient messages -- the message should not be stored offline for later delivery.</li>
    </ul>
  </div>
  <div class="indent">
<h3>1.2 <a name="intro-concepts">Concepts</a>
</h3>
    <p class="" style="">This protocol is mostly handled by the server or servers processing the &lt;message/&gt;. The protocol consists of a list of rules, with conditions and actions for each rule. Upon receipt of an appropriately marked message, the server interprets the rules in the order they are received, looking for met conditions. When a condition is met, the action for that rule is executed, and message processing stops.</p>
    <p class="" style="">Each rule is flagged for the scope it applies to, whether it be the overall route, or for each hop in the route.  Additionally, while this JEP defines a default set of conditions and actions, the protocol is extensible enough to allow for more to be defined in the future.</p>
    <p class="" style="">The namespace for the protocol is "http://jabber.org/protocol/amp".</p>
  </div>
  <div class="indent">
<h3>1.3 <a name="intro-prereq">Prerequisites</a>
</h3>
    <p class="" style="">In order for this protocol to function properly, the containing &lt;message/&gt; stanza MUST possess an 'id' attribute, and the value of the 'id' attribute MUST NOT be an empty string. The server MUST specify this 'id' attribute value with any response back to the sender. This is necessary so that servers and clients can properly relate the initial request with any subsequent error or notification.</p>
  </div>
<h2>2.
       <a name="process">Process Flows</a>
</h2>
  <div class="indent">
<h3>2.1 <a name="process-s2s">Sender-to-Server</a>
</h3>
    <p class="" style="">This flow describes the interaction between the sender and a server. As illustrated below, this interaction is actually rather simple:</p>
    <ol start="1" type="1">
      <li>Sender determines support (E1)</li>
      <li>Sender specifies appropriate rules and sends message to server (E1,E2)</li>
      <li>Sender awaits any protocol-specific responses (UCE)</li>
    </ol>
    <ul>
      <li>
<span style="font-weight: bold">E1:</span> The server does not support this protocol (UCE)</li>
      <li>
<span style="font-weight: bold">E2:</span> The server does not support one or more specified rule conditions/actions (UCE)</li>
    </ul>
    <div class="indent">
<h3>2.1.1 <a name="process-s2s-disco">Discovery</a>
</h3>
      <p class="" style="">Sending entities that wish to use AMP SHOULD discover support for this protocol (using <span class="ref" style="">Service Discovery</span>  [<a href="#nt-id2256385">3</a>]) along the intended path. Typically, this would involve sending disco#info queries to the sending entity's own server and the server of the intended recipient. The results of these queries MAY be cached for up to 24 hours, unless otherwise expired.</p>
      <p class="" style="">If a server supports Advanced Message Processing, it MUST report that by including a service discovery feature of "http://jabber.org/protocol/amp" in the service discovery information result that it returns to the requesting entity.</p>
      <p class="caption">Example 1. Initial Service Discovery information request</p>
<div class="indent"><pre>
&lt;iq from='northumberland@shakespeare.lit/westminster'
    to='shakespeare.lit'
    type='get'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#info'/&gt;
&lt;/iq&gt;
      </pre></div>
      <p class="caption">Example 2. Service Discovery information response</p>
<div class="indent"><pre>
&lt;iq from='shakespeare.lit'
    to='northumberland@shakespeare.lit/westminster'
    type='result'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#info'&gt;
    &lt;identity name='Shakespeare IM' category='im' type='server'/&gt;
    ...
    &lt;feature var='http://jabber.org/protocol/amp'/&gt;
    ...
  &lt;/query&gt;
&lt;/iq&gt;
      </pre></div>
      <p class="" style="">A server SHOULD also maintain a service discovery node named "http://jabber.org/protocol/amp", at which it advertises the individual actions and conditions it supports. If an entity needs to determine whether the server supports individual actions and conditions, it SHOULD send a service discovery information request to that node; the server then MUST either return the list of supported actions and conditions or return an error such as &lt;feature-not-implemented/&gt;. (Note: If the server does not provide information for this disco node, the requesting entity MUST assume that all actions and conditons are supported for each reported action set or condition set.)</p>
      <p class="" style="">Each supported action shall be reported as a feature using the following format:</p>
      <p class="caption"></p>
<div class="indent"><pre>http://jabber.org/protocol/amp?action={action}</pre></div>
      <p class="" style="">Each supported condition shall be reported as a feature using the following format:</p>
      <p class="caption"></p>
<div class="indent"><pre>http://jabber.org/protocol/amp?condition={condition}</pre></div>
      <p class="" style="">The following examples show the request-response flow for information about individual actions and conditions (note the inclusion of the 'node' attribute).</p>
      <p class="caption">Example 3. Request for information about individual actions and conditions</p>
<div class="indent"><pre>
&lt;iq from='northumberland@shakespeare.lit/westminster'
    to='shakespeare.lit'
    type='get'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#info'
         node='http://jabber.org/protocol/amp'/&gt;
&lt;/iq&gt;
      </pre></div>
      <p class="caption">Example 4. Response for individual actions and conditions</p>
<div class="indent"><pre>
&lt;iq from='shakespeare.lit'
    to='northumberland@shakespeare.lit/westminster'
    type='result'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#info'
         node='http://jabber.org/protocol/amp'&gt;
    &lt;identity name='Shakespeare IM AMP Support' category='im' type='server'/&gt;
    ...
    &lt;feature var='http://jabber.org/protocol/amp'/&gt;
    &lt;feature var='http://jabber.org/protocol/amp?action=drop'/&gt;
    &lt;feature var='http://jabber.org/protocol/amp?action=error'/&gt;
    &lt;feature var='http://jabber.org/protocol/amp?action=notify'/&gt;
    &lt;feature var='http://jabber.org/protocol/amp?condition=deliver'/&gt;
    &lt;feature var='http://jabber.org/protocol/amp?condition=expire-at'/&gt;
    &lt;feature var='http://jabber.org/protocol/amp?condition=match-resource'/&gt;
    ...
  &lt;/query&gt;
&lt;/iq&gt;
      </pre></div>
    </div>
    <div class="indent">
<h3>2.1.2 <a name="process-s2s-semantics">Specifying Semantics</a>
</h3>
      <p class="" style="">Once support is determined, the sender can attach the desired delivery semantics to the message:</p>
      <p class="caption">Example 5. A message with semantics</p>
<div class="indent"><pre>
&lt;message
    from='northumberland@shakespeare.lit'
    id='richard2-4.1.247'
    to='kingrichard@royalty.england.lit'&gt;
  &lt;body&gt;My lord, dispatch; read o'er these articles.&lt;/body&gt;
  &lt;amp xmlns='http://jabber.org/protocol/amp'&gt;
    &lt;rule condition='expire-at'
          action='drop'
          value='2004-01-01T00:00:00Z'/&gt;
  &lt;/amp&gt;
&lt;/message&gt;
      </pre></div>
      <p class="" style="">The semantics are defined as a set of &lt;rule/&gt; elements within the &lt;amp/&gt; root element. Each &lt;rule/&gt; declares the condition to trigger on and the action to execute if triggered.</p>
      <p class="" style="">By default, the ruleset applies only to the "edge servers": those servers to which the sending and receiving entities are connected. (Note: For the purposes of Advanced Message Processing, "server" is defined as in <span style="font-weight: bold">XMPP Core</span> and does not include any internal components, such as connection managers, that may provide functionality within a server implementation or installation.)</p>
      <p class="" style="">The ruleset MAY be applied to all server-to-server "hops" along the route from the sending and receiving entities by adding the "per-hop' attribute to the &lt;amp/&gt; element. The value of this attribute is either "true" (apply rules to all hops) or "false" (follow default behavior, i.e., apply rules at the edge servers only).</p>
      <p class="caption">Example 6. A message with semantics</p>
<div class="indent"><pre>
&lt;message
    from='northumberland@shakespeare.lit'
    id='richard2-4.1.247'
    to='kingrichard@royalty.england.lit'&gt;
  &lt;body&gt;My lord, dispatch; read o'er these articles.&lt;/body&gt;
  &lt;amp xmlns='http://jabber.org/protocol/amp'
       per-hop='true'&gt;
    &lt;rule condition='expire-at'
          action='drop'
          value='2004-01-01T00:00:00Z'/&gt;
  &lt;/amp&gt;
&lt;/message&gt;
      </pre></div>
      <p class="" style="">For examples of validation failure, refer to the <a href="#errors">Error Handling</a> section of this document.</p>
      <p class="" style="">Note: Even if "per-hop" processing is requested, each server in the route MUST ignore rules that cannot apply to it; the <a href="#conditions-def">Defined Conditions</a> outline if they can be applied per-hop.</p>
    </div>
  </div>
  <div class="indent">
<h3>2.2 <a name="process-server">Server Processing</a>
</h3>
    <p class="" style="">Server operation is where the bulk of the work is performed. Upon receiving a message with an AMP extension, the server performs the following flow:</p>
    <ol start="1" type="1">
      <li>Validate the semantics (E1, E2).</li>
      <li>Determine the default behavior.</li>
      <li>Process rules until condition is met.
        <ul>
          <li>If a condition is met, execute that rule's action</li>
          <li>If no conditions are met, perform "default" behavior for message</li>
        </ul>
      </li>
      <li>Execute determined action (UCE) (E3).</li>
    </ol>
    <ul>
      <li>
<span style="font-weight: bold">E1:</span> The provided semantics (rule's condition/action) are not supported or valid (UCE)</li>
      <li>
<span style="font-weight: bold">E2:</span> The requested semantics are not acceptable (UCE)</li>
      <li>
<span style="font-weight: bold">E3:</span> The next server does not support this protocol (UCE)</li>
    </ul>
    <div class="indent">
<h3>2.2.1 <a name="process-server-semantics">Validating Semantics</a>
</h3>
      <p class="" style="">Validation can take many forms, but at the very least the server MUST verify that it understands each of the rule conditions and actions, and that the condition contents are appropriate. The server MAY also refused to accept certain combinations of conditions and actions, for example if they present a risk of overriding security. If the semantics are not valid, supported, or acceptable, the server MUST reply with an error specifying the rule(s) that are at issue. The server SHOULD validate all the semantics before returning an error. For syntax and examples of error handling related to validation failure, refer to the <a href="#errors">Error Handling</a> section of this document.</p>
    </div>
    <div class="indent">
<h3>2.2.2 <a name="process-server-default">Determine Default Action</a>
</h3>
      <p class="" style="">This step is essentially what a server normally does, except that it does not actually perform the action. This determines what would happen to the message if there were no semantics attached (such as dispatch to another server or store offline). At this point, the server SHOULD also calculate any timing or calendar requirements (if applicable).</p>
    </div>
    <div class="indent">
<h3>2.2.3 <a name="process-server-rules">Process Rules</a>
</h3>
      <p class="" style="">At this step, the server processes the attached semantics. The server MUST process the rules serially, and in the order they are presented within the &lt;amp/&gt; element. As soon as a rule's condition is met, processing ends with that action overriding the default action determined earlier (unless the action permits continued processing).</p>
    </div>
    <div class="indent">
<h3>2.2.4 <a name="process-server-execute">Execute Determined Action</a>
</h3>
      <p class="" style="">Once all rules have been processed or otherwise accounted for, the server executes the action determined at this point.</p>
      <p class="" style="">A server SHOULD NOT dispatch a &lt;message/&gt; stanza with AMP semantics to another server unless it knows that the next server supports AMP (this SHOULD be discovered via <span style="font-weight: bold">Service Discovery</span> and MAY be cached to avoid delivery delays). If the next server does not support AMP, the current server replies to the original sender with a &lt;service-unavailable/&gt; error condition. Otherwise this flow starts again for the server to which the message has been dispatched.</p>
    </div>
  </div>
<h2>3.
       <a name="conditionsactions">Conditions and Actions</a>
</h2>
  <p class="" style="">The preceding sections of this JEP define the general behavior regarding AMP. This section outlines how &lt;rule/&gt; action and condition sets are defined. It also provides defined action and condition sets; these action and condition sets SHOULD be supported by any implementation of Advanced Message Processing, but support for any given action or condition set it not required. (Note: The action and condition sets defined herein may be supplemented in the future via registration of additional action and condition sets with the Jabber Registrar.)</p>
  <div class="indent">
<h3>3.1 <a name="conditions-guide">Rule Condition Guidelines</a>
</h3>
    <p class="" style="">The definition of a &lt;rule/&gt; condition MUST provide the following information:</p>
    <ul>
      <li>Define a namespace governing the condition set</li>
      <li>Define the condition:
        <ul>
          <li>Define the 'condition' attribute value</li>
          <li>Specify if the "per-hop" flag applies</li>
          <li>Define the syntax/format of the 'value' attribute value</li>
          <li>Define how the "value" is interpreted to meet a condition</li>
        </ul>
      </li>
    </ul>
  </div>
  <div class="indent">
<h3>3.2 <a name="actions-guide">Rule Action Guidelines</a>
</h3>
    <p class="" style="">The definition of a &lt;rule/&gt; action MUST provide the following information:</p>
    <ul>
      <li>Define a namespace governing the action set</li>
      <li>Define the action:
        <ul>
          <li>Define each 'action' attribute value</li>
          <li>Define the expected behavior if the &lt;rule/&gt; is triggered</li>
        </ul>
      </li>
    </ul>
  </div>
  <div class="indent">
<h3>3.3 <a name="conditions-def">Defined Conditions</a>
</h3>
    <p class="" style="">The condition defines how or when a particular rule is triggered. The value of the condition attribute determines what the contents of the &lt;rule/&gt; mean.</p>
    <p class="" style="">The following conditions are defined by this JEP and SHOULD be supported by any implementation.</p>
    <p class="" style="">In the following sections, the terms "content" and "contents" refers to the XML character data contained by the &lt;rule/&gt; element.</p>
    <div class="indent">
<h3>3.3.1 <a name="conditions-def-deliver">deliver</a>
</h3>
      <p class="" style="">The "deliver" condition is used to ensure delivery (or non-delivery) in one of five ways:</p>
      <ol start="1" type="1">
        <li>Directly to an appropriate resource over XMPP</li>
        <li>Delayed to offline storage (for later delivery via XMPP)</li>
        <li>Forwarded to an alternate address over XMPP</li>
        <li>Indirectly to an alternate address through a gateway to a non-XMPP system</li>
      </ol>
      <p class="" style="">The possible contents for this condition are defined in the following table:</p>
      <p class="caption">Table 1: "deliver" values</p>
<table border="1" cellpadding="3" cellspacing="0">
        <tr class="body">
          <th colspan="" rowspan="">Value</th>
          <th colspan="" rowspan="">Description</th>
        </tr>
        <tr class="body">
          <td align="" colspan="" rowspan="">"direct"</td>
          <td align="" colspan="" rowspan="">The message can be delivered immediately to the intended resource.</td>
        </tr>
        <tr class="body">
          <td align="" colspan="" rowspan="">"forward"</td>
          <td align="" colspan="" rowspan="">The message cannot be delivered immediately to the intended resource and shall be forwarded to another XMPP address.</td>
        </tr>
        <tr class="body">
          <td align="" colspan="" rowspan="">"gateway"</td>
          <td align="" colspan="" rowspan="">The message cannot be delivered immediately to the intended resource and shall be sent through a gateway to an address on a non-XMPP system.</td>
        </tr>
        <tr class="body">
          <td align="" colspan="" rowspan="">"none"</td>
          <td align="" colspan="" rowspan="">The message cannot be delivered immediately to the intended resource and is to be dropped (e.g., because offline storage is not enabled).</td>
        </tr>
        <tr class="body">
          <td align="" colspan="" rowspan="">"stored"</td>
          <td align="" colspan="" rowspan="">The message cannot be delivered immediately to the intended resource and shall be stored offline for later delivery via XMPP.</td>
        </tr>
      </table>
      <p class="" style="">This condition is met based on what the processor is able to do with the message at the moment of receipt. To correctly process this condition, a processor first determines if the message can be delivered immediately to the intended resource or further dispatched to another hop. If so and the contents are "direct", the condition is met. If not and the contents are "stored", the condition is also met if offline storage is enabled. In all other cases the condition is not met.</p>
      <p class="" style="">This condition MAY be applied to each "hop" in the server route.</p>
    </div>
    <div class="indent">
<h3>3.3.2 <a name="conditions-def-expireat">expire-at</a>
</h3>
      <p class="" style="">The "expire-at" condition is used to ensure delivery before an absolute point in time. Naturally, this does not <span style="font-style: italic">guarantee</span>  [<a href="#nt-id2257365">4</a>] that the message will not be delivered after that time from the sender's perspective, since this JEP does not assume that all machine clocks (e.g., for all servers along the delivery route) are synchronized. However, in order to help ensure that this condition is met correctly, servers that implement this JEP (or the machines that host such servers) SHOULD use the Network Time Protocol (<span class="ref" style="">RFC 1305</span>  [<a href="#nt-id2257399">5</a>]) to keep in sync with established time authorities. Note also that expire-at functionality becomes less reliable the closer the expire-at time is to the present (e.g., the sender will receive less reliable delivery of a message speciifying an expire-at time two seconds in the future than of a message specifying an expire-at time two hours or two days in the future).</p>
      <p class="" style="">The content of the 'value' attribute specifies some point after the exact moment the message is sent; the content MUST be a DateTime as specified in <span class="ref" style="">Jabber Date and Time Profiles</span>  [<a href="#nt-id2257444">6</a>], and the timezone MUST be UTC.</p>
      <p class="" style="">The condition is met if the message cannot be delivered to the recipient before the specified datetime. To determine the datetime to compare to, the processor first determines if and when a message can be dispatched (e.g. not stored offline). The processor then records this datetime, and compares it with the specified datetime. If the current datetime is on or after that specified, the condition is met.</p>
      <p class="" style="">This condition MAY be applied to each "hop" in the server route.</p>
    </div>
    <div class="indent">
<h3>3.3.3 <a name="conditions-def-match">match-resource</a>
</h3>
      <p class="" style="">The "match-resource" condition is used to restrict delivery based on the resource identifier of the recipient JID.</p>
      <p class="" style="">The possible contents for this condition are:</p>
      <p class="caption">Table 2: "match-resource" values</p>
<table border="1" cellpadding="3" cellspacing="0">
        <tr class="body">
          <th colspan="" rowspan="">Value</th>
          <th colspan="" rowspan="">Description</th>
          <th colspan="" rowspan="">Example</th>
        </tr>
        <tr class="body">
          <td align="" colspan="" rowspan="">"exact"</td>
          <td align="" colspan="" rowspan="">Destination resource exactly matches the specified resource.</td>
          <td align="" colspan="" rowspan="">"home/laptop" only matches "home/laptop" and not "home/desktop" or "work/desktop"</td>
        </tr>
        <tr class="body">
          <td align="" colspan="" rowspan="">"any"</td>
          <td align="" colspan="" rowspan="">Destination resource matches any value, effectively ignoring the specified resource.</td>
          <td align="" colspan="" rowspan="">"home/laptop" matches "home", "home/desktop" or "work/desktop"</td>
        </tr>
        <tr class="body">
          <td align="" colspan="" rowspan="">"other"</td>
          <td align="" colspan="" rowspan="">Destination resource matches any value except for the specified resource.</td>
          <td align="" colspan="" rowspan="">"home/laptop" matches "work/desktop", "home" or "home/desktop", but not "home/laptop"</td>
        </tr>
      </table>
      <p class="" style="">The condition is met if the resource for the actual destination JID matches the specified destination JID using the above rules. For instance, if a message is intended for "romeo@montague.net/work" with the "match-resource" condition of "other", the condition is met if the message can be immediately delivered only to "romeo@montague.net/home".</p>
      <p class="" style="">For purposes of this condition, a JID with no resource has the following behavior:</p>
      <ul>
        <li>If the value is "exact", the condition is met only if the server would deliver to a non-resource JID (e.g., a <span class="ref" style="">Multi-User Chat</span>  [<a href="#nt-id2257668">7</a>] room or offline storage).</li>
        <li>If the value is "other", the condition is met only if the server would not deliver to a non-resource JID.</li>
      </ul>
      <p class="" style="">This condition MUST NOT be applied to each "hop" in the server route, only at the edge servers. If an &lt;amp/&gt; element includes this condition and also indicates that it should be processed per hop, this &lt;rule/&gt; shall be ignored.</p>
      <p class="" style="">Note: By design, this protocol does not include support for partial JID matching (which would stipulate, for example, that the resource identifiers "home/laptop" and "homeboy" both match "home").</p>
    </div>
  </div>
  <div class="indent">
<h3>3.4 <a name="actions-def">Defined Actions</a>
</h3>
    <p class="" style="">The action defines what occurs when a particular rule is triggered. The value of the action attribute determines the behavior if the rule's condition is met.</p>
    <p class="" style="">The following actions are defined by this JEP.</p>
    <div class="indent">
<h3>3.4.1 <a name="actions-def-drop">drop</a>
</h3>
      <p class="" style="">The "drop" action silently discards the message from any further delivery attempts and ensures that it is not placed into offline storage. The drop MUST NOT result in other responses.</p>
    </div>
    <div class="indent">
<h3>3.4.2 <a name="actions-def-error">error</a>
</h3>
      <p class="" style="">The "error" action triggers a reply &lt;message/&gt; stanza of type "error" to the sending entity. The &lt;message/&gt; stanza's &lt;error/&gt; child MUST contain a &lt;failed-rules xmlns='http://jabber.org/protocol/amp#errors'/&gt; error condition, which itself contains the rules that triggered this action.</p>
      <p class="caption">Example 7. "error" response</p>
<div class="indent"><pre><p class="caption"></p><div class="indent"><pre>
  &lt;message from='hamlet.lit'
           to='bernardo@hamlet.lit/elsinore'
           type='error'
           id='chatty2'&gt;
    &lt;body&gt;Who&amp;apos;s there?&lt;/body&gt;
    &lt;amp xmlns='http://jabber.org/protocol/amp'
         status='error'
         from='francisco@hamlet.lit'
         to='bernardo@hamlet.lit/elsinore'&gt;
      &lt;rule condition='deliver' value='stored' action='error'/&gt;
    &lt;/amp&gt;
    &lt;error type='modify' code='500'&gt;
      &lt;undefined-condition xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/&gt;
      &lt;failed-rules xmlns='http://jabber.org/protocol/amp#errors'&gt;
        &lt;rule condition='deliver' value='stored' action='error'/&gt;
      &lt;/failed-rules&gt;
    &lt;/error&gt;
  &lt;/message&gt;
      </pre></div></pre></div>
      <p class="" style="">Note that the error SHOULD be of type "modify", and the general error condition SHOULD be &lt;undefined-condition xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/&gt;.</p>
    </div>
    <div class="indent">
<h3>3.4.3 <a name="actions-def-notify">notify</a>
</h3>
      <p class="" style="">The "notify" action triggers a reply &lt;message/&gt; stanza to the sending entity. This &lt;message/&gt; stanza MUST contain the element &lt;amp status='notify'/&gt;, which itself contains the &lt;rule/&gt; that triggered this action. Unlike the other actions, this action does not override the default behavior for a server. Instead, the server then executes its default behavior after sending the notify.</p>
      <p class="caption">Example 8. "error" response</p>
<div class="indent"><pre><p class="caption"></p><div class="indent"><pre>
  &lt;message from='hamlet.lit'
           to='bernardo@hamlet.lit/elsinore'
           id='chatty2'&gt;
    &lt;body&gt;Who&amp;apos;s there?&lt;/body&gt;
    &lt;amp xmlns='http://jabber.org/protocol/amp'
         status='notify'
         from='francisco@hamlet.lit'
         to='bernardo@hamlet.lit/elsinore'&gt;
      &lt;rule condition='deliver' value='stored' action='notify'/&gt;
    &lt;/amp&gt;
  &lt;/message&gt;
      </pre></div></pre></div>
    </div>
    <div class="indent">
<h3>3.4.4 <a name="actions-def-alert">alert</a>
</h3>
      <p class="" style="">The "alert" action triggers a reply &lt;message/&gt; stanza to the sending entity. This &lt;message/&gt; stanza MUST contain the element &lt;amp type='alert'/&gt;, which itself contains the &lt;rule/&gt; that triggered this action. In all other respects, this action behaves as "drop".</p>
      <p class="caption">Example 9. "error" response</p>
<div class="indent"><pre><p class="caption"></p><div class="indent"><pre>
  &lt;message from='hamlet.lit'
           to='bernardo@hamlet.lit/elsinore'
           id='chatty2'&gt;
    &lt;body&gt;Who&amp;apos;s there?&lt;/body&gt;
    &lt;amp xmlns='http://jabber.org/protocol/amp'
         status='alert'
         from='francisco@hamlet.lit'
         to='bernardo@hamlet.lit/elsinore'&gt;
      &lt;rule condition='deliver' value='stored' action='alert'/&gt;
    &lt;/amp&gt;
  &lt;/message&gt;
      </pre></div></pre></div>
    </div>
  </div>
  <div class="indent">
<h3>3.5 <a name="security-conditions">Security Considerations for the Defined Conditions/Actions</a>
</h3>
    <div class="indent">
<h3>3.5.1 <a name="security-deliver">"deliver" Condition</a>
</h3>
      <p class="" style="">This condition has the largest potential for abuse, as it can appear to bypass presence. [<a href="#nt-id2257907">8</a>] A naive server could simply check to see the outcome for a particular message, regardless of whether the sender and receiver are subscribed to each other. This behavior SHOULD NOT be implemented, although it may be desirable in some environments (such as fully-trusted networks).</p>
      <p class="" style="">There are several directions server implementors can follow in this regard:</p>
      <ul>
        <li>This condition is not implemented. The result MUST be to reply to the sender with a &lt;feature-not-implemented/&gt; error condition.</li>
        <li>This condition is accepted only if the action is "drop". The result otherwise MUST be to reply to the sender with a &lt;not-acceptable/&gt; error condition.</li>
        <li>This condition is accepted only if the sender is subscribed to the receiver's presence. The result otherwise MUST be to reply to the sender with a &lt;not-acceptable/&gt; error condition.</li>
      </ul>
    </div>
  </div>
<h2>4.
       <a name="formal">Formal Description</a>
</h2>
  <div class="indent">
<h3>4.1 <a name="formal-root">&lt;amp/&gt; Root Element</a>
</h3>
    <p class="" style="">All delivery semantics are encapsulated in the &lt;amp/&gt; element. This element contains one or more &lt;rule/&gt; elements specifying the specific rules to process. It can optionally possess attributes about the current status, the original sender and recipient, and route applicability.</p>
    <p class="" style="">The 'status' attribute specifies the reason for this &lt;amp/&gt; element. When specifying semantics to be applied (client to server), this attribute MUST NOT be present. When replying to a sending entity regarding a met condition, this attribute MUST be present and SHOULD be the value of the 'action' attribute for the triggered rule. (Note: Individual action definitions MAY provide their own requirements.)</p>
    <p class="" style="">The 'from' attribute specifies the original sender of the containing &lt;message/&gt; stanza. This attribute MUST be specified for any &lt;message/&gt; stanza sent from a supporting server, regardless of the recipient. It SHOULD NOT be specified otherwise. The value of the 'from' attribute MUST be the full JID (node@domain/resource) of the sender for the original &lt;message/&gt; stanza.</p>
    <p class="" style="">The 'to' attribute specifies the original (intended) recipient of the containing &lt;message/&gt; stanza. This attribute MUST be specified for any &lt;message/&gt; stanza sent from a supporting server, regardless of the recipient. It SHOULD NOT be specified otherwise. The value of the 'to' attribute MUST be the full JID (node@domain/resource) of the intended recipient for the original &lt;message/&gt; stanza.</p>
    <p class="" style="">The 'per-hop' attribute flags the contained ruleset for processing at each server in the route between the original sender and original intended recipient. This attribute MAY be present, and MUST be either "true" or "false". If not present, the default is "false".</p>
  </div>
  <div class="indent">
<h3>4.2 <a name="formal-rule">&lt;rule/&gt; Element</a>
</h3>
    <p class="" style="">Each semantic rule is specified with a &lt;rule/&gt; element. This element possesses attributes for the condition, value, and action.</p>
    <p class="" style="">The 'action' attribute defines the result for this rule. This attribute MUST be present, and MUST be either a value defined in the <a href="#actions-def">Defined Actions</a> section, or one registered with the Jabber Registrar.</p>
    <p class="" style="">The 'condition' attribute defines the overall condition this rule applies to. This attribute MUST be present, and MUST be either a value defined in the <a href="#conditions-def">Defined Conditions</a> section, or one registered with the Jabber Registrar.</p>
    <p class="" style="">The 'value' attribute defines how the condition is matched. This attribute MUST be present, and MUST NOT be an empty string (""). The interpretation of this attribute's value is determined by the 'condition' attribute.</p>
  </div>
<h2>5.
       <a name="examples">Example Scenarios</a>
</h2>
  <div class="indent">
<h3>5.1 <a name="examples-reliabledata">Reliable Data Transport</a>
</h3>
    <p class="" style="">The &lt;message/&gt; stanza is nearly ideal for data transport, but to ensure reliability it is often desirable that such messages not be delivered to any resource but that specified. To facilitate this, the sending entity includes a &lt;rule action='drop' condition='match-resource' value='exact'/&gt; (if failure notification is unnecessary) or &lt;rule action='error' condition='match-resource' value='exact'/&gt; (if failure notification is required). The following example illustrates this using <span class="ref" style="">In-Band Bytestreams</span>  [<a href="#nt-id2258187">9</a>]:</p>
    <p class="caption">Example 10. Sending a message for reliable data transport</p>
<div class="indent"><pre>
&lt;message to='francisco@hamlet.lit/pda'
         from='bernardo@hamlet.lit/elsinore'
         id='ibb1'&gt;
  &lt;data xmlns='http://jabber.org/protocol/ibb' sid='mySID' seq='0'&gt;
    qANQR1DBwU4DX7jmYZnncmUQB/9KuKBddzQH+tZ1ZywKK0yHKnq57kWq+RFtQdCJ
    WpdWpR0uQsuJe7+vh3NWn59/gTc5MDlX8dS9p0ovStmNcyLhxVgmqS8ZKhsblVeu
    IpQ0JgavABqibJolc3BKrVtVV1igKiX/N7Pi8RtY1K18toaMDhdEfhBRzO/XB0+P
    AQhYlRjNacGcslkhXqNjK5Va4tuOAPy2n1Q8UUrHbUd0g+xJ9Bm0G0LZXyvCWyKH
    kuNEHFQiLuCY6Iv0myq6iX6tjuHehZlFSh80b5BVV9tNLwNR5Eqz1klxMhoghJOA
  &lt;/data&gt;
  &lt;amp xmlns='http://jabber.org/protocol/amp' per-hop='true'&gt;
    &lt;rule condition='expire-at' value='2004-09-10T08:33:14Z' action='error'/&gt;
    &lt;rule condition='match-resource' value='exact' action='error'/&gt;
  &lt;/amp&gt;
&lt;/message&gt;
    </pre></div>
    <p class="" style="">In the above case, the sender would receive an error reply if the message could not be delivered specifically to "francisco@hamlet.lit/pda" within 500 seconds.</p>
    <p class="caption">Example 11. Failed reliable data transport message</p>
<div class="indent"><pre>
&lt;message from='hamlet.lit'
         to='bernardo@hamlet.lit/elsinore'
         id='ibb1'&gt;
  &lt;data xmlns='http://jabber.org/protocol/ibb' sid='mySID' seq='0'&gt;
    qANQR1DBwU4DX7jmYZnncmUQB/9KuKBddzQH+tZ1ZywKK0yHKnq57kWq+RFtQdCJ
    WpdWpR0uQsuJe7+vh3NWn59/gTc5MDlX8dS9p0ovStmNcyLhxVgmqS8ZKhsblVeu
    IpQ0JgavABqibJolc3BKrVtVV1igKiX/N7Pi8RtY1K18toaMDhdEfhBRzO/XB0+P
    AQhYlRjNacGcslkhXqNjK5Va4tuOAPy2n1Q8UUrHbUd0g+xJ9Bm0G0LZXyvCWyKH
    kuNEHFQiLuCY6Iv0myq6iX6tjuHehZlFSh80b5BVV9tNLwNR5Eqz1klxMhoghJOA
  &lt;/data&gt;
  &lt;amp xmlns='http://jabber.org/protocol/amp'
      from='bernardo@hamlet.lit/elsinore'
      to='francisco@hamlet.lit/pda'&gt;
    &lt;rule condition='match-resource' value='exact' action='error'/&gt;
  &lt;/amp&gt;
  &lt;error type='modify' code='500'&gt;
    &lt;undefined-condition xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/&gt;
    &lt;failed-rules xmlns='http://jabber.org/protocol/amp#errors'&gt;
      &lt;rule condition='match-resource' value='exact' action='error'/&gt;
    &lt;/failed-rules&gt;
  &lt;/error&gt;
&lt;/message&gt;
    </pre></div>
  </div>
  <div class="indent">
<h3>5.2 <a name="examples-time">Time-Sensitive Messages</a>
</h3>
    <p class="" style="">Time-sensitive messages are a frequent occurrence in some environments (e.g., front-office personnel routinely notify others of "events" such as guests, unexpected refreshments, and ad-hoc gatherings). To send a time-sensitive message, the sending entity includes a &lt;rule condition='expire-at' action='drop'/&gt; with the time when the event is to occur:</p>
    <p class="caption">Example 12. Sending a time-sensitive message</p>
<div class="indent"><pre>
&lt;message to='linuxwolf@outer-planes.net'
         from='receptionist@outer-planes.net'
         id='alert849'&gt;
  &lt;subject&gt;Guest Alert!&lt;/subject&gt;
  &lt;body&gt;
    There will be clients in the conference room today around 1 PM!
    As always, be courteous and quiet nearby...
  &lt;/body&gt;
  &lt;amp xmlns='http://jabber.org/protocol/amp'&gt;
    &lt;rule condition='expire-at'
          action='drop'
          value='2003-06-23T23:00:00Z'/&gt;
  &lt;/amp&gt;
&lt;/message&gt;
    </pre></div>
    <p class="" style="">In the above case, the server for "linuxwolf@outer-planes.net" would not deliver the message once 23:00 UTC (3:00 PM Pacific Daylight Time) has passed.</p>
  </div>
  <div class="indent">
<h3>5.3 <a name="examples-transient">Transient Messages</a>
</h3>
    <p class="" style="">Transient messages are messages that should never be stored offline. To send a transient message, the sending entity includes a &lt;rule condition='deliver' action='drop' value='stored'/&gt;:</p>
    <p class="caption">Example 13. Sending a transient message</p>
<div class="indent"><pre>
&lt;message to='francisco@hamlet.lit'
         from='bernardo@hamlet.lit/elsinore'
         type='chat'
         id='chatty1'&gt;
  &lt;body&gt;Who&amp;apos;s there?&lt;/body&gt;
  &lt;amp xmlns='http://jabber.org/protocol/amp'&gt;
    &lt;rule condition='deliver' value='stored' action='drop'/&gt;
  &lt;/amp&gt;
&lt;/message&gt;
    </pre></div>
    <p class="" style="">Alternatively, the sending entity includes a &lt;rule condition='deliver' action='alert' value='stored'/&gt; to be alerted instead of having the message silently dropped:</p>
    <p class="caption">Example 14. Sending a transient message (requesting alert)</p>
<div class="indent"><pre>
&lt;message to='francisco@hamlet.lit'
         from='bernardo@hamlet.lit/elsinore'
         type='chat'
         id='chatty2'&gt;
  &lt;body&gt;Who&amp;apos;s there?&lt;/body&gt;
  &lt;amp xmlns='http://jabber.org/protocol/amp'&gt;
    &lt;rule condition='deliver' value='stored' action='alert'/&gt;
  &lt;/amp&gt;
&lt;/message&gt;
    </pre></div>
    <p class="caption">Example 15. Sender alerted regarding transient message</p>
<div class="indent"><pre>
&lt;message from='hamlet.lit'
         to='bernardo@hamlet.lit/elsinore'
         id='chatty2'&gt;
  &lt;amp xmlns='http://jabber.org/protocol/amp'
       action='alert'
       from='bernardo@hamlet.lit/elsinore'
       to='francisco@hamlet.lit'&gt;
    &lt;rule condition='deliver' value='stored' action='alert'/&gt;
  &lt;/amp&gt;
&lt;/message&gt;
    </pre></div>
  </div>
<h2>6.
       <a name="errors">Error Handling</a>
</h2>
  <div class="indent">
<h3>6.1 <a name="errors-conditions">Conditions</a>
</h3>
    <p class="" style="">To simplify the discussion of error conditions, this document uses the following mappings between namespace URIs and namespace prefixes (note: this mapping is provided only for the purpose of simplifying the discussion and is not intended for use within the protocol itself).</p>
    <p class="caption">Table 3: Namespace Mappings</p>
<table border="1" cellpadding="3" cellspacing="0">
      <tr class="body">
        <th colspan="" rowspan="">Prefix</th>
        <th colspan="" rowspan="">URI</th>
      </tr>
      <tr class="body">
        <td align="" colspan="" rowspan="">xmpp</td>
        <td align="" colspan="" rowspan="">urn:ietf:params:xml:ns:xmpp-stanzas</td>
      </tr>
      <tr class="body">
        <td align="" colspan="" rowspan="">msg</td>
        <td align="" colspan="" rowspan="">http://jabber.org/protocol/amp</td>
      </tr>
      <tr class="body">
        <td align="" colspan="" rowspan="">err</td>
        <td align="" colspan="" rowspan="">http://jabber.org/protocol/amp#errors</td>
      </tr>
    </table>
    <p class="" style="">The following table shows the possible error conditions in relation to general AMP rules and conditions as well as the <a href="#actions-def">Defined Actions</a>.</p>
    <p class="caption">Table 4: Error conditions</p>
<table border="1" cellpadding="3" cellspacing="0">
      <tr class="body">
        <th colspan="" rowspan="">General Condition</th>
        <th colspan="" rowspan="">Error Type</th>
        <th colspan="" rowspan="">Specific Condition</th>
        <th colspan="" rowspan="">Description</th>
      </tr>
      <tr class="body">
        <td align="" colspan="" rowspan="">&lt;xmpp:bad-request/&gt;</td>
        <td align="" colspan="" rowspan="">modify</td>
        <td align="" colspan="" rowspan="">&lt;msg:unsupported-actions/&gt;</td>
        <td align="" colspan="" rowspan="">One or more rule's specified actions are not supported. The element &lt;msg:unsupported-actions/&gt; contains the &lt;rule/&gt; elements that specify the unsupported actions.</td>
      </tr>
      <tr class="body">
        <td align="" colspan="" rowspan="">&lt;xmpp:bad-request/&gt;</td>
        <td align="" colspan="" rowspan="">modify</td>
        <td align="" colspan="" rowspan="">&lt;msg:unsupported-conditions/&gt;</td>
        <td align="" colspan="" rowspan="">One or more rule's specified conditions are not supported. The element &lt;msg:unsupported-conditions/&gt; contains the &lt;rule/&gt; elements that specify the unsupported conditions.</td>
      </tr>
      <tr class="body">
        <td align="" colspan="" rowspan="">&lt;xmpp:not-acceptable/&gt;</td>
        <td align="" colspan="" rowspan="">modify</td>
        <td align="" colspan="" rowspan="">&lt;msg:invalid-rules/&gt;</td>
        <td align="" colspan="" rowspan="">One or more rules are not acceptable by this server, usually because the condition/action combination is restricted. The element &lt;msg:invalid-rules/&gt; contains the &lt;rule/&gt; elements that are not acceptable.</td>
      </tr>
      <tr class="body">
        <td align="" colspan="" rowspan="">&lt;xmpp:service-unavailable/&gt;</td>
        <td align="" colspan="" rowspan="">cancel</td>
        <td align="" colspan="" rowspan="">NONE</td>
        <td align="" colspan="" rowspan="">This protocol is not supported. This error is returned to the sending entity if a server along the route to the recipient does not implement this protocol.</td>
      </tr>
      <tr class="body">
        <td align="" colspan="" rowspan="">&lt;xmpp:undefined-condition/&gt;</td>
        <td align="" colspan="" rowspan="">modify</td>
        <td align="" colspan="" rowspan="">&lt;err:failed-rules/&gt;</td>
        <td align="" colspan="" rowspan="">One or more &lt;rule/&gt; elements triggered the "error" action. This condition contains the triggered &lt;rule/&gt; elements.</td>
      </tr>
    </table>
  </div>
  <div class="indent">
<h3>6.2 <a name="errors-examples">Examples</a>
</h3>
    <p class="" style="">This section shows examples of the error conditions described in the previous section (for information regarding mapping of XMPP error conditions to Jabber error codes, refer to <span class="ref" style="">Error Condition Mappings</span>  [<a href="#nt-id2258762">10</a>]).</p>
    <div class="indent">
<h3>6.2.1 <a name="errors-action">Unsupported Action</a>
</h3>
      <p class="caption">Example 16. A message with semantics</p>
<div class="indent"><pre>
&lt;message
    from='northumberland@shakespeare.lit'
    id='richard2-4.1.247'
    to='kingrichard@royalty.england.lit'&gt;
  &lt;body&gt;My lord, dispatch; read o'er these articles.&lt;/body&gt;
  &lt;amp xmlns='http://jabber.org/protocol/amp'&gt;
    &lt;rule condition='expire-at'
          action='drop'
          value='2004-01-01T00:00:00Z'/&gt;
  &lt;/amp&gt;
&lt;/message&gt;
      </pre></div>
      <p class="caption">Example 17. Server does not support action</p>
<div class="indent"><pre>
&lt;message
    from='shakespeare.lit'
    id='richard2-4.1.247'
    to='northumberland@shakespeare.lit'
    type='error'&gt;
  &lt;body&gt;My lord, dispatch; read o'er these articles.&lt;/body&gt;
  &lt;amp xmlns='http://jabber.org/protocol/amp'&gt;
    &lt;rule condition='expire-at'
          action='drop'
          value='2004-01-01T00:00:00Z'/&gt;
  &lt;/amp&gt;
  &lt;error type='modify' code='400'&gt;
    &lt;bad-request xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/&gt;
    &lt;unsupported-actions xmlns='http://jabber.org/protocol/amp'&gt;
      &lt;rule condition='expire-at'
            action='drop'
            value='2004-01-01T00:00:00Z'/&gt;
    &lt;/unsupported-actions&gt;
  &lt;/error&gt;
&lt;/message&gt;
      </pre></div>
    </div>
    <div class="indent">
<h3>6.2.2 <a name="errors-condition">Unsupported Condition</a>
</h3>
      <p class="caption">Example 18. A message with semantics</p>
<div class="indent"><pre>
&lt;message
    from='shakespeare.lit'
    id='richard2-4.1.247'
    to='kingrichard@royalty.england.lit'&gt;
  &lt;body&gt;My lord, dispatch; read o'er these articles.&lt;/body&gt;
  &lt;amp xmlns='http://jabber.org/protocol/amp'&gt;
    &lt;rule condition='expire-at'
          action='drop'
          value='2004-01-01T00:00:00Z'/&gt;
  &lt;/amp&gt;
&lt;/message&gt;
      </pre></div>
      <p class="caption">Example 19. Server does not support condition</p>
<div class="indent"><pre>
&lt;message
    from='shakespeare.lit'
    id='richard2-4.1.247'
    to='northumberland@shakespeare.lit'
    type='error'&gt;
  &lt;body&gt;My lord, dispatch; read o'er these articles.&lt;/body&gt;
  &lt;amp xmlns='http://jabber.org/protocol/amp'&gt;
    &lt;rule condition='expire-at'
          action='drop'
          value='2004-01-01T00:00:00Z'/&gt;
  &lt;/amp&gt;
  &lt;error type='modify' code='400'&gt;
    &lt;bad-request xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/&gt;
    &lt;unsupported-conditions xmlns='http://jabber.org/protocol/amp'&gt;
      &lt;rule condition='expire-at'
            action='drop'
            value='2004-01-01T00:00:00Z'/&gt;
    &lt;/unsupported-conditions&gt;
  &lt;/error&gt;
&lt;/message&gt;
      </pre></div>
    </div>
    <div class="indent">
<h3>6.2.3 <a name="errors-notacceptable">Not Acceptable</a>
</h3>
      <p class="caption">Example 20. A message with semantics</p>
<div class="indent"><pre>
&lt;message
    from='northumberland@shakespeare.lit'
    id='richard2-4.1.247'
    to='kingrichard@royalty.england.lit'&gt;
  &lt;body&gt;My lord, dispatch; read o'er these articles.&lt;/body&gt;
  &lt;amp xmlns='http://jabber.org/protocol/amp'&gt;
    &lt;rule condition='expire-at'
          action='drop'
          value='2004-01-01T00:00:00Z'/&gt;
  &lt;/amp&gt;
&lt;/message&gt;
      </pre></div>
      <p class="caption">Example 21. The rule is not acceptable to the server</p>
<div class="indent"><pre>
&lt;message
    from='shakespeare.lit'
    id='richard2-4.1.247'
    to='northumberland@shakespeare.lit'
    type='error'&gt;
  &lt;body&gt;My lord, dispatch; read o'er these articles.&lt;/body&gt;
  &lt;amp xmlns='http://jabber.org/protocol/amp'&gt;
    &lt;rule condition='expire-at'
          action='drop'
          value='2004-01-01T00:00:00Z'/&gt;
  &lt;/amp&gt;
  &lt;error type='modify' code='405'&gt;
    &lt;not-acceptable xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/&gt;
    &lt;invalid-rules xmlns='http://jabber.org/protocol/amp'&gt;
      &lt;rule condition='expire-at'
            action='drop'
            value='2004-01-01T00:00:00Z'/&gt;
    &lt;/invalid-rules&gt;
  &lt;/error&gt;
&lt;/message&gt;
      </pre></div>
    </div>
    <div class="indent">
<h3>6.2.4 <a name="errors-unavail">Service Unavailable</a>
</h3>
      <p class="caption">Example 22. A message with semantics</p>
<div class="indent"><pre>
&lt;message
    from='northumberland@shakespeare.lit'
    id='richard2-4.1.247'
    to='kingrichard@royalty.england.lit'&gt;
  &lt;body&gt;My lord, dispatch; read o'er these articles.&lt;/body&gt;
  &lt;amp xmlns='http://jabber.org/protocol/amp'&gt;
    &lt;rule condition='expire-at'
          action='drop'
          value='2004-01-01T00:00:00Z'/&gt;
  &lt;/amp&gt;
&lt;/message&gt;
      </pre></div>
      <p class="caption">Example 23. AMP service is unavailable</p>
<div class="indent"><pre>
&lt;message
    from='royalty.england.lit'
    id='richard2-4.1.247'
    to='northumberland@shakespeare.lit'
    type='error'&gt;
  &lt;body&gt;My lord, dispatch; read o'er these articles.&lt;/body&gt;
  &lt;amp xmlns='http://jabber.org/protocol/amp'&gt;
    &lt;rule condition='expire-at'
          action='drop'
          value='2004-01-01T00:00:00Z'/&gt;
  &lt;/amp&gt;
  &lt;error type='cancel' code='503'&gt;
    &lt;service-unavailable xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/&gt;
  &lt;/error&gt;
&lt;/message&gt;
      </pre></div>
    </div>
    <div class="indent">
<h3>6.2.5 <a name="errors-undefined">Undefined Condition</a>
</h3>
      <p class="caption">Example 24. A message with semantics</p>
<div class="indent"><pre>
  &lt;message from='hamlet.lit'
           to='bernardo@hamlet.lit/elsinore'
           id='chatty2'&gt;
    &lt;body&gt;Who&amp;apos;s there?&lt;/body&gt;
    &lt;amp xmlns='http://jabber.org/protocol/amp'
         status='error'
         from='francisco@hamlet.lit'
         to='bernardo@hamlet.lit/elsinore'&gt;
      &lt;rule condition='deliver' value='stored' action='error'/&gt;
    &lt;/amp&gt;
  &lt;/message&gt;
      </pre></div>
      <p class="caption">Example 25. Failed rules</p>
<div class="indent"><pre>
  &lt;message from='hamlet.lit'
           to='bernardo@hamlet.lit/elsinore'
           type='error'
           id='chatty2'&gt;
    &lt;body&gt;Who&amp;apos;s there?&lt;/body&gt;
    &lt;amp xmlns='http://jabber.org/protocol/amp'
         status='error'
         from='francisco@hamlet.lit'
         to='bernardo@hamlet.lit/elsinore'&gt;
      &lt;rule condition='deliver' value='stored' action='error'/&gt;
    &lt;/amp&gt;
    &lt;error type='modify' code='500'&gt;
      &lt;undefined-condition xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/&gt;
      &lt;failed-rules xmlns='http://jabber.org/protocol/amp#errors'&gt;
        &lt;rule condition='deliver' value='stored' action='error'/&gt;
      &lt;/failed-rules&gt;
    &lt;/error&gt;
  &lt;/message&gt;
      </pre></div>
    </div>
  </div>
<h2>7.
       <a name="impl">Implementation Notes</a>
</h2>
  <p class="" style="">If the recipient's server implements "offline storage", it will need to keep track of which offline messages are subject to expiration and not deliver those which have expired. Exactly how to do so is a matter of implementation. One possible implementation is for the server to maintain a separate database of expirable messages and periodically scan it; upon discovering an expired message, it could flag the messages as eligible for discarding and inform the sender, but not discard the message until the intended recipient next becomes available.</p>
<h2>8.
       <a name="security">Security Considerations</a>
</h2>
  <p class="" style="">The security considerations are dependent upon the specific conditions and actions in use. The considerations for the defined conditions and actions are outlined with their definitions in the <a href="#conditionsactions">Conditions and Actions</a> section of this document.</p>
<h2>9.
       <a name="iana">IANA Considerations</a>
</h2>
  <p class="" style="">No interaction with the <span class="ref" style="">Internet Assigned Numbers Authority (IANA)</span>  [<a href="#nt-id2259033">11</a>] is necessary as a result of this JEP.</p>
<h2>10.
       <a name="registrar">Jabber Registrar Considerations</a>
</h2>
  <div class="indent">
<h3>10.1 <a name="registrar-ns">Protocol Namespaces</a>
</h3>
    <p class="" style="">The <span class="ref" style="">Jabber Registrar</span>  [<a href="#nt-id2259084">12</a>] includes 'http://jabber.org/protocol/amp' and 'http://jabber.org/protocol/amp#errors' in its registry of protocol namespaces.</p>
  </div>
  <div class="indent">
<h3>10.2 <a name="registrar-nodes">Well-Known Service Discovery Nodes</a>
</h3>
    <p class="" style="">The Jabber Registrar includes 'http://jabber.org/protocol/amp' in its registry of well-known Service Discovery nodes.</p>
  </div>
  <div class="indent">
<h3>10.3 <a name="registrar-reg">Registries</a>
</h3>
    <div class="indent">
<h3>10.3.1 <a name="registrar-reg-conditions">Rule Conditions Registry</a>
</h3>
      <p class="" style="">The Jabber Registrar maintains a registry of AMP &lt;rule/&gt; conditions (see &lt;<a href="http://www.jabber.org/registrar/amp-conditions.html">http://www.jabber.org/registrar/amp-conditions.html</a>&gt;).</p>
      <div class="indent">
<h3>10.3.1.1 <a name="registrar-reg-conditions-process">Process</a>
</h3>
        <p class="" style="">In order to submit new values to this registry, the registrant must define an XML fragment of the following form and either include it in the relevant Jabber Enhancement Proposal or send it to the email address &lt;registrar@jabber.org&gt;:</p>
        <p class="caption"></p>
<div class="indent"><pre>
&lt;condition&gt;
  &lt;name&gt;the value of the 'condition' attribute&lt;/name&gt;
  &lt;ns&gt;the namespace to be used as a service discovery feature&lt;/ns&gt;
  &lt;per-hop&gt;does the "per-hop" flag apply? [true|false]&lt;/per-hop&gt;
  &lt;value&gt;
     The syntax (e.g., datatype or allowable values) of the
     'value' attribute.
  &lt;/value&gt;
  &lt;processing&gt;values that result in message processing&lt;/processing&gt;
  &lt;doc&gt;the document (e.g., JEP) in which this condition is specified&lt;/doc&gt;
&lt;/condition&gt;
        </pre></div>
        <p class="" style="">The registrant may register more than one condition at a time, each contained in a separate &lt;condition/&gt; element.</p>
        <p class="" style="">Note: The namespace for the condition set shall be included in the Service Discovery features registry.</p>
      </div>
      <div class="indent">
<h3>10.3.1.2 <a name="registrar-reg-conditions-initial">Initial Submission</a>
</h3>
        <p class="caption"></p>
<div class="indent"><pre>
&lt;condition&gt;
  &lt;name&gt;deliver&lt;/name&gt;
  &lt;ns&gt;http://jabber.org/protocol/amp?condition=deliver&lt;/ns&gt;
  &lt;per-hop&gt;true&lt;/per-hop&gt;
  &lt;value&gt;[direct|forward|gateway|none|stored]&lt;/value&gt;
  &lt;processing&gt;
    The condition is met if (1) the value is "direct" and the message
    can be immediately delivered or further dispatched, or (2) the 
    value is "stored" and offline storage is enabled.
  &lt;/processing&gt;
  &lt;doc&gt;JEP-0079&lt;/doc&gt;
&lt;/condition&gt;

&lt;condition&gt;
  &lt;name&gt;expire-at&lt;/name&gt;
  &lt;ns&gt;http://jabber.org/protocol/amp?condition=expire-at&lt;/ns&gt;
  &lt;per-hop&gt;true&lt;/per-hop&gt;
  &lt;value&gt;DateTime per JEP-0082&lt;/value&gt;
  &lt;processing&gt;
    The condition is met if the message cannot be delivered before
    the specified DateTime.
  &lt;/processing&gt;
  &lt;doc&gt;JEP-0079&lt;/doc&gt;
&lt;/condition&gt;

&lt;condition&gt;
  &lt;name&gt;match-resource&lt;/name&gt;
  &lt;ns&gt;http://jabber.org/protocol/amp?condition=match-resource&lt;/ns&gt;
  &lt;per-hop&gt;false&lt;/per-hop&gt;
  &lt;value&gt;[any|exact|other]&lt;/value&gt;
  &lt;processing&gt;
    The condition is met if (1) the value is "any" and the intended
    recipient has at least one available resource (as defined in the
    XMPP IM specification); (2) the value "exact" and the intended
    recipient has an available resource that exactly matches the JID
    specified in the 'to' address; (3) the value is "other" and the
    intended recipient has an available resource whose full JID is
    other than that specified in the 'to' address.
  &lt;/processing&gt;
  &lt;doc&gt;JEP-0079&lt;/doc&gt;
&lt;/condition&gt;
        </pre></div>
      </div>
    </div>
    <div class="indent">
<h3>10.3.2 <a name="registrar-reg-actions">Rule Actions Registry</a>
</h3>
      <p class="" style="">The Jabber Registrar maintains a registry of AMP &lt;rule/&gt; actions (see &lt;<a href="http://www.jabber.org/registrar/amp-actions.html">http://www.jabber.org/registrar/amp-actions.html</a>&gt;).</p>
      <div class="indent">
<h3>10.3.2.1 <a name="registrar-reg-actions-process">Process</a>
</h3>
        <p class="" style="">In order to submit new values to this registry, the registrant must define an XML fragment of the following form and either include it in the relevant Jabber Enhancement Proposal or send it to the email address &lt;registrar@jabber.org&gt;:</p>
        <p class="caption"></p>
<div class="indent"><pre>
&lt;action&gt;
  &lt;name&gt;the value of the 'action' attribute&lt;/name&gt;
  &lt;ns&gt;the namespace to be used as a service discovery feature&lt;/ns&gt;
  &lt;behavior&gt;the expected behavior if the rule is triggered&lt;/behavior&gt;
  &lt;doc&gt;the document (e.g., JEP) in which this action is specified&lt;/doc&gt;
&lt;/action&gt;
        </pre></div>
        <p class="" style="">The registrant may register more than one action at a time, each contained in a separate &lt;action/&gt; element.</p>
        <p class="" style="">Note: The namespace for the action set shall be included in the Service Discovery features registry.</p>
      </div>
      <div class="indent">
<h3>10.3.2.2 <a name="registrar-reg-actions-initial">Initial Submission</a>
</h3>
        <p class="caption"></p>
<div class="indent"><pre>
&lt;action&gt;
  &lt;name&gt;alert&lt;/name&gt;
  &lt;ns&gt;http://jabber.org/protocol/amp?action=drop&lt;/ns&gt;
  &lt;behavior&gt;
    The message is silently discarded but an alert is returned to the
    sender.
  &lt;/behavior&gt;
  &lt;doc&gt;JEP-0079&lt;/doc&gt;
&lt;/action&gt;

&lt;action&gt;
  &lt;name&gt;drop&lt;/name&gt;
  &lt;ns&gt;http://jabber.org/protocol/amp?action=drop&lt;/ns&gt;
  &lt;behavior&gt;
    The message is silently discarded.
  &lt;/behavior&gt;
  &lt;doc&gt;JEP-0079&lt;/doc&gt;
&lt;/action&gt;

&lt;action&gt;
  &lt;name&gt;error&lt;/name&gt;
  &lt;ns&gt;http://jabber.org/protocol/amp?action=error&lt;/ns&gt;
  &lt;behavior&gt;
    The message is not processed and an error is returned to the sender,
    specifying which rule resulted in failed processing.
  &lt;/behavior&gt;
  &lt;doc&gt;JEP-0079&lt;/doc&gt;
&lt;/action&gt;

&lt;action&gt;
  &lt;name&gt;notify&lt;/name&gt;
  &lt;ns&gt;http://jabber.org/protocol/amp?action=notify&lt;/ns&gt;
  &lt;behavior&gt;
    The message is processed and a notification message is returned to
    the sender, specifying which rule was processed.
  &lt;/behavior&gt;
  &lt;doc&gt;JEP-0079&lt;/doc&gt;
&lt;/action&gt;
        </pre></div>
      </div>
    </div>
  </div>
<h2>11.
       <a name="schemas">XML Schemas</a>
</h2>
  <div class="indent">
<h3>11.1 <a name="schemas-amp">AMP</a>
</h3>
    <p class="caption"></p>
<div class="indent"><pre>
&lt;?xml version='1.0' encoding='UTF-8'?&gt;

&lt;xs:schema
    xmlns:xs='http://www.w3.org/2001/XMLSchema'
    targetNamespace='http://jabber.org/protocol/amp'
    xmlns='http://jabber.org/protocol/amp'
    elementFormDefault='qualified'&gt;
 
  &lt;xs:annotation&gt;
    &lt;xs:documentation&gt;
      The protocol documented by this schema is defined in
      JEP-0079: http://www.jabber.org/jeps/jep-0079.html
    &lt;/xs:documentation&gt;
  &lt;/xs:annotation&gt;

  &lt;xs:element name='amp'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:sequence&gt;
        &lt;xs:element ref='rule' minOccurs='1' maxOccurs='unbounded'/&gt;
      &lt;/xs:sequence&gt;
      &lt;xs:attribute name='from' usage='optional' type='xs:string'/&gt;
      &lt;xs:attribute name='per-hop' use='optional' type='xs:bool' default='false'/&gt;
      &lt;xs:attribute name='status' usage='optional' type='xs:NCName'/&gt;
      &lt;xs:attribute name='to' usage='optional' type='xs:string'/&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;
 
  &lt;xs:element name='invalid-rules'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:sequence&gt;
        &lt;xs:element ref='rule' minOccurs='1' maxOccurs='unbounded'/&gt;
      &lt;/xs:sequence&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:element name='unsupported-actions'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:sequence&gt;
        &lt;xs:element ref='rule' minOccurs='1' maxOccurs='unbounded'/&gt;
      &lt;/xs:sequence&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:element name='unsupported-conditions'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:sequence&gt;
        &lt;xs:element ref='rule' minOccurs='1' maxOccurs='unbounded'/&gt;
      &lt;/xs:sequence&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:element name='rule'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:attribute name='action' use='required' type='xs:NCName'/&gt;
      &lt;xs:attribute name='condition' use='required' type='xs:NCName'/&gt;
      &lt;xs:attribute name='value' use='required' type='xs:string'/&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

&lt;/xs:schema&gt;
    </pre></div>
  </div>
  <div class="indent">
<h3>11.2 <a name="schemas-err">Errors</a>
</h3>
    <p class="caption"></p>
<div class="indent"><pre>
&lt;?xml version='1.0' encoding='UTF-8'?&gt;

&lt;xs:schema
    xmlns:xs='http://www.w3.org/2001/XMLSchema'
    targetNamespace='http://jabber.org/protocol/amp#errors'
    xmlns='http://jabber.org/protocol/amp#errors'
    elementFormDefault='qualified'&gt;
 
  &lt;xs:annotation&gt;
    &lt;xs:documentation&gt;
      The protocol documented by this schema is defined in
      JEP-0079: http://www.jabber.org/jeps/jep-0079.html
    &lt;/xs:documentation&gt;
  &lt;/xs:annotation&gt;

  &lt;xs:element name='failed-rules'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:sequence&gt;
        &lt;xs:element ref='rule' minOccurs='1' maxOccurs='unbounded'/&gt;
      &lt;/xs:sequence&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:element name='rule'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:attribute name='action' use='required' type='xs:NCName'/&gt;
      &lt;xs:attribute name='condition' use='required' type='xs:NCName'/&gt;
      &lt;xs:attribute name='value' use='required' type='xs:string'/&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

&lt;/xs:schema&gt;
    </pre></div>
  </div>
<h2>12.
       <a name="acks">Acknowledgements</a>
</h2>
  <p class="" style="">Thanks to Marshall Rose and Craig Kaes for their comments.</p>
<p><hr></p>
<a name="notes"></a><h2>Notes</h2>
<div class="indent">
<p><a name="nt-id2250770">1</a>. RFC 3920: Extensible Messaging and Presence Protocol (XMPP): Core &lt;<a href="http://www.ietf.org/rfc/rfc3920.txt">http://www.ietf.org/rfc/rfc3920.txt</a>&gt;.</p>
<p><a name="nt-id2250713">2</a>. RFC 3921: Extensible Messaging and Presence Protocol (XMPP): Instant Messaging and Presence &lt;<a href="http://www.ietf.org/rfc/rfc3921.txt">http://www.ietf.org/rfc/rfc3921.txt</a>&gt;.</p>
<p><a name="nt-id2256385">3</a>. JEP-0030: Service Discovery &lt;<a href="http://www.jabber.org/jeps/jep-0030.html">http://www.jabber.org/jeps/jep-0030.html</a>&gt;.</p>
<p><a name="nt-id2257365">4</a>. Guarantee is a strong word. This JEP defines methods for making message delivery more reliable within certain bounds, but does not pretend that such methods provide any form of guaranteed delivery.</p>
<p><a name="nt-id2257399">5</a>. RFC 1305: Network Time Protocol (Version 3) &lt;<a href="http://www.ietf.org/rfc/rfc1305.txt">http://www.ietf.org/rfc/rfc1305.txt</a>&gt;.</p>
<p><a name="nt-id2257444">6</a>. JEP-0082: Jabber Date and Time Profiles &lt;<a href="http://www.jabber.org/jeps/jep-0082.html">http://www.jabber.org/jeps/jep-0082.html</a>&gt;.</p>
<p><a name="nt-id2257668">7</a>. JEP-0045: Multi-User Chat &lt;<a href="http://www.jabber.org/jeps/jep-0045.html">http://www.jabber.org/jeps/jep-0045.html</a>&gt;.</p>
<p><a name="nt-id2257907">8</a>. Consider the following scenario: the user &lt;romeo@montague.net&gt; is not an authorized subscriber to the presence of the user &lt;nurse@capulet.com&gt;, but sends a &lt;message/&gt; stanza with a "deliver" rule of "direct" to that address; if the Nurse is not online, Romeo could discover that fact if the capulet.com server informs him that the message could not be delivered immediately.</p>
<p><a name="nt-id2258187">9</a>. JEP-0047: In-Band Bytestreams &lt;<a href="http://www.jabber.org/jeps/jep-0047.html">http://www.jabber.org/jeps/jep-0047.html</a>&gt;.</p>
<p><a name="nt-id2258762">10</a>. JEP-0086: Error Condition Mappings &lt;<a href="http://www.jabber.org/jeps/jep-0086.html">http://www.jabber.org/jeps/jep-0086.html</a>&gt;.</p>
<p><a name="nt-id2259033">11</a>. The Internet Assigned Numbers Authority (IANA) is the central coordinator for the assignment of unique parameter values for Internet protocols, such as port numbers and URI schemes. For further information, see &lt;<a href="http://www.iana.org/">http://www.iana.org/</a>&gt;.</p>
<p><a name="nt-id2259084">12</a>. The Jabber Registrar maintains a list of reserved Jabber protocol namespaces as well as registries of parameters used in the context of protocols approved by the Jabber Software Foundation. For further information, see &lt;<a href="http://www.jabber.org/registrar/">http://www.jabber.org/registrar/</a>&gt;.</p>
</div>
<p><hr></p>
<a name="revs"></a><h2>Revision History</h2>
<div class="indent">
<h4>Version 1.1 (2005-10-19)</h4>
<div class="indent">Reversed the meaning of conditions other than expire-at (per list discussion); correctly specified stream feature. (psa)
    </div>
<h4>Version 1.0 (2004-10-11)</h4>
<div class="indent">Per a vote of the Jabber Council, advanced to a status of Draft. (psa)
    </div>
<h4>Version 0.12 (2004-09-09)</h4>
<div class="indent">Relaxed server-to-server requirements; clarified discovery rules; removed expire-in condition. (lw)
    </div>
<h4>Version 0.11 (2004-08-25)</h4>
<div class="indent">Specified that the timestamp for an expire-at condition must be a UTC DateTime per JEP-0082; provided further explanation regarding expire-at and expire-in conditions. (lw/psa)
    </div>
<h4>Version 0.10 (2004-07-14)</h4>
<div class="indent">Changes to address Council feedback: clarified error handling and provided error examples; specified that server should validate all rule semantics before returning an error; specified that service discovery information can be cached (not necessary to send disco query before dispatching each message); added "forward" and "gateway" to values of "deliver" condition to handle redirection of messages to alternate XMPP addresses and non-XMPP systems respectively; more clearly specified processing rules for "expire-in" condition; changed milliseconds to seconds for "expire-in"; made explicit that partial JID-matching is not included for "match-resource" condition; added clarifying note to security consideration regarding "deliver" condition; corrected values of per-hop from [yes|no] to [true|false]; changed "standard" conditions to "defined" conditions and mandated that they should be supported; changed "http://jabber.org/protocol/amp#std-actions" namespace to "http://jabber.org/protocol/amp#errors". (lw/psa)
    </div>
<h4>Version 0.9 (2004-04-25)</h4>
<div class="indent">JEP Editor's review: clarified some matters in the text; fully defined the Jabber Registrar Considerations. (psa)
    </div>
<h4>Version 0.8 (2004-01-20)</h4>
<div class="indent">Reorganized for JEP editor's preferences; revised error conditions to properly align with XMPP-Core (lw)
    </div>
<h4>Version 0.7 (2003-12-10)</h4>
<div class="indent">Incorported changes requested from Standards-JIG discussions: Changed entity-to-server discovery behavior; s2s discovery behavior; Expanded application-specific error conditions; Reorganized for better presentation; Changed "per-hop" to apply to the entire ruleset; Fixed minor typos and missteps (lw)
    </div>
<h4>Version 0.6 (2003-10-15)</h4>
<div class="indent">Changed disco behavior; Changed schema to reflect customizations (lw)
    </div>
<h4>Version 0.5.1 (2003-09-20)</h4>
<div class="indent">Fixed many typos (lw)
    </div>
<h4>Version 0.5 (2003-08-28)</h4>
<div class="indent">Renamed to "amp" (thanks stpeter!); Added information about the original addressing; Added requirement for id attribute in &lt;message/&gt;; Restricted behavior within the "Security Considerations"; (lw)
    </div>
<h4>Version 0.4 (2003-06-23)</h4>
<div class="indent">Completely rewritten to better account for various suggested usage details and requirements; Completely reorganized to better codify the protocol(s) and their possible uses; Added more conditions; Added more actions; Added common usage scenarios (lw)
    </div>
<h4>Version 0.3 (2003-04-21)</h4>
<div class="indent">Clarified client-side processing; Removed semantics scope; Clarified "fail" action; Moved existing "use-cases" into "Usage" section in "Overview"; Added more relevant use cases; Added XMPP-style error conditions (lw)
    </div>
<h4>Version 0.2 (2003-04-15)</h4>
<div class="indent">Added XML Schema (with author's assistance). (psa)
    </div>
<h4>Version 0.1 (2003-04-15)</h4>
<div class="indent">Initial version. (lw)
    </div>
</div>
<p><hr></p>
<p>END</p>
</body>
</html>
