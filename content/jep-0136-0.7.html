<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>JEP-0136: Message Archiving</title>
<link rel="stylesheet" type="text/css" href="jep.css">
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
<meta name="DC.Title" content="Message Archiving">
<meta name="DC.Creator" content="Justin Karneges">
<meta name="DC.Creator" content="Ian Paterson">
<meta name="DC.Creator" content="Jon Perlow">
<meta name="DC.Creator" content="Peter Saint-Andre">
<meta name="DC.Description" content="This document defines mechanisms for server-side archiving of XMPP messages.">
<meta name="DC.Publisher" content="Jabber Software Foundation">
<meta name="DC.Contributor" content="JEP Editor">
<meta name="DC.Date" content="2006-09-08">
<meta name="DC.Type" content="Jabber Enhancement Proposal">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="JEP-0136">
<meta name="DC.Language" content="en">
<meta name="DC.Rights" content="This Jabber Enhancement Proposal is copyright 1999 - 2006 by the Jabber Software Foundation (JSF) and is in full conformance with the JSF's Intellectual Property Rights Policy &lt;http://www.jabber.org/jsf/ipr-policy.shtml&gt;. This material may be distributed only subject to the terms and conditions set forth in the Creative Commons Attribution License (&lt;http://creativecommons.org/licenses/by/2.5/&gt;).">
</head>
<body>
<h1>JEP-0136: Message Archiving</h1>
<p>This document defines mechanisms for server-side archiving of XMPP messages.</p>
<p><hr></p>
<p style="color:red">WARNING: This Standards-Track JEP is Experimental. Publication as a Jabber Enhancement Proposal does not imply approval of this proposal by the Jabber Software Foundation. Implementation of the protocol described herein is encouraged in exploratory implementations, but production systems should not deploy implementations of this protocol until it advances to a status of Draft.</p>
<p><hr></p>
<h2>JEP Information</h2>
<p class="indent">
            Status: 
            <a href="http://www.jabber.org/jeps/jep-0001.html#states-Experimental">Experimental</a><br>
            Type:
            <a href="http://www.jabber.org/jeps/jep-0001.html#types-Standards%20Track">Standards Track</a><br>
            Number: 0136<br>
            Version: 0.7<br>
            Last Updated: 2006-09-08<br>
            JIG: Standards JIG<br>
                Approving Body: <a href="http://www.jabber.org/council/">Jabber Council</a><br>Dependencies: XMPP Core, XMPP IM, JEP-0030, JEP-0059, JEP-0155<br>
                Supersedes: None<br>
                Superseded By: None<br>
            Short Name: archive<br>
              Wiki Page: &lt;<a href="http://wiki.jabber.org/index.php/Message%20Archiving%20(JEP-0136)">http://wiki.jabber.org/index.php/Message Archiving (JEP-0136)</a>&gt;
            </p>
<h2>Author Information</h2>
<div class="indent">
<h3>Justin Karneges</h3>
<p class="indent">
        Email:
        <a href="mailto:justin@affinix.com">justin@affinix.com</a><br>
        JID: 
        <a href="xmpp:justin@andbit.net">justin@andbit.net</a></p>
<h3>Ian Paterson</h3>
<p class="indent">
        Email:
        <a href="mailto:ian.paterson@clientside.co.uk">ian.paterson@clientside.co.uk</a><br>
        JID: 
        <a href="xmpp:ian@zoofy.com">ian@zoofy.com</a></p>
<h3>Jon Perlow</h3>
<p class="indent">
        Email:
        <a href="mailto:jonp@google.com">jonp@google.com</a><br>
        JID: 
        <a href="xmpp:jonp@google.com">jonp@google.com</a></p>
<h3>Peter Saint-Andre</h3>
<p class="indent">
        Email:
        <a href="mailto:stpeter@jabber.org">stpeter@jabber.org</a><br>
        JID: 
        <a href="xmpp:stpeter@jabber.org">stpeter@jabber.org</a></p>
</div>
<h2>Legal Notice</h2>
<p class="indent">This Jabber Enhancement Proposal is copyright 1999 - 2006 by the <a href="http://www.jabber.org/jsf/">Jabber Software Foundation</a> (JSF) and is in full conformance with the JSF's Intellectual Property Rights Policy &lt;<a href="http://www.jabber.org/jsf/ipr-policy.shtml">http://www.jabber.org/jsf/ipr-policy.shtml</a>&gt;. This material may be distributed only subject to the terms and conditions set forth in the Creative Commons Attribution License (&lt;<a href="http://creativecommons.org/licenses/by/2.5/">http://creativecommons.org/licenses/by/2.5/</a>&gt;).</p>
<h2>Discussion Venue</h2>
<p class="indent">The preferred venue for discussion of this document is the Standards-JIG discussion list: &lt;<a href="http://mail.jabber.org/mailman/listinfo/standards-jig">http://mail.jabber.org/mailman/listinfo/standards-jig</a>&gt;.</p>
<h2>Relation to XMPP</h2>
<p class="indent">The Extensible Messaging and Presence Protocol (XMPP) is defined in the XMPP Core (RFC 3920) and XMPP IM (RFC 3921) specifications contributed by the Jabber Software Foundation to the Internet Standards Process, which is managed by the Internet Engineering Task Force in accordance with RFC 2026. Any protocol defined in this JEP has been developed outside the Internet Standards Process and is to be understood as an extension to XMPP rather than as an evolution, development, or modification of XMPP itself.</p>
<h2>Conformance Terms</h2>
<p class="indent">The following keywords as used in this document are to be interpreted as described in RFC 2119: "MUST", "SHALL", "REQUIRED"; "MUST NOT", "SHALL NOT"; "SHOULD", "RECOMMENDED"; "SHOULD NOT", "NOT RECOMMENDED"; "MAY", "OPTIONAL".</p>
<p><hr></p>
<h2>Table of Contents</h2>
<div class="indent"><dl>
<dt>1.  <a href="#intro">Introduction</a>
</dt>
<dt>2.  <a href="#disco">Determining Server Support</a>
</dt>
<dt>3.  <a href="#pref">Archiving Preferences</a>
</dt>
<dl>
<dt>3.1.  <a href="#pref-reqs">Introducton</a>
</dt>
<dt>3.2.  <a href="#pref-determine">Determining Modes</a>
</dt>
<dt>3.3.  <a href="#pref-default">Setting Default Modes</a>
</dt>
<dt>3.4.  <a href="#pref-jid">Setting Modes for a Contact</a>
</dt>
</dl>
<dt>4.  <a href="#otr">Off The Record</a>
</dt>
<dt>5.  <a href="#manual">Manual Archiving</a>
</dt>
<dl>
<dt>5.1.  <a href="#manual-intro">Introduction</a>
</dt>
<dt>5.2.  <a href="#manual-collection">Collections</a>
</dt>
<dt>5.3.  <a href="#manual-upload">Uploading Messages to a Collection</a>
</dt>
<dt>5.4.  <a href="#impl-muc">Groupchat Messages</a>
</dt>
<dt>5.5.  <a href="#crypt">Encryption</a>
</dt>
<dt>5.6.  <a href="#crypt">Updating Collection Attributes</a>
</dt>
</dl>
<dt>6.  <a href="#auto">Automated Archiving</a>
</dt>
<dt>7.  <a href="#manage">Archive Management</a>
</dt>
<dl>
<dt>7.1.  <a href="#manage-list">Retrieving a List of Collections</a>
</dt>
<dt>7.2.  <a href="#manage-retrieve">Retrieving a Collection</a>
</dt>
<dt>7.3.  <a href="#manage-remove">Removing a Collection</a>
</dt>
</dl>
<dt>8.  <a href="#sect-id2259771">Replication</a>
</dt>
<dt>9.  <a href="#fileformat">File Format</a>
</dt>
<dt>10.  <a href="#impl">Implementation Notes</a>
</dt>
<dl>
<dt>10.1.  <a href="#impl-sync">Time Synchronization</a>
</dt>
<dt>10.2.  <a href="#impl-bandwidth">Bandwidth Considerations</a>
</dt>
<dt>10.3.  <a href="#impl-storage">Storage Considerations</a>
</dt>
</dl>
<dt>11.  <a href="#security">Security Considerations</a>
</dt>
<dl>
<dt>11.1.  <a href="#security-encrypt">Plain Text Subject</a>
</dt>
<dt>11.2.  <a href="#security-store">Store Headers</a>
</dt>
</dl>
<dt>12.  <a href="#iana">IANA Considerations</a>
</dt>
<dt>13.  <a href="#registrar">Jabber Registrar Considerations</a>
</dt>
<dl>
<dt>13.1.  <a href="#registrar-ns">Protocol Namespaces</a>
</dt>
<dt>13.2.  <a href="#registrar-features">Service Discovery Features</a>
</dt>
<dt>13.3.  <a href="#registrar-crypt">Cryptography Scheme Names</a>
</dt>
<dl>
<dt>13.3.1.  <a href="#registrar-kemkdf2">RSA-KEM-KDF2-SHA256</a>
</dt>
<dt>13.3.2.  <a href="#registrar-dem1sc2">DEM1-SC2-KDF2-SHA256</a>
</dt>
</dl>
</dl>
<dt>14.  <a href="#schema">XML Schemas</a>
</dt>
<dt><a href="#notes">Notes</a></dt>
<dt><a href="#revs">Revision History</a></dt>
</dl></div>
<p><hr></p>
<h2>1.
       <a name="intro">Introduction</a>
</h2>
  <p class="" style="">Many XMPP clients implement some form of client-side message archiving. However, it is not always convenient or even possible to archive messages locally, e.g., because it is easier to keep all archives in one universally accessable place (not scattered around on multiple computers or devices) or because the client operates in a web browser or resides on a mobile device that does not have sufficient local storage for message archiving. In addition, server-side archiving makes it possible to offer new services such as integration of IM and email. Therefore it is beneficial to define methods for server-side archiving of XMPP messages.</p>
  <p class="" style="">There are two main approaches to this problem:</p>
  <ol start="1" type="">
    <li>Enable the client to send individual messages or entire conversations to the server for archiving (optionally after encryption); we call this manual archiving.</li>
    <li>Enable the server (at the client's request) to archive messages as they pass through the server; we call this automated archiving.</li>
  </ol>
  <p class="" style="">So that client and server developers can refer to one specification, both approaches are defined in this document. In addition, this document defines common methods for retrieving and managing archived messages.</p>
    <p class="" style="">Complying with <span style="font-weight: bold">XMPP Core</span>, the server MUST respond to all &lt;iq/&gt; element of type 'get' or 'set'. However, most successful responses have been omitted from this document in the interest of conciseness.</p>
<h2>2.
       <a name="disco">Determining Server Support</a>
</h2>
  <p class="" style="">A client discovers whether its server supports this protocol using <span class="ref" style="">Service Discovery</span>  [<a href="#nt-id2250950">1</a>].</p>
  <p class="caption">Example 1. Client Service Discovery request</p>
<div class="indent"><pre>
    
&lt;iq type='get' to='montague.net'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#info'/&gt;
&lt;/iq&gt;
</pre></div>
  <p class="" style="">For each feature defined herein, if the server supports that feature it MUST return a &lt;feature/&gt; element with the 'var' attribute set to 'http://jabber.org/protocol/archive#name', where "name" is "auto" for the <a href="#auto">Automated Archiving</a> feature, "encrypt" for the <span style="font-style: italic">server-side</span> encryption feature (see <a href="#auto">Automated Archiving</a>), "manage" for the <a href="#manage">Archive Management</a> feature, "manual" for the <a href="#manual">Manual Archiving</a> feature, or "pref" for the <a href="#pref">Archiving Preferences</a> feature.</p>
  <p class="caption">Example 2. Server Service Discovery response</p>
<div class="indent"><pre>
    
&lt;iq type='result'
    from='montague.net'
    to='romeo@montague.net/orchard'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#info'/&gt;
    ...
    &lt;feature var='http://jabber.org/protocol/archive#auto'/&gt;
    &lt;feature var='http://jabber.org/protocol/archive#encrypt'/&gt;
    &lt;feature var='http://jabber.org/protocol/archive#manage'/&gt;
    &lt;feature var='http://jabber.org/protocol/archive#manual'/&gt;
    &lt;feature var='http://jabber.org/protocol/archive#pref'/&gt;
    ...
  &lt;/query&gt;
&lt;/iq&gt;
</pre></div>
<h2>3.
       <a name="pref">Archiving Preferences</a>
</h2>
  <div class="indent">
<h3>3.1 <a name="pref-reqs">Introducton</a>
</h3>
    <p class="" style="">Not all users want to archive messages. A client SHOULD save its user's default archiving preference (or "Save Mode") to its own server (i.e., specify whether by default all conversations should be archived or not). In addition, a client MAY save different preferences for particular contacts.</p>
    <p class="" style="">Some users may also prefer that the messages they exchange with contacts are "<a href="#otr">Off The Record</a>" (OTR). A client SHOULD save its user's default and contact-specific OTR preferences (or "OTR Modes") to its own server.</p>
    <p class="" style="">Whichever archiving method a client uses (e.g., local archiving, or automatic or manual archiving to a server), it SHOULD adhere to its user's archiving preferences.</p>
    <p class="" style="">This section addresses the following use cases:</p>
    <ol start="1" type="">
      <li>A client determines its user's current default Save Mode and OTR Mode, and the Modes for particular contacts.</li>
      <li>A client sets the default Save Mode and OTR Mode.</li>
      <li>A client sets the Save Mode and OTR Mode for a particular contact.</li>
    </ol>
  </div>
  <div class="indent">
<h3>3.2 <a name="pref-determine">Determining Modes</a>
</h3>
    <p class="" style="">In order to determine its user's current Save Mode(s) and OTR Mode(s), a client sends this query to its server:</p>
    <p class="caption">Example 3. Client Requests Modes</p>
<div class="indent"><pre>
&lt;iq type='get' id='save1' from='juliet@capulet.com/chamber'&gt;
  &lt;pref xmlns='http://jabber.org/protocol/archive'/&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">The server responds with the default Save Mode and OTR Mode (&lt;default/&gt; element) and any Save Modes and OTR Modes for specific contacts (&lt;item/&gt; elements).</p>
    <p class="" style="">Each child element in the response MUST include a 'save' attribute, whose value MAY be 'false' (the client MUST save no messages), 'body' (the client SHOULD save only &lt;body/&gt; elements) or 'all' (the client SHOULD save the full XML content of each &lt;message/&gt; element).</p>
    <p class="" style="">Note: Support for the 'all' value is optional and, to conserve bandwidth and storage space, it is RECOMMENDED that client implementations do not specify the 'all' value.</p>
    <p class="" style="">Note: When archiving <span style="font-style: italic">locally</span> a client MAY save the full XML content of each &lt;message/&gt; element even if the Save Mode is 'body'.</p>
    <p class="" style="">Each child element in the response MUST include an 'otr' attribute, whose value MAY be 'deny' (if <a href="#otr">Off The Record</a> is <span style="font-style: italic">required</span> by the contact the client MUST send no messages), 'allow' (the client MAY save messages unless the contact requests OTR), 'try' (the client MUST try to negotiate OTR with the contact) or 'require' (the client MUST send no messages unless the contact explicitly agrees to OTR).</p>
    <p class="" style="">Note: If the OTR Mode is 'require' then the Save Mode MUST be 'false'.</p>
    <p class="caption">Example 4. Server Returns Modes</p>
<div class="indent"><pre>
&lt;iq type='result' id='save1' to='juliet@capulet.com/chamber'&gt;
  &lt;pref xmlns='http://jabber.org/protocol/archive'&gt;
    &lt;default save='body' otr='allow'/&gt;
    &lt;item jid='romeo@montague.net' save='false' otr='require'/&gt;
    &lt;item jid='benvolio@montague.net' save='all' otr='deny'/&gt;
  &lt;/pref&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">If the user has never set the default Modes, the 'save' and 'otr' attributes SHOULD specify the server's default settings, and the 'unset' attribute SHOULD be set to "true". Note: The 'unset' attribute defaults to "false".</p>
    <p class="caption">Example 5. Server Returns Service Default Modes</p>
<div class="indent"><pre>
&lt;iq type='result' id='save1' to='juliet@capulet.com/chamber'&gt;
  &lt;pref xmlns='http://jabber.org/protocol/archive'&gt;
    &lt;default save='false' otr='allow' unset='true'/&gt;
  &lt;/pref&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">Once it has received a request for archiving preferences from the client, the server MUST send any subsequent changes to any of the user's archiving preferences to the client until the stream is closed (see below).</p>
  </div>
  <div class="indent">
<h3>3.3 <a name="pref-default">Setting Default Modes</a>
</h3>
    <p class="" style="">A client may set the default Modes:</p>
    <p class="caption">Example 6. Client Sets Default Modes</p>
<div class="indent"><pre>
&lt;iq type='set' id='save2' from='juliet@capulet.com/chamber'&gt;
  &lt;pref xmlns='http://jabber.org/protocol/archive'&gt;
    &lt;default save='false' otr='try'/&gt;
  &lt;/pref&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">If the server can process the request, it acknowledges the change:</p>
    <p class="caption">Example 7. Server Acknowledges Change</p>
<div class="indent"><pre>
&lt;iq type='result' id='save2' to='juliet@capulet.com/chamber'/&gt;
    </pre></div>
    <p class="" style="">The server then MUST inform all of the user's connected resources that have previously requested the user's archiving preferences:</p>
    <p class="caption">Example 8. Server Pushes New Modes</p>
<div class="indent"><pre>
&lt;iq type='set' id='savepush1' to='juliet@capulet.com/chamber'&gt;
  &lt;pref xmlns='http://jabber.org/protocol/archive'&gt;
    &lt;default save='false' otr='try'/&gt;
  &lt;/pref&gt;
&lt;/iq&gt;

&lt;iq type='set' id='savepush2' to='juliet@capulet.com/pda'&gt;
  &lt;pref xmlns='http://jabber.org/protocol/archive'&gt;
    &lt;default save='false' otr='try'/&gt;
  &lt;/pref&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">The server MAY be configured to return a &lt;feature-not-implemented/&gt; error in the following cases:</p>
    <ul>
      <li><p class="" style="">If it does not allow the saving of full message stanza content, and the client set the value of the 'save' attribute to "all", and any of the user's connected resources have <a href="#auto">Automated Archiving</a> enabled.</p></li>
      <li><p class="" style="">If administrator policies require that at least the &lt;body/&gt; (or the full content) of every message is logged automatically, and the client sets the value of the 'save' attribute to "false" (or "body").</p></li>
    </ul>
    <p class="" style="">Note: More error cases to follow.</p>
  </div>
  <div class="indent">
<h3>3.4 <a name="pref-jid">Setting Modes for a Contact</a>
</h3>
    <p class="" style="">A client may use a similar protocol to set the Modes for a particular contact or domain of contacts (bare JID, full JID or domain). Note: It is STRONGLY RECOMMENDED for the value of the 'jid' attribute to be a bare JID (&lt;node@domain.tld&gt;).</p>
    <p class="caption">Example 9. Client Sets Modes for a Contact</p>
<div class="indent"><pre>
&lt;iq type='set' item='save3' from='juliet@capulet.com/chamber'&gt;
  &lt;pref xmlns='http://jabber.org/protocol/archive'&gt;
    &lt;item jid='romeo@montague.net' save='body' otr='allow'/&gt;
  &lt;/pref&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="caption">Example 10. Server Acknowleges Change</p>
<div class="indent"><pre>
&lt;iq type='result' id='save3' to='juliet@capulet.com/chamber'/&gt;
    </pre></div>
    <p class="caption">Example 11. Server Pushes New Modes</p>
<div class="indent"><pre>
&lt;iq type='set' id='savepush3' to='juliet@capulet.com/chamber'&gt;
  &lt;pref xmlns='http://jabber.org/protocol/archive'&gt;
    &lt;item jid='romeo@montague.net' save='body' otr='allow'/&gt;
  &lt;/pref&gt;
&lt;/iq&gt;

&lt;iq type='set' id='savepush4' to='juliet@capulet.com/pda'&gt;
  &lt;pref xmlns='http://jabber.org/protocol/archive'&gt;
    &lt;item jid='romeo@montague.net' save='body' otr='allow'/&gt;
  &lt;/pref&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">The same error cases apply as when <a href="#auto">Setting Default Modes</a>.</p>
  </div>
<h2>4.
       <a name="otr">Off The Record</a>
</h2>
  <p class="" style="">A user will sometimes exchange messages with contacts who prefer that their conversations are not archived by either party. Any client that archives messages SHOULD support <span class="ref" style="">Chat Session Negotiation</span>  [<a href="#nt-id2258246">2</a>] and its 'logging' field both to give other contacts the opportunity to indicate this preference, and to negotiate an "Off The Record" (OTR) policy that complies with its user's own <a href="#pref">Archiving Preferences</a>.</p>
  <p class="" style="">If a Chat Session Negotiation agreed to enable OTR (disable logging) then the clients MUST NOT allow messages sent in <span style="font-style: italic">either</span> direction to be archived in any way (including <a href="#manual">Manual Archiving</a> and <a href="#auto">Automated Archiving</a>).  [<a href="#nt-id2258281">3</a>]</p>
  <p class="" style="">Note: If a contact does not include a 'logging' field in its initial Chat Session Negotiation request, and a user's Archiving Preferences indicate that OTR is <span style="font-style: italic">required</span>, then the client MUST refuse the request. It MAY then send its own Chat Session Negotiation request with a 'logging' field.</p>
  <p class="" style="">Note: Chat Session Negotiation messages SHOULD NOT be saved, since they are exchanged before clients have been able to negotiate OTR mode and disable archiving.</p>
  <p class="" style="">If a user's OTR preference for a contact changes during a Chat Session that has been negotiated with the contact, and if the new preference would affect the value of the 'logging' field that was previously negotiated, then the client MUST immediately terminate the Chat Session and try to negotiate a new one according to the user's new OTR preference.</p>
<h2>5.
       <a name="manual">Manual Archiving</a>
</h2>
  <div class="indent">
<h3>5.1 <a name="manual-intro">Introduction</a>
</h3>
    <p class="" style="">While automated archiving is easy for the client and server to implement, there are many contexts in which automated archiving is required. For examples, when:</p>
    <ul>
      <li>Messages are encrypted using evanscent keys, as in <span class="ref" style="">Encrypted Sessions</span>  [<a href="#nt-id2258379">4</a>]</li>
      <li>A client's own server does not support automated archiving but it (or another server) does support manual archiving</li>
      <li>A server does not support encryption of auto-archived collections</li>
      <li>A client wants to maintain a unified archive for messages that were transmitted both in and out-of-band (e.g. SMS or email)</li>
      <li>A client wants to append private notes to a conversation</li>
    </ul>
    <p class="" style="">Therefore, often a client will want to send or receive a sequence of messages, optionally add private notes to the sequence, optionally encrypt the sequence, and then ask the server to store it.</p>
    <p class="" style="">Such messages and notes SHOULD be stored on the server in the form of a "collection", i.e., a set of messages to/from the same user that are received near each other in time or as part of the same conversation thread. A collection is intended to mimic the natural flow of human conversations, which in instant messaging (IM) systems tend to occur in bursts (e.g., a five-minute conversation one day, followed by a ten-minute conversation the next).</p>
  </div>
  <div class="indent">
<h3>5.2 <a name="manual-collection">Collections</a>
</h3>
    <p class="" style="">The client uniquely specifies a collection using a pair of attributes:</p>
    <ul>
      <li>'with' (the full JID with which the messages were exchanged)</li>
      <li>'start' (the UTC start time of the conversation thread, which MUST be UTC and adhere to the DateTime format specified in <span class="ref" style="">Jabber Date and Time Profiles</span>  [<a href="#nt-id2258473">5</a>])</li>
    </ul>
    <p class="" style="">A friendly name for the collection MAY be specified with a 'subject' attribute. Note the <a href="#security-subject">Security Considerations</a> regarding the subject attribute.</p>
    <p class="" style="">Each collection MAY contain &lt;note/&gt;, &lt;to/&gt; or &lt;from/&gt; elements (or &lt;crypt/&gt; elements - see <a href="#crypt">Encryption</a>).</p>
    <p class="" style="">The text of each individual private note MUST be encapsulated in a &lt;note/&gt; element. The absolute time the note was created SHOULD be specified with a 'utc' attribute (which MUST be UTC and adhere to the DateTime format specified in <span style="font-weight: bold">Jabber Date and Time Profiles</span>).</p>
    <p class="" style="">The content of each individual message MUST be encapsulated in a &lt;to/&gt; or &lt;from/&gt; element. The time in seconds of the message relative to the previous message in the collection (or, for the first message, relative to the start of the collection) SHOULD be specified with a 'secs' attribute. The content of each &lt;to/&gt; or &lt;from/&gt; element SHOULD include a &lt;body/&gt; element.</p>
    <p class="" style="">Note: Other elements MAY be included, but they are NOT RECOMMENDED. To conserve bandwidth and storage space  [<a href="#nt-id2258553">6</a>], elements qualified by the 'http://jabber.org/protocol/xhtml-im' namespace SHOULD NOT be included. &lt;thread/&gt; elements and elements qualified by the 'jabber:x:delay', 'jabber:x:event' and 'http://jabber.org/protocol/chatstates' namespaces MUST NOT be included. The server MAY be configured to return a &lt;feature-not-implemented/&gt; error if any &lt;to/&gt; or &lt;from/&gt; element contains anything other than a single &lt;body/&gt; element.</p>
  </div>
  <div class="indent">
<h3>5.3 <a name="manual-upload">Uploading Messages to a Collection</a>
</h3>
    <p class="" style="">The collection of messages and notes to be uploaded are encapsulated in the &lt;store/&gt; element.</p>
    <p class="caption">Example 12. Storing messages in a collection</p>
<div class="indent"><pre>
&lt;iq type='set' to='montague.net' id='up1'&gt;
  &lt;store xmlns='http://jabber.org/protocol/archive'
         with='juliet@capulet.com/chamber'
         start='1469-07-21T02:56:15Z'
         subject='She speaks!'&gt;
    &lt;from secs='0'&gt;&lt;body&gt;Art thou not Romeo, and a Montague?&lt;/body&gt;&lt;/from&gt;
    &lt;to secs='11'&gt;&lt;body&gt;Neither, fair saint, if either thee dislike.&lt;/body&gt;&lt;/to&gt;
    &lt;from secs='14'&gt;&lt;body&gt;How cam'st thou hither, tell me, and wherefore?&lt;/body&gt;&lt;/from&gt;
    &lt;note utc='1469-07-21T03:04:35Z'&gt;I think she might fancy me.&lt;/note&gt;
  &lt;/store&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">If the collection does not exist then the server MUST create a new collection. If the collection already exists then the server MUST append the messages to the existing collection.</p>
    <p class="" style="">Note: Clients MUST take care to append each sequence of messages to the collection before the sequence becomes so large that uploading it may violate common rate limiting restrictions (in Jabber systems, often called "karma").</p>
    <p class="caption">Example 13. Successful reply</p>
<div class="indent"><pre>
&lt;iq type='result' to='romeo@montague.net/orchard' id='up1'/&gt;
    </pre></div>
    <p class="" style="">If the server cannot service a store request because the collection is too large then it MUST return a &lt;not-acceptable/&gt; error:</p>
    <p class="caption">Example 14. Unsuccessful reply</p>
<div class="indent"><pre>
&lt;iq type='error' to='romeo@montague.net/orchard'&gt;
  &lt;error code='406' type='modify'&gt;
    &lt;not-acceptable xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/&gt;
  &lt;/error&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">The client MAY specify an absolute time for any message by providing a longer 'utc' attribute (which MUST be UTC and adhere to the DateTime format specified in <span style="font-weight: bold">Jabber Date and Time Profiles</span>) instead of a 'secs' attribute:</p>
    <p class="caption">Example 15. Storing offline messages in a collection</p>
<div class="indent"><pre>
&lt;iq type='set' to='montague.net' id='up2'&gt;
  &lt;store xmlns='http://jabber.org/protocol/archive'
         with='juliet@capulet.com/chamber'
         start='1469-07-21T02:56:15Z'
         subject='She speaks!'&gt;
    &lt;from utc='1469-07-21T00:32:29Z'&gt;&lt;body&gt;Art thou not Romeo, and a Montague?&lt;/body&gt;&lt;/from&gt;
    &lt;to secs='11'&gt;&lt;body&gt;Neither, fair saint, if either thee dislike.&lt;/body&gt;&lt;/to&gt;
    &lt;from secs='14'&gt;&lt;body&gt;How cam'st thou hither, tell me, and wherefore?&lt;/body&gt;&lt;/from&gt;
  &lt;/store&gt;
&lt;/iq&gt;
    </pre></div>
  </div>
  <div class="indent">
<h3>5.4 <a name="impl-muc">Groupchat Messages</a>
</h3>
    <p class="" style="">A client MAY archive messages that it receives from <span class="ref" style="">Multi-User Chat</span>  [<a href="#nt-id2258716">7</a>] rooms. The 'with' attribute MUST be the bare JID of the room. The client MUST include a 'name' attribute for each &lt;from/&gt; element to specify the room nickname of the message sender:</p>
    <p class="caption">Example 16. Storing groupchat messages in a collection</p>
<div class="indent"><pre>
&lt;iq type='set' to='montague.net' id='up3'&gt;
  &lt;store xmlns='http://jabber.org/protocol/archive'
         with='balcony@house.capulet.com'
         start='1469-07-21T03:16:37Z'&gt;
    &lt;from secs='0' name='benvolio'&gt;&lt;body&gt;She will indite him to some supper.&lt;/body&gt;&lt;/from&gt;
    &lt;from secs='5' name='mercutio'&gt;&lt;body&gt;A bawd, a bawd, a bawd! So ho!&lt;/body&gt;&lt;/from&gt;
    &lt;from secs='11' name='romeo'&gt;&lt;body&gt;What hast thou found?&lt;/body&gt;&lt;/from&gt;
  &lt;/store&gt;
&lt;/iq&gt;
    </pre></div>
  </div>
  <div class="indent">
<h3>5.5 <a name="crypt">Encryption</a>
</h3>
    <p class="" style="">The examples above are not encrypted for clarity. However, clients SHOULD encrypt manually-archived collections, and the encryption of auto-archived collections (see <a href="#auto">Automated Archiving</a>) is strongly RECOMMENDED.</p>
    <p class="" style="">Before uploading a sequence of messages to a collection, the client SHOULD encrypt and encapsulate the joined sequence of &lt;to/&gt;, &lt;from/&gt; and &lt;note/&gt; elements, base64 encode the resulting sequence of bytes, and wrap it inside a &lt;crypt/&gt; element. If a randomly generated unique public label was used to encapsulate the encrypted messages then the 'label' attribute of &lt;crypt/&gt; element MUST be set to that base64 encoded label.</p>
    <p class="" style="">Note: Entities MUST support the SHA-256 hash  [<a href="#nt-id2258786">8</a>] and the DEM1 (with SC2/SHA-256) data encapsulation mechanism (see ISO 18033-2 at http://www.shoup.net/iso/std6.pdf, or ANSI-X9.44). Entities MAY support other hashes and algorithms (see <a href="#registrar">Jabber Registrar Considerations</a>).  [<a href="#nt-id2258801">9</a>]</p>
    <p class="" style="">Clients MAY add one or more &lt;crypt/&gt; elements to a collection using exactly the same method as for &lt;to/&gt;, &lt;from/&gt; and &lt;note/&gt; elements (see <a href="#manual-upload">Uploading Messages to a Collection</a>). Note: a collection that contains &lt;crypt/&gt; elements MUST NOT contain &lt;to/&gt; or &lt;from/&gt; or &lt;note/&gt; elements.</p>
    <p class="" style="">When an encrypted collection is created (or when a &lt;crypt/&gt; element is added to an <span style="font-style: italic">empty non-encrypted</span> collection) four extra attributes MUST be specified for the &lt;store/&gt; element:</p>
    <ul>
      <li>'dataalg' - the name of the encryption/encapsulation algorithm (see <a href="#registrar">Jabber Registrar Considerations</a>) used (with the messages encryption key - see below) to generate the content of all the &lt;crypt/&gt; elements in the collection</li>
      <li>'key' - the <span style="font-style: italic">encrypted</span> (see below) and base64 encoded version of the messages encryption key used (with the messages encryption algorithm above) to generate the content of all the &lt;crypt/&gt; elements in the collection</li>
      <li>'keyalg' - the name of the encryption/encapsulation algorithm (see <a href="#registrar">Jabber Registrar Considerations</a>) used to transform the messages encryption key into the 'key' attribute (see above)</li>
      <li>'master' - the identity (fingerprint) of the private key used (with the <span style="font-style: italic">key</span> encryption algorithm above) to transform the messages encryption key into the 'key' attribute (see above)  [<a href="#nt-id2258890">10</a>]</li>
    </ul>
    <p class="" style="">Note: Clients MUST support the SHA-256 hash and the RSA-KEM (with KDF2/SHA-256) key encapsulation scheme (see ISO 18033-2 at http://www.shoup.net/iso/std6.pdf, or ANSI-X9.44).  [<a href="#nt-id2258906">11</a>] The client MAY support other hashes and algorithms (see <a href="#registrar">Jabber Registrar Considerations</a>).  [<a href="#nt-id2258920">12</a>]</p>
    <p class="caption">Example 17. Storing encrypted messages in a new collection</p>
<div class="indent"><pre>
&lt;iq type='set' to='montague.net' id='crypt1'&gt;
  &lt;store xmlns='http://jabber.org/protocol/archive'
         with='juliet@capulet.com/chamber'
         start='1469-07-21T02:56:15Z'
         subject='She speaks!'
         dataalg='DEM1-SC2-KDF2-SHA256'
         key='bfXv33i+Ybqypa4ETLyorGkVl73v67SMvzX41MPRKA5cOp9wGDMgd8SirwIDAQAB'
         keyalg='RSA-KEM-KDF2-SHA256'
         master='acc3594e844c77696f7a7ba9367ae324b6b958ad'&gt;
    &lt;crypt label='VROLURBVEFDb3JwU0dDL'&gt;E5Qbvfa2gI5lBZMAHryv4g+OGQ0SR+ysraP6LnD43m77VkIVni5c7yPeIbkFdicZ&lt;/crypt&gt;
  &lt;/store&gt;
&lt;/iq&gt;
    </pre></div>
  </div>
  <div class="indent">
<h3>5.6 <a name="crypt">Updating Collection Attributes</a>
</h3>
    <p class="" style="">If the client specifies a new value for the 'subject' attribute of any existing collection, or new values for the 'key', 'keyalg' or 'master' attributes of an existing <span style="font-style: italic">encrypted</span> collection then the server MUST update the existing values. This enables a client to change the subject of a collection, to remove any dependencies on an obsolete private key, or to change the decryption key encryption algorithm.</p>
    <p class="" style="">Note: The client MUST NOT specify new values for the 'dataalg', 'with' or 'start' attributes. The only way to change these values is to delete the collection (see <a href="#manage-remove">Removing a Collection</a>) and then create a new one.</p>
    <p class="caption">Example 18. Changing the private key for a collection</p>
<div class="indent"><pre>
&lt;iq type='set' to='montague.net' id='private1'&gt;
  &lt;store xmlns='http://jabber.org/protocol/archive'
         with='juliet@capulet.com/chamber'
         start='1469-07-21T02:56:15Z'
         key='IHNpbmd1bGFyIHBhc3Npb24gZnJvbSBvdGhlciBhbmltYWxzLCB3aGljaCBpcyBhIGx1c3Qgb2Yg'
         master='3fb37d8e817c673dfa60637351926d564ce65629'/&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="caption">Example 19. Changing the subject of an encrypted collection while appending messages</p>
<div class="indent"><pre>
&lt;iq type='set' to='montague.net' id='subject1'&gt;
  &lt;store xmlns='http://jabber.org/protocol/archive'
         with='juliet@capulet.com/chamber'
         start='1469-07-21T02:56:15Z'
         subject='She speaks twice!'
    &lt;crypt label='TWFuIGlzIGRpc3Rpbmd1'&gt;dGhlIG1pbmQsIHRoYXQgYnkgYSBwZXJzZXZlcmFuY2Ugb2YgZGVsaWdodCBpbiB0aGUgY29udGlu&lt;/crypt&gt;
  &lt;/store&gt;
&lt;/iq&gt;
    </pre></div>
  </div>
<h2>6.
       <a name="auto">Automated Archiving</a>
</h2>
  <p class="" style="">A client MAY enable or disable automatic archiving for messages sent over its stream. Automatic archiving SHOULD default to disabled for each new stream that is opened. Once automatic archiving is switched on then the server MUST automatically archive messages only according to the user's general <a href="#pref">Archiving Preferences</a>.</p>
  <p class="" style="">Note: Both parties to an ESession (see <span class="ref" style="">Encrypted Sessions</span>  [<a href="#nt-id2259052">13</a>]) MUST disable automatic archiving, since ESession decryption keys are short-lived - making it impossible to decrypt automatically archived messages.</p>
  <p class="caption">Example 20. Client Enables Auto Archiving</p>
<div class="indent"><pre>
&lt;iq type='set' id='auto1'&gt;
  &lt;auto save='true' xmlns='http://jabber.org/protocol/archive'/&gt;
&lt;/iq&gt;
  </pre></div>
  <p class="" style="">The server MAY be configured to return a &lt;feature-not-implemented/&gt; error in the following cases:</p>
  <ul>
    <li><p class="" style="">If the client is trying to enable automatic archiving, but the server does not allow the saving of full message stanza content, and the user has specified the 'all' Save Mode in one of its <a href="#pref">Archiving Preferences</a>.</p></li>
    <li><p class="" style="">If administrator policies require that every message is logged automatically, and the client is trying to disable automatic archiving.</p></li>
  </ul>
  <p class="" style="">Whenever the client enables auto-archiving it MAY also specify a 'secret' attribute, this is a base64 encoded secret symmetric encryption key that the server SHOULD use to encrypt all <span style="font-style: italic">new</span> automatically archived collections. It should also specify the 'dataalg', 'key', 'keyalg' and 'master' attributes (see <a href="#crypt">Encryption</a>) that will eventually be downloaded by clients and used to decrypt collections (the 'dataalg' attribute is also required by the server to encrypt collections).</p>
  <p class="caption">Example 21. Client Enables Auto Archiving and Sets Encryption Parameters</p>
<div class="indent"><pre>
&lt;iq type='set' id='auto2'&gt;
  &lt;auto save='true'
        secret='dWVkIGFuZCBpbmRlZmF0aWdhYmxl'
        dataalg='DEM1-SC2-KDF2-SHA256'
        key='bfXv33i+Ybqypa4ETLyorGkVl73v67SMvzX41MPRKA5cOp9wGDMgd8SirwIDAQAB'
        keyalg='RSA-KEM-KDF2-SHA256'
        master='acc3594e844c77696f7a7ba9367ae324b6b958ad'
        xmlns='http://jabber.org/protocol/archive'/&gt;
&lt;/iq&gt;
  </pre></div>
  <p class="" style="">As soon as the client specifies a new secret symmetric encryption key (or switches off all auto-archiving - thus completing all active collections), the server MUST securely destroy all its copies of the old secret key.</p>
  <p class="" style="">Note: If the client uses this protocol to change the secret key regularly (e.g. immediately after the start of every conversation) then, if the server is compromised, only the messages stored during the attack will be compromised (i.e. only those messages that would have been compromised even if they had not been stored).</p>
<h2>7.
       <a name="manage">Archive Management</a>
</h2>
  <p class="" style="">Manually uploaded and automatically saved collections are managed in the same way. There are three main areas of functionality related to archive management:</p>
  <ol start="1" type="">
    <li>Retrieving a list of collections</li>
    <li>Retrieving a collection</li>
    <li>Removing a collection</li>
  </ol>
  <p class="" style="">Requirements and protocol flows for each of these use cases are defined below. The protocols to retrieve a list of collections and an indivdual collection both make extensive use of <span class="ref" style="">Result Set Management</span>  [<a href="#nt-id2259249">14</a>]. Clients and servers SHOULD support all the features defined in that protocol.</p>
  <div class="indent">
<h3>7.1 <a name="manage-list">Retrieving a List of Collections</a>
</h3>
    <p class="" style="">To request a list of collections the client sends a &lt;list/&gt; element. The 'start' and 'end' attributes MAY be specified to indicate a date range (the values of these attributes MUST be UTC and adhere to the DateTime format specified in <span style="font-weight: bold">Jabber Date and Time Profiles</span>). The 'with' attribute MAY be specified to limit the list to a single participating full JID, bare JID or domain.</p>
    <p class="" style="">If the 'with' attribute is omitted then collections with any JID are returned. If only 'start' is specified then all collections on or after that date should be returned. If only 'end' is specified then all collections prior to that date should be returned.</p>
    <p class="" style="">The client SHOULD use <span style="font-weight: bold">Result Set Management</span> to limit the number of collections returned by the server in a single stanza, taking care not to request a page of collections that is so big it might exceed karma limits.</p>
    <p class="caption">Example 22. Requesting the first page of a list with same JID</p>
<div class="indent"><pre>
&lt;iq type='get' to='montague.net' id='juliet1'&gt;
  &lt;list xmlns='http://jabber.org/protocol/archive'
        with='juliet@capulet.com'&gt;
    &lt;set xmlns='http://jabber.org/protocol/rsm'&gt;
      &lt;max&gt;30&lt;/max&gt;
    &lt;/set&gt;
  &lt;/list&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="caption">Example 23. Requesting the first page of a list with same JID between two times</p>
<div class="indent"><pre>
&lt;iq type='get' to='montague.net' id='period1'&gt;
  &lt;list xmlns='http://jabber.org/protocol/archive'
        with='juliet@capulet.com'
        start='1469-07-21T02:00:00Z'
        end='1479-07-21T04:00:00Z'&gt;
    &lt;set xmlns='http://jabber.org/protocol/rsm'&gt;
      &lt;max&gt;30&lt;/max&gt;
    &lt;/set&gt;
  &lt;/list&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="caption">Example 24. Requesting the first page of a list after a time</p>
<div class="indent"><pre>
&lt;iq type='get' to='montague.net' id='list1'&gt;
  &lt;list xmlns='http://jabber.org/protocol/archive'
        start='1469-07-21T02:00:00Z'&gt;
    &lt;set xmlns='http://jabber.org/protocol/rsm'&gt;
      &lt;max&gt;30&lt;/max&gt;
    &lt;/set&gt;
  &lt;/list&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">The server MUST list the collections (empty &lt;store/&gt; elements including all attributes) in chronological order when responding to any request:</p>
    <p class="caption">Example 25. Receiving the first page of a list</p>
<div class="indent"><pre>
&lt;iq type='result' to='romeo@montague.net/orchard' from='montague.net' id='list1'&gt;
  &lt;list xmlns='http://jabber.org/protocol/archive'&gt;
    &lt;store with='juliet@capulet.com/chamber'
           start='1469-07-21T02:56:15Z'
           subject='She speaks!'
           dataalg='DEM1-SC2-KDF2-SHA256'
           key='bfXv33i+Ybqypa4ETLyorGkVl73v67SMvzX41MPRKA5cOp9wGDMgd8SirwIDAQAB'
           keyalg='RSA-KEM-KDF2-SHA256'
           master='acc3594e844c77696f7a7ba9367ae324b6b958ad'/&gt;
    .
    [28 more collections]
    .
    &lt;store with='balcony@house.capulet.com'
           start='1469-07-21T03:16:37Z'/&gt;
    &lt;set xmlns='http://jabber.org/protocol/rsm'&gt;
      &lt;first index='0'&gt;1469-07-21T02:56:15Zjuliet@capulet.com&lt;/first&gt;
      &lt;last&gt;1469-07-21T03:16:37Zbalcony@house.capulet.com&lt;/last&gt;
      &lt;count&gt;1372&lt;/count&gt;
    &lt;/set&gt;
  &lt;/list&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">Note: In accordance with <span style="font-weight: bold">Result Set Management</span>, the client MUST assume the unique IDs it receives in the &lt;first/&gt; and &lt;last/&gt; elements are opaque. Servers MAY adopt a unique ID format other than the one suggested in the example above.</p>
    <p class="" style="">If no collections correspond to the request the server MUST return an empty &lt;list/&gt; element:</p>
    <p class="caption">Example 26. Receiving an empty list</p>
<div class="indent"><pre>
&lt;iq type='result' to='romeo@montague.net/orchard' from='montague.net' id='list1'&gt;
  &lt;list xmlns='http://jabber.org/protocol/archive'/&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="caption">Example 27. Requesting the second page of a list</p>
<div class="indent"><pre>
&lt;iq type='get' to='montague.net' id='list2'&gt;
  &lt;list xmlns='http://jabber.org/protocol/archive'
        start='1469-07-21T02:00:00Z'&gt;
    &lt;set xmlns='http://jabber.org/protocol/rsm'&gt;
      &lt;max&gt;30&lt;/max&gt;
      &lt;after&gt;1469-07-21T03:16:37Zbalcony@house.capulet.com&lt;/after&gt;
    &lt;/set&gt;
  &lt;/list&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">Refer to <span style="font-weight: bold">Result Set Management</span> to learn more about the various ways that the pages of the list may be accessed.</p>
    <p class="" style="">The 'master' attribute MAY be included to limit the list to encrypted collections whose messages decryption key was encrypted with the specified private key. This feature enables a client to find any collections that depend on an obsolete private key:</p>
    <p class="caption">Example 28. Requesting the first page of a list with a private key ID</p>
<div class="indent"><pre>
&lt;iq type='get' to='montague.net' id='master1'&gt;
  &lt;list xmlns='http://jabber.org/protocol/archive'
        master='acc3594e844c77696f7a7ba9367ae324b6b958ad'&gt;
    &lt;set xmlns='http://jabber.org/protocol/rsm'&gt;
      &lt;max&gt;30&lt;/max&gt;
    &lt;/set&gt;
  &lt;/list&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="caption">Example 29. Receiving the first page of a list with a private key ID</p>
<div class="indent"><pre>
&lt;iq type='result' to='romeo@montague.net/orchard' from='montague.net' id='master1'&gt;
  &lt;list xmlns='http://jabber.org/protocol/archive'&gt;
    &lt;store xmlns='http://jabber.org/protocol/archive'
           with='juliet@capulet.com/chamber'
           start='1469-07-21T02:56:15Z'
           subject='She speaks!'
           dataalg='DEM1-SC2-KDF2-SHA256'
           key='bfXv33i+Ybqypa4ETLyorGkVl73v67SMvzX41MPRKA5cOp9wGDMgd8SirwIDAQAB'
           keyalg='RSA-KEM-KDF2-SHA256'
           master='acc3594e844c77696f7a7ba9367ae324b6b958ad'/&gt;
    .
    [29 more encrypted collections]
    .
    &lt;set xmlns='http://jabber.org/protocol/rsm'&gt;
      &lt;first index='0'&gt;1469-07-21T02:56:15Zjuliet@capulet.com&lt;/first&gt;
      &lt;last&gt;1469-07-21T03:16:37Zbalcony@house.capulet.com&lt;/last&gt;
      &lt;count&gt;142&lt;/count&gt;
    &lt;/set&gt;
  &lt;/list&gt;
&lt;/iq&gt;
    </pre></div>
  </div>
  <div class="indent">
<h3>7.2 <a name="manage-retrieve">Retrieving a Collection</a>
</h3>
    <p class="" style="">To request a page of messages from a collection the client sends a &lt;retrieve/&gt; element. The 'with' and 'start' attributes specify the participating full JID and the start time (see <span style="font-weight: bold">Jabber Date and Time Profiles</span>). Both attributes MUST be included to uniquely identify a collection:</p>
    <p class="" style="">The client SHOULD use <span style="font-weight: bold">Result Set Management</span> to limit the number of messages returned by the server in a single stanza, taking care not to request a page of messages that is so big it might exceed karma limits.</p>
    <p class="caption">Example 30. Requesting the first page of a collection</p>
<div class="indent"><pre>
&lt;iq type='get' to='montague.net' id='page1'&gt;
  &lt;retrieve xmlns='http://jabber.org/protocol/archive'
            with='juliet@capulet.com/chamber'
            start='1469-07-21T02:56:15Z'&gt;
    &lt;set xmlns='http://jabber.org/protocol/rsm'&gt;
      &lt;max&gt;100&lt;/max&gt;
    &lt;/set&gt;
  &lt;/retrieve&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="caption">Example 31. Receiving the first page of a collection</p>
<div class="indent"><pre>
&lt;iq type='result' to='romeo@montague.net/orchard' from='montague.net' id='page1'&gt;
  &lt;store xmlns='http://jabber.org/protocol/archive'
         with='juliet@capulet.com/chamber'
         start='1469-07-21T02:56:15Z'
         subject='She speaks!'&gt;
    &lt;from secs='0'&gt;&lt;body&gt;Art thou not Romeo, and a Montague?&lt;/body&gt;&lt;/from&gt;
    &lt;to secs='11'&gt;&lt;body&gt;Neither, fair saint, if either thee dislike.&lt;/body&gt;&lt;/to&gt;
    .
    [98 more messages]
    .
    &lt;from secs='14'&gt;&lt;body&gt;How cam'st thou hither, tell me, and wherefore?&lt;/body&gt;&lt;/from&gt;
    &lt;set xmlns='http://jabber.org/protocol/rsm'&gt;
      &lt;first index='0'&gt;0&lt;/first&gt;
      &lt;last&gt;99&lt;/last&gt;
      &lt;count&gt;217&lt;/count&gt;
    &lt;/set&gt;
  &lt;/store&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">Note: In accordance with <span style="font-weight: bold">Result Set Management</span>, the client MUST assume the unique IDs it receives in the &lt;first/&gt; and &lt;last/&gt; elements are opaque. Servers MAY adopt a unique ID format other than the one suggested in the example above.</p>
    <p class="" style="">If the specified collection does not exist then the server MUST return an &lt;item-not-found/&gt; error:</p>
    <p class="caption">Example 32. Unsuccessful reply</p>
<div class="indent"><pre>
&lt;iq type='error' to='romeo@montague.net/orchard' from='montague.net' id='page1'&gt;
  &lt;error code='404' type='cancel'&gt;
    &lt;item-not-found xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/&gt;
  &lt;/error&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">If the requested collection is empty the server MUST return an empty &lt;store/&gt; element:</p>
    <p class="caption">Example 33. Receiving an empty collection</p>
<div class="indent"><pre>
&lt;iq type='result' to='romeo@montague.net/orchard' from='montague.net' id='page1'&gt;
  &lt;store xmlns='http://jabber.org/protocol/archive'
         with='juliet@capulet.com/chamber'
         start='1469-07-21T02:56:15Z'
         subject='She speaks!'/&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="caption">Example 34. Requesting the second page of a collection</p>
<div class="indent"><pre>
&lt;iq type='get' to='montague.net' id='page2'&gt;
  &lt;retrieve xmlns='http://jabber.org/protocol/archive'
            with='juliet@capulet.com/chamber'
            start='1469-07-21T02:56:15Z'&gt;
    &lt;set xmlns='http://jabber.org/protocol/rsm'&gt;
      &lt;max&gt;100&lt;/max&gt;
      &lt;after&gt;99&lt;/after&gt;
    &lt;/set&gt;
  &lt;/retrieve&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">Refer to <span style="font-weight: bold">Result Set Management</span> to learn more about the various ways that the pages of the collection may be accessed.</p>
  </div>
  <div class="indent">
<h3>7.3 <a name="manage-remove">Removing a Collection</a>
</h3>
    <p class="" style="">To request the removal of a single collection the client sends an empty &lt;remove/&gt; element. The 'with' (full JID) and 'start' attributes MUST be included to uniquely identify the collection.</p>
    <p class="caption">Example 35. Removing a single collection</p>
<div class="indent"><pre>
&lt;iq type='set' to='montague.net'&gt;
  &lt;remove xmlns='http://jabber.org/protocol/archive'
          with='juliet@capulet.com/chamber'
          start='1469-07-21T02:56:15Z'/&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">The client may remove several collections at once. The 'start' and 'end' elements MAY be specified to indicate a date range. The 'with' attribute MAY be a full JID, bare JID or domain.</p>
    <p class="caption">Example 36. Removing all collections with a specified bare JID between two times</p>
<div class="indent"><pre>
&lt;iq type='set' to='montague.net'&gt;
  &lt;remove xmlns='http://jabber.org/protocol/archive'
          with='juliet@capulet.com'
          start='1469-07-21T02:00:00Z'
          end='1469-07-21T04:00:00Z'/&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">If the 'with' attribute is omitted then collections with any JID are removed.</p>
    <p class="" style="">If the end date is in the future then then all collections after the start date are removed.</p>
    <p class="caption">Example 37. Removing all collections after a date</p>
<div class="indent"><pre>
&lt;iq type='set' to='montague.net'&gt;
  &lt;remove xmlns='http://jabber.org/protocol/archive'
          start='1469-07-21T02:00:00Z'
          end='2038-01-01T00:00:00Z'/&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">If the start date is before all the collections in the archive then all collections prior to the end date are removed.</p>
    <p class="caption">Example 38. Removing all collections before a date</p>
<div class="indent"><pre>
&lt;iq type='set' to='montague.net'&gt;
  &lt;remove xmlns='http://jabber.org/protocol/archive'
          start='0000-01-01T00:00:00Z'
          end='1469-07-21T04:00:00Z'/&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="caption">Example 39. Removing all collections</p>
<div class="indent"><pre>
&lt;iq type='set' to='montague.net'&gt;
  &lt;remove xmlns='http://jabber.org/protocol/archive'/&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">If the specified collection (or collections) do not exist then the server MUST return an &lt;item-not-found/&gt; error:</p>
    <p class="caption">Example 40. Unsuccessful reply</p>
<div class="indent"><pre>
&lt;iq type='error' to='romeo@montague.net/orchard'&gt;
  &lt;error code='404' type='cancel'&gt;
    &lt;item-not-found xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/&gt;
  &lt;/error&gt;
&lt;/iq&gt;
    </pre></div>
  </div>
<h2>8.
       <a name="sect-id2259771">Replication</a>
</h2>
  <p class="" style="">This section describes how a client MAY replicate an archive locally.  [<a href="#nt-id2259784">15</a>] The existance of a local copy of the archive enables clients to search the content of all messages (including collections saved by another client machine).  [<a href="#nt-id2259792">16</a>]</p>
  <p class="" style="">The client MAY 'synchronize' its local copy of the archive with the 'master' archive on the server at any time. The first step is to request the list of collections that the server has changed (created, modified or removed) in its master archive since the last update to the client's copy of the archive.</p>
  <p class="" style="">The client MUST request each page of the list using the <span style="font-weight: bold">Result Set Management</span> protocol embeded in a &lt;modified/&gt; element. The content of the &lt;after/&gt; element SHOULD be a UTC time (see <span style="font-weight: bold">Jabber Date and Time Profiles</span>) that it has previously received from the server (see below). When synchronizing for the first time, the client MAY choose a suitable time for the first page request (e.g. 1970-01-01T00:00:00Z).</p>
  <p class="caption">Example 41. Requesting a page of modifications</p>
<div class="indent"><pre>
    
&lt;iq type='get' to='montague.net' id='sync1'&gt;
  &lt;modified xmlns='http://jabber.org/protocol/archive'&gt;
    &lt;set xmlns='http://jabber.org/protocol/rsm'&gt;
      &lt;max&gt;50&lt;/max&gt;
      &lt;after&gt;1469-07-21T01:14:47Z&lt;/after&gt;
    &lt;/set&gt;
  &lt;/modified&gt;
&lt;/iq&gt;
  </pre></div>
  <p class="" style="">The server MUST return the changed collections in the chronological order that they were changed (most recent last). If a collection has been modified, created or removed <span style="font-style: italic">after</span> the time specified by the &lt;after/&gt; element then the server MUST include it in the returned result set page of collections (unless the specified maximum page size would be exceeded). Each &lt;changed/&gt; or &lt;removed/&gt; collection element (for modified/created, or removed collections respectively) in the returned list MUST include only 'with' and 'start' attribues. The server MUST set the content of the &lt;last/&gt; element to the UTC time (see <span style="font-weight: bold">Jabber Date and Time Profiles</span>) that the last collection on the page was modified.</p>
  <p class="caption">Example 42. Receiving a page of modifications</p>
<div class="indent"><pre>
&lt;iq type='result' to='romeo@montague.net/orchard' from='montague.net' id='sync1'&gt;
  &lt;modified xmlns='http://jabber.org/protocol/archive'&gt;
    &lt;changed with='juliet@capulet.com/chamber'
           start='1469-07-21T02:56:15Z'/&gt;
    .
    [up to 48 more collections]
    .
    &lt;removed with='balcony@house.capulet.com'
             start='1469-07-21T03:16:37Z'/&gt;
    &lt;set xmlns='http://jabber.org/protocol/rsm'&gt;
      &lt;last&gt;1469-07-21T04:22:39Z&lt;/last&gt;
      &lt;count&gt;1372&lt;/count&gt;
    &lt;/set&gt;
  &lt;/modified&gt;
&lt;/iq&gt;
  </pre></div>
  <p class="" style="">Note: The server should remember the 'with' and 'start' attribues and the time of removal of all deleted collections. If this 'state' cannot be maintained indefinitely, then unless all the user's clients replicate before the server deletes its memory of a removal then it will not be reflected in all the local copies of the archive.</p>
  <p class="" style="">Note: Along with its copy of the archive the client SHOULD store the most recent &lt;last/&gt; time that it received from the server. The next time it synchronizes with the server it SHOULD specify that time when requesting the first result set page (see above).</p>
  <p class="" style="">After receiving each result set page the client SHOULD delete from its local archive any collections that have been removed from the master archive. The client should also retrieve from the server the content of each collection that has been modified (see <a href="#retrieve">Retrieving a Collection</a>) and add it to its local copy of the archive (deleting any older version of the same collection that it may already have).</p>
<h2>9.
       <a name="fileformat">File Format</a>
</h2>
  <p class="" style=""><span style="font-style: italic">Note the file format specified in this section is likely to be depricated once a standards-based format has been published in a separate JEP.</span></p>
  <p class="" style="">So that clients can share archived messages, this document specifies a common format for storage on disk (similar to email formats like mbox and Maildir). The file format uses the same XML constructs as the protocol. Each file may contain messages exchanged with a single JID. Any number of items may be stored in an archive file.</p>
  <p class="caption">Example 43. Example file</p>
<div class="indent"><pre>
&lt;?xml version='1.0'?&gt;
&lt;archive xmlns='http://jabber.org/protocol/archive'
         with='juliet@capulet.com'&gt;
  &lt;store start='1469-07-21T02:56:15Z' subject='She speaks!'&gt;
    &lt;from secs='0'&gt;&lt;body&gt;Art thou not Romeo, and a Montague?&lt;/body&gt;&lt;/from&gt;
    &lt;to secs='11'&gt;&lt;body&gt;Neither, fair saint, if either thee dislike.&lt;/body&gt;&lt;/to&gt;
    &lt;from secs='14'&gt;&lt;body&gt;How cam'st thou hither, tell me, and wherefore?&lt;/body&gt;&lt;/from&gt;
  &lt;/store&gt;
&lt;/archive&gt;
  </pre></div>
<h2>10.
       <a name="impl">Implementation Notes</a>
</h2>
  <div class="indent">
<h3>10.1 <a name="impl-sync">Time Synchronization</a>
</h3>
    <p class="" style="">When creating a new collection, it is RECOMMENDED that the client synchronizes the collection start time that it sends to the server with server time. This is important since the user may subsequently retrieve the stored collection using client machines whose UTC clocks are not synchronized with the client machine that stored the collection. (i.e. Either or both of the clients' UTC clocks may be wrong.) The client can achieve this synchronization with server time by using <span class="ref" style="">Entity Time</span>  [<a href="#nt-id2260046">17</a>] to estimate the difference between the server and client UTC clocks.</p>
    <p class="" style="">When retrieving collections, it is RECOMMENDED that the client adjusts the start times of the collections it receives from server to be synchronized with the clock of the client machine.</p>
  </div>
  <div class="indent">
<h3>10.2 <a name="impl-bandwidth">Bandwidth Considerations</a>
</h3>
    <p class="" style="">When uploading messages using manual archiving, a client SHOULD NOT store one message at a time on the server since this increases both bandwidth consumption and the total number of transactions. It is instead RECOMMENDED that clients store messages only when the conversation thread <span style="font-style: italic">appears</span> to be terminated, e.g. when the user closes the chat window. If the user reopens the window and the thread continues then the client should append the new messages to the collection when the user closes the window again.</p>
  </div>
  <div class="indent">
<h3>10.3 <a name="impl-storage">Storage Considerations</a>
</h3>
    <p class="" style="">Server implementations SHOULD give system administrators the option to disable support for both automated and manual archiving, since archived conversations can consume significant storage space.</p>
  </div>
<h2>11.
       <a name="security">Security Considerations</a>
</h2>
  <div class="indent">
<h3>11.1 <a name="security-encrypt">Plain Text Subject</a>
</h3>
    <p class="" style="">Since the subject of each collection will not be encrypted, the client MUST warn its human user (if any) before including 'subject' attributes on encrypted collections.</p>
  </div>
  <div class="indent">
<h3>11.2 <a name="security-store">Store Headers</a>
</h3>
    <p class="" style="">The client that originates a message MAY specify a 'false' value for the 'store' header (see <span class="ref" style="">Stanza Headers and Internet Metadata</span>  [<a href="#nt-id2260158">18</a>]). The recipient MUST NOT archive such a message or any of the information it contains.</p>
    <p class="" style="">If the sender plans to use 'store' headers it MUST use Service Discovery to determine whether or not the recipient supports them. Note: Since servers are not required to check the content of message stanzas for headers, if the recipient is using automatic archiving then it MUST indicate that it does not support 'store' headers.</p>
    <p class="" style="">If the recipient does not support 'store' headers, then the sender MUST confirm with its human user (if any) before sending such a message.</p>
  </div>
<h2>12.
       <a name="iana">IANA Considerations</a>
</h2>
  <p class="" style="">No interaction with the <span class="ref" style="">Internet Assigned Numbers Authority (IANA)</span>  [<a href="#nt-id2260238">19</a>] is required as a result of this JEP.</p>
<h2>13.
       <a name="registrar">Jabber Registrar Considerations</a>
</h2>
  <div class="indent">
<h3>13.1 <a name="registrar-ns">Protocol Namespaces</a>
</h3>
    <p class="" style="">The <span class="ref" style="">Jabber Registrar</span>  [<a href="#nt-id2260284">20</a>] shall include 'http://jabber.org/protocol/archive' in its registry of protocol namespaces (see &lt;<a href="http://www.jabber.org/registrar/namespaces.html">http://www.jabber.org/registrar/namespaces.html</a>&gt;):</p>
  </div>
  <div class="indent">
<h3>13.2 <a name="registrar-features">Service Discovery Features</a>
</h3>
    <p class="" style="">The Jabber Registrar shall include the following features in its registry of service discovery features (see &lt;<a href="http://www.jabber.org/registrar/disco-features.html">http://www.jabber.org/registrar/disco-features.html</a>&gt;):</p>
    <ul>
      <li>http://jabber.org/protocol/archive#auto</li>
      <li>http://jabber.org/protocol/archive#encrypt</li>
      <li>http://jabber.org/protocol/archive#manage</li>
      <li>http://jabber.org/protocol/archive#manual</li>
      <li>http://jabber.org/protocol/archive#pref</li>
    </ul>
  </div>
  <div class="indent">
<h3>13.3 <a name="registrar-crypt">Cryptography Scheme Names</a>
</h3>
    <div class="indent">
<h3>13.3.1 <a name="registrar-kemkdf2">RSA-KEM-KDF2-SHA256</a>
</h3>
      <p class="" style="">The Jabber Registrar shall include 'RSA-KEM-KDF2-SHA256' in its registry of cryptography scheme names with the following description:</p>
      <p class="" style="">The encrypting entity uses the <span style="font-style: italic">RSA-KEM.Encrypt</span> algorithm and the <span style="font-style: italic">KDF2</span> key derivation function and the SHA256-based HMAC algorithm (see ISO 18033-2) along with the entity's <span style="font-style: italic">public</span> RSA key (i.e. the key whose identity is the 'master' attribute of the &lt;store/&gt; element) to generate a secret symmetric encryption key, K, and an RSA-encrypted version of the key, C (i.e. the 'key' attribute of the &lt;store/&gt; element).</p>
      <p class="" style="">The decrypting entity uses <span style="font-style: italic">RSA-KEM.Decrypt</span> algorithm and the <span style="font-style: italic">KDF2</span> key derivation function and the SHA256-based HMAC algorithm (see ISO 18033-2) along with the entity's <span style="font-style: italic">private</span> RSA key to decrypt C to K.</p>
    </div>
    <div class="indent">
<h3>13.3.2 <a name="registrar-dem1sc2">DEM1-SC2-KDF2-SHA256</a>
</h3>
      <p class="" style="">The Jabber Registrar shall include 'DEM1-SC2-KDF2-SHA256' in its registry of cryptography scheme names with the following description:</p>
      <p class="" style="">The encrypting entity uses the <span style="font-style: italic">DEM1.Encrypt</span> algorithm with the <span style="font-style: italic">SC2.Encrypt</span> symmetric encryption algorithm and the <span style="font-style: italic">KDF2</span> key derivation function and the SHA256-based HMAC algorithm (see ISO 18033-2) to encrypt the data, M (i.e. the complete sequence of &lt;from/&gt;, &lt;to/&gt; and &lt;note/&gt; elements), with the secret symmetric encryption key, K, and a randomly generated public label, L (i.e. the 'label' attribute of the &lt;crypt/&gt; element).</p>
      <p class="" style="">Note that the encrypting entity MAY use same key, K, for more than one collection. But it MUST use the label, L, with only one plain text, M.</p>
      <p class="" style="">The decrypting entity uses the <span style="font-style: italic">DEM1.Decrypt</span> algorithm with the <span style="font-style: italic">SC2.Decrypt</span> symmetric decryption algorithm and the <span style="font-style: italic">KDF2</span> key derivation function and the SHA256-based HMAC algorithm (see ISO 18033-2) to decrypt the data with K and L.</p>
    </div>
  </div>
<h2>14.
       <a name="schema">XML Schemas</a>
</h2>
  <p class="caption"></p>
<div class="indent"><pre>
&lt;?xml version='1.0' encoding='UTF-8'?&gt;

&lt;xs:schema
    xmlns:xs='http://www.w3.org/2001/XMLSchema'
    targetNamespace='http://jabber.org/protocol/archive'
    xmlns='http://jabber.org/protocol/archive'
    elementFormDefault='qualified'&gt;

  &lt;xs:annotation&gt;
    &lt;xs:documentation&gt;
      The allowable root element for the namespace defined
      herein are:
        - archive
        - list
        - otr
        - remove
        - retrieve
        - save
        - store
    &lt;/xs:documentation&gt;
  &lt;/xs:annotation&gt;

  &lt;xs:element name='archive'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:sequence&gt;
        &lt;xs:element ref='store' minOccurs='1' maxOccurs='unbounded'/&gt;
      &lt;/xs:sequence&gt;
      &lt;xs:attribute name='with' type='xs:string' use='optional'/&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:element name='auto'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:simpleContent&gt;
        &lt;xs:extension base='empty'&gt;
          &lt;xs:attribute name='dataalg' type='xs:string' use='optional'/&gt;
          &lt;xs:attribute name='key' type='xs:string' use='optional'/&gt;
          &lt;xs:attribute name='keyalg' type='xs:string' use='optional'/&gt;
          &lt;xs:attribute name='master' type='xs:string' use='optional'/&gt;
          &lt;xs:attribute name='save' type='xs:boolean' use='required'/&gt;
          &lt;xs:attribute name='secret' use='optional' type='xs:string'/&gt;
        &lt;/xs:extension&gt;
      &lt;/xs:simpleContent&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:element name='changed'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:simpleContent&gt;
        &lt;xs:extension base='empty'&gt;
          &lt;xs:attribute name='start' type='xs:dateTime' use='required'/&gt;
          &lt;xs:attribute name='with' type='xs:string' use='required'/&gt;
        &lt;/xs:extension&gt;
      &lt;/xs:simpleContent&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:element name='crypt'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:simpleContent&gt;
        &lt;xs:extension base='xs:string'&gt;
          &lt;xs:attribute name='label' type='xs:string' use='optional'/&gt;
        &lt;/xs:extension&gt;
      &lt;/xs:simpleContent&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:element name='default'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:simpleContent&gt;
        &lt;xs:extension base='empty'&gt;
          &lt;xs:attribute name='otr' use='required'&gt;
            &lt;xs:simpleType&gt;
              &lt;xs:restriction base='xs:NCName'&gt;
                &lt;xs:enumeration value='allow'/&gt;
                &lt;xs:enumeration value='deny'/&gt;
                &lt;xs:enumeration value='require'/&gt;
                &lt;xs:enumeration value='try'/&gt;
              &lt;/xs:restriction&gt;
            &lt;/xs:simpleType&gt;
          &lt;/xs:attribute&gt;
          &lt;xs:attribute name='save' use='required'&gt;
            &lt;xs:simpleType&gt;
              &lt;xs:restriction base='xs:NCName'&gt;
                &lt;xs:enumeration value='all'/&gt;
                &lt;xs:enumeration value='body'/&gt;
                &lt;xs:enumeration value='false'/&gt;
              &lt;/xs:restriction&gt;
            &lt;/xs:simpleType&gt;
          &lt;/xs:attribute&gt;
          &lt;xs:attribute name='unset' use='optional' type='xs:boolean'/&gt;
        &lt;/xs:extension&gt;
      &lt;/xs:simpleContent&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:element name='item'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:simpleContent&gt;
        &lt;xs:extension base='empty'&gt;
          &lt;xs:attribute name='jid' use='required' type='xs:string'/&gt;
          &lt;xs:attribute name='otr' use='required'&gt;
            &lt;xs:simpleType&gt;
              &lt;xs:restriction base='xs:NCName'&gt;
                &lt;xs:enumeration value='allow'/&gt;
                &lt;xs:enumeration value='deny'/&gt;
                &lt;xs:enumeration value='require'/&gt;
                &lt;xs:enumeration value='try'/&gt;
              &lt;/xs:restriction&gt;
            &lt;/xs:simpleType&gt;
          &lt;/xs:attribute&gt;
          &lt;xs:attribute name='save' use='required'&gt;
            &lt;xs:simpleType&gt;
              &lt;xs:restriction base='xs:NCName'&gt;
                &lt;xs:enumeration value='all'/&gt;
                &lt;xs:enumeration value='body'/&gt;
                &lt;xs:enumeration value='false'/&gt;
              &lt;/xs:restriction&gt;
            &lt;/xs:simpleType&gt;
          &lt;/xs:attribute&gt;
        &lt;/xs:extension&gt;
      &lt;/xs:simpleContent&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:element name='list'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:sequence&gt;
        &lt;xs:element ref='store' minOccurs='0' maxOccurs='unbounded'/&gt;
      &lt;/xs:sequence&gt;
      &lt;xs:attribute name='end' type='xs:dateTime' use='optional'/&gt;
      &lt;xs:attribute name='master' type='xs:string' use='optional'/&gt;
      &lt;xs:attribute name='start' type='xs:dateTime' use='optional'/&gt;
      &lt;xs:attribute name='with' type='xs:string' use='optional'/&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:element name='modified'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:sequence&gt;
        &lt;xs:element ref='changed' minOccurs='0' maxOccurs='unbounded'/&gt;
        &lt;xs:element ref='removed' minOccurs='0' maxOccurs='unbounded'/&gt;
      &lt;/xs:sequence&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:element name='pref'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:sequence&gt;
        &lt;xs:element ref='default' minOccurs='0' maxOccurs='1'/&gt;
        &lt;xs:element ref='item' minOccurs='0' maxOccurs='unbounded'/&gt;
      &lt;/xs:sequence&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:element name='remove'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:simpleContent&gt;
        &lt;xs:extension base='empty'&gt;
          &lt;xs:attribute name='end' type='xs:dateTime' use='optional'/&gt;
          &lt;xs:attribute name='start' type='xs:dateTime' use='required'/&gt;
          &lt;xs:attribute name='with' type='xs:string' use='required'/&gt;
        &lt;/xs:extension&gt;
      &lt;/xs:simpleContent&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:element name='removed'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:simpleContent&gt;
        &lt;xs:extension base='empty'&gt;
          &lt;xs:attribute name='start' type='xs:dateTime' use='required'/&gt;
          &lt;xs:attribute name='with' type='xs:string' use='required'/&gt;
        &lt;/xs:extension&gt;
      &lt;/xs:simpleContent&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:element name='retrieve'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:simpleContent&gt;
        &lt;xs:extension base='empty'&gt;
          &lt;xs:attribute name='start' type='xs:dateTime' use='required'/&gt;
          &lt;xs:attribute name='with' type='xs:string' use='required'/&gt;
        &lt;/xs:extension&gt;
      &lt;/xs:simpleContent&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:element name='store'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:choice maxOccurs='unbounded'&gt;
        &lt;xs:element ref='crypt'/&gt;
        &lt;xs:element name='from' type='messageType'/&gt;
        &lt;xs:element name='note' type='xs:string'/&gt;
        &lt;xs:element name='to' type='messageType'/&gt;
      &lt;/xs:choice&gt;
      &lt;xs:attribute name='dataalg' type='xs:string' use='optional'/&gt;
      &lt;xs:attribute name='key' type='xs:string' use='optional'/&gt;
      &lt;xs:attribute name='keyalg' type='xs:string' use='optional'/&gt;
      &lt;xs:attribute name='master' type='xs:string' use='optional'/&gt;
      &lt;xs:attribute name='start' type='xs:dateTime' use='required'/&gt;
      &lt;xs:attribute name='subject' type='xs:string' use='optional'/&gt;
      &lt;xs:attribute name='with' type='xs:string' use='required'/&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:complexType name='messageType'&gt;
    &lt;xs:sequence&gt;
      &lt;xs:element name='body' type='xs:string' maxOccurs='unbounded'/&gt;
    &lt;/xs:sequence&gt;
    &lt;xs:attribute name='secs' type='xs:nonNegativeInteger' use='required'/&gt;
  &lt;/xs:complexType&gt;

  &lt;xs:simpleType name='empty'&gt;
    &lt;xs:restriction base='xs:string'&gt;
      &lt;xs:enumeration value=''/&gt;
    &lt;/xs:restriction&gt;
  &lt;/xs:simpleType&gt;

&lt;/xs:schema&gt;
  </pre></div>
<p><hr></p>
<a name="notes"></a><h2>Notes</h2>
<div class="indent">
<p><a name="nt-id2250950">1</a>. JEP-0030: Service Discovery &lt;<a href="http://www.jabber.org/jeps/jep-0030.html">http://www.jabber.org/jeps/jep-0030.html</a>&gt;.</p>
<p><a name="nt-id2258246">2</a>. JEP-0155: Chat Session Negotiation &lt;<a href="http://www.jabber.org/jeps/jep-0155.html">http://www.jabber.org/jeps/jep-0155.html</a>&gt;.</p>
<p><a name="nt-id2258281">3</a>. If a client (or user) acts in bad faith then its contacts cannot prevent it archiving conversations.</p>
<p><a name="nt-id2258379">4</a>. JEP-0116: Encrypted Sessions &lt;<a href="http://www.jabber.org/jeps/jep-0116.html">http://www.jabber.org/jeps/jep-0116.html</a>&gt;.</p>
<p><a name="nt-id2258473">5</a>. JEP-0082: Jabber Date and Time Profiles &lt;<a href="http://www.jabber.org/jeps/jep-0082.html">http://www.jabber.org/jeps/jep-0082.html</a>&gt;.</p>
<p><a name="nt-id2258553">6</a>. Stream compression typically does not mitigate bandwidth and storage issues since collections SHOULD be encrypted, and since clients running in constrained runtime environments typically cannot take advantage of stream compression (no binary data, only XML, may be transfered).</p>
<p><a name="nt-id2258716">7</a>. JEP-0045: Multi-User Chat &lt;<a href="http://www.jabber.org/jeps/jep-0045.html">http://www.jabber.org/jeps/jep-0045.html</a>&gt;.</p>
<p><a name="nt-id2258786">8</a>. SHA-1 is broken (assuming the attacker has plenty of computing power) and many other standard hashes are not optimised for 32-bit processors (e.g. Whirlpool, SHA-384, SHA-512).</p>
<p><a name="nt-id2258801">9</a>. Future versions of this document MAY be modified to recommend other algorithms.</p>
<p><a name="nt-id2258890">10</a>. Mechanisms for the storage and retrieval of private keys are beyond the scope of this document.</p>
<p><a name="nt-id2258906">11</a>. RSA-KEM is the only required encapsulation scheme since it is NESSIE-recommended, its security is tightly proven (unlike RSA-OAEP or PKCS #1 v1.5), and it is very simple to implement.</p>
<p><a name="nt-id2258920">12</a>. Future versions of this document MAY be modified to recommend other algorithms.</p>
<p><a name="nt-id2259052">13</a>. JEP-0116: Encrypted Sessions &lt;<a href="http://www.jabber.org/jeps/jep-0116.html">http://www.jabber.org/jeps/jep-0116.html</a>&gt;.</p>
<p><a name="nt-id2259249">14</a>. JEP-0059: Result Set Management &lt;<a href="http://www.jabber.org/jeps/jep-0059.html">http://www.jabber.org/jeps/jep-0059.html</a>&gt;.</p>
<p><a name="nt-id2259784">15</a>. Clients that run in constrained environments may not be able to implement replication if they are prevented from accessing (sufficient) local storage.</p>
<p><a name="nt-id2259792">16</a>. Since collections should be stored in encrypted form on the server, server-side searching of the content of messages is beyond the scope of this protocol.</p>
<p><a name="nt-id2260046">17</a>. JEP-0090: Entity Time &lt;<a href="http://www.jabber.org/jeps/jep-0090.html">http://www.jabber.org/jeps/jep-0090.html</a>&gt;.</p>
<p><a name="nt-id2260158">18</a>. JEP-0131: Stanza Headers and Internet Metadata &lt;<a href="http://www.jabber.org/jeps/jep-0131.html">http://www.jabber.org/jeps/jep-0131.html</a>&gt;.</p>
<p><a name="nt-id2260238">19</a>. The Internet Assigned Numbers Authority (IANA) is the central coordinator for the assignment of unique parameter values for Internet protocols, such as port numbers and URI schemes. For further information, see &lt;<a href="http://www.iana.org/">http://www.iana.org/</a>&gt;.</p>
<p><a name="nt-id2260284">20</a>. The Jabber Registrar maintains a list of reserved Jabber protocol namespaces as well as registries of parameters used in the context of protocols approved by the Jabber Software Foundation. For further information, see &lt;<a href="http://www.jabber.org/registrar/">http://www.jabber.org/registrar/</a>&gt;.</p>
</div>
<p><hr></p>
<a name="revs"></a><h2>Revision History</h2>
<div class="indent">
<h4>Version 0.7 (2006-09-08)</h4>
<div class="indent">
<p class="" style="">Added preferences, results set management and notes; reinstated encryption and replication; simplified auto-archiving and off-the-record (with JEP-0155); many minor changes</p> (ip)
    </div>
<h4>Version 0.6 (2006-08-18)</h4>
<div class="indent">
<p class="" style="">Added unset value for save attribute and added service attribute on default element; added source attribute on record element; specified that services should (not must) support save mode for particular contacts.</p> (jp/psa)
    </div>
<h4>Version 0.5 (2006-05-03)</h4>
<div class="indent">
<p class="" style="">Integrated text from server-side archiving proposal; added partial support to collection retrieval; harmonized XML formats and namespaces; defined Jabber Registrar considerations and XML schema.</p> (psa/jp/jk)
    </div>
<h4>Version 0.4 (2005-12-21)</h4>
<div class="indent">
<p class="" style="">Added Replication and Searching section, partial attribute; minor improvements</p> (ip)
    </div>
<h4>Version 0.3 (2005-10-21)</h4>
<div class="indent">
<p class="" style="">Added more examples to Removing Collections</p> (ip)
    </div>
<h4>Version 0.2 (2005-04-18)</h4>
<div class="indent">
<p class="" style="">Complete rewrite.</p> (ip)
    </div>
<h4>Version 0.1 (2004-06-04)</h4>
<div class="indent">
<p class="" style="">Initial version.</p> (jk)
    </div>
</div>
<p><hr></p>
<p>END</p>
</body>
</html>
